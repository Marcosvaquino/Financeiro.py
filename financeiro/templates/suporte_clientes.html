{% extends "base.html" %}

{% block title %}Clientes - Suporte{% endblock %}

{% block content %}
<style>
/* Estilos específicos para a página de clientes */
.client-form-input {
    padding: 12px;
    border: 2px solid #e5e7eb;
    border-radius: 8px;
    font-size: 16px;
    transition: all 0.2s ease;
    width: 100%;
}

.client-form-input:focus {
    border-color: #059669 !important;
    box-shadow: 0 0 0 3px rgba(5, 150, 105, 0.1) !important;
    outline: none;
}

.client-btn {
    padding: 12px 24px;
    border: none;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
    text-decoration: none;
    display: inline-block;
}

.client-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 15px rgba(0,0,0,0.15);
}

.client-btn-primary {
    background: linear-gradient(135deg, #059669 0%, #047857 100%);
    color: white;
}

.client-btn-small {
    padding: 6px 12px;
    font-size: 12px;
}

.status-badge {
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: 600;
    color: white;
}

.status-ativo {
    background: linear-gradient(135deg, #059669 0%, #047857 100%);
}

.status-inativo {
    background: #94a3b8;
}

/* Estilos para tabela compacta de clientes */
.uploads-table-wrapper {
    overflow-x: auto;
    background: white;
}

.uploads-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 13px;
}

.uploads-table th {
    background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
    padding: 8px 10px;
    text-align: left;
    font-weight: 700;
    color: #1e293b;
    border-bottom: 2px solid #e5e7eb;
    font-size: 12px;
}

.uploads-table td {
    padding: 6px 10px;
    border-bottom: 1px solid #f1f5f9;
    vertical-align: middle;
    font-size: 12px;
    line-height: 1.3;
}

.uploads-table tr:hover {
    background: #f0fdf4;
}

/* Linha de cliente compacta */
.client-row {
    height: 38px;
}

.client-row td {
    padding: 4px 8px !important;
    font-size: 11px;
}

.client-row .status-badge {
    padding: 2px 6px;
    font-size: 10px;
    border-radius: 8px;
}

.client-row .client-btn-small {
    padding: 3px 6px;
    font-size: 10px;
    border-radius: 4px;
}

/* Responsividade */
@media (max-width: 768px) {
    .uploads-table {
        font-size: 10px;
    }
    
    .client-row td {
        padding: 3px 5px !important;
        font-size: 9px;
    }
    
    .client-row .status-badge {
        padding: 1px 4px;
        font-size: 8px;
    }
    
    .client-row .client-btn-small {
        padding: 2px 4px;
        font-size: 8px;
    }
}

/* Paginação */
#pagination button {
    border: 1px solid #e5e7eb;
    background: white;
    padding: 6px 10px;
    margin: 0 1px;
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.2s ease;
    font-size: 12px;
}

#pagination button:hover {
    background: #f0fdf4;
    transform: translateY(-1px);
}

#pagination button.active {
    background: #059669;
    color: white;
    border-color: #059669;
}

/* Controles de filtro */
.filter-controls {
    display: flex;
    gap: 10px;
    align-items: center;
    margin-top: 12px;
    flex-wrap: wrap;
}

.filter-controls input, .filter-controls select {
    font-size: 14px;
    padding: 8px 12px;
}

@media (max-width: 768px) {
    .filter-controls {
        flex-direction: column;
        align-items: stretch;
    }
    
    .filter-controls > div {
        flex: 1;
    }
}
</style>

<div class="import-cards">
    <!-- Cabeçalho com título e breadcrumb -->
    <div class="card">
        <div class="card-header">
            <h2 style="margin:0; color:#1e293b;">👥 Gerenciamento de Clientes</h2>
        </div>
        <div style="padding: 0 30px 20px 30px;">
            <nav aria-label="breadcrumb">
                <ol style="margin:0; padding:0; list-style:none; display:flex; gap:8px; font-size:14px; color:#64748b;">
                    <li><a href="{{ url_for('suporte.index') }}" style="color:#059669; text-decoration:none;">Suporte</a></li>
                    <li>›</li>
                    <li style="color:#64748b;">Clientes</li>
                </ol>
            </nav>
        </div>
    </div>

    <!-- Formulário de Adição -->
    <div class="card card-primary">
        <h3 style="margin-top:0; color:#1e293b;">➕ Adicionar Novo Cliente</h3>
        <form method="POST" action="{{ url_for('suporte.add_cliente') }}">
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px; margin-bottom:20px;">
                <div>
                    <label style="display:block; margin-bottom:8px; font-weight:600; color:#374151;">Nome Real *</label>
                    <input type="text" class="client-form-input" id="nome_real" name="nome_real" required 
                           placeholder="Ex: Adoro Frango Ltda">
                </div>
                <div>
                    <label style="display:block; margin-bottom:8px; font-weight:600; color:#374151;">Nome Ajustado *</label>
                    <input type="text" class="client-form-input" id="nome_ajustado" name="nome_ajustado" required 
                           placeholder="Ex: ADORO" style="text-transform:uppercase;">
                </div>
            </div>
            
            <div style="text-align:center;">
                <button type="submit" class="client-btn client-btn-primary">
                    💾 Cadastrar Cliente
                </button>
            </div>
        </form>
    </div>

    <!-- Lista de Clientes -->
    <div class="card">
        <div class="card-header">
            <h3 style="margin:0; color:#1e293b;">📋 Clientes Cadastrados</h3>
            <div style="display:flex; gap:12px; align-items:center; margin-top:12px;">
                <div style="flex:1;">
                    <input type="text" id="searchInput" placeholder="🔍 Buscar por nome real ou ajustado..." 
                           class="client-form-input" style="margin:0;">
                </div>
                <select id="statusFilter" class="client-form-input" style="margin:0; width:auto;">
                    <option value="">Todos os status</option>
                    <option value="1">Ativos</option>
                    <option value="0">Inativos</option>
                </select>
            </div>
        </div>
        
        {% if clientes and clientes|length > 0 %}
        <div style="padding:0 30px 20px 30px;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px; font-size:14px; color:#64748b;">
                <div id="showingInfo">Mostrando registros...</div>
                <div style="display:flex; align-items:center; gap:8px;">
                    <span>Registros por página:</span>
                    <select id="pageSize" style="padding:4px 8px; border:1px solid #e5e7eb; border-radius:4px;">
                        <option value="20">20</option>
                        <option value="50" selected>50</option>
                        <option value="100">100</option>
                        <option value="all">Todos</option>
                    </select>
                </div>
            </div>
        </div>
        
        <div class="uploads-table-wrapper">
            <table class="uploads-table" id="clientesTable">
                <thead>
                    <tr>
                        <th style="width:200px; padding:8px 10px; font-size:12px;">Nome Real</th>
                        <th style="width:120px; padding:8px 10px; font-size:12px;">Nome Ajustado</th>
                        <th style="width:90px; padding:8px 10px; font-size:12px;">Cadastro</th>
                        <th style="width:60px; padding:8px 10px; font-size:12px;">Ativo</th>
                        <th style="width:120px; padding:8px 10px; font-size:12px;">Ações</th>
                    </tr>
                </thead>
                <tbody id="clientesTableBody">
                    {% for cliente in clientes %}
                    <tr data-nome-real="{{ cliente.nome_real }}" data-nome-ajustado="{{ cliente.nome_ajustado }}" data-ativo="{{ 1 if cliente.ativo else 0 }}" class="client-row">
                        <td style="padding:6px 10px;"><strong style="font-size:12px;">{{ cliente.nome_real }}</strong></td>
                        <td style="padding:6px 10px;">
                            <span style="background:linear-gradient(135deg, #059669 0%, #047857 100%); color:white; padding:2px 6px; font-size:10px; border-radius:8px; font-weight:600;">
                                {{ cliente.nome_ajustado }}
                            </span>
                        </td>
                        <td style="color:#64748b; font-size:11px; padding:6px 10px;">{{ cliente.data_cadastro.split(' ')[0] if cliente.data_cadastro else '' }}</td>
                        <td style="padding:6px 10px;">
                            {% if cliente.ativo %}
                            <span class="status-badge status-ativo" style="padding:2px 6px; font-size:10px;">
                                ✅
                            </span>
                            {% else %}
                            <span class="status-badge status-inativo" style="padding:2px 6px; font-size:10px;">
                                ❌
                            </span>
                            {% endif %}
                        </td>
                        <td style="padding:6px 10px;">
                            <button type="button" onclick="openEditModal(this)" 
                                    class="client-btn client-btn-primary client-btn-small" style="margin-right:4px; padding:4px 8px; font-size:10px;">
                                ✏️
                            </button>
                            <button type="button" onclick="confirmDelete('{{ cliente.nome_real }}')" 
                                    class="client-btn client-btn-small" style="background:linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color:white; padding:4px 8px; font-size:10px;">
                                🗑️
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <!-- Paginação -->
        <div style="padding:20px 30px; border-top:1px solid #f1f5f9;">
            <div style="display:flex; justify-content:center; align-items:center; gap:8px;" id="pagination">
                <!-- Será preenchido via JavaScript -->
            </div>
        </div>
        
        {% else %}
        <div style="text-align:center; padding:40px; color:#94a3b8;">
            <div style="font-size:48px; margin-bottom:16px;">👥</div>
            <div style="font-size:18px; font-weight:600; margin-bottom:8px;">Nenhum cliente cadastrado</div>
            <div style="font-size:14px;">Adicione o primeiro cliente usando o formulário acima</div>
        </div>
        {% endif %}
    </div>

    <!-- Modal de Edição Customizado -->
    <div style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000;" id="editModal">
        <div style="position:absolute; top:50%; left:50%; transform:translate(-50%, -50%); background:white; border-radius:16px; padding:30px; width:500px; max-width:90vw; box-shadow:0 25px 50px rgba(0,0,0,0.25);">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:24px;">
                <h3 style="margin:0; color:#1e293b;">✏️ Editar Cliente</h3>
                <button onclick="closeEditModal()" style="background:none; border:none; font-size:24px; cursor:pointer; color:#94a3b8;">&times;</button>
            </div>
            
            <form method="POST" id="editForm">
                <input type="hidden" id="edit_nome_real_hidden" name="nome_real_original">
                
                <div style="margin-bottom:20px;">
                    <label style="display:block; margin-bottom:8px; font-weight:600; color:#374151;">Nome Real</label>
                    <input type="text" id="edit_nome_real" name="nome_real" required class="client-form-input">
                </div>
                
                <div style="margin-bottom:20px;">
                    <label style="display:block; margin-bottom:8px; font-weight:600; color:#374151;">Nome Ajustado</label>
                    <input type="text" id="edit_nome_ajustado" name="nome_ajustado" required class="client-form-input" style="text-transform:uppercase;">
                </div>
                
                <div style="margin-bottom:24px;">
                    <label style="display:flex; align-items:center; cursor:pointer;">
                        <input type="checkbox" id="edit_ativo" name="ativo" style="margin-right:8px; width:16px; height:16px;">
                        <span style="font-weight:600; color:#374151;">Cliente Ativo</span>
                    </label>
                </div>
                
                <div style="display:flex; gap:12px; justify-content:flex-end;">
                    <button type="button" onclick="closeEditModal()" class="client-btn" style="border:2px solid #e5e7eb; background:white; color:#374151;">
                        Cancelar
                    </button>
                    <button type="submit" class="client-btn client-btn-primary">
                        💾 Salvar Alterações
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// Variáveis de controle da tabela
let allRows = [];
let filteredRows = [];
let currentPage = 1;
let itemsPerPage = 50;

// Inicialização e efeitos visuais
document.addEventListener('DOMContentLoaded', function() {
    // Placeholder para nome ajustado
    var nomeAjustado = document.getElementById('nome_ajustado');
    if (nomeAjustado) {
        nomeAjustado.addEventListener('input', function() {
            this.value = this.value.toUpperCase();
        });
    }
    
    var editNomeAjustado = document.getElementById('edit_nome_ajustado');
    if (editNomeAjustado) {
        editNomeAjustado.addEventListener('input', function() {
            this.value = this.value.toUpperCase();
        });
    }
    
    // Efeitos de hover para botões
    var btns = document.querySelectorAll('button[type="submit"], button[onclick*="Edit"], button[onclick*="Delete"]');
    btns.forEach(function(btn) {
        btn.addEventListener('mouseenter', function() {
            this.style.transform = 'translateY(-2px)';
            this.style.boxShadow = '0 8px 15px rgba(0,0,0,0.15)';
        });
        btn.addEventListener('mouseleave', function() {
            this.style.transform = 'translateY(0)';
            this.style.boxShadow = 'none';
        });
    });
    
    // Efeitos de foco para inputs
    var inputs = document.querySelectorAll('input, select');
    inputs.forEach(function(input) {
        input.addEventListener('focus', function() {
            this.style.borderColor = '#059669';
            this.style.boxShadow = '0 0 0 3px rgba(5, 150, 105, 0.1)';
        });
        input.addEventListener('blur', function() {
            this.style.borderColor = '#e5e7eb';
            this.style.boxShadow = 'none';
        });
    });

    // Inicializar tabela se existir
    initializeTable();
    setupEventListeners();
});

// Sistema de Paginação e Busca
function initializeTable() {
    const tbody = document.getElementById('clientesTableBody');
    if (!tbody) return;
    
    allRows = Array.from(tbody.querySelectorAll('.client-row'));
    filteredRows = [...allRows];
    updateTable();
}

function setupEventListeners() {
    // Busca
    const searchInput = document.getElementById('searchInput');
    if (searchInput) {
        searchInput.addEventListener('input', handleSearch);
    }

    // Filtros
    const statusFilter = document.getElementById('statusFilter');
    if (statusFilter) {
        statusFilter.addEventListener('change', handleFilter);
    }

    // Tamanho da página
    const pageSize = document.getElementById('pageSize');
    if (pageSize) {
        pageSize.addEventListener('change', function() {
            itemsPerPage = this.value === 'all' ? filteredRows.length : parseInt(this.value);
            currentPage = 1;
            updateTable();
        });
    }
}

function handleSearch() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    applyFilters(searchTerm);
}

function handleFilter() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    applyFilters(searchTerm);
}

function applyFilters(searchTerm = '') {
    const statusFilter = document.getElementById('statusFilter').value;

    filteredRows = allRows.filter(row => {
        const nomeReal = row.dataset.nomeReal.toLowerCase();
        const nomeAjustado = row.dataset.nomeAjustado.toLowerCase();
        const ativo = row.dataset.ativo;

        // Busca por texto
        const matchesSearch = !searchTerm || 
            nomeReal.includes(searchTerm) || 
            nomeAjustado.includes(searchTerm);

        // Filtro por status
        const matchesStatus = !statusFilter || ativo === statusFilter;

        return matchesSearch && matchesStatus;
    });

    currentPage = 1;
    updateTable();
}

function updateTable() {
    const tbody = document.getElementById('clientesTableBody');
    if (!tbody) return;

    // Limpar tabela
    tbody.innerHTML = '';

    // Calcular paginação
    const startIndex = (currentPage - 1) * itemsPerPage;
    const endIndex = itemsPerPage === filteredRows.length ? filteredRows.length : startIndex + itemsPerPage;
    const rowsToShow = filteredRows.slice(startIndex, endIndex);

    // Adicionar linhas
    rowsToShow.forEach(row => {
        tbody.appendChild(row.cloneNode(true));
    });

    // Atualizar informações
    updateShowingInfo(startIndex + 1, endIndex, filteredRows.length, allRows.length);
    updatePagination();
}

function updateShowingInfo(start, end, filtered, total) {
    const showingInfo = document.getElementById('showingInfo');
    if (!showingInfo) return;

    if (filtered === total) {
        showingInfo.textContent = `Mostrando ${start} a ${end} de ${total} clientes`;
    } else {
        showingInfo.textContent = `Mostrando ${start} a ${end} de ${filtered} clientes (filtrado de ${total})`;
    }
}

function updatePagination() {
    const pagination = document.getElementById('pagination');
    if (!pagination) return;

    const totalPages = Math.ceil(filteredRows.length / itemsPerPage);
    
    if (totalPages <= 1) {
        pagination.innerHTML = '';
        return;
    }

    let html = '';

    // Botão anterior
    if (currentPage > 1) {
        html += `<button onclick="changePage(${currentPage - 1})" style="padding:8px 12px; margin:0 2px; border:1px solid #e5e7eb; background:white; border-radius:6px; cursor:pointer;">‹ Anterior</button>`;
    }

    // Páginas
    const startPage = Math.max(1, currentPage - 2);
    const endPage = Math.min(totalPages, currentPage + 2);

    if (startPage > 1) {
        html += `<button onclick="changePage(1)" style="padding:8px 12px; margin:0 2px; border:1px solid #e5e7eb; background:white; border-radius:6px; cursor:pointer;">1</button>`;
        if (startPage > 2) {
            html += `<span style="padding:8px 4px;">...</span>`;
        }
    }

    for (let i = startPage; i <= endPage; i++) {
        const isActive = i === currentPage;
        html += `<button onclick="changePage(${i})" style="padding:8px 12px; margin:0 2px; border:1px solid ${isActive ? '#059669' : '#e5e7eb'}; background:${isActive ? '#059669' : 'white'}; color:${isActive ? 'white' : 'black'}; border-radius:6px; cursor:pointer;">${i}</button>`;
    }

    if (endPage < totalPages) {
        if (endPage < totalPages - 1) {
            html += `<span style="padding:8px 4px;">...</span>`;
        }
        html += `<button onclick="changePage(${totalPages})" style="padding:8px 12px; margin:0 2px; border:1px solid #e5e7eb; background:white; border-radius:6px; cursor:pointer;">${totalPages}</button>`;
    }

    // Botão próximo
    if (currentPage < totalPages) {
        html += `<button onclick="changePage(${currentPage + 1})" style="padding:8px 12px; margin:0 2px; border:1px solid #e5e7eb; background:white; border-radius:6px; cursor:pointer;">Próximo ›</button>`;
    }

    pagination.innerHTML = html;
}

function changePage(page) {
    currentPage = page;
    updateTable();
}

// Funções de modal
function openEditModal(button){
    const tr = button.closest('tr');
    const nomeReal = tr.getAttribute('data-nome-real');
    const nomeAjustado = tr.getAttribute('data-nome-ajustado');
    const ativo = tr.getAttribute('data-ativo') === '1';

    // Preenche o modal
    document.getElementById('edit_nome_real_hidden').value = nomeReal;
    document.getElementById('edit_nome_real').value = nomeReal;
    document.getElementById('edit_nome_ajustado').value = nomeAjustado;
    document.getElementById('edit_ativo').checked = ativo;

    // Ajusta action do form
    const editForm = document.getElementById('editForm');
    editForm.action = `{{ url_for('suporte.edit_cliente', nome_real='PLACEHOLDER') }}`.replace('PLACEHOLDER', encodeURIComponent(nomeReal));

    // Exibe modal
    document.getElementById('editModal').style.display = 'block';
    document.body.style.overflow = 'hidden';
}

function closeEditModal(){
    document.getElementById('editModal').style.display = 'none';
    document.body.style.overflow = 'auto';
}

function confirmDelete(nomeReal){
    if (!confirm(`🗑️ Tem certeza que deseja excluir o cliente "${nomeReal}"?`)) return;
    const action = `{{ url_for('suporte.delete_cliente', nome_real='PLACEHOLDER') }}`.replace('PLACEHOLDER', encodeURIComponent(nomeReal));
    const f = document.createElement('form');
    f.method = 'POST';
    f.action = action;
    document.body.appendChild(f);
    f.submit();
}

// Fechar modal ao clicar fora
document.addEventListener('click', function(e) {
    const modal = document.getElementById('editModal');
    if (e.target === modal) {
        closeEditModal();
    }
});
</script>

{% endblock %}