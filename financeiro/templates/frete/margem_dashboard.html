{% extends "base.html" %}

{% block title %}Análise de Margem Líquida - FRZ Log{% endblock %}

{% block content %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
        :root {
            --primary-color: #2c3e50;
            --success-color: #27ae60;
            --danger-color: #e74c3c;
            --warning-color: #f39c12;
            --info-color: #3498db;
        }



        .card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s ease;
        }

        .card:hover {
            transform: translateY(-2px);
        }

        .card-header {
            background: linear-gradient(135deg, var(--primary-color), #34495e);
            color: white;
            border-radius: 15px 15px 0 0 !important;
            padding: 1rem 1.5rem;
        }

        .metric-card {
            background: linear-gradient(135deg, #fff, #f8f9fa);
            border-left: 4px solid;
        }

        .metric-card.positive { border-left-color: var(--success-color); }
        .metric-card.negative { border-left-color: var(--danger-color); }
        .metric-card.warning { border-left-color: var(--warning-color); }
        .metric-card.info { border-left-color: var(--info-color); }

        .metric-card .card-body {
            padding: 0.4rem; /* aumentado de 0.25rem para 0.4rem para acomodar as fontes maiores */
            display: flex;
            flex-direction: column;
            justify-content: center;
            min-height: 45px; /* aumentado de 30px para 45px */
        }

        .metric-value {
            font-size: 1.6rem; /* aumentado de 1.1rem para 1.6rem para melhor destaque */
            font-weight: bold;
            margin: 0;
            line-height: 1.1;
        }

        .metric-label {
            color: #6c757d;
            font-size: 0.8rem; /* aumentado de 0.65rem para 0.8rem para melhor legibilidade */
            margin-top: 0.1rem;
            font-weight: 500;
        }

        .kpi-card {
            background: linear-gradient(135deg, #fff, #f8f9fa);
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            transition: all 0.3s ease;
            min-height: 55px;
        }

        .kpi-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.12);
        }

        .kpi-card .card-body {
            padding: 0.4rem;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .trend-chart {
            background: linear-gradient(135deg, #2c3e50, #34495e);
            color: white;
            border-radius: 15px;
            margin: 2rem 0;
        }

        .alert-item {
            padding: 0.75rem 1rem;
            border-radius: 8px;
            margin-bottom: 0.5rem;
            border-left: 4px solid;
        }

        .alert-critico { 
            background: #fff5f5; 
            border-left-color: var(--danger-color); 
        }

        .alert-atencao { 
            background: #fffdf0; 
            border-left-color: var(--warning-color); 
        }

        .alert-info { 
            background: #f0f8ff; 
            border-left-color: var(--info-color); 
        }

        .filter-section {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 1.5rem;
            border-radius: 15px;
            margin-bottom: 2rem;
            border: 1px solid #dee2e6;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .filter-control {
            border: 1px solid #ced4da;
            border-radius: 10px;
            font-size: 0.875rem;
            padding: 0.5rem 0.75rem;
            background: white;
            transition: all 0.3s ease;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .filter-control:focus {
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.15);
            border-color: #80bdff;
            background: #fff;
        }

        .filter-control:hover {
            border-color: #adb5bd;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.15);
        }

        /* Estilo para os botões de análise */
        .btn-outline-primary {
            color: #495057;
            border-color: #dee2e6;
            background: white;
            border-radius: 10px !important;
            font-weight: 500;
            transition: all 0.3s ease;
            border: 1px solid #dee2e6;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .btn-outline-primary:hover {
            color: white;
            background-color: #007bff;
            border-color: #007bff;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 123, 255, 0.3);
        }

        .btn-check:checked + .btn-outline-primary {
            color: white;
            background-color: #007bff;
            border-color: #007bff;
            box-shadow: 0 2px 6px rgba(0, 123, 255, 0.4);
        }

        .btn-check:checked + .btn-outline-primary:hover {
            background-color: #0056b3;
            border-color: #0056b3;
        }

        .tab-content {
            margin-top: 2rem;
        }

        .nav-pills .nav-link {
            border-radius: 25px;
            margin-right: 0.5rem;
            color: var(--primary-color);
            border: 2px solid transparent;
        }

        .nav-pills .nav-link.active {
            background: var(--primary-color);
            border-color: var(--primary-color);
        }

        .chart-container {
            position: relative;
            height: 400px;
            margin: 2rem 0;
        }

        .ranking-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.2rem;
            margin: 0.8rem 0;
            background: linear-gradient(135deg, #ffffff, #f8f9fa);
            border-radius: 10px;
            border: 1px solid #e9ecef;
            transition: all 0.3s ease;
            position: relative;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
        }

        .ranking-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            border-radius: 3px 0 0 3px;
        }

        .ranking-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.12);
        }

        .ranking-item.top::before { 
            background: linear-gradient(45deg, #28a745, #20c997);
        }
        
        .ranking-item.medium::before { 
            background: linear-gradient(45deg, #ffc107, #fd7e14);
        }
        
        .ranking-item.bottom::before { 
            background: linear-gradient(45deg, #dc3545, #e83e8c);
        }

        .ranking-position {
            background: linear-gradient(135deg, #6c757d, #495057);
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1rem;
            margin-right: 1rem;
            flex-shrink: 0;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
            transition: all 0.3s ease;
            position: relative;
        }

        /* Medalhas especiais para os 3 primeiros no ranking top */
        .ranking-item.top:nth-child(1) .ranking-position {
            background: linear-gradient(135deg, #ffd700, #ffed4e);
            color: #b8860b;
            transform: scale(1.15);
            box-shadow: 0 4px 12px rgba(255, 215, 0, 0.4);
        }

        .ranking-item.top:nth-child(2) .ranking-position {
            background: linear-gradient(135deg, #c0c0c0, #e8e8e8);
            color: #696969;
            transform: scale(1.1);
            box-shadow: 0 4px 10px rgba(192, 192, 192, 0.4);
        }

        .ranking-item.top:nth-child(3) .ranking-position {
            background: linear-gradient(135deg, #cd7f32, #daa520);
            color: #8b4513;
            transform: scale(1.05);
            box-shadow: 0 3px 8px rgba(205, 127, 50, 0.4);
        }

        .ranking-info {
            flex-grow: 1;
        }

        .ranking-name {
            font-weight: 600;
            color: #495057;
            font-size: 1.1rem;
            margin-bottom: 0.2rem;
        }

        .ranking-subtitle {
            color: #6c757d;
            font-size: 0.85rem;
        }

        .ranking-values {
            text-align: right;
            flex-shrink: 0;
        }

        .ranking-percentage {
            font-weight: 700;
            font-size: 1.3rem;
            margin-bottom: 0.1rem;
        }

        .ranking-percentage.positive {
            color: #28a745;
        }

        .ranking-percentage.negative {
            color: #dc3545;
        }

        .ranking-margin {
            color: #6c757d;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .ranking-header {
            background: linear-gradient(135deg, #495057 0%, #6c757d 100%);
            color: white;
            padding: 1.2rem 1.5rem;
            border-radius: 10px 10px 0 0;
            margin: -1px -1px 0 -1px;
            position: relative;
        }

        .ranking-header h5 {
            margin: 0;
            font-weight: 600;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            flex: 1;
        }

        .ranking-header .icon {
            background: rgba(255, 255, 255, 0.2);
            width: 36px;
            height: 36px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Estilo para o filtro dentro do header */
        .ranking-header .form-select {
            background: rgba(255, 255, 255, 0.95);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: #495057;
            font-size: 0.85rem;
            margin-top: 0.5rem;
            border-radius: 8px;
            padding: 0.375rem 0.5rem;
            transition: all 0.3s ease;
        }

        .ranking-header .form-select:focus {
            background: white;
            box-shadow: 0 0 0 0.2rem rgba(255, 255, 255, 0.25);
            border-color: rgba(255, 255, 255, 0.5);
        }

        .ranking-header .form-select:hover {
            background: white;
            border-color: rgba(255, 255, 255, 0.5);
        }

        .ranking-card {
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            border: 1px solid #e9ecef;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .ranking-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        .ranking-empty {
            text-align: center;
            padding: 3rem 2rem;
            color: #6c757d;
        }

        .ranking-empty i {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .loading {
            text-align: center;
            padding: 3rem;
            color: #6c757d;
        }

        .spinner-border {
            width: 3rem;
            height: 3rem;
        }

        .summary-badge {
            font-size: 0.8rem;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
        }

        @media (max-width: 768px) {
            .metric-value {
                font-size: 1.3rem;
            }
            
            .metric-card .card-body {
                min-height: 50px;
                padding: 0.4rem;
            }
            
            .kpi-card {
                min-height: 45px;
            }
            
            .kpi-card .card-body {
                padding: 0.3rem;
            }
            
            .chart-container {
                height: 300px;
            }
        }

        @media (max-width: 576px) {
            .metric-value {
                font-size: 1.2rem;
            }
            
            .metric-card .card-body {
                min-height: 45px;
            }
            
            .kpi-card {
                min-height: 40px;
            }
            
            .metric-label, 
            .kpi-card small {
                font-size: 0.65rem;
            }
        }

        /* Estilos para Rankings */
        .ranking-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            border-radius: 8px;
            border-left: 4px solid;
            background: linear-gradient(135deg, #fff, #f8f9fa);
            transition: transform 0.2s ease;
        }

        .ranking-item:hover {
            transform: translateX(5px);
        }

        .ranking-item.melhor {
            border-left-color: #28a745;
            background: linear-gradient(135deg, #f8fff9, #e8f5e8);
        }

        .ranking-item.pior {
            border-left-color: #dc3545;
            background: linear-gradient(135deg, #fff8f8, #f5e8e8);
        }

        .ranking-posicao {
            font-weight: bold;
            font-size: 1.2rem;
            color: #6c757d;
            min-width: 30px;
        }

        .ranking-placa {
            font-weight: 600;
            font-size: 1rem;
            color: #333;
        }

        .ranking-tipologia {
            font-size: 0.8rem;
            color: #6c757d;
            background: rgba(108, 117, 125, 0.1);
            padding: 0.2rem 0.5rem;
            border-radius: 12px;
        }

        .ranking-valor {
            font-weight: bold;
            font-size: 1rem;
        }

        .ranking-valor.positivo {
            color: #28a745;
        }

        .ranking-valor.negativo {
            color: #dc3545;
        }

        /* Estilos para botões de navegação no filtro */
        .nav-link.btn {
            border: 2px solid #dee2e6;
            margin-bottom: 0;
            transition: all 0.3s ease;
        }

        .nav-link.btn.active {
            background-color: #0d6efd;
            border-color: #0d6efd;
            color: white;
        }

        .nav-link.btn:hover {
            background-color: #f8f9fa;
            border-color: #0d6efd;
            color: #0d6efd;
        }

        .nav-link.btn.active:hover {
            background-color: #0b5ed7;
            border-color: #0a58ca;
        }
    </style>

<div class="container-fluid py-1">
        <!-- Header com Resumo Geral -->
        <div class="row mb-1">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h4 class="mb-0">
                            <i class="fas fa-analytics me-2"></i>
                            Dashboard de Margem Líquida e Rentabilidade
                        </h4>
                    </div>
                    <div class="card-body">
                        <!-- Cards Principais -->
                        <div id="resumo-geral" class="row mb-1">
                            <div class="col-lg-3 col-md-6 mb-1">
                                <div class="metric-card card info">
                                    <div class="card-body text-center">
                                        <p class="metric-value text-info" id="receita-total">-</p>
                                        <p class="metric-label">Receita Total</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-3 col-md-6 mb-1">
                                <div class="metric-card card warning">
                                    <div class="card-body text-center">
                                        <p class="metric-value text-warning" id="despesa-total">-</p>
                                        <p class="metric-label">Despesa Total</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-3 col-md-6 mb-1">
                                <div class="metric-card card positive">
                                    <div class="card-body text-center">
                                        <p class="metric-value text-success" id="margem-total">-</p>
                                        <p class="metric-label">Margem Líquida</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-3 col-md-6 mb-1">
                                <div class="metric-card card info">
                                    <div class="card-body text-center">
                                        <p class="metric-value text-primary" id="margem-percentual">-</p>
                                        <p class="metric-label">Margem %</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Cards KPI Adicionais -->
                        <div class="row">
                            <div class="col-lg-2 col-md-4 col-sm-6 mb-2">
                                <div class="kpi-card card">
                                    <div class="card-body text-center">
                                        <div class="metric-value text-dark" id="total-operacoes" style="font-size: 1.3rem;">-</div>
                                        <small class="metric-label" style="font-size: 0.8rem;">Total Operações</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-2 col-md-4 col-sm-6 mb-2">
                                <div class="kpi-card card">
                                    <div class="card-body text-center">
                                        <div class="metric-value text-primary" id="ticket-medio" style="font-size: 1.3rem;">-</div>
                                        <small class="metric-label" style="font-size: 0.8rem;">Ticket Médio</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-2 col-md-4 col-sm-6 mb-2">
                                <div class="kpi-card card">
                                    <div class="card-body text-center">
                                        <div class="metric-value text-success" id="operacoes-lucro" style="font-size: 1.3rem;">-</div>
                                        <small class="metric-label" style="font-size: 0.8rem;">Operações Lucro</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-2 col-md-4 col-sm-6 mb-2">
                                <div class="kpi-card card">
                                    <div class="card-body text-center">
                                        <div class="metric-value text-danger" id="operacoes-prejuizo" style="font-size: 1.3rem;">-</div>
                                        <small class="metric-label" style="font-size: 0.8rem;">Operações Prejuízo</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-2 col-md-4 col-sm-6 mb-2">
                                <div class="kpi-card card">
                                    <div class="card-body text-center">
                                        <div class="metric-value text-info" id="melhor-tipologia" style="font-size: 1.3rem;">-</div>
                                        <small class="metric-label" style="font-size: 0.8rem;">Melhor Tipologia</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-2 col-md-4 col-sm-6 mb-2">
                                <div class="kpi-card card">
                                    <div class="card-body text-center">
                                        <div class="metric-value text-warning" id="pior-tipologia" style="font-size: 1.3rem;">-</div>
                                        <small class="metric-label" style="font-size: 0.8rem;">Pior Tipologia</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filtros Superiores (Afetam Cards + Gráfico Anual) -->
        <div class="row mb-2">
            <div class="col-12">
                <div class="card">
                    <div class="card-body py-2">
                        <h6 class="mb-1"><i class="fas fa-sliders-h me-2"></i>Filtros Gerais</h6>
                        <div class="row g-2">
                            <div class="col-md-2">
                                <select class="form-select form-select-sm" id="filtro-geral-tipologia">
                                    <option value="">Todas Tipologias</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <select class="form-select form-select-sm" id="filtro-geral-perfil">
                                    <option value="">Todos Perfis</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <select class="form-select form-select-sm" id="filtro-geral-placa">
                                    <option value="">Todas Placas</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <select class="form-select form-select-sm" id="filtro-geral-mes">
                                    <option value="">Todos Meses</option>
                                    <option value="1">Janeiro</option>
                                    <option value="2">Fevereiro</option>
                                    <option value="3">Março</option>
                                    <option value="4">Abril</option>
                                    <option value="5">Maio</option>
                                    <option value="6">Junho</option>
                                    <option value="7">Julho</option>
                                    <option value="8">Agosto</option>
                                    <option value="9">Setembro</option>
                                    <option value="10">Outubro</option>
                                    <option value="11">Novembro</option>
                                    <option value="12">Dezembro</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <select class="form-select form-select-sm" id="filtro-geral-ano">
                                    <option value="">Todos Anos</option>
                                    <option value="2024">2024</option>
                                    <option value="2025">2025</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <button class="btn btn-secondary btn-sm w-100" disabled>
                                    <i class="fas fa-check me-1"></i>Auto-Filtro
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Gráfico Anual Mensal -->
        <div class="row mb-4" style="margin-top: -0.5rem;">
            <div class="col-12">
                <div class="card trend-chart">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-chart-line me-2"></i>
                            Evolução da Rentabilidade Anual (Mês a Mês)
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container" style="height: 300px;">
                            <canvas id="chartEvolucaoAnual"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filtros e Navegação -->
        <div class="filter-section">
            <div class="row align-items-center">
                <div class="col-md-2">
                    <label class="form-label small text-muted mb-1">Perfil:</label>
                    <select class="form-select form-select-sm filter-control" id="filtro-perfil-top5">
                        <option value="">Todos Perfis</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label small text-muted mb-1">Análise por:</label>
                    <div class="d-flex gap-2">
                        <input type="radio" class="btn-check" name="tipo-analise" id="tipologia-radio" value="tipologia" checked>
                        <label class="btn btn-outline-primary btn-sm flex-fill" for="tipologia-radio">
                            <i class="fas fa-truck me-1"></i>Tipologia
                        </label>
                        
                        <input type="radio" class="btn-check" name="tipo-analise" id="destino-radio" value="destino">
                        <label class="btn btn-outline-primary btn-sm flex-fill" for="destino-radio">
                            <i class="fas fa-map-marker-alt me-1"></i>Destino
                        </label>
                        
                        <input type="radio" class="btn-check" name="tipo-analise" id="placa-radio" value="placa">
                        <label class="btn btn-outline-primary btn-sm flex-fill" for="placa-radio">
                            <i class="fas fa-id-card me-1"></i>Placa
                        </label>
                    </div>
                </div>
                <div class="col-md-2">
                    <label class="form-label small text-muted mb-1">Mês:</label>
                    <select class="form-select form-select-sm filter-control" id="filtro-mes">
                        <option value="todos">Todos os Meses</option>
                        <option value="1">Janeiro</option>
                        <option value="2">Fevereiro</option>
                        <option value="3">Março</option>
                        <option value="4">Abril</option>
                        <option value="5">Maio</option>
                        <option value="6">Junho</option>
                        <option value="7">Julho</option>
                        <option value="8">Agosto</option>
                        <option value="9">Setembro</option>
                        <option value="10">Outubro</option>
                        <option value="11">Novembro</option>
                        <option value="12">Dezembro</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label small text-muted mb-1">Ano:</label>
                    <select class="form-select form-select-sm filter-control" id="filtro-ano">
                        <option value="todos">Todos os Anos</option>
                        <option value="2024">2024</option>
                        <option value="2025">2025</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <small class="text-muted d-flex align-items-end" style="padding-bottom: 0.375rem;">
                        <i class="fas fa-info-circle me-1"></i>
                        Filtros aplicados automaticamente
                    </small>
                </div>
            </div>
        </div>

        <!-- Conteúdo das Tabs -->
        <div class="tab-content" id="analysisTabContent">
            <!-- Tab Tipologia - Rankings de Rentabilidade -->
            <div class="tab-pane fade show active" id="tipologia" role="tabpanel">
                <div class="row">
                    <!-- Top 5 Melhores -->
                    <div class="col-md-6">
                        <div class="ranking-card">
                            <div class="ranking-header">
                                <div class="icon">
                                    <i class="fas fa-trophy"></i>
                                </div>
                                <h5>Top 5 Melhores Rentabilidades</h5>
                            </div>
                            <div class="card-body" id="ranking-melhores">
                                <div class="loading text-center">
                                    <div class="spinner-border text-success" role="status"></div>
                                    <p class="mt-2">Carregando melhores...</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Top 5 Piores -->
                    <div class="col-md-6">
                        <div class="ranking-card">
                            <div class="ranking-header">
                                <div class="icon">
                                    <i class="fas fa-exclamation-triangle"></i>
                                </div>
                                <h5>Top 5 Piores Rentabilidades</h5>
                            </div>
                            <div class="card-body" id="ranking-piores">
                                <div class="loading text-center">
                                    <div class="spinner-border text-danger" role="status"></div>
                                    <p class="mt-2">Carregando piores...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab Destino - Removido por solicitação -->
            <div class="tab-pane fade" id="destino" role="tabpanel">
                <div class="row">
                    <div class="col-12">
                        <div class="alert alert-info text-center">
                            <i class="fas fa-info-circle me-2"></i>
                            Seção de análise por destino removida para otimizar o layout
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab Placa - Removido por solicitação -->
            <div class="tab-pane fade" id="placa" role="tabpanel">
                <div class="row">
                    <div class="col-12">
                        <div class="alert alert-info text-center">
                            <i class="fas fa-info-circle me-2"></i>
                            Seção de análise por placa removida para otimizar o layout
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Variáveis globais
        let chartTipologia, chartDestinos, chartPlacas, chartEvolucaoAnual;
        
        // Utilitários
        function formatCurrency(value) {
            return new Intl.NumberFormat('pt-BR', {
                style: 'currency',
                currency: 'BRL'
            }).format(value);
        }
        
        function formatPercent(value) {
            return `${value.toFixed(1)}%`;
        }
        
        function showLoading(elementId, message = 'Carregando...') {
            document.getElementById(elementId).innerHTML = `
                <div class="loading">
                    <div class="spinner-border text-primary" role="status"></div>
                    <p class="mt-2">${message}</p>
                </div>
            `;
        }
        
        // Carregamento inicial otimizado
        document.addEventListener('DOMContentLoaded', function() {
            // Carregar dados críticos primeiro
            Promise.all([
                carregarDadosGerais(),
                carregarFiltros(),
                carregarFiltrosGerais()
            ]).then(() => {
                // Carregar gráfico de evolução anual (independente dos filtros)
                setTimeout(() => {
                    carregarEvolucaoAnual();
                }, 50);
                
                // Carregar análises em background
                setTimeout(() => {
                    carregarAnalises();
                }, 100);
            }).catch(error => {
                console.error('Erro no carregamento inicial:', error);
            });

            // Event listeners para botões de análise
            const radioButtons = document.querySelectorAll('input[name="tipo-analise"]');
            
            radioButtons.forEach(radio => {
                radio.addEventListener('change', function() {
                    console.log('Mudança no tipo de análise:', this.value);
                    if (this.checked) {
                        carregarRankings();
                    }
                });
            });

            // Auto-filtro para os selects principais (rankings)
            const filtroMes = document.getElementById('filtro-mes');
            const filtroAno = document.getElementById('filtro-ano');
            
            if (filtroMes) {
                filtroMes.addEventListener('change', function() {
                    console.log('Mudança no mês (rankings):', this.value);
                    carregarRankings();
                });
            }
            
            if (filtroAno) {
                filtroAno.addEventListener('change', function() {
                    console.log('Mudança no ano (rankings):', this.value);
                    carregarRankings();
                });
            }

            // Auto-filtro para os filtros gerais (cards + gráfico)
            const filtroGeralTipologia = document.getElementById('filtro-geral-tipologia');
            const filtroGeralPerfil = document.getElementById('filtro-geral-perfil');
            const filtroGeralPlaca = document.getElementById('filtro-geral-placa');
            const filtroGeralMes = document.getElementById('filtro-geral-mes');
            const filtroGeralAno = document.getElementById('filtro-geral-ano');
            
            if (filtroGeralTipologia) {
                filtroGeralTipologia.addEventListener('change', function() {
                    console.log('Mudança na tipologia geral:', this.value);
                    aplicarFiltrosGerais();
                });
            }
            
            if (filtroGeralPerfil) {
                filtroGeralPerfil.addEventListener('change', function() {
                    console.log('Mudança no perfil geral:', this.value);
                    aplicarFiltrosGerais();
                });
            }
            
            if (filtroGeralPlaca) {
                filtroGeralPlaca.addEventListener('change', function() {
                    console.log('Mudança na placa geral:', this.value);
                    aplicarFiltrosGerais();
                });
            }
            
            if (filtroGeralMes) {
                filtroGeralMes.addEventListener('change', function() {
                    console.log('Mudança no mês geral:', this.value);
                    aplicarFiltrosGerais();
                });
            }
            
            if (filtroGeralAno) {
                filtroGeralAno.addEventListener('change', function() {
                    console.log('Mudança no ano geral:', this.value);
                    aplicarFiltrosGerais();
                });
            }

            // Event listeners para filtros específicos dos Top 5
            const filtroPerfilTop5 = document.getElementById('filtro-perfil-top5');
            const tipoAnalise = document.getElementById('tipo-analise');
            
            if (filtroPerfilTop5) {
                filtroPerfilTop5.addEventListener('change', function() {
                    console.log('Mudança no perfil Top 5:', this.value);
                    carregarRankings();
                });
            }
            
            if (tipoAnalise) {
                tipoAnalise.addEventListener('change', function() {
                    console.log('Mudança no tipo de análise:', this.value);
                    carregarRankings();
                });
            }

            // Carregar rankings na inicialização
            setTimeout(() => {
                carregarRankings();
            }, 500);
        });
        
        // Carregar dados gerais do resumo
        async function carregarDadosGerais() {
            try {
                console.log('Carregando dados gerais...');
                const response = await fetch('/api/margem/dados-gerais');
                console.log('Response status:', response.status);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('Dados recebidos:', data);
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                // Verificar se os dados existem
                if (!data.resumo_financeiro) {
                    throw new Error('Dados financeiros não encontrados');
                }
                
                // Atualizar cards do resumo
                document.getElementById('receita-total').textContent = formatCurrency(data.resumo_financeiro.receita_total);
                document.getElementById('despesa-total').textContent = formatCurrency(data.resumo_financeiro.despesa_total);
                document.getElementById('margem-total').textContent = formatCurrency(data.resumo_financeiro.margem_total);
                document.getElementById('margem-percentual').textContent = formatPercent(data.resumo_financeiro.margem_percentual_geral);

                // Atualizar KPIs adicionais
                atualizarKPIs(data);
                
                // Atualizar cores baseadas na margem
                const margemCard = document.getElementById('margem-total').closest('.card');
                const margemPercentCard = document.getElementById('margem-percentual').closest('.card');
                
                if (data.resumo_financeiro.margem_total >= 0) {
                    margemCard.className = 'metric-card card positive';
                    document.getElementById('margem-total').className = 'metric-value text-success';
                } else {
                    margemCard.className = 'metric-card card negative';
                    document.getElementById('margem-total').className = 'metric-value text-danger';
                }
                
            } catch (error) {
                console.error('Erro ao carregar dados gerais:', error);
                document.getElementById('receita-total').textContent = 'Erro ao carregar';
                document.getElementById('despesa-total').textContent = 'Erro ao carregar';
                document.getElementById('margem-total').textContent = 'Erro ao carregar';
                document.getElementById('margem-percentual').textContent = 'Erro ao carregar';
                
                // Mostrar erro na tela
                alert('Erro ao carregar dados: ' + error.message);
            }
        }
        
        // Carregar opções dos filtros
        async function carregarFiltros() {
            try {
                const response = await fetch('/api/margem/filtros');
                const data = await response.json();
                
                // Preencher filtros
                preencherSelect('filtro-tipologia', data.tipologias);
                preencherSelect('filtro-destino', data.destinos);
                preencherSelect('filtro-placa', data.placas);
                
            } catch (error) {
                console.error('Erro ao carregar filtros:', error);
            }
        }
        
        function preencherSelect(selectId, options) {
            const select = document.getElementById(selectId);
            const firstOption = select.querySelector('option[value="all"], option[value=""]');
            
            // Manter primeira opção e limpar resto
            select.innerHTML = '';
            if (firstOption) {
                select.appendChild(firstOption);
            }
            
            // Adicionar opções
            options.forEach(option => {
                const optionElement = document.createElement('option');
                optionElement.value = option;
                optionElement.textContent = option;
                select.appendChild(optionElement);
            });
        }
        
        // Carregar análises de forma escalonada para melhor performance
        async function carregarAnalises() {
            // Carregar primeiro a análise ativa (Tipologia)
            await carregarAnaliseTipologia();
            
            // Carregar as outras em background
            setTimeout(async () => {
                await carregarAnaliseDestinos();
            }, 500);
            
            setTimeout(async () => {
                await carregarAnalisePlacas();
            }, 1000);
        }
        
        // Análise por Tipologia
        async function carregarAnaliseTipologia() {
            showLoading('metas-tipologia', 'Calculando metas por tipologia...');
            
            try {
                const response = await fetch('/api/margem/tipologia');
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                // Criar gráfico
                criarGraficoTipologia(data.analise);
                
                // Atualizar metas
                atualizarMetasTipologia(data.metas_sugeridas);
                
            } catch (error) {
                console.error('Erro ao carregar análise por tipologia:', error);
            }
        }
        
        function criarGraficoTipologia(analise) {
            const ctx = document.getElementById('chartTipologia').getContext('2d');
            
            if (chartTipologia) {
                chartTipologia.destroy();
            }
            
            const tipologias = Object.keys(analise.resumo_geral || {});
            const margens = tipologias.map(tip => analise.resumo_geral[tip].margem_percentual_media);
            const receitas = tipologias.map(tip => analise.resumo_geral[tip].receita_total);
            
            chartTipologia = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: tipologias,
                    datasets: [{
                        label: 'Margem Percentual (%)',
                        data: margens,
                        backgroundColor: margens.map(m => m >= 15 ? '#27ae60' : m >= 10 ? '#f39c12' : '#e74c3c'),
                        borderColor: margens.map(m => m >= 15 ? '#2ecc71' : m >= 10 ? '#f1c40f' : '#c0392b'),
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Margem Percentual por Tipologia'
                        },
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Margem (%)'
                            }
                        }
                    },
                    onClick: (event, elements) => {
                        if (elements.length > 0) {
                            const index = elements[0].index;
                            const tipologia = tipologias[index];
                            mostrarDetalhesTipologia(tipologia, analise.resumo_geral[tipologia]);
                        }
                    }
                }
            });
        }
        
        function atualizarMetasTipologia(metas) {
            const container = document.getElementById('metas-tipologia');
            let html = '';
            
            Object.entries(metas).forEach(([tipologia, meta]) => {
                const status = meta.performance_atual >= meta.meta_sugerida ? 'success' : 'warning';
                const icon = meta.performance_atual >= meta.meta_sugerida ? 'check-circle' : 'exclamation-triangle';
                
                html += `
                    <div class="d-flex justify-content-between align-items-center mb-3 p-2 border-start border-4 border-${status}">
                        <div>
                            <strong>${tipologia}</strong>
                            <br>
                            <small class="text-muted">Meta: ${meta.meta_sugerida}% | Atual: ${meta.performance_atual}%</small>
                        </div>
                        <i class="fas fa-${icon} text-${status}"></i>
                    </div>
                `;
            });
            
            container.innerHTML = html || '<p class="text-muted">Nenhuma meta disponível</p>';
        }
        
        // Análise por Destinos
        async function carregarAnaliseDestinos() {
            showLoading('ranking-destinos', 'Analisando destinos mais rentáveis...');
            
            try {
                const response = await fetch('/api/margem/destinos');
                const data = await response.json();
                
                criarGraficoDestinos(data);
                atualizarRankingDestinos(data);
                
            } catch (error) {
                console.error('Erro ao carregar análise por destinos:', error);
            }
        }
        
        function criarGraficoDestinos(data) {
            const ctx = document.getElementById('chartDestinos').getContext('2d');
            
            if (chartDestinos) {
                chartDestinos.destroy();
            }
            
            const destinos = Object.keys(data.top_destinos || {}).slice(0, 10);
            const margens = destinos.map(dest => data.top_destinos[dest].margem_percentual);
            
            chartDestinos = new Chart(ctx, {
                type: 'horizontalBar',
                data: {
                    labels: destinos,
                    datasets: [{
                        label: 'Margem %',
                        data: margens,
                        backgroundColor: '#3498db',
                        borderColor: '#2980b9',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Margem (%)'
                            }
                        }
                    }
                }
            });
        }
        
        function atualizarRankingDestinos(data) {
            const container = document.getElementById('ranking-destinos');
            let html = '';
            
            const destinos = Object.entries(data.top_destinos || {})
                .sort((a, b) => b[1].margem_percentual - a[1].margem_percentual)
                .slice(0, 10);
            
            destinos.forEach(([destino, dados], index) => {
                const rankClass = index < 3 ? 'top' : index < 7 ? 'medium' : 'bottom';
                html += `
                    <div class="ranking-item ${rankClass}">
                        <div>
                            <strong>${destino}</strong>
                            <br>
                            <small>${dados.total_entregas} entregas</small>
                        </div>
                        <div class="text-end">
                            <strong>${formatPercent(dados.margem_percentual)}</strong>
                            <br>
                            <small>${formatCurrency(dados.margem_total)}</small>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html || '<p class="text-muted">Nenhum dado disponível</p>';
        }
        
        // Análise por Placas
        async function carregarAnalisePlacas() {
            showLoading('ranking-placas', 'Calculando performance das placas...');
            
            try {
                const response = await fetch('/api/margem/placas');
                const data = await response.json();
                
                criarGraficoPlacas(data);
                atualizarRankingPlacas(data);
                
            } catch (error) {
                console.error('Erro ao carregar análise por placas:', error);
            }
        }
        
        function criarGraficoPlacas(data) {
            const ctx = document.getElementById('chartPlacas').getContext('2d');
            
            if (chartPlacas) {
                chartPlacas.destroy();
            }
            
            const placas = Object.keys(data.top_placas || {}).slice(0, 10);
            const margens = placas.map(placa => data.top_placas[placa].margem_percentual);
            
            chartPlacas = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: placas,
                    datasets: [{
                        label: 'Margem %',
                        data: margens,
                        borderColor: '#e74c3c',
                        backgroundColor: 'rgba(231, 76, 60, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Margem (%)'
                            }
                        }
                    }
                }
            });
        }
        
        function atualizarRankingPlacas(data) {
            const container = document.getElementById('ranking-placas');
            let html = '';
            
            const placas = Object.entries(data.top_placas || {})
                .sort((a, b) => b[1].margem_percentual - a[1].margem_percentual)
                .slice(0, 10);
            
            placas.forEach(([chave, dados], index) => {
                const rankClass = index < 3 ? 'top' : index < 7 ? 'medium' : 'bottom';
                html += `
                    <div class="ranking-item ${rankClass}">
                        <div>
                            <strong>${dados.placa}</strong>
                            <br>
                            <small>${dados.tipologia} • ${dados.total_viagens} viagens</small>
                        </div>
                        <div class="text-end">
                            <strong>${formatPercent(dados.margem_percentual)}</strong>
                            <br>
                            <small>${formatCurrency(dados.margem_total)}</small>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html || '<p class="text-muted">Nenhum dado disponível</p>';
        }
        
        // Carregar filtros gerais (tipologias e placas)
        async function carregarFiltrosGerais() {
            try {
                const response = await fetch('/api/margem/filtros');
                const data = await response.json();
                
                // Filtros gerais (topo da página)
                const selectTipologia = document.getElementById('filtro-geral-tipologia');
                const selectPerfil = document.getElementById('filtro-geral-perfil');
                const selectPlaca = document.getElementById('filtro-geral-placa');
                
                // Filtro específico dos Top 5
                const selectPerfilTop5 = document.getElementById('filtro-perfil-top5');
                
                if (data.tipologias && selectTipologia) {
                    selectTipologia.innerHTML = '<option value="">Todas Tipologias</option>';
                    data.tipologias.forEach(tipologia => {
                        selectTipologia.innerHTML += `<option value="${tipologia}">${tipologia}</option>`;
                    });
                }
                
                if (data.perfis && selectPerfil) {
                    selectPerfil.innerHTML = '<option value="">Todos Perfis</option>';
                    data.perfis.forEach(perfil => {
                        selectPerfil.innerHTML += `<option value="${perfil}">${perfil}</option>`;
                    });
                }
                
                if (data.perfis && selectPerfilTop5) {
                    selectPerfilTop5.innerHTML = '<option value="">Todos Perfis</option>';
                    data.perfis.forEach(perfil => {
                        selectPerfilTop5.innerHTML += `<option value="${perfil}">${perfil}</option>`;
                    });
                }
                
                if (data.placas && selectPlaca) {
                    selectPlaca.innerHTML = '<option value="">Todas Placas</option>';
                    // Limitar a 50 placas para não sobrecarregar
                    data.placas.slice(0, 50).forEach(placa => {
                        selectPlaca.innerHTML += `<option value="${placa}">${placa}</option>`;
                    });
                }
                
            } catch (error) {
                console.error('Erro ao carregar filtros:', error);
            }
        }

        // Aplicar filtros gerais (afeta cards + gráfico anual)
        function aplicarFiltrosGerais() {
            const filtros = {
                tipologia: document.getElementById('filtro-geral-tipologia').value,
                perfil: document.getElementById('filtro-geral-perfil').value,
                placa: document.getElementById('filtro-geral-placa').value,
                mes: document.getElementById('filtro-geral-mes').value,
                ano: document.getElementById('filtro-geral-ano').value
            };
            
            // Mostrar loading nos cards
            const elementos = ['receita-total', 'despesa-total', 'margem-total', 'margem-percentual',
                              'total-operacoes', 'ticket-medio', 'operacoes-lucro', 'operacoes-prejuizo'];
            elementos.forEach(id => {
                const elemento = document.getElementById(id);
                if (elemento) {
                    elemento.textContent = 'Carregando...';
                }
            });
            
            // Recarregar apenas dados gerais e gráfico anual
            carregarDadosGeraisFiltrados(filtros);
            // Os rankings são controlados pelo filtro específico dos Top 5
        }

        // Carregar dados gerais com filtros aplicados
        async function carregarDadosGeraisFiltrados(filtros) {
            try {
                const params = new URLSearchParams();
                Object.entries(filtros).forEach(([key, value]) => {
                    if (value && value !== '') {
                        params.append(key, value);
                    }
                });
                
                const response = await fetch(`/api/margem/dados-gerais?${params}`);
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                // Atualizar cards do resumo
                document.getElementById('receita-total').textContent = formatCurrency(data.resumo_financeiro.receita_total);
                document.getElementById('despesa-total').textContent = formatCurrency(data.resumo_financeiro.despesa_total);
                document.getElementById('margem-total').textContent = formatCurrency(data.resumo_financeiro.margem_total);
                document.getElementById('margem-percentual').textContent = formatPercent(data.resumo_financeiro.margem_percentual_geral);

                // Atualizar KPIs adicionais
                atualizarKPIs(data);
                
                // Recarregar gráfico anual com filtros (exceto mês)
                const filtrosGrafico = { ...filtros };
                delete filtrosGrafico.mes; // Mês não afeta o gráfico anual
                carregarEvolucaoAnualFiltrada(filtrosGrafico);
                
            } catch (error) {
                console.error('Erro ao aplicar filtros gerais:', error);
                alert('Erro ao aplicar filtros: ' + error.message);
            }
        }

        // Carregar evolução anual com filtros
        async function carregarEvolucaoAnualFiltrada(filtros) {
            try {
                const params = new URLSearchParams();
                Object.entries(filtros).forEach(([key, value]) => {
                    if (value && value !== '') {
                        params.append(key, value);
                    }
                });
                
                const response = await fetch(`/api/margem/evolucao-anual?${params}`);
                const data = await response.json();
                
                if (data.error) {
                    console.error('Erro na API:', data.error);
                    return;
                }
                
                criarGraficoEvolucaoAnual(data);
                
            } catch (error) {
                console.error('Erro ao carregar evolução anual filtrada:', error);
            }
        }

        // Aplicar filtros de análise (só afeta gráficos das tabs)
        function aplicarFiltros() {
            const filtros = {
                tipologia: document.getElementById('filtro-tipologia').value,
                destino: document.getElementById('filtro-destino').value,
                placa: document.getElementById('filtro-placa').value,
                mes: document.getElementById('filtro-mes').value,
                ano: document.getElementById('filtro-ano').value
            };
            
            // Apenas recarregar análises (não afeta cards superiores)
            carregarAnalises();
        }
        
        async function carregarDadosFiltrados(filtros) {
            try {
                const params = new URLSearchParams();
                Object.entries(filtros).forEach(([key, value]) => {
                    if (value && value !== 'all' && value !== '') {
                        params.append(key, value);
                    }
                });
                
                const response = await fetch(`/api/margem/filtrados?${params}`);
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                // Atualizar resumo com dados filtrados (verificar se elementos existem)
                const receitaEl = document.getElementById('receita-total');
                const despesaEl = document.getElementById('despesa-total');
                const margemEl = document.getElementById('margem-total');
                const percentualEl = document.getElementById('margem-percentual');
                
                if (receitaEl) receitaEl.textContent = formatCurrency(data.receita_total);
                if (despesaEl) despesaEl.textContent = formatCurrency(data.despesa_total);
                if (margemEl) margemEl.textContent = formatCurrency(data.margem_total);
                if (percentualEl) percentualEl.textContent = formatPercent(data.margem_percentual);
                
                // Recarregar análises
                carregarAnalises();
                
            } catch (error) {
                console.error('Erro ao aplicar filtros:', error);
                alert('Erro ao aplicar filtros: ' + error.message);
            }
        }
        
        // Função para atualizar KPIs adicionais
        function atualizarKPIs(data) {
            try {
                const kpis = data.kpis || {};
                
                // Atualizar elementos se existirem
                const updateElement = (id, value) => {
                    const element = document.getElementById(id);
                    if (element) element.textContent = value;
                };
                
                updateElement('total-operacoes', kpis.total_operacoes || '0');
                updateElement('ticket-medio', formatCurrency(kpis.ticket_medio || 0));
                updateElement('operacoes-lucro', kpis.operacoes_lucro || '0');
                updateElement('operacoes-prejuizo', kpis.operacoes_prejuizo || '0');
                updateElement('melhor-tipologia', kpis.melhor_tipologia || '-');
                updateElement('pior-tipologia', kpis.pior_tipologia || '-');
                
            } catch (error) {
                console.error('Erro ao atualizar KPIs:', error);
            }
        }
        
        // Função para carregar evolução anual
        async function carregarEvolucaoAnual() {
            try {
                const response = await fetch('/api/margem/evolucao-anual');
                const data = await response.json();
                
                if (data.error) {
                    console.error('Erro na API:', data.error);
                    return;
                }
                
                criarGraficoEvolucaoAnual(data);
                
            } catch (error) {
                console.error('Erro ao carregar evolução anual:', error);
            }
        }
        
        // Função para criar gráfico de evolução anual
        function criarGraficoEvolucaoAnual(data) {
            const ctx = document.getElementById('chartEvolucaoAnual').getContext('2d');
            
            if (chartEvolucaoAnual) {
                chartEvolucaoAnual.destroy();
            }
            
            const meses = data.meses || [];
            const margens = data.margens_percentuais || [];
            const receitas = data.receitas || [];
            
            chartEvolucaoAnual = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: meses,
                    datasets: [{
                        label: 'Margem %',
                        data: margens,
                        borderColor: '#3498db',
                        backgroundColor: 'rgba(52, 152, 219, 0.1)',
                        fill: true,
                        tension: 0.4,
                        yAxisID: 'y'
                    }, {
                        label: 'Receita',
                        data: receitas,
                        borderColor: '#2ecc71',
                        backgroundColor: 'rgba(46, 204, 113, 0.1)',
                        fill: false,
                        tension: 0.4,
                        yAxisID: 'y1'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            labels: {
                                color: '#ffffff'
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: {
                                color: '#ffffff'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'Margem (%)',
                                color: '#ffffff'
                            },
                            ticks: {
                                color: '#ffffff'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: 'Receita (R$)',
                                color: '#ffffff'
                            },
                            ticks: {
                                color: '#ffffff',
                                callback: function(value) {
                                    return 'R$ ' + (value / 1000).toFixed(0) + 'k';
                                }
                            },
                            grid: {
                                drawOnChartArea: false,
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        }
                    }
                }
            });
        }

        // Event listeners para tabs
        document.addEventListener('shown.bs.tab', function (event) {
            const target = event.target.getAttribute('data-bs-target');
            
            // Carregar rankings quando a tab tipologia for mostrada
            if (target === '#tipologia') {
                carregarRankings();
            }
            
            // Redimensionar gráficos quando a tab for mostrada
            setTimeout(() => {
                if (target === '#tipologia' && chartTipologia) {
                    chartTipologia.resize();
                } else if (target === '#destino' && chartDestinos) {
                    chartDestinos.resize();
                } else if (target === '#placa' && chartPlacas) {
                    chartPlacas.resize();
                }
            }, 100);
        });

        // Funções para Rankings por Tipologia
        async function carregarRankings() {
            carregarRankingMelhores();
            carregarRankingPiores();
        }

        async function carregarRankingMelhores() {
            try {
                const mes = document.getElementById('filtro-mes').value;
                const ano = document.getElementById('filtro-ano').value;
                const tipoAnalise = document.getElementById('tipo-analise')?.value || 'tipologia';
                const perfilTop5 = document.getElementById('filtro-perfil-top5')?.value || '';
                
                const params = new URLSearchParams();
                if (mes && mes !== 'todos') params.append('mes', mes);
                if (ano && ano !== 'todos') params.append('ano', ano);
                if (perfilTop5) params.append('perfil_filter', perfilTop5);
                params.append('tipo', tipoAnalise);
                
                const response = await fetch(`/api/margem/ranking-melhores?${params}`);
                const data = await response.json();
                
                renderizarRanking(data, 'ranking-melhores', 'top');
                
            } catch (error) {
                console.error('Erro ao carregar ranking melhores:', error);
                document.getElementById('ranking-melhores').innerHTML = 
                    '<p class="text-muted text-center">Erro ao carregar dados</p>';
            }
        }

        async function carregarRankingPiores() {
            try {
                const mes = document.getElementById('filtro-mes').value;
                const ano = document.getElementById('filtro-ano').value;
                const tipoAnalise = document.getElementById('tipo-analise')?.value || 'tipologia';
                const perfilTop5 = document.getElementById('filtro-perfil-top5')?.value || '';
                
                const params = new URLSearchParams();
                if (mes && mes !== 'todos') params.append('mes', mes);
                if (ano && ano !== 'todos') params.append('ano', ano);
                if (perfilTop5) params.append('perfil_filter', perfilTop5);
                params.append('tipo', tipoAnalise);
                
                const response = await fetch(`/api/margem/ranking-piores?${params}`);
                const data = await response.json();
                
                renderizarRanking(data, 'ranking-piores', 'bottom');
                
            } catch (error) {
                console.error('Erro ao carregar ranking piores:', error);
                document.getElementById('ranking-piores').innerHTML = 
                    '<p class="text-muted text-center">Erro ao carregar dados</p>';
            }
        }

        function renderizarRanking(data, containerId, tipo) {
            const container = document.getElementById(containerId);
            let html = '';
            
            if (!data || !data.length) {
                html = `
                    <div class="ranking-empty">
                        <i class="fas fa-inbox"></i>
                        <h6>Nenhum dado disponível</h6>
                        <p class="small">Tente ajustar os filtros ou verificar os dados.</p>
                    </div>
                `;
            } else {
                // Garantir exatamente 5 posições
                const rankingData = [...data];
                while (rankingData.length < 5) {
                    rankingData.push({
                        nome: `-- Posição ${rankingData.length + 1} --`,
                        percentual: '0.0%',
                        margem: 'R$ 0,00',
                        receita: 'R$ 0,00',
                        tipologia: '-'
                    });
                }
                
                rankingData.slice(0, 5).forEach((item, index) => {
                    const posicao = index + 1;
                    const percentual = parseFloat(item.percentual?.replace('%', '') || 0);
                    const percentualClass = percentual >= 0 ? 'positive' : 'negative';
                    const isEmptyRow = item.nome?.includes('-- Posição');
                    
                    // Determinar subtítulo baseado no valor e tipologia
                    let subtitle = '';
                    if (isEmptyRow) {
                        subtitle = 'Sem dados suficientes';
                    } else {
                        // Extrair tipologia e placa do nome (formato: "TRUCK - Placa ABC1234")
                        const partesNome = item.nome.split(' - ');
                        if (partesNome.length >= 2) {
                            const tipologia = partesNome[0];
                            const placaInfo = partesNome[1];
                            
                            if (percentual > 40) subtitle = `${tipologia} • ${placaInfo} • Excelente rentabilidade`;
                            else if (percentual > 20) subtitle = `${tipologia} • ${placaInfo} • Boa rentabilidade`;
                            else if (percentual > 0) subtitle = `${tipologia} • ${placaInfo} • Rentabilidade positiva`;
                            else subtitle = `${tipologia} • ${placaInfo} • Necessita atenção`;
                        } else {
                            // Fallback para formato antigo
                            if (percentual > 40) subtitle = 'Excelente rentabilidade';
                            else if (percentual > 20) subtitle = 'Boa rentabilidade';
                            else if (percentual > 0) subtitle = 'Rentabilidade positiva';
                            else subtitle = 'Necessita atenção';
                        }
                    }
                    
                    // Ícones de medalha apenas para os melhores (tipo 'top')
                    let medalIcon = '';
                    if (!isEmptyRow && tipo === 'top') {
                        if (posicao === 1) medalIcon = '<i class="fas fa-medal text-warning me-2"></i>';
                        else if (posicao === 2) medalIcon = '<i class="fas fa-medal text-secondary me-2"></i>';
                        else if (posicao === 3) medalIcon = '<i class="fas fa-medal text-warning me-2" style="opacity: 0.7;"></i>';
                    }
                    
                    // Para os piores, usar ícones de alerta
                    if (!isEmptyRow && tipo === 'bottom') {
                        if (posicao === 1) medalIcon = '<i class="fas fa-exclamation-triangle text-danger me-2"></i>';
                        else if (posicao === 2) medalIcon = '<i class="fas fa-exclamation-circle text-warning me-2"></i>';
                        else if (posicao === 3) medalIcon = '<i class="fas fa-info-circle text-info me-2"></i>';
                    }
                    
                    const opacityClass = isEmptyRow ? 'opacity-50' : '';
                    
                    html += `
                        <div class="ranking-item ${tipo} ${opacityClass}" ${isEmptyRow ? 'style="background: #f8f9fa; border-style: dashed;"' : ''}>
                            <div class="ranking-position">${medalIcon}${posicao}º</div>
                            <div class="ranking-info">
                                <div class="ranking-name" ${isEmptyRow ? 'style="color: #adb5bd; font-style: italic;"' : ''}>${item.nome || 'N/A'}</div>
                                <div class="ranking-subtitle" ${isEmptyRow ? 'style="color: #adb5bd;"' : ''}>${subtitle}</div>
                            </div>
                            <div class="ranking-values">
                                <div class="ranking-percentage ${percentualClass}" ${isEmptyRow ? 'style="color: #adb5bd;"' : ''}>
                                    ${item.percentual || '0.0%'}
                                </div>
                                <div class="ranking-margin" ${isEmptyRow ? 'style="color: #adb5bd;"' : ''}>${item.margem || 'R$ 0,00'}</div>
                            </div>
                        </div>
                    `;
                });
            }
            
            container.innerHTML = html;
        }

    </script>
</div>
{% endblock %}