{% extends "base.html" %}

{% block content %}
<div class="board-header fade-in-up">
    <h1>üì¶ Importa√ß√£o de Dados - Frete</h1>
    <div class="subtitle">Gerencie uploads de arquivos para o m√≥dulo de frete</div>
</div>

<div class="import-cards">
    <!-- Importa√ß√£o MANIFESTO -->
    <div class="card fade-in-up" style="border-left: 4px solid #10b981;">
        <h2 style="margin-bottom:12px; color: #065f46;">ÔøΩ Importar Arquivos de MANIFESTO</h2>
        <form method="POST" enctype="multipart/form-data">
            <input type="hidden" name="tipo_arquivo" value="manifesto">
            <div class="drop-zone" id="dropZoneManifesto">
                <div style="text-align:center; padding:18px;">
                    <strong id="dropTextManifesto">Arraste e solte os arquivos de MANIFESTO aqui ou clique para selecionar</strong>
                    <div style="font-size:12px; color:#6b7280; margin-top:6px">Suporta CSV e XLSX com dados de manifesto</div>
                </div>
                <input type="file" name="files" id="fileInputManifesto" multiple hidden>
            </div>

            <div style="margin-top:12px; display:flex; gap:10px; align-items:center;">
                <button type="submit" class="btn btn-primary" style="background: #059669;">üì§ Enviar Manifesto</button>
                <button type="button" id="btnClearInputManifesto" class="btn btn-secondary">Limpar sele√ß√£o</button>
            </div>
        </form>
    </div>

    <!-- Importa√ß√£o VALENCIO -->
    <div class="card fade-in-up" style="border-left: 4px solid #f59e0b;">
        <h2 style="margin-bottom:12px; color: #92400e;">‚ö° Importar Arquivos de VALENCIO</h2>
        <form method="POST" enctype="multipart/form-data">
            <input type="hidden" name="tipo_arquivo" value="valencio">
            <div class="drop-zone" id="dropZoneValencio">
                <div style="text-align:center; padding:18px;">
                    <strong id="dropTextValencio">Arraste e solte os arquivos de VALENCIO aqui ou clique para selecionar</strong>
                    <div style="font-size:12px; color:#6b7280; margin-top:6px">Suporta CSV e XLSX com dados de valencio</div>
                </div>
                <input type="file" name="files" id="fileInputValencio" multiple hidden>
            </div>

            <div style="margin-top:12px; display:flex; gap:10px; align-items:center;">
                <button type="submit" class="btn btn-primary" style="background: #d97706;">üì§ Enviar Valencio</button>
                <button type="button" id="btnClearInputValencio" class="btn btn-secondary">Limpar sele√ß√£o</button>
            </div>
        </form>
    </div>

    <!-- Mensagens Flash -->
    <div class="card fade-in-up">
        {% with messages = get_flashed_messages(with_categories=true) %}
          {% if messages %}
            <ul class="messages">
              {% for category, message in messages %}
                <li class="{{ category }}">{{ message }}</li>
              {% endfor %}
            </ul>
          {% endif %}
        {% endwith %}
    </div>

    <div class="card fade-in-up">
        <h3 style="margin-top:0;">üìã Hist√≥rico de uploads - Frete</h3>
        {% if uploads and uploads|length > 0 %}
        <div class="uploads-table-wrapper">
            <table class="uploads-table">
                <thead>
                    <tr>
                        <th>Data</th>
                        <th>Arquivo</th>
                        <th>Tamanho (KB)</th>
                        <th>A√ß√£o</th>
                    </tr>
                </thead>
                <tbody>
                    {% for f in uploads %}
                    <tr>
                        <td>{{ f.mtime }}</td>
                        <td>
                            {% set display = f.display_name if f.display_name is defined else f.name %}
                            <div class="file-name" title="{{ f.name }}">{{ display }}</div>
                        </td>
                        <td style="text-align:right">{{ (f.size / 1024) | round(1) }}</td>
                        <td><a href="{{ url_for('frete.uploaded_file', filename=f.name) }}" target="_blank">Baixar</a></td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
            <div style="color:#64748b; margin-top:8px;">Nenhum arquivo encontrado na pasta de uploads do frete.</div>
        {% endif %}
    </div>

    <!-- Card para arquivos acumulados de Manifesto -->
    <div class="card fade-in-up" style="border-left: 4px solid #10b981;">
        <h3 style="margin-top:0; color: #065f46;">üìä Arquivos Acumulados - Manifestos</h3>
        {% if accumulated and accumulated|length > 0 %}
        <div class="uploads-table-wrapper">
            <table class="uploads-table">
                <thead>
                    <tr>
                        <th>Data</th>
                        <th>Arquivo</th>
                        <th>Tamanho (KB)</th>
                        <th>A√ß√£o</th>
                    </tr>
                </thead>
                <tbody>
                    {% for f in accumulated %}
                    <tr>
                        <td>{{ f.mtime }}</td>
                        <td>
                            <div class="file-name" title="{{ f.name }}">{{ f.name }}</div>
                        </td>
                        <td style="text-align:right">{{ (f.size / 1024) | round(1) }}</td>
                        <td><a href="{{ url_for('frete.accumulated_file', filename=f.name) }}" target="_blank">Baixar</a></td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
            <div style="color:#64748b; margin-top:8px;">Nenhum arquivo acumulado encontrado.</div>
        {% endif %}
    </div>

    <!-- Card informativo sobre o formato esperado -->
    <div class="card fade-in-up" style="background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); border-left: 4px solid #0ea5e9;">
        <h3 style="margin-top:0; color: #0c4a6e;">üìù Informa√ß√µes sobre Importa√ß√£o</h3>
        <div style="color: #164e63; line-height: 1.6;">
            <p><strong>Agora com dois tipos de importa√ß√£o separados:</strong></p>
            <ul style="margin: 8px 0; padding-left: 20px;">
                <li><span style="color: #059669;"><strong>MANIFESTO:</strong></span> Dados de manifesto que s√£o acumulados em um arquivo consolidado</li>
                <li><span style="color: #d97706;"><strong>VALENCIO:</strong></span> Dados de valencio que s√£o processados com c√°lculos espec√≠ficos</li>
            </ul>
            <p><strong>Formatos aceitos:</strong> CSV e XLSX</p>
            <p style="margin-top: 12px;"><em>üí° Selecione o tipo correto antes de fazer upload para garantir o processamento adequado.</em></p>
        </div>
    </div>
</div>

<script>
    // Fun√ß√£o para configurar drag&drop para uma se√ß√£o
    function setupDropZone(dropZoneId, fileInputId, dropTextId, clearButtonId, defaultText) {
        const dropZone = document.getElementById(dropZoneId);
        const fileInput = document.getElementById(fileInputId);
        const dropText = document.getElementById(dropTextId);

        dropZone.addEventListener("click", () => fileInput.click());

        dropZone.addEventListener("dragover", (e) => {
            e.preventDefault();
            dropZone.classList.add("dragover");
            dropText.textContent = "Solte os arquivos aqui";
        });

        dropZone.addEventListener("dragleave", () => {
            dropZone.classList.remove("dragover");
            dropText.textContent = defaultText;
        });

        dropZone.addEventListener("drop", (e) => {
            e.preventDefault();
            fileInput.files = e.dataTransfer.files;
            dropZone.classList.remove("dragover");
            dropText.textContent = fileInput.files.length + " arquivo(s) selecionado(s)";
        });

        fileInput.addEventListener("change", () => {
            dropText.textContent = fileInput.files.length + " arquivo(s) selecionado(s)";
        });

        document.getElementById(clearButtonId).addEventListener('click', function(){
            fileInput.value = null;
            dropText.textContent = defaultText;
        });
    }

    // Configurar as duas zonas de drop
    setupDropZone(
        "dropZoneManifesto", 
        "fileInputManifesto", 
        "dropTextManifesto", 
        "btnClearInputManifesto",
        "Arraste e solte os arquivos de MANIFESTO aqui ou clique para selecionar"
    );

    setupDropZone(
        "dropZoneValencio", 
        "fileInputValencio", 
        "dropTextValencio", 
        "btnClearInputValencio",
        "Arraste e solte os arquivos de VALENCIO aqui ou clique para selecionar"
    );
</script>
{% endblock %}