{% extends "base.html" %}
{% block content %}
<div class="dashboard-header fade-in-up">
    <h1>üìå Painel</h1>
    <div class="subtitle">Vis√£o geral r√°pida dos principais indicadores</div>
</div>

<!-- Filtro obrigat√≥rio: sempre selecionar um m√™s para visualizar os cards -->
<div style="max-width:1180px; margin: 8px auto 18px; display:flex; align-items:center; gap:12px;">
    <div style="display:flex; gap:12px; align-items:center;">
        <div style="font-size:13px; color:#334155;">Filtrar M√™s</div>
        <select id="panelMonth" class="form-input" style="padding:8px; border-radius:8px;">
            <option value="01">Janeiro</option>
            <option value="02">Fevereiro</option>
            <option value="03">Mar√ßo</option>
            <option value="04">Abril</option>
            <option value="05">Maio</option>
            <option value="06">Junho</option>
            <option value="07">Julho</option>
            <option value="08">Agosto</option>
            <option value="09">Setembro</option>
            <option value="10">Outubro</option>
            <option value="11">Novembro</option>
            <option value="12">Dezembro</option>
        </select>
        <select id="panelYear" class="form-input" style="padding:8px; border-radius:8px;">
            {% for y in range(2022, 2031) %}
                <option value="{{ y }}">{{ y }}</option>
            {% endfor %}
        </select>
        <button id="btnApplyPanel" class="btn btn-primary">Aplicar</button>
        <div style="color:#64748b; font-size:13px; margin-left:8px;">(Sele√ß√£o obrigat√≥ria)</div>
    </div>
</div>

<!-- Reaproveita a mesma estrutura do planejamento para come√ßar -->

<!-- Cards de Estat√≠sticas -->
<div class="stats-grid fade-in-up">
    <div class="stat-card">
        <div id="stat_total_receber" class="stat-number">R$ {{ data.total_receber or "0,00" }}</div>
        <div class="stat-label">Total a Receber</div>
    </div>
    <div class="stat-card">
        <div id="stat_total_pagar" class="stat-number">R$ {{ data.total_pagar or "0,00" }}</div>
        <div class="stat-label">Total a Pagar</div>
    </div>
    <div class="stat-card">
        <div id="stat_saldo_projetado" class="stat-number">R$ {{ data.saldo_projetado or "0,00" }}</div>
        <div class="stat-label">Saldo Projetado</div>
    </div>
    <div class="stat-card">
        <div id="stat_total_lancamentos" class="stat-number">{{ data.total_lancamentos or 0 }}</div>
        <div class="stat-label">Lan√ßamentos</div>
    </div>
</div>

<!-- Cards Principais (mesma estrutura que o planejamento) -->
<div class="cards-container fade-in-up">
    <div class="card card-primary">
        <div class="card-header">
            <div class="card-title">Resumo do M√™s</div>
            <div class="card-icon">üìä</div>
        </div>
    <div id="card_saldo_projetado" class="card-value">R$ {{ data.saldo_projetado or "0,00" }}</div>
        <div class="card-subtitle">Saldo projetado atual</div>
        <div class="card-progress">
                <div class="card-progress-bar" data-width="{{ data.get('percent_saldo', 25) }}"></div>
        </div>
    </div>

    <div class="card card-success">
        <div class="card-header">
            <div class="card-title">Contas a Receber</div>
            <div class="card-icon">üí∞</div>
        </div>
    <div id="card_total_receber" class="card-value">R$ {{ data.recebido_receber or "0,00" }}</div>
        <div id="card_receber_sub" class="card-subtitle">Proje√ß√£o: R$ {{ data.projecao_receber or "0,00" }}</div>
        <div class="card-progress" title="Proje√ß√£o: R$ {{ data.projecao_receber or '0,00' }} ({{ data.get('projecao_receber_count',0) }} lan√ß.)\nRecebido: R$ {{ data.recebido_receber or '0,00' }} ({{ data.get('recebido_receber_count',0) }} lan√ß.)">
            <div id="card_receber_bar" class="card-progress-bar" data-width="{{ data.get('percent_receber', 0) }}"></div>
            <div id="card_receber_badge" class="card-progress-badge">{{ data.get('percent_receber_text','--') }}</div>
        </div>
    </div>

    <div class="card card-warning">
        <div class="card-header">
            <div class="card-title">Contas a Pagar</div>
            <div class="card-icon">üí∏</div>
        </div>
    <div id="card_total_pagar" class="card-value">R$ {{ data.total_pagar or "0,00" }}</div>
        <div class="card-subtitle">Obriga√ß√µes pendentes</div>
        <div class="card-progress">
            <div class="card-progress-bar" style="width: 85%"></div>
        </div>
    </div>

    <div class="card card-danger">
        <div class="card-header">
            <div class="card-title">Alertas</div>
            <div class="card-icon">‚ö†Ô∏è</div>
        </div>
    <div id="card_alertas" class="card-value">{{ data.alertas or 0 }}</div>
        <div class="card-subtitle">Vencimentos pr√≥ximos</div>
        <div class="card-progress">
                <div class="card-progress-bar" data-width="{{ data.get('percent_alertas', 25) }}"></div>
        </div>
    </div>
</div>

<!-- Tabela Din√¢mica (reaproveitada) -->
<div class="table-container slide-in-left">
    <div class="table-header">
        <div class="table-title">üìã Lan√ßamentos Financeiros</div>
        <div class="table-controls">
            <input type="text" class="search-box" placeholder="Buscar lan√ßamentos..." id="searchInput">
            <select class="filter-select" id="statusFilter">
                <option value="">Todos os Status</option>
                <option value="pending">Pendente</option>
                <option value="paid">Pago</option>
                <option value="overdue">Vencido</option>
            </select>
            <select class="filter-select" id="monthFilter">
                <option value="">Todos os Meses</option>
                <option value="01">Janeiro</option>
                <option value="02">Fevereiro</option>
                <option value="03">Mar√ßo</option>
                <option value="04">Abril</option>
                <option value="05">Maio</option>
                <option value="06">Junho</option>
                <option value="07">Julho</option>
                <option value="08">Agosto</option>
                <option value="09">Setembro</option>
                <option value="10">Outubro</option>
                <option value="11">Novembro</option>
                <option value="12">Dezembro</option>
            </select>
        </div>
    </div>
    <table class="dynamic-table" id="financialTable">
        <thead>
            <tr>
                <th class="sortable" data-column="cliente">Cliente/Fornecedor</th>
                <th class="sortable" data-column="valor">Valor</th>
                <th class="sortable" data-column="vencimento">Vencimento</th>
                <th class="sortable" data-column="status">Status</th>
                <th>A√ß√µes</th>
            </tr>
        </thead>
        <tbody id="tableBody">
            {% if data.lancamentos %}
                {% for lancamento in data.lancamentos %}
                <tr>
                    <td>{{ lancamento[0] or 'N/A' }}</td>
                    <td>R$ {{ "%.2f"|format(lancamento[1] or 0)|replace(".", ",") }}</td>
                    <td>{{ lancamento[2] or 'N/A' }}</td>
                    <td>
                        {% if lancamento[3] == 'Pendente' %}
                            <span class="status-badge pending">Pendente</span>
                        {% elif lancamento[3] == 'Pago' %}
                            <span class="status-badge paid">Pago</span>
                        {% else %}
                            <span class="status-badge overdue">{{ lancamento[3] or 'N/A' }}</span>
                        {% endif %}
                    </td>
                    <td>
                        <button class="btn btn-primary btn-sm">Editar</button>
                        <button class="btn btn-secondary btn-sm">Detalhes</button>
                    </td>
                </tr>
                {% endfor %}
            {% else %}
                <tr>
                    <td colspan="5" style="text-align: center; padding: 40px; color: #64748b;">
                        üìä Nenhum lan√ßamento encontrado. Importe seus dados financeiros na se√ß√£o de Importa√ß√£o.
                    </td>
                </tr>
            {% endif %}
        </tbody>
    </table>
</div>

<script>
// Reaplicar scripts do planejamento para busca/ordenacao
document.addEventListener('DOMContentLoaded', function() {
    // ensure panel filter defaults to month 8 (agosto) conforme solicitado
    const now = new Date();
    const defaultMonth = '08'; // MUDAN√áA: usar agosto como padr√£o
    const defaultYear = String(now.getFullYear());
    const panelMonth = document.getElementById('panelMonth');
    const panelYear = document.getElementById('panelYear');
    if (panelMonth) panelMonth.value = defaultMonth;
    if (panelYear) panelYear.value = defaultYear;

    async function applyPanelFilter() {
        const selMonth = panelMonth ? panelMonth.value : '';
        const selYear = panelYear ? panelYear.value : defaultYear;
        if (!selMonth) {
            alert('Selecione um m√™s para filtrar.');
            return;
        }
        // call backend (month required)
        const url = `/api/painel?month=${encodeURIComponent(selMonth)}&year=${encodeURIComponent(selYear)}`;
        try {
            const res = await fetch(url);
            if (!res.ok) {
                const err = await res.json().catch(()=>({message:'erro'}));
                console.error('API painel error', err);
                alert('Erro ao buscar dados filtrados: ' + (err.message || res.statusText));
                return;
            }
            const body = await res.json();
            if (body.status !== 'success') {
                alert('Erro ao buscar dados do painel');
                return;
            }
            const d = body.data;
            // update stat numbers
            const fmt = v => 'R$ ' + Number(v||0).toFixed(2).replace('.', ',');
            const set = (id, val) => { const el = document.getElementById(id); if (el) el.textContent = val; };
                    // aplica larguras das barras definidas como data-width
                    function applyDataWidths() {
                        document.querySelectorAll('.card-progress-bar[data-width]').forEach(el => {
                            const w = Number(el.dataset.width) || 0;
                            el.style.width = Math.min(100, w) + '%';
                        });
                    }
            set('stat_total_receber', fmt(d.total_receber));
            set('stat_total_pagar', fmt(d.total_pagar));
            set('stat_saldo_projetado', fmt(d.saldo_projetado));
            set('stat_total_lancamentos', d.total_lancamentos);
            
            // Para card de Contas a Receber: mostrar REALIZADO como valor principal
            const proj = Number(d.projecao_receber || 0);
            const recv = Number(d.recebido_receber || 0);
            set('card_total_receber', fmt(recv)); // MUDAN√áA: mostra recebido como valor principal
            set('card_total_pagar', fmt(d.total_pagar));
            set('card_saldo_projetado', fmt(d.saldo_projetado));
            set('card_alertas', d.alertas);
            
            // Atualizar subt√≠tulo: apenas proje√ß√£o
            const cardSub = document.getElementById('card_receber_sub');
            if (cardSub) {
                cardSub.textContent = `Proje√ß√£o: ${fmt(proj)}`; // MUDAN√áA: s√≥ mostra proje√ß√£o
            }
            const projCount = Number(d.projecao_receber_count || 0);
            const recvCount = Number(d.recebido_receber_count || 0);
            const recBar = document.getElementById('card_receber_bar');
            const recBadge = document.getElementById('card_receber_badge');
            if (recBar) {
                let pct = 0;
                if (proj > 0) pct = Math.round((recv / proj) * 100);
                pct = Math.max(0, Math.min(999, pct));
                // largura visual limitada a 100% (se houve excesso, mostramos 100% e prefix '+' no badge)
                recBar.style.width = `${Math.min(100, Math.max(6, pct))}%`;
                if (recBadge) {
                    if (proj <= 0) {
                        recBadge.textContent = proj === 0 && recv === 0 ? '--' : (recv > 0 ? '+ ' + recv.toFixed(0) : '--');
                    } else {
                        recBadge.textContent = (pct > 100 ? '+' + pct : pct) + '%';
                    }
                }
                // set tooltip with counts
                const recContainer = recBar.parentElement;
                if (recContainer) {
                    recContainer.title = `Proje√ß√£o: R$ ${proj.toFixed(2).replace('.', ',')} (${projCount} lan√ß.)\nRecebido: R$ ${recv.toFixed(2).replace('.', ',')} (${recvCount} lan√ß.)`;
                }
            }
            // alerts: keep previous heuristic
            const alertBar = document.querySelector('.card-danger .card-progress-bar');
            if (alertBar) alertBar.style.width = `${Math.min(90, 10 + (d.alertas || 0) * 4)}%`;

            // filter table rows client-side by selected month
            const monthFilterSelect = document.getElementById('monthFilter');
            if (monthFilterSelect) monthFilterSelect.value = selMonth;
            // trigger the existing change handler on monthFilter if any
            if (monthFilterSelect && typeof monthFilterSelect.onchange === 'function') monthFilterSelect.onchange();

        } catch (e) {
            console.error('Erro applyPanelFilter', e);
            alert('Erro ao buscar dados do painel');
        }
    }

    const btnApplyPanel = document.getElementById('btnApplyPanel');
    if (btnApplyPanel) btnApplyPanel.addEventListener('click', applyPanelFilter);

    const searchInput = document.getElementById('searchInput');
    const table = document.getElementById('financialTable');
    const rows = table.getElementsByTagName('tbody')[0].getElementsByTagName('tr');

    searchInput.addEventListener('keyup', function() {
        const filter = this.value.toLowerCase();
        for (let i = 0; i < rows.length; i++) {
            const row = rows[i];
            const text = row.textContent.toLowerCase();
            if (text.includes(filter)) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        }
    });

    const sortableHeaders = document.querySelectorAll('th.sortable');
    let sortDirection = 1;

    sortableHeaders.forEach(header => {
        header.addEventListener('click', function() {
            const column = this.dataset.column;
            sortTable(column);
            sortableHeaders.forEach(h => h.classList.remove('sort-asc', 'sort-desc'));
            this.classList.add(sortDirection === 1 ? 'sort-asc' : 'sort-desc');
            sortDirection *= -1;
        });
    });

    function sortTable(column) {
        const tbody = table.getElementsByTagName('tbody')[0];
        const rowsArray = Array.from(tbody.getElementsByTagName('tr'));
        rowsArray.sort((a, b) => {
            let aValue, bValue;
            switch(column) {
                case 'cliente':
                    aValue = a.cells[0].textContent;
                    bValue = b.cells[0].textContent;
                    break;
                case 'valor':
                    aValue = parseFloat(a.cells[1].textContent.replace(/[^\d,]/g, '').replace(',', '.'));
                    bValue = parseFloat(b.cells[1].textContent.replace(/[^\d,]/g, '').replace(',', '.'));
                    break;
                case 'vencimento':
                    aValue = new Date(a.cells[2].textContent.split('/').reverse().join('-'));
                    bValue = new Date(b.cells[2].textContent.split('/').reverse().join('-'));
                    break;
                case 'status':
                    aValue = a.cells[3].textContent;
                    bValue = b.cells[3].textContent;
                    break;
            }
            if (aValue < bValue) return -sortDirection;
            if (aValue > bValue) return sortDirection;
            return 0;
        });
        rowsArray.forEach(row => tbody.appendChild(row));
    }

    const statusFilter = document.getElementById('statusFilter');
    statusFilter.addEventListener('change', function() {
        const filterValue = this.value;
        for (let i = 0; i < rows.length; i++) {
            const row = rows[i];
            const statusBadge = row.querySelector('.status-badge');
            if (!filterValue || statusBadge.classList.contains(filterValue)) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        }
    });

    // Filtra por m√™s (client-side) lendo a coluna de vencimento (formato dd/mm/yyyy ou yyyy-mm-dd)
    const monthFilter = document.getElementById('monthFilter');
    if (monthFilter) {
        monthFilter.addEventListener('change', function() {
            const sel = this.value; // '01'..'12' or ''
            for (let i = 0; i < rows.length; i++) {
                const row = rows[i];
                const vencimentoCell = row.cells[2];
                if (!vencimentoCell) continue;
                const txt = vencimentoCell.textContent.trim();
                let month = '';
                if (txt.includes('/')) { // dd/mm/yyyy
                    const parts = txt.split('/');
                    if (parts.length >= 2) month = parts[1].padStart(2,'0');
                } else if (txt.includes('-')) { // yyyy-mm-dd
                    const parts = txt.split('-');
                    if (parts.length >= 2) month = parts[1].padStart(2,'0');
                }
                if (!sel || sel === month) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            }
        });
    }

    const cards = document.querySelectorAll('.card, .stat-card');
    cards.forEach((card, index) => {
        setTimeout(() => {
            card.style.opacity = '1';
            card.style.transform = 'translateY(0)';
        }, index * 100);
    });
});
</script>

<style>
.card, .stat-card {
    opacity: 0;
    transform: translateY(20px);
    transition: all 0.6s ease-out;
}

.btn-sm {
    padding: 6px 12px;
    font-size: 12px;
    margin-right: 5px;
}

.card-progress {
    position: relative;
}

.card-progress-badge {
    position: absolute;
    right: 4px;
    top: 50%;
    transform: translateY(-50%);
    background: rgba(255, 255, 255, 0.9);
    color: #334155;
    font-size: 11px;
    font-weight: 600;
    padding: 2px 6px;
    border-radius: 4px;
    border: 1px solid rgba(0, 0, 0, 0.1);
}
</style>

<script>
// set widths from data-width attributes to avoid Jinja inside CSS
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('[data-width]').forEach(el => {
        const w = el.getAttribute('data-width');
        if (w !== null) el.style.width = w + '%';
    });
});
</script>

{% endblock %}
