<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>{% block title %}Financeiro{% endblock %}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}?v=4">
</head>
<body>
    <div class="sidebar" id="sidebar">
        <button id="sidebarClose" class="sidebar-close" aria-label="Fechar menu">‹</button>
        <h2 class="sidebar-title">Menu</h2>
        
        <!-- Seção do usuário (DESATIVADA) -->
        <div class="user-info">
            <div class="user-name">👤 Administrador</div>
            <a href="#" class="logout-btn" title="Sair" style="display: none;">🚪 Sair</a>
        </div>
        
        <ul>
            <li><a href="/planejamento">Painel</a></li>
            <li><a href="/projecao">Projeção</a></li>
            <li><a href="/dashboard">Dashboard</a></li>
            <li><a href="/resumo">Resumo</a></li>
            <li><a href="/consolidacao">Consolidação</a></li>
            <li><a href="/importacao">📂 Importação</a></li>
            <li><a href="/frz_log">🚛 FRZ Log</a></li>
            <li><a href="/logistica/monitoramento">�️ Monitoramento</a></li>
            <li><a href="/painel_frete">🚚 Painel Frete</a></li>
            <li><a href="/margem_analise">📊 Análise Margem</a></li>
            <li><a href="/manifesto">📋 Manifesto</a></li>
            <li><a href="/custo_frota">🧮 Custo Frota</a></li>
            <li><a href="/suporte">🚗 Suporte Veículos</a></li>
            <!-- NOVO ITEM: Gestão de Usuários (apenas para admin) -->
            {% if session.user_name == 'Administrador' %}
                <li><a href="/admin/usuarios" class="menu-admin">🛠️ Gestão de Usuários</a></li>
            {% endif %}
        </ul>
            </ul>
        </nav>
    </div>

    <!-- botão fixo para abrir quando o menu estiver fechado -->
    <button id="sidebarOpen" class="sidebar-open" aria-label="Abrir menu">›</button>

    <div class="content">
        {# Mensagens flash globais (sucessos/erros) #}
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <div class="container py-2">
                    {% for category, message in messages %}
                        {% set css = 'info' %}
                        {% if category == 'success' %}{% set css = 'success' %}{% elif category == 'error' %}{% set css = 'danger' %}{% endif %}
                        <div class="alert alert-{{ css }}" role="alert">{{ message }}</div>
                    {% endfor %}
                </div>
            {% endif %}
        {% endwith %}

        {% block content %}{% endblock %}
    </div>
    <script>
        // Simple sidebar toggle: adiciona/removes a classe 'collapsed'
        (function(){
            const btnClose = document.getElementById('sidebarClose');
            const btnOpen = document.getElementById('sidebarOpen');
            const sidebar = document.getElementById('sidebar');
            const STORAGE_KEY = 'frz_sidebar_collapsed';
            if(!sidebar) return;

            // helper to hide/show controls
            function setClosed(){
                sidebar.classList.add('collapsed');
                if(btnClose) btnClose.style.display = 'none';
                if(btnOpen) btnOpen.style.display = 'block';
                try { localStorage.setItem(STORAGE_KEY, '1'); } catch(e){}
            }
            function setOpen(){
                sidebar.classList.remove('collapsed');
                if(btnClose) btnClose.style.display = 'block';
                if(btnOpen) btnOpen.style.display = 'none';
                try { localStorage.setItem(STORAGE_KEY, '0'); } catch(e){}
            }

            // wire up buttons
            if(btnClose){
                btnClose.addEventListener('click', function(e){
                    setClosed();
                    e.stopPropagation();
                });
            }
            if(btnOpen){
                btnOpen.addEventListener('click', function(e){
                    setOpen();
                    e.stopPropagation();
                });
            }

            // initialize based on current class
            // If user previously set a preference, restore it
            try {
                const stored = localStorage.getItem(STORAGE_KEY);
                if (stored === '1') {
                    setClosed();
                } else if (stored === '0') {
                    setOpen();
                } else {
                    // no stored preference — keep default from class
                    if(sidebar.classList.contains('collapsed')){
                        if(btnClose) btnClose.style.display = 'none';
                        if(btnOpen) btnOpen.style.display = 'block';
                    } else {
                        if(btnClose) btnClose.style.display = 'block';
                        if(btnOpen) btnOpen.style.display = 'none';
                    }
                }
            } catch(e) {
                // localStorage may be unavailable (privacy mode); fallback to default
                if(sidebar.classList.contains('collapsed')){
                    if(btnClose) btnClose.style.display = 'none';
                    if(btnOpen) btnOpen.style.display = 'block';
                } else {
                    if(btnClose) btnClose.style.display = 'block';
                    if(btnOpen) btnOpen.style.display = 'none';
                }
            }
        })();
        // Menu pai/filho: alterna submenus ao clicar no item pai
        (function(){
            const parents = document.querySelectorAll('.menu-parent');
            parents.forEach(p => {
                p.addEventListener('click', function(){
                    const item = this.parentElement;
                    
                    // Se o menu já está expandido, apenas feche
                    if (item.classList.contains('expanded')) {
                        item.classList.remove('expanded');
                        return;
                    }
                    
                    // Fechar todos os outros menus primeiro
                    const allMenuItems = document.querySelectorAll('.menu-item');
                    allMenuItems.forEach(menuItem => {
                        menuItem.classList.remove('expanded');
                    });
                    
                    // Abrir apenas o menu clicado
                    item.classList.add('expanded');
                });
            });
            
            // Manter submenu aberto se estamos em uma de suas páginas filhas
            const currentPath = window.location.pathname;
            
            // Mapear caminhos para seus menus pais
            const menuMappings = {
                'Financeiro': ['/planejamento', '/projecao', '/dashboard', '/resumo', '/consolidacao', '/importacao'],
                // Também considerar a rota /upload como pertencente ao menu Frete
                'Frete': ['/frete', '/upload'],
                'Armazem': ['/armazem'], 
                'Logistica': ['/logistica', '/logistica/monitoramento']
            };
            
            // Verificar qual menu deve estar expandido baseado na URL atual
            Object.keys(menuMappings).forEach(menuName => {
                const paths = menuMappings[menuName];
                const isCurrentMenu = paths.some(path => currentPath.startsWith(path));
                
                if (isCurrentMenu) {
                    // Encontrar o menu pai correspondente e expandir
                    const menuParents = document.querySelectorAll('.menu-parent');
                    menuParents.forEach(parent => {
                        if (parent.textContent.trim() === menuName) {
                            parent.parentElement.classList.add('expanded');
                        }
                    });
                }
            });
        })();
    </script>
    
    {% block scripts %}{% endblock %}
</body>
</html>
