{% extends "base.html" %}

{% block content %}

<style>
    :root{
        --matrix-height: calc(100vh - 180px);
        /* diminuir linhas para caber mais clientes sem scroll lateral */
        --row-height: 30px;
        --input-height: 20px;
    }

    /* Faz o card agir como um flex-column para alinhar header + tabela */
    .table-container {
        display: flex;
        flex-direction: column;
        height: auto; /* ajustar ao conteúdo; wrapper terá max-height para scroll */
        gap: 0;
        padding: 8px 18px 0 18px; /* remove padding inferior para eliminar espaço em branco */
        box-sizing: border-box;
    }

    /* diminuir visualmente a barra roxa do cabeçalho */
    .table-container .table-header {
        padding: 6px 12px !important; /* reduz espaço vertical do header */
        align-items: center;
        display: flex;
        justify-content: space-between;
        gap: 12px;
    }

    .table-container .table-header .table-title {
        padding: 6px 0 !important;
        margin: 0;
        font-size: 18px !important; /* reduz um pouco o título */
        line-height: 1 !important;
        font-weight: 600;
    }

    .table-container .table-header .table-controls {
        margin: 0 !important;
        align-self: center !important;
    }

    .table-container .table-header {
        flex: 0 0 auto;
        margin-bottom: 8px;
    }

    /* wrapper já presente - forçar a usar o espaço restante do card */
    .table-container > div[style*="overflow-x"] {
        /* o wrapper não força altura do card; limita sua altura para caber na viewport */
        max-height: var(--matrix-height);
        height: auto !important; /* ignora o height inline */
        /* permitir scroll horizontal e vertical quando necessário */
        overflow-x: auto !important;
        overflow-y: auto !important;
        display: block;
        padding-bottom: 0 !important; /* remove gap que empurra a scrollbar para baixo */
        margin-bottom: 0 !important;
        white-space: nowrap; /* evita que conteúdos quebrem em várias linhas, força scroll */
    }

        /* reduzir visualmente a barra de rolagem horizontal */
        .table-container > div[style*="overflow-x"]::-webkit-scrollbar {
            height: 8px; /* torna a barra mais fina */
        }
        .table-container > div[style*="overflow-x"]::-webkit-scrollbar-track {
            background: transparent;
        }
        .table-container > div[style*="overflow-x"]::-webkit-scrollbar-thumb {
            background: rgba(0,0,0,0.25);
            border-radius: 6px;
        }

    /* força linhas maiores */
    .projecao-table tbody tr,
    .projecao-table thead tr {
        height: var(--row-height) !important;
        min-height: var(--row-height) !important;
        max-height: var(--row-height) !important;
    }

    /* inputs compactos (sobrescreve estilos inline) para caber mais colunas */
    .projecao-table .valor-input {
        height: var(--input-height) !important;
        line-height: var(--input-height) !important;
        padding: 0 4px !important;
        box-sizing: border-box !important;
        font-size: 10px !important;
        text-align: right !important; /* mantém alinhamento numérico à direita */
        white-space: nowrap !important; /* impede quebra dentro do input */
    }

    /* força larguras menores nas colunas de dias (sobrescreve os inline styles) */
    .projecao-table thead th { min-width: 44px !important; padding: 2px 4px !important; }
    .projecao-table thead th:first-child { min-width: 140px !important; }
    /* diminui a largura do TOTAL à direita */
    .projecao-table thead th:last-child { min-width: 90px !important; }

    /* coluna total fixa à direita permanece visualmente consistente */
    .projecao-table .total-linha {
        padding: 6px 10px !important;
        font-size: 12px !important;
        text-align: center !important; /* centraliza o total da linha */
        white-space: nowrap !important;
    }

    /* footer totals */
    .projecao-table tfoot td {
        padding: 8px 6px !important;
        font-size: 12px !important;
    }

    /* centralizar os totais diários no footer */
    .projecao-table tfoot td.total-dia {
        text-align: center !important;
        color: #fff !important;
        white-space: nowrap !important;
    }

    /* tornar o texto TOTAL (thead última th) branco */
    .projecao-table thead th:last-child {
        color: #fff !important;
    }

    /* total geral na tabela (canto inferior direito) - número em branco */
    #totalGeralTabela {
        color: #ffffff !important;
        font-weight: 700 !important;
        text-align: center !important;
        padding: 6px 10px !important;
        box-sizing: border-box !important;
    }

    /* tornar o texto TOTAL DIÁRIO (tfoot primeira td) branco */
    .projecao-table tfoot td:first-child {
        color: #fff !important;
        font-weight: 600;
    }

    /* pequenas responsividades */
    @media (max-height: 800px) {
        :root{ --row-height: 28px; --input-height: 18px; }
    }
    
    /* Diminuir altura da barra de filtros */
    .card {
        padding: 12px 18px !important; /* reduz padding de 25px para 12px */
    }
    
    .board-header {
        margin-bottom: 15px !important; /* reduz margem inferior */
    }
    
    .board-header h1 {
        font-size: 24px !important; /* diminui título */
        margin-bottom: 5px !important;
    }
    
    .board-header .subtitle {
        font-size: 14px !important; /* diminui subtítulo */
    }
</style>



<div class="card fade-in-up" style="margin-bottom: 20px;">
    <form method="POST" action="{{ url_for('projecao') }}" id="projecaoForm">
        <div style="display: flex; gap: 20px; align-items: center; justify-content: space-between;">
            <div style="display: flex; gap: 20px; align-items: center;">
                <div class="form-group" style="margin-bottom: 0;">
                    <label class="form-label" for="mes">Mês:</label>
                    <select id="mes" name="mes" class="form-input">
                        <option value="1" selected>Janeiro</option>
                        <option value="2">Fevereiro</option>
                        <option value="3">Março</option>
                        <option value="4">Abril</option>
                        <option value="5">Maio</option>
                        <option value="6">Junho</option>
                        <option value="7">Julho</option>
                        <option value="8">Agosto</option>
                        <option value="9">Setembro</option>
                        <option value="10">Outubro</option>
                        <option value="11">Novembro</option>
                        <option value="12">Dezembro</option>
                    </select>
                </div>
                
                <div class="form-group" style="margin-bottom: 0;">
                    <label class="form-label" for="ano">Ano:</label>
                    <select id="ano" name="ano" class="form-input">
                        <option value="2025" selected>2025</option>
                        <option value="2026">2026</option>
                    </select>
                </div>
                
                <div style="margin-top: 18px;">
                    <span id="totalGeral" style="color: #667eea; font-weight: bold; font-size: 16px;">Total Geral: R$ 0,00</span>
                </div>
                
                <div class="form-group" style="margin-bottom: 0; margin-top: 10px;">
                    <label class="form-label" for="clienteFilter">Cliente:</label>
                    <select id="clienteFilter" class="form-input" onchange="abrirModalClienteSelecionado()">
                        <option value="">Selecione um cliente...</option>
                        {% for cliente in clientes %}
                        <option value="{{ cliente[0] }}|{{ cliente[1] }}">{{ cliente[1] }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            
            <div style="display: flex; gap: 10px;">
                <button type="button" class="btn btn-secondary" onclick="clearAll()">Limpar</button>
                <button type="button" id="btnSalvar" class="btn btn-primary">Salvar</button>
            </div>
        </div>
    </form>
</div>

<div class="table-container slide-in-left">
    <div class="table-header">
        <div class="table-title">Matriz de Projeção por Cliente e Dia</div>
        <div class="table-controls">
            <button type="button" class="btn btn-secondary" onclick="adicionarLinha()" disabled>Adicionar Cliente</button>
        </div>
    </div>
    
    <div style="overflow-x: auto; height: calc(100vh - 280px); overflow-y: hidden;">
        <table class="dynamic-table projecao-table" id="projecaoTable" style="width: 100%;">
            <thead>
                <tr style="position: sticky; top: 0; background: #667eea; color: white; z-index: 10;">
                    <th style="position: sticky; left: 0; background: #667eea; z-index: 11; min-width: 180px;">Cliente</th>
                    {% for d in range(1,32) %}
                    <th style="min-width: 70px; text-align: center;">{{ d }}</th>
                    {% endfor %}
                    <th style="min-width: 120px; background: #4f46e5; position: sticky; right: 0; z-index: 11;">TOTAL</th>
                </tr>
            </thead>
            <tbody>
                {% if clientes %}
                    {% for cliente in clientes %}
                    <tr class="cliente-row" style="height: 18px;">
                        <td style="position: sticky; left: 0; background: white; z-index: 5; font-weight: 600; border-right: 2px solid #e2e8f0; padding: 2px 8px; font-size: 9px;">
                            {{ cliente[1] }}
                        </td>
                        {% for d in range(1,32) %}
                        <td style="padding: 1px;">
                            <input 
                                type="text" 
                                name="cliente_{{ cliente[0] }}_{{ d }}" 
                                class="valor-input"
                                style="width: 100%; border: 1px solid #e2e8f0; padding: 1px; text-align: right;"
                                placeholder="0"
                                form="projecaoForm"
                            >
                        </td>
                        {% endfor %}
                        <td class="total-linha" style="background: #f1f5f9; font-weight: bold; text-align: right; padding: 2px 8px; font-size: 9px; position: sticky; right: 0; z-index: 5;">R$ 0,00</td>
                    </tr>
                    {% endfor %}
                {% else %}
                    <tr>
                        <td colspan="33" style="text-align: center; padding: 40px; color: #64748b;">
                            Nenhum cliente encontrado. Importe dados ou adicione clientes.
                        </td>
                    </tr>
                {% endif %}
            </tbody>
            {% if clientes %}
            <tfoot style="position: sticky; bottom: 0; background: #1e293b; color: white; z-index: 10;">
                <tr style="height: 24px;">
                    <td style="position: sticky; left: 0; background: #1e293b; z-index: 11; padding: 4px 8px; font-size: 10px;">TOTAL DIÁRIO</td>
                    {% for d in range(1,32) %}
                    <td class="total-dia" style="text-align: right; padding: 4px 2px; font-size: 8px;">R$ 0</td>
                    {% endfor %}
                    <td style="background: #059669; text-align: center; padding: 4px 8px; font-size: 10px; position: sticky; right: 0; z-index: 11;" id="totalGeralTabela">R$ 0,00</td>
                </tr>
            </tfoot>
            {% endif %}
        </table>
    </div>
</div>

<script>
let clienteIdCounter = 100;

// Implementação simples de notificação (fallback se não existir)
function showNotification(message, type) {
    try {
        const existing = document.getElementById('toast-container');
        let container = existing;
        if (!container) {
            container = document.createElement('div');
            container.id = 'toast-container';
            container.style.position = 'fixed';
            container.style.top = '18px';
            container.style.right = '18px';
            container.style.zIndex = 99999;
            document.body.appendChild(container);
        }
        const toast = document.createElement('div');
        toast.textContent = message;
        toast.style.background = type === 'error' ? '#ef4444' : (type === 'success' ? '#10b981' : '#64748b');
        toast.style.color = 'white';
        toast.style.padding = '8px 12px';
        toast.style.marginTop = '8px';
        toast.style.borderRadius = '6px';
        toast.style.boxShadow = '0 2px 6px rgba(0,0,0,0.15)';
        container.appendChild(toast);
        setTimeout(() => { toast.remove(); }, 4500);
    } catch (e) {
        console.error('showNotification error', e);
    }
}

// --- Formatação: apenas apresentação ---
// Formata número inteiro com separador de milhares '.' (ex: 7000 -> "7.000")
function formatWithDots(value) {
    if (value === null || value === undefined || value === '') return '';
    const n = Number(value);
    if (!isFinite(n)) return '';
    // arredonda para inteiro para exibição
    const rounded = Math.round(n);
    return rounded.toString().replace(/\B(?=(\d{3})+(?!\d))/g, '.');
}

// Faz o parse de uma string possivelmente formatada (ex: "7.000" ou "1.234,56") para número
function parseFormattedNumber(s) {
    if (s === null || s === undefined || s === '') return 0;
    const str = s.toString();
    // remove tudo que não seja dígito, ponto, vírgula ou menos
    const cleaned = str.replace(/[^0-9,.-]/g, '');
    // Se o usuário usou '.' como separador de milhares, remova-os
    // Em seguida troque vírgula decimal por ponto, se houver
    const noThousands = cleaned.replace(/\./g, '');
    const normalized = noThousands.replace(/,/g, '.');
    const parsed = parseFloat(normalized);
    return Number.isFinite(parsed) ? parsed : 0;
}

function adicionarLinha() {
    const nomeCliente = prompt('Nome do cliente:');
    if (!nomeCliente || nomeCliente.trim() === '') return;
    
    const tbody = document.querySelector('#projecaoTable tbody');
    const novoId = ++clienteIdCounter;
    
    const novaLinha = document.createElement('tr');
    novaLinha.className = 'cliente-row';
    novaLinha.style.height = '18px';
    
    let html = '<td style="position: sticky; left: 0; background: white; z-index: 5; font-weight: 600; border-right: 2px solid #e2e8f0; padding: 2px 8px; font-size: 9px;">' + nomeCliente.trim() + '</td>';
    
    for (let d = 1; d <= 31; d++) {
        html += '<td style="padding: 1px;"><input type="text" name="cliente_' + novoId + '_' + d + '" class="valor-input" style="width: 100%; border: 1px solid #e2e8f0; padding: 1px; text-align: right;" placeholder="0" onchange="calcularTotais()" form="projecaoForm"></td>';
    }
    
    html += '<td class="total-linha" style="background: #f1f5f9; font-weight: bold; text-align: right; padding: 2px 8px; font-size: 9px; position: sticky; right: 0; z-index: 5;">R$ 0,00</td>';
    
    novaLinha.innerHTML = html;
    tbody.appendChild(novaLinha);
    // garante listeners em inputs recém-criados
    attachInputListeners();
    calcularTotais();
}

function abrirModalClienteSelecionado() {
    const select = document.getElementById('clienteFilter');
    if (select.value) {
        const [clienteId, nomeCliente] = select.value.split('|');
        abrirModalCliente(clienteId, nomeCliente);
        // Resetar o select após abrir o modal
        select.value = '';
    }
}

// ===== MODAL DE EDIÇÃO DE CLIENTE =====
let modalClienteAtual = null;
let modalDadosOriginais = {};

function abrirModalCliente(clienteId, nomeCliente) {
    modalClienteAtual = clienteId;
    
    // Atualizar informações do modal
    document.getElementById('clienteModalTitle').textContent = `Editar Projeção - ${nomeCliente}`;
    document.getElementById('clienteModalNome').textContent = nomeCliente;
    
    // Pegar mês e ano atual dos filtros
    const mesSelect = document.getElementById('mes');
    const anoSelect = document.getElementById('ano');
    const mesNome = mesSelect.options[mesSelect.selectedIndex].text;
    const ano = anoSelect.value;
    document.getElementById('clienteModalMesAno').textContent = `${mesNome}/${ano}`;
    
    // Criar grade de dias
    criarGradeDias();
    
    // Preencher valores existentes
    preencherValoresExistentes(clienteId);
    
    // Mostrar modal
    document.getElementById('clienteModal').style.display = 'flex';
    document.body.style.overflow = 'hidden';
    
    // Calcular total inicial
    calcularTotalModal();
}

function criarGradeDias() {
    const gradeContainer = document.querySelector('.cliente-grade-container');
    gradeContainer.innerHTML = '';
    
    // Título
    const titulo = document.createElement('h4');
    titulo.textContent = 'Preenchimento por Dia do Mês';
    gradeContainer.appendChild(titulo);
    
    // Header com dias da semana
    const semanaHeader = document.createElement('div');
    semanaHeader.className = 'semana-header';
    const diasSemana = ['DOM', 'SEG', 'TER', 'QUA', 'QUI', 'SEX', 'SAB'];
    diasSemana.forEach(dia => {
        const diaSemana = document.createElement('div');
        diaSemana.className = 'dia-semana';
        diaSemana.textContent = dia;
        semanaHeader.appendChild(diaSemana);
    });
    gradeContainer.appendChild(semanaHeader);
    
    // Grade de dias
    const grade = document.createElement('div');
    grade.className = 'cliente-grade';
    grade.id = 'clienteGrade';
    
    // Determinar quantos dias tem o mês e qual dia da semana começa
    const mes = parseInt(document.getElementById('mes').value);
    const ano = parseInt(document.getElementById('ano').value);
    const diasNoMes = new Date(ano, mes, 0).getDate();
    const primeiroDia = new Date(ano, mes - 1, 1).getDay(); // 0 = domingo
    
    // Adicionar células vazias no início
    for (let i = 0; i < primeiroDia; i++) {
        const container = document.createElement('div');
        container.className = 'dia-input-container dia-vazio';
        grade.appendChild(container);
    }
    
    // Adicionar dias do mês
    for (let dia = 1; dia <= diasNoMes; dia++) {
        const container = document.createElement('div');
        container.className = 'dia-input-container';
        
        const label = document.createElement('div');
        label.className = 'dia-label';
        label.textContent = dia;
        
        const input = document.createElement('input');
        input.type = 'text';
        input.className = 'dia-input';
        input.placeholder = '0';
        input.setAttribute('data-dia', dia);
        input.addEventListener('input', function() {
            formatarMoedaSimples(this);
            calcularTotalModal();
        });
        input.addEventListener('keypress', function(e) {
            // Permitir apenas números
            if (!/[\d]/.test(e.key) && !['Backspace', 'Delete', 'Tab', 'Enter', 'ArrowLeft', 'ArrowRight'].includes(e.key)) {
                e.preventDefault();
            }
        });
        
        container.appendChild(label);
        container.appendChild(input);
        grade.appendChild(container);
    }
    
    gradeContainer.appendChild(grade);
}

// Formatação mais simples para números inteiros
function formatarMoedaSimples(input) {
    let valor = input.value.replace(/\D/g, '');
    if (valor === '') {
        input.value = '';
        return;
    }
    // Converter para número e formatar com pontos
    const numero = parseInt(valor);
    input.value = numero.toLocaleString('pt-BR');
}

function preencherValoresExistentes(clienteId) {
    // Buscar valores da tabela atual
    modalDadosOriginais = {};
    
    const inputs = document.querySelectorAll(`input[name^="cliente_${clienteId}_"]`);
    inputs.forEach(input => {
        const match = input.name.match(/cliente_\d+_(\d+)/);
        if (match) {
            const dia = parseInt(match[1]);
            const valor = input.value.trim();
            
            modalDadosOriginais[dia] = valor;
            
            // Preencher no modal
            const modalInput = document.querySelector(`.dia-input[data-dia="${dia}"]`);
            if (modalInput && valor) {
                modalInput.value = valor;
            }
        }
    });
}

function calcularTotalModal() {
    let total = 0;
    
    document.querySelectorAll('.dia-input').forEach(input => {
        const valor = parseMoeda(input.value);
        if (!isNaN(valor)) {
            total += valor;
        }
    });
    
    document.getElementById('clienteModalTotal').textContent = formatarMoedaBR(total);
}

function salvarModalCliente() {
    if (!modalClienteAtual) return;
    
    // Aplicar valores da grade para a tabela principal
    document.querySelectorAll('.dia-input').forEach(input => {
        const dia = input.getAttribute('data-dia');
        const valor = input.value.trim();
        
        const inputTabela = document.querySelector(`input[name="cliente_${modalClienteAtual}_${dia}"]`);
        if (inputTabela) {
            inputTabela.value = valor;
        }
    });
    
    // Recalcular totais da tabela
    calcularTotais();
    
    // Fechar modal
    fecharModalCliente();
    
    // Mostrar notificação
    showNotification('Valores aplicados com sucesso! Lembre-se de salvar.', 'success');
}

function fecharModalCliente() {
    document.getElementById('clienteModal').style.display = 'none';
    document.body.style.overflow = 'auto';
    modalClienteAtual = null;
    modalDadosOriginais = {};
}

// Utilitários de formatação
function formatarMoeda(input) {
    let valor = input.value.replace(/\D/g, '');
    valor = (valor / 100).toFixed(2) + '';
    valor = valor.replace(".", ",");
    valor = valor.replace(/(\d)(\d{3})(\d{3}),/g, "$1.$2.$3,");
    valor = valor.replace(/(\d)(\d{3}),/g, "$1.$2,");
    input.value = valor;
}

function parseMoeda(valor) {
    if (!valor) return 0;
    // Remove pontos (separadores de milhares) e converte para número
    return parseInt(valor.replace(/\./g, '')) || 0;
}

function formatarMoedaBR(valor) {
    return new Intl.NumberFormat('pt-BR', {
        style: 'currency',
        currency: 'BRL',
        minimumFractionDigits: 2
    }).format(valor);
}

// Fechar modal com ESC
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape' && document.getElementById('clienteModal').style.display === 'flex') {
        fecharModalCliente();
    }
});

function calcularTotais() {
    const linhas = document.querySelectorAll('.cliente-row');
    const totalDias = new Array(31).fill(0);
    let totalGeral = 0;
    
    linhas.forEach(linha => {
        const inputs = linha.querySelectorAll('.valor-input');
        let totalLinha = 0;
        
        inputs.forEach((input, index) => {
            const valor = parseFormattedNumber(input.value) || 0;
            totalLinha += valor;
            totalDias[index] += valor;
        });
        
        const cellTotal = linha.querySelector('.total-linha');
        if (cellTotal) {
            // exibição sem casas decimais, apenas separador de milhares
            cellTotal.textContent = 'R$ ' + formatWithDots(totalLinha);
        }
        
        totalGeral += totalLinha;
    });
    
    const totalDiaCells = document.querySelectorAll('.total-dia');
    totalDiaCells.forEach((cell, index) => {
        cell.textContent = 'R$ ' + formatWithDots(totalDias[index]);
    });
    
    const totalFormatado = 'R$ ' + formatWithDots(totalGeral);
    const elTotalGeral = document.getElementById('totalGeral');
    if (elTotalGeral) elTotalGeral.textContent = 'Total Geral: ' + totalFormatado;
    
    const totalGeralTabela = document.getElementById('totalGeralTabela');
    if (totalGeralTabela) {
        totalGeralTabela.textContent = totalFormatado;
    }
}

function clearAll() {
    const inputs = document.querySelectorAll('.valor-input');
    inputs.forEach(input => input.value = '');
    calcularTotais();
}

// Attach listeners to inputs so totals update while typing and after dynamic additions
function attachInputListeners() {
    const inputs = document.querySelectorAll('.valor-input');
    inputs.forEach(input => {
        // remove listeners gently to avoid duplicates
        input.removeEventListener('input', calcularTotais);
        input.removeEventListener('focus', input._projFocusHandler);
        input.removeEventListener('blur', input._projBlurHandler);

        input.addEventListener('input', calcularTotais);

        // ao focar, desfaz a formatação para facilitar edição
        input._projFocusHandler = function (e) {
            const v = e.target.value || '';
            e.target.value = v.toString().replace(/\./g, '');
        };
        input.addEventListener('focus', input._projFocusHandler);

        // ao perder o foco, formata com separador de milhares
        input._projBlurHandler = function (e) {
            const v = parseFormattedNumber(e.target.value);
            e.target.value = v ? formatWithDots(v) : '';
            calcularTotais();
        };
        input.addEventListener('blur', input._projBlurHandler);
    });
}

// monta payload e envia para o backend
async function saveProjecao() {
    const mes = parseInt(document.getElementById('mes').value, 10);
    const ano = parseInt(document.getElementById('ano').value, 10);

    const linhas = [];
    const rows = document.querySelectorAll('.cliente-row');
    rows.forEach(row => {
        const clienteCell = row.querySelector('td');
        const cliente = clienteCell ? clienteCell.textContent.trim() : '';
        const inputs = row.querySelectorAll('.valor-input');
        const valores = Array.from(inputs).map(i => {
            const v = parseFormattedNumber(i.value);
            return Number.isFinite(v) ? v : 0.0;
        });
        linhas.push({ cliente: cliente, valores: valores });
    });

    const payload = { mes: mes, ano: ano, linhas: linhas };

    try {
        const resp = await fetch('/api/projecao', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });
        const data = await resp.json();
        if (resp.ok && data.status === 'success') {
            showNotification('Projeção salva com sucesso!', 'success');
            // recalcula e mantém os valores
            calcularTotais();
        } else {
            showNotification('Erro ao salvar: ' + (data.message || resp.statusText), 'error');
        }
    } catch (err) {
        showNotification('Erro de rede ao salvar projeção', 'error');
        console.error(err);
    }
}

// Carrega projeção para mes/ano e popula a tabela (mantém estrutura atual, preenche inputs)
async function loadProjecao() {
    const mes = parseInt(document.getElementById('mes').value, 10);
    const ano = parseInt(document.getElementById('ano').value, 10);
    try {
        const resp = await fetch(`/api/projecao?mes=${mes}&ano=${ano}`);
        if (!resp.ok) throw new Error('Resposta do servidor: ' + resp.status);
        const data = await resp.json();
        if (data.status !== 'success') {
            showNotification('Nenhuma projeção encontrada para esse mês/ano', 'info');
            return;
        }

        // Limpa inputs existentes
        const rows = document.querySelectorAll('.cliente-row');
        // Mapeia cliente -> valores retornadas
        const map = {};
        (data.linhas || []).forEach(l => { map[l.cliente] = l.valores || []; });

        rows.forEach(row => {
            const clienteCell = row.querySelector('td');
            const cliente = clienteCell ? clienteCell.textContent.trim() : '';
            const valores = map[cliente] || [];
            const inputs = row.querySelectorAll('.valor-input');
            inputs.forEach((input, idx) => {
                const v = idx < valores.length ? valores[idx] : 0;
                // apenas formata para apresentação; não altera valor armazenado
                input.value = v && v !== 0 ? formatWithDots(v) : '';
            });
        });

        attachInputListeners();
        calcularTotais();
        showNotification('Projeção carregada', 'success');
    } catch (err) {
        console.error(err);
        showNotification('Erro ao carregar projeção', 'error');
    }
}

// Wire eventos UI
document.addEventListener('DOMContentLoaded', () => {
    try {
        attachInputListeners();
        calcularTotais();
        const btn = document.getElementById('btnSalvar');
        if (btn) btn.addEventListener('click', saveProjecao);

        const selMes = document.getElementById('mes');
        const selAno = document.getElementById('ano');
        if (selMes) selMes.addEventListener('change', loadProjecao);
        if (selAno) selAno.addEventListener('change', loadProjecao);

        // carregar projeção atual ao abrir a página
        loadProjecao();
    } catch (e) {
        console.error('Erro na inicialização de projecao.js', e);
        showNotification('Erro de inicialização. Veja console para detalhes.', 'error');
    }
});

</script>

<!-- Modal de Edição de Cliente -->
<div id="clienteModal" class="cliente-modal" style="display: none;">
    <div class="cliente-modal-content">
        <div class="cliente-modal-header">
            <h3 id="clienteModalTitle">Editar Projeção - Cliente</h3>
            <button class="btn-close-modal" onclick="fecharModalCliente()">×</button>
        </div>
        <div class="cliente-modal-body">
            <div class="cliente-modal-info">
                <div class="info-item">
                    <span class="info-label">Mês/Ano:</span>
                    <span id="clienteModalMesAno" class="info-value">-</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Cliente:</span>
                    <span id="clienteModalNome" class="info-value">-</span>
                </div>
            </div>
            
            <div class="cliente-grade-container">
                <h4>Preenchimento por Dia do Mês</h4>
                <div id="clienteGrade" class="cliente-grade"></div>
            </div>
            
            <div class="cliente-total-container">
                <div class="total-item">
                    <span class="total-label">Total do Mês:</span>
                    <span id="clienteModalTotal" class="total-valor">R$ 0,00</span>
                </div>
            </div>
        </div>
        <div class="cliente-modal-footer">
            <button type="button" class="btn btn-secondary" onclick="fecharModalCliente()">Cancelar</button>
            <button type="button" class="btn btn-success" onclick="salvarModalCliente()">Aplicar Valores</button>
        </div>
    </div>
</div>

<style>
/* Modal Styles */
.cliente-modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    justify-content: center;
    align-items: center;
}

.cliente-modal-content {
    background: white;
    border-radius: 12px;
    width: 95%;
    max-width: 1100px;
    max-height: 85vh;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    animation: modalSlideIn 0.3s ease;
}

@keyframes modalSlideIn {
    from { opacity: 0; transform: scale(0.9); }
    to { opacity: 1; transform: scale(1); }
}

.cliente-modal-header {
    padding: 20px 25px;
    border-bottom: 1px solid #e2e8f0;
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 12px 12px 0 0;
}

.cliente-modal-header h3 {
    margin: 0;
    font-size: 1.2rem;
    font-weight: 600;
    color: #1e293b;
}

.btn-close-modal {
    background: none;
    border: none;
    font-size: 24px;
    color: white;
    cursor: pointer;
    padding: 5px;
    border-radius: 50%;
    width: 35px;
    height: 35px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background-color 0.2s;
}

.btn-close-modal:hover {
    background: rgba(255, 255, 255, 0.2);
    transform: scale(1.1);
}

.cliente-modal-body {
    padding: 12px;
    max-height: 80vh;
    overflow-y: hidden;
}

.cliente-modal-info {
    display: flex;
    gap: 30px;
    margin-bottom: 15px;
    padding: 12px 18px;
    background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
    border-radius: 8px;
    border-left: 4px solid #667eea;
}

.info-item {
    display: flex;
    flex-direction: column;
    gap: 5px;
}

.info-label {
    font-size: 12px;
    color: #64748b;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.info-value {
    font-size: 16px;
    color: #1e293b;
    font-weight: 600;
}

.cliente-grade-container h4 {
    margin: 0 0 10px 0;
    color: #374151;
    font-size: 15px;
    font-weight: 600;
}

.cliente-grade {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 3px;
    margin-bottom: 15px;
    border: 2px solid #e5e7eb;
    border-radius: 8px;
    padding: 8px;
    background: linear-gradient(135deg, #fefefe 0%, #f8fafc 100%);
}

.semana-header {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 3px;
    margin-bottom: 5px;
    padding: 0 8px;
}

.dia-semana {
    text-align: center;
    font-weight: 700;
    font-size: 11px;
    color: #374151;
    padding: 6px 3px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 4px;
    letter-spacing: 0.3px;
}

.dia-input-container {
    display: flex;
    flex-direction: column;
    gap: 3px;
    min-height: 50px;
}

.dia-input-container.dia-vazio {
    visibility: hidden;
}

.dia-label {
    font-size: 10px;
    font-weight: 700;
    color: #374151;
    text-align: center;
    background: #f1f5f9;
    border-radius: 3px;
    padding: 2px 3px;
}

.dia-input {
    padding: 5px 4px;
    border: 1px solid #e5e7eb;
    border-radius: 4px;
    text-align: center;
    font-size: 12px;
    font-weight: 600;
    transition: all 0.2s;
    background: white;
    min-height: 32px;
    width: 100%;
    box-sizing: border-box;
}

.dia-input:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    transform: scale(1.02);
}

.cliente-total-container {
    padding: 20px;
    background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
    border-radius: 8px;
    border: 1px solid #0ea5e9;
}

.total-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.total-label {
    font-size: 18px;
    font-weight: 600;
    color: #0f172a;
}

.total-valor {
    font-size: 24px;
    font-weight: 700;
    color: #059669;
}

.cliente-modal-footer {
    padding: 20px 25px;
    border-top: 1px solid #e2e8f0;
    display: flex;
    justify-content: flex-end;
    gap: 12px;
    background: #f8fafc;
    border-radius: 0 0 12px 12px;
}

.cliente-modal-footer .btn {
    padding: 10px 20px;
    border-radius: 6px;
    font-weight: 600;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.2s;
}

.cliente-modal-footer .btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}

/* Responsivo */
@media (max-width: 800px) {
    .cliente-modal-content {
        width: 95%;
        max-height: 90vh;
    }
    
    .cliente-grade {
        grid-template-columns: repeat(4, 1fr);
    }
    
    .cliente-modal-info {
        flex-direction: column;
        gap: 15px;
    }
}
</style>

{% endblock %}
