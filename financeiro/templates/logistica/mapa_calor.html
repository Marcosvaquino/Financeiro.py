{% extends "base.html" %}

{% block title %}Mapa de Calor - Logística{% endblock %}

{% block content %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.css" />

<style>
    body {
        background: #e3e3e3 !important;
        min-height: 100vh;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    
    .content {
        background: #e3e3e3 !important;
    }

    .main-container {
        padding: 15px;
        min-height: 100vh;
    }

    .dashboard-header {
        background: rgba(255, 255, 255, 0.95);
        border-radius: 10px;
        padding: 15px;
        margin-bottom: 15px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
    }

    .upload-section {
        background: rgba(255, 255, 255, 0.95);
        border-radius: 10px;
        padding: 15px;
        margin-bottom: 15px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
    }

    .upload-area {
        border: 2px dashed #2a5298;
        border-radius: 10px;
        padding: 25px;
        text-align: center;
        transition: all 0.3s ease;
        cursor: pointer;
        background: rgba(42, 82, 152, 0.03);
    }

    .upload-area:hover {
        background: rgba(42, 82, 152, 0.08);
        border-color: #1e3c72;
    }

    .btn-upload {
        background: linear-gradient(135deg, #2a5298 0%, #1e3c72 100%);
        color: white;
        border: none;
        padding: 8px 20px;
        border-radius: 20px;
        font-weight: 600;
        transition: all 0.3s ease;
        font-size: 0.85rem;
    }

    .btn-upload:hover {
        transform: translateY(-2px);
        box-shadow: 0 3px 10px rgba(42, 82, 152, 0.3);
        color: white;
    }

    .card {
        background: rgba(255, 255, 255, 0.95);
        border-radius: 10px;
        border: none;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
        margin-bottom: 15px;
    }

    .stats-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 12px;
        border-radius: 10px;
        text-align: center;
        margin-bottom: 0;
    }

    .stats-value {
        font-size: 1.5rem;
        font-weight: bold;
        margin: 5px 0;
    }

    .stats-label {
        font-size: 0.75rem;
        opacity: 0.9;
    }

    .file-info {
        background: #f8f9fa;
        padding: 10px 12px;
        border-radius: 8px;
        margin-top: 10px;
        display: none;
        font-size: 0.85rem;
    }

    .file-info.show {
        display: block;
    }
    }

    @keyframes slideDown {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 9999;
    }

    .loading-overlay.show {
        display: flex;
    }

    .loading-content {
        background: white;
        padding: 40px;
        border-radius: 20px;
        text-align: center;
    }

    .spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #2a5298;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        animation: spin 1s linear infinite;
        margin: 0 auto 20px;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .progress-container {
        margin-top: 20px;
        width: 100%;
    }

    .progress-bar-custom {
        width: 100%;
        height: 30px;
        background-color: #e9ecef;
        border-radius: 15px;
        overflow: hidden;
        margin-bottom: 10px;
    }

    .progress-bar-fill {
        height: 100%;
        background: linear-gradient(90deg, #2a5298 0%, #4facfe 100%);
        transition: width 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
        font-size: 14px;
    }

    .progress-info {
        display: flex;
        justify-content: space-between;
        font-size: 13px;
        color: #666;
    }

    .intensity-legend {
        position: absolute;
        bottom: 30px;
        right: 30px;
        background: white;
        padding: 15px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        z-index: 1000;
    }

    .intensity-legend h6 {
        margin: 0 0 10px 0;
        font-size: 0.9rem;
        font-weight: bold;
    }

    .legend-scale {
        display: flex;
        align-items: center;
        gap: 5px;
    }

    .legend-gradient {
        width: 200px;
        height: 20px;
        background: linear-gradient(to right, 
            #00ff00 0%,     /* Verde: 0-25 */
            #00ff00 25%,
            #ffff00 25%,    /* Amarelo: 26-50 */
            #ffff00 50%,
            #ff7700 50%,    /* Laranja: 51-75 */
            #ff7700 75%,
            #ff0000 75%,    /* Vermelho: 76-100+ */
            #ff0000 100%
        );
        border-radius: 5px;
        border: 1px solid #ddd;
    }

    .legend-labels {
        display: flex;
        justify-content: space-between;
        font-size: 0.7rem;
        margin-top: 5px;
        width: 200px;
    }

    /* Filter Buttons */
    .filter-buttons {
        display: flex;
        flex-direction: column;
        gap: 5px;
    }

    .filter-btn {
        border: 2px solid transparent;
        border-radius: 6px;
        padding: 6px 10px;
        font-size: 0.75rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        text-align: center;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    .filter-btn:hover {
        transform: translateX(5px);
        box-shadow: 0 3px 8px rgba(0,0,0,0.2);
    }

    .filter-btn.active {
        border-color: #2a5298;
        box-shadow: 0 0 0 3px rgba(42, 82, 152, 0.3);
        transform: scale(1.05);
    }

    .filter-btn i {
        margin-right: 4px;
    }

    /* Fullscreen Styles */
    .fullscreen {
        position: fixed !important;
        top: 0 !important;
        left: 0 !important;
        width: 100vw !important;
        height: 100vh !important;
        z-index: 9999 !important;
        margin: 0 !important;
        border-radius: 0 !important;
    }

    .fullscreen #map {
        height: calc(100vh - 50px) !important;
        border-radius: 0 !important;
    }

    .fullscreen .card-header {
        border-radius: 0 !important;
    }
</style>

<div class="main-container">
    <!-- Header Compacto -->
    <div class="dashboard-header" style="padding: 15px;">
        <div class="row align-items-center">
            <div class="col">
                <h4 class="mb-0">
                    <i class="fas fa-fire text-danger"></i> Mapa de Calor
                </h4>
            </div>
            <div class="col-auto">
                <button class="btn btn-success btn-sm me-2" onclick="carregarUltimoUpload()">
                    <i class="fas fa-history"></i> Carregar Último
                </button>
                <button class="btn btn-danger btn-sm" onclick="limparMapa()">
                    <i class="fas fa-trash"></i> Limpar
                </button>
            </div>
        </div>
    </div>

    <!-- Stats Row Compacta -->
    <div class="row mb-3" id="statsRow" style="display: none;">
        <div class="col-md-3 mb-2">
            <div class="stats-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 12px;">
                <i class="fas fa-map-marker-alt" style="font-size: 1.5rem;"></i>
                <div class="stats-value" id="totalLocais" style="font-size: 1.5rem;">0</div>
                <div class="stats-label" style="font-size: 0.75rem;">Cidades</div>
            </div>
        </div>
        <div class="col-md-3 mb-2">
            <div class="stats-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); padding: 12px;">
                <i class="fas fa-chart-line" style="font-size: 1.5rem;"></i>
                <div class="stats-value" id="totalValor" style="font-size: 1.5rem;">0</div>
                <div class="stats-label" style="font-size: 0.75rem;">Ocorrências</div>
            </div>
        </div>
        <div class="col-md-3 mb-2">
            <div class="stats-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); padding: 12px;">
                <i class="fas fa-calculator" style="font-size: 1.5rem;"></i>
                <div class="stats-value" id="mediaValor" style="font-size: 1.5rem;">0</div>
                <div class="stats-label" style="font-size: 0.75rem;">Média</div>
            </div>
        </div>
        <div class="col-md-3 mb-2">
            <div class="stats-card" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); padding: 12px;">
                <i class="fas fa-fire" style="font-size: 1.5rem;"></i>
                <div class="stats-value" id="maiorValor" style="font-size: 1.5rem;">0</div>
                <div class="stats-label" style="font-size: 0.75rem;">Máximo</div>
            </div>
        </div>
    </div>

    <!-- Map Compacto com Botão Fullscreen -->
    <div class="card" id="mapCard">
        <div class="card-header bg-primary text-white" style="padding: 10px 15px;">
            <div class="d-flex justify-content-between align-items-center">
                <h6 class="mb-0">
                    <i class="fas fa-globe-americas me-2"></i>
                    Mapa de Calor
                </h6>
                <button class="btn btn-sm btn-light" onclick="toggleFullscreen()" title="Tela Cheia">
                    <i class="fas fa-expand" id="fullscreenIcon"></i>
                </button>
            </div>
        </div>
        <div class="card-body p-0" style="position: relative;">
            <div id="map" style="height: 500px;"></div>
            
            <!-- Controle de Setores (Micro/Macro) -->
            <div class="setor-control" style="position: absolute; top: 10px; left: 60px; z-index: 1000; background: white; padding: 12px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.15); min-width: 280px;">
                <div style="font-size: 0.8rem; font-weight: 600; margin-bottom: 8px; color: #333;">
                    <i class="fas fa-layer-group me-1"></i> Visualização
                </div>
                <div class="btn-group btn-group-sm mb-2" role="group" style="width: 100%;">
                    <input type="radio" class="btn-check" name="tipoSetor" id="microSetor" value="micro" checked>
                    <label class="btn btn-outline-primary" for="microSetor" style="font-size: 0.75rem;">
                        <i class="fas fa-map-marker-alt me-1"></i>Micro Setores
                    </label>
                    
                    <input type="radio" class="btn-check" name="tipoSetor" id="macroSetor" value="macro">
                    <label class="btn btn-outline-primary" for="macroSetor" style="font-size: 0.75rem;">
                        <i class="fas fa-globe-americas me-1"></i>Macro Setores
                    </label>
                </div>
                
                <!-- Dropdown de Regiões (só aparece no modo Macro) -->
                <div id="regiaoSelector" style="display: none;">
                    <label style="font-size: 0.75rem; font-weight: 600; color: #555; margin-bottom: 4px; display: block;">
                        <i class="fas fa-map-marked-alt me-1"></i>Selecione a Região:
                    </label>
                    <select id="selectRegiao" class="form-select form-select-sm" onchange="filtrarMacroRegioes()" style="font-size: 0.75rem;">
                        <option value="Vale do Paraíba" style="background: #FF6B6B20;">📍 Vale do Paraíba</option>
                        <option value="Litoral Norte" style="background: #4ECDC420;">🏖️ Litoral Norte</option>
                        <option value="Litoral Sul" style="background: #45B7D120;">🌊 Litoral Sul</option>
                        <option value="SP Capital e RM" style="background: #FFA07A20;">🏙️ SP Capital e RM</option>
                        <option value="ABC Paulista" style="background: #98D8C820;">🏭 ABC Paulista</option>
                        <option value="Campinas e Região" style="background: #F7DC6F20;">🌆 Campinas e Região</option>
                        <option value="Sorocaba e Região" style="background: #BB8FCE20;">🏘️ Sorocaba e Região</option>
                        <option value="Interior SP" style="background: #F8B50020;">🌾 Interior SP</option>
                        <option value="Outras Capitais" style="background: #AED6F120;">🌎 Outras Capitais</option>
                    </select>
                </div>
            </div>
            
            <!-- Legenda Interativa com Filtros -->
            <div class="intensity-legend" id="microLegend" style="padding: 12px; font-size: 0.85rem;">
                <h6 style="font-size: 0.85rem; margin-bottom: 10px;">
                    <i class="fas fa-filter me-1"></i>Filtrar por Intensidade
                </h6>
                
                <!-- Filtros Clicáveis -->
                <div class="filter-buttons">
                    <button class="filter-btn active" data-range="all" onclick="filtrarPorCor('all')" 
                            style="background: linear-gradient(to right, #00ff00, #ffff00, #ff7700, #ff0000); color: #333; font-weight: bold;">
                        <i class="fas fa-layer-group me-1"></i> Todos
                    </button>
                    <button class="filter-btn" data-range="0-25" onclick="filtrarPorCor('0-25')" 
                            style="background: #00ff00; color: #333;">
                        0-25
                    </button>
                    <button class="filter-btn" data-range="26-50" onclick="filtrarPorCor('26-50')" 
                            style="background: #ffff00; color: #333;">
                        26-50
                    </button>
                    <button class="filter-btn" data-range="51-75" onclick="filtrarPorCor('51-75')" 
                            style="background: #ff7700; color: white;">
                        51-75
                    </button>
                    <button class="filter-btn" data-range="76-100" onclick="filtrarPorCor('76-100')" 
                            style="background: #ff0000; color: white;">
                        76-100+
                    </button>
                </div>
                
                <div style="margin-top: 8px; font-size: 0.7rem; color: #666; text-align: center;">
                    <span id="filterInfo">Mostrando todas as cidades</span>
                </div>
            </div>
            
            <!-- Legenda de Macro-Regiões (aparece só no modo Macro) -->
            <div class="macro-legend" id="macroLegend" style="padding: 12px; font-size: 0.85rem; display: none;">
                <div style="font-size: 0.75rem; color: #666; text-align: center; padding: 8px; background: #f8f9fa; border-radius: 6px;">
                    <i class="fas fa-map-marked-alt me-1"></i>
                    <span id="macroInfo">
                        <span id="regioesCount">9</span> regiões disponíveis
                    </span>
                </div>
            </div>
        </div>
    </div>

    <!-- Upload Section Compacta (MOVIDO PARA BAIXO) -->
    <div class="upload-section" style="padding: 15px;">
        <h6 class="mb-3"><i class="fas fa-upload me-2"></i>Importar Dados</h6>
        <div class="upload-area" id="uploadArea" style="padding: 25px;">
            <div class="upload-icon" style="font-size: 2.5rem; margin-bottom: 10px;">
                <i class="fas fa-cloud-upload-alt"></i>
            </div>
            <h6>Arraste arquivo Excel/CSV aqui</h6>
            <input type="file" id="fileInput" class="file-input" accept=".xlsx,.xls,.csv">
            <button class="btn btn-upload btn-sm mt-2" onclick="document.getElementById('fileInput').click()">
                <i class="fas fa-folder-open me-1"></i>Selecionar
            </button>
        </div>

        <div class="file-info" id="fileInfo">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <i class="fas fa-file-excel text-success me-2"></i>
                    <strong id="fileName"></strong>
                </div>
                <button class="btn btn-sm btn-primary" onclick="processarArquivo()">
                    <i class="fas fa-cog me-1"></i>Processar
                </button>
            </div>
        </div>

        <!-- Status Compacto -->
        <div class="alert alert-success alert-sm mt-2 mb-0" id="processStatus" style="display: none; padding: 8px 12px; font-size: 0.85rem;">
            <div id="statusMessage"></div>
        </div>
    </div>

    <!-- Stats Row Compacta -->
    <div class="row mb-3" id="statsRow" style="display: none;">
        <div class="col-md-3 mb-2">
            <div class="stats-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 12px;">
                <i class="fas fa-map-marker-alt" style="font-size: 1.5rem;"></i>
                <div class="stats-value" id="totalLocais" style="font-size: 1.5rem;">0</div>
                <div class="stats-label" style="font-size: 0.75rem;">Cidades</div>
            </div>
        </div>
        <div class="col-md-3 mb-2">
            <div class="stats-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); padding: 12px;">
                <i class="fas fa-chart-line" style="font-size: 1.5rem;"></i>
                <div class="stats-value" id="totalValor" style="font-size: 1.5rem;">0</div>
                <div class="stats-label" style="font-size: 0.75rem;">Ocorrências</div>
            </div>
        </div>
        <div class="col-md-3 mb-2">
            <div class="stats-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); padding: 12px;">
                <i class="fas fa-calculator" style="font-size: 1.5rem;"></i>
                <div class="stats-value" id="mediaValor" style="font-size: 1.5rem;">0</div>
                <div class="stats-label" style="font-size: 0.75rem;">Média</div>
            </div>
        </div>
        <div class="col-md-3 mb-2">
            <div class="stats-card" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); padding: 12px;">
                <i class="fas fa-fire" style="font-size: 1.5rem;"></i>
                <div class="stats-value" id="maiorValor" style="font-size: 1.5rem;">0</div>
                <div class="stats-label" style="font-size: 0.75rem;">Máximo</div>
            </div>
        </div>
    </div>
</div>

<!-- Loading Overlay -->
<div class="loading-overlay" id="loadingOverlay">
    <div class="loading-content" style="min-width: 400px;">
        <div class="spinner"></div>
        <h5>Processando arquivo...</h5>
        <p class="text-muted mb-3">
            Geocodificando endereços e cidades...<br>
            <small>Isso pode levar alguns minutos para arquivos grandes</small>
        </p>
        
        <!-- Barra de Progresso -->
        <div class="progress-container">
            <div class="progress-bar-custom">
                <div class="progress-bar-fill" id="progressBarFill" style="width: 0%">
                    <span id="progressPercent">0%</span>
                </div>
            </div>
            <div class="progress-info">
                <span id="progressCurrent">Linha: 0/0</span>
                <span id="progressMessage">Iniciando...</span>
            </div>
        </div>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>

<script>
    let map;
    let heatLayer;
    let markersLayer;
    let dadosAtuais = [];
    let dadosMacroGlobal = []; // Armazena dados macro para filtros
    let progressInterval = null;
    let filtroAtivo = 'all'; // Filtro ativo
    let tipoVisualizacao = 'micro'; // micro ou macro
    let poligonosCache = {}; // Cache dos polígonos das cidades

    // Função para buscar polígonos das cidades
    async function buscarPoligonosCidades(dados) {
        console.log('🗺️ Buscando polígonos das cidades...');
        
        const cidadesParaBuscar = dados.map(item => ({
            cidade: item.cidade,
            lat: item.lat,
            lng: item.lng
        }));
        
        try {
            const response = await fetch('/logistica/api/mapa_calor/poligonos', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    cidades: cidadesParaBuscar
                })
            });
            
            const result = await response.json();
            
            if (result.status === 'success') {
                poligonosCache = result.poligonos;
                console.log(`✅ ${result.total} polígonos carregados`);
                return true;
            }
        } catch (error) {
            console.error('❌ Erro ao buscar polígonos:', error);
        }
        
        return false;
    }

    // Função para classificar cidade em macro-região
    function classificarMacroRegiao(cidade, lat, lng) {
        const cidadeUpper = cidade.toUpperCase();
        
        // Outras Capitais (fora de SP)
        const outrasCapitais = ['RIO DE JANEIRO', 'BELO HORIZONTE', 'BRASÍLIA', 'SALVADOR', 
                               'FORTALEZA', 'RECIFE', 'PORTO ALEGRE', 'CURITIBA', 'GUARÁ'];
        if (outrasCapitais.includes(cidadeUpper)) {
            return 'Outras Capitais';
        }
        
        // Vale do Paraíba
        if (lat >= -23.4 && lat <= -22.5 && lng >= -46.0 && lng <= -44.7) {
            return 'Vale do Paraíba';
        }
        
        // Litoral Norte
        if (lat < -23.3 && lng >= -46.0 && lng <= -44.7) {
            return 'Litoral Norte';
        }
        
        // Litoral Sul
        if (lat < -23.8 && lng > -47.0) {
            return 'Litoral Sul';
        }
        
        // ABC Paulista
        if (lat >= -23.8 && lat <= -23.5 && lng >= -46.8 && lng <= -46.3) {
            return 'ABC Paulista';
        }
        
        // SP Capital e Região Metropolitana
        if (lat >= -23.8 && lat <= -23.1 && lng >= -46.9 && lng <= -46.0) {
            return 'SP Capital e Região Metropolitana';
        }
        
        // Campinas e Região
        if (lat >= -23.3 && lat <= -22.5 && lng >= -47.5 && lng <= -46.3) {
            return 'Campinas e Região';
        }
        
        // Sorocaba e Região
        if (lat >= -23.8 && lat <= -23.3 && lng >= -47.8 && lng <= -47.2) {
            return 'Sorocaba e Região';
        }
        
        // Interior SP
        if (lat >= -25.0 && lat <= -19.0 && lng >= -52.0 && lng <= -44.0) {
            return 'Interior SP';
        }
        
        return 'Outras Regiões';
    }

    // Cores distintas para cada macro-região
    const coresMacroRegioes = {
        'Vale do Paraíba': '#FF6B6B',           // Vermelho suave
        'Litoral Norte': '#4ECDC4',             // Turquesa
        'Litoral Sul': '#45B7D1',               // Azul claro
        'SP Capital e Região Metropolitana': '#FFA07A', // Laranja claro
        'ABC Paulista': '#98D8C8',              // Verde água
        'Campinas e Região': '#F7DC6F',         // Amarelo
        'Sorocaba e Região': '#BB8FCE',         // Roxo claro
        'Interior SP': '#F8B500',               // Laranja escuro
        'Outras Capitais': '#AED6F1',           // Azul pastel
        'Outras Regiões': '#D5DBDB'             // Cinza claro
    };

    // Função para preparar dados no modo Macro
    // Mantém todas as cidades, mas adiciona info da região
    function prepararDadosMacro(dados) {
        const regioes = {};
        const dadosComRegiao = [];
        
        // Primeiro, calcular totais por região
        dados.forEach(item => {
            const regiao = classificarMacroRegiao(item.cidade, item.lat, item.lng);
            
            if (!regioes[regiao]) {
                regioes[regiao] = {
                    nome: regiao,
                    totalValor: 0,
                    cidades: [],
                    cor: coresMacroRegioes[regiao] || '#999999'
                };
            }
            
            regioes[regiao].totalValor += item.valor;
            regioes[regiao].cidades.push(item.cidade);
        });
        
        // Depois, adicionar info da região a cada cidade
        dados.forEach(item => {
            const regiao = classificarMacroRegiao(item.cidade, item.lat, item.lng);
            const infoRegiao = regioes[regiao];
            
            dadosComRegiao.push({
                ...item,
                macroRegiao: regiao,  // Nome consistente
                regiao: regiao,
                totalRegiao: infoRegiao.totalValor,
                cidadesRegiao: infoRegiao.cidades,
                corRegiao: infoRegiao.cor
            });
        });
        
        return { dadosComRegiao, regioes };
    }

    // Event listeners para mudança de tipo de visualização
    document.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll('input[name="tipoSetor"]').forEach(radio => {
            radio.addEventListener('change', async function() {
                tipoVisualizacao = this.value;
                console.log('🔄 Mudando visualização para:', tipoVisualizacao);
                
                // Alternar legendas E seletor de região
                const microLegend = document.getElementById('microLegend');
                const macroLegend = document.getElementById('macroLegend');
                const regiaoSelector = document.getElementById('regiaoSelector');
                
                if (tipoVisualizacao === 'macro') {
                    microLegend.style.display = 'none';
                    macroLegend.style.display = 'block';
                    regiaoSelector.style.display = 'block';
                } else {
                    microLegend.style.display = 'block';
                    macroLegend.style.display = 'none';
                    regiaoSelector.style.display = 'none';
                }
                
                if (dadosAtuais.length > 0) {
                    if (tipoVisualizacao === 'macro') {
                        // Buscar polígonos se ainda não tiver (CACHE PERMANENTE)
                        if (Object.keys(poligonosCache).length === 0) {
                            const loadingOverlay = document.getElementById('loadingOverlay');
                            const processStatus = document.getElementById('processStatus');
                            const statusMessage = document.getElementById('statusMessage');
                            
                            loadingOverlay.classList.add('show');
                            statusMessage.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Buscando limites das cidades pela primeira vez...<br><small>Aguarde ~1-2 minutos. Próximas vezes será INSTANTÂNEO!</small>';
                            processStatus.className = 'alert alert-info mt-3';
                            processStatus.style.display = 'block';
                            
                            await buscarPoligonosCidades(dadosAtuais);
                            
                            loadingOverlay.classList.remove('show');
                            processStatus.style.display = 'none';
                        }
                        
                        const { dadosComRegiao, regioes } = prepararDadosMacro(dadosAtuais);
                        
                        // Salvar dados macro globalmente para uso nos filtros
                        dadosMacroGlobal = dadosComRegiao;
                        
                        // Aplicar filtro da região selecionada
                        filtrarMacroRegioes();
                    } else {
                        if (filtroAtivo !== 'all') {
                            filtrarPorCor(filtroAtivo);
                        } else {
                            atualizarMapa(dadosAtuais, false);
                            atualizarEstatisticas(dadosAtuais);
                        }
                    }
                }
            });
        });
    });

    // Função para filtrar dados por faixa de valor
    function filtrarPorCor(range) {
        filtroAtivo = range;
        
        // Atualizar botões ativos
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        document.querySelector(`[data-range="${range}"]`).classList.add('active');
        
        // Filtrar dados
        let dadosFiltrados = dadosAtuais;
        let rangeText = 'todas as cidades';
        let count = dadosAtuais.length;
        
        if (range !== 'all') {
            dadosFiltrados = dadosAtuais.filter(item => {
                const valor = item.valor;
                switch(range) {
                    case '0-25':
                        rangeText = '0-25 ocorrências';
                        return valor >= 0 && valor <= 25;
                    case '26-50':
                        rangeText = '26-50 ocorrências';
                        return valor >= 26 && valor <= 50;
                    case '51-75':
                        rangeText = '51-75 ocorrências';
                        return valor >= 51 && valor <= 75;
                    case '76-100':
                        rangeText = '76-100+ ocorrências';
                        return valor >= 76;
                    default:
                        return true;
                }
            });
            count = dadosFiltrados.length;
        }
        
        // Atualizar info do filtro
        document.getElementById('filterInfo').innerHTML = 
            `<i class="fas fa-map-marked-alt me-1"></i>Mostrando <strong>${count}</strong> ${count === 1 ? 'cidade' : 'cidades'} (${rangeText})`;
        
        // Atualizar mapa com dados filtrados
        atualizarMapa(dadosFiltrados);
        
        // Atualizar estatísticas com dados filtrados
        atualizarEstatisticas(dadosFiltrados);
        
        console.log(`🎨 Filtro aplicado: ${range} (${count} cidades)`);
    }

    // Função para filtrar macro-regiões
    function filtrarMacroRegioes() {
        const regiaoSelecionada = document.getElementById('selectRegiao').value;
        
        console.log(`🎯 Filtrando região: ${regiaoSelecionada}`);
        console.log(`📊 Total de dados macro: ${dadosMacroGlobal.length}`);
        
        if (dadosMacroGlobal.length === 0) {
            console.warn('⚠️ Nenhum dado macro disponível ainda!');
            return;
        }
        
        // Filtrar dados macro pela região selecionada
        const dadosFiltrados = dadosMacroGlobal.filter(item => {
            // Normalizar nome da região
            let regiao = item.macroRegiao;
            if (regiao === 'SP Capital e Região Metropolitana') {
                regiao = 'SP Capital e RM';
            }
            return regiao === regiaoSelecionada;
        });
        
        console.log(`🗺️ Região "${regiaoSelecionada}": ${dadosFiltrados.length} cidades`);
        
        if (dadosFiltrados.length === 0) {
            console.warn(`⚠️ Nenhuma cidade encontrada para a região "${regiaoSelecionada}"`);
            console.log('Regiões disponíveis:', [...new Set(dadosMacroGlobal.map(d => d.macroRegiao))]);
        }
        
        // Atualizar mapa
        atualizarMapa(dadosFiltrados, true);
    }

    // Função para atualizar a barra de progresso
    async function atualizarProgresso() {
        try {
            const response = await fetch('/logistica/api/mapa_calor/progresso');
            const progresso = await response.json();
            
            // Atualizar elementos visuais
            const progressBarFill = document.getElementById('progressBarFill');
            const progressPercent = document.getElementById('progressPercent');
            const progressCurrent = document.getElementById('progressCurrent');
            const progressMessage = document.getElementById('progressMessage');
            
            if (progressBarFill && progressPercent && progressCurrent && progressMessage) {
                progressBarFill.style.width = progresso.percentual + '%';
                progressPercent.textContent = progresso.percentual + '%';
                progressCurrent.textContent = `Linha: ${progresso.atual}/${progresso.total}`;
                progressMessage.textContent = progresso.mensagem;
            }
            
            // Se concluído, parar o polling
            if (progresso.concluido) {
                clearInterval(progressInterval);
                progressInterval = null;
            }
            
        } catch (error) {
            console.error('Erro ao buscar progresso:', error);
        }
    }

    // Inicializar mapa
    function initMap() {
        map = L.map('map').setView([-23.5505, -46.6333], 10); // São Paulo como centro inicial

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors',
            maxZoom: 18
        }).addTo(map);

        markersLayer = L.layerGroup().addTo(map);

        console.log('✅ Mapa inicializado');
    }

    // Drag and drop
    const uploadArea = document.getElementById('uploadArea');
    const fileInput = document.getElementById('fileInput');

    uploadArea.addEventListener('click', () => {
        fileInput.click();
    });

    uploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadArea.classList.add('dragover');
    });

    uploadArea.addEventListener('dragleave', () => {
        uploadArea.classList.remove('dragover');
    });

    uploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
        
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            handleFileSelect(files[0]);
        }
    });

    fileInput.addEventListener('change', (e) => {
        if (e.target.files.length > 0) {
            handleFileSelect(e.target.files[0]);
        }
    });

    function handleFileSelect(file) {
        const fileInfo = document.getElementById('fileInfo');
        const fileName = document.getElementById('fileName');
        const fileSize = document.getElementById('fileSize');

        fileName.textContent = file.name;
        fileSize.textContent = `(${(file.size / 1024).toFixed(2)} KB)`;
        fileInfo.classList.add('show');

        // Armazenar arquivo para processar depois
        window.selectedFile = file;
    }

    async function processarArquivo() {
        if (!window.selectedFile) {
            alert('Selecione um arquivo primeiro!');
            return;
        }

        // LIMPAR CACHE DE POLÍGONOS ao importar novo arquivo
        poligonosCache = {};
        console.log('🗑️ Cache de polígonos limpo - novo arquivo sendo importado');

        const loadingOverlay = document.getElementById('loadingOverlay');
        const processStatus = document.getElementById('processStatus');
        const statusMessage = document.getElementById('statusMessage');
        
        loadingOverlay.classList.add('show');
        processStatus.style.display = 'none';

        // Iniciar polling de progresso
        if (progressInterval) {
            clearInterval(progressInterval);
        }
        progressInterval = setInterval(atualizarProgresso, 500); // Atualizar a cada 500ms
        
        // Resetar barra de progresso
        document.getElementById('progressBarFill').style.width = '0%';
        document.getElementById('progressPercent').textContent = '0%';
        document.getElementById('progressCurrent').textContent = 'Linha: 0/0';
        document.getElementById('progressMessage').textContent = 'Enviando arquivo...';

        try {
            const formData = new FormData();
            formData.append('file', window.selectedFile);

            statusMessage.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Enviando arquivo e processando...';
            processStatus.className = 'alert alert-info mt-3';
            processStatus.style.display = 'block';

            const response = await fetch('/logistica/api/mapa_calor/upload', {
                method: 'POST',
                body: formData
            });

            const result = await response.json();

            if (response.ok && result.status === 'success') {
                dadosAtuais = result.dados;
                
                // Resetar filtro para "Todos" quando carregar novos dados
                filtroAtivo = 'all';
                document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
                document.querySelector('[data-range="all"]').classList.add('active');
                document.getElementById('filterInfo').innerHTML = 
                    `<i class="fas fa-map-marked-alt me-1"></i>Mostrando <strong>${result.dados.length}</strong> cidades`;
                
                atualizarMapa(result.dados, false); // false = modo micro
                atualizarEstatisticas(result.dados);
                
                // Mostrar status de sucesso com detalhes
                let mensagem = `<strong>✅ Processamento Concluído!</strong><br>`;
                mensagem += `📍 ${result.dados.length} locais mapeados com sucesso<br>`;
                
                if (result.salvo_bd) {
                    mensagem += `💾 <strong>Dados salvos no sistema!</strong> (ID: ${result.upload_id})<br>`;
                    mensagem += `<small>Você pode carregar novamente clicando em "Carregar Último Upload"</small><br>`;
                }
                
                if (result.total_erros > 0) {
                    mensagem += `<br><strong>⚠️ Atenção:</strong> ${result.total_erros} localização(ões) não foram geocodificadas:<br>`;
                    mensagem += `<small>${result.erros.slice(0, 5).join(', ')}</small>`;
                    if (result.total_erros > 5) {
                        mensagem += `<br><small>... e mais ${result.total_erros - 5}</small>`;
                    }
                    processStatus.className = 'alert alert-warning mt-3';
                } else {
                    processStatus.className = 'alert alert-success mt-3';
                }
                
                statusMessage.innerHTML = mensagem;
                
            } else {
                statusMessage.innerHTML = `<strong>❌ Erro:</strong> ${result.error || 'Erro desconhecido'}`;
                processStatus.className = 'alert alert-danger mt-3';
                processStatus.style.display = 'block';
            }

        } catch (error) {
            console.error('❌ Erro:', error);
            statusMessage.innerHTML = `<strong>❌ Erro ao processar arquivo:</strong> ${error.message}`;
            processStatus.className = 'alert alert-danger mt-3';
            processStatus.style.display = 'block';
        } finally {
            // Parar polling
            if (progressInterval) {
                clearInterval(progressInterval);
                progressInterval = null;
            }
            loadingOverlay.classList.remove('show');
        }
    }

    function atualizarMapa(dados, isMacro = false) {
        // Limpar camadas anteriores
        if (heatLayer) {
            map.removeLayer(heatLayer);
        }
        markersLayer.clearLayers();

        if (dados.length === 0) {
            return;
        }

        // MODO MACRO: Polígonos das cidades (SEM marcadores)
        if (isMacro) {
            // Cor única padrão para todas as cidades da região selecionada
            const corPadrao = '#2E86DE'; // Azul vibrante que destaca no mapa
            
            dados.forEach(item => {
                const poligono = poligonosCache[item.cidade];
                
                if (poligono) {
                    // Desenhar polígono GeoJSON com cor única
                    const geoJsonLayer = L.geoJSON(poligono, {
                        style: {
                            color: corPadrao,
                            weight: 2.5,
                            opacity: 0.8,
                            fillColor: corPadrao,
                            fillOpacity: 0.3
                        }
                    });
                    
                    // Popup ao clicar no polígono
                    geoJsonLayer.bindPopup(`
                        <div style="text-align: center; min-width: 200px;">
                            <div style="background: ${corPadrao}; color: white; padding: 8px; margin: -10px -10px 10px -10px; border-radius: 3px 3px 0 0;">
                                <h6 style="margin: 0; font-weight: bold;">
                                    <i class="fas fa-map-marker-alt"></i> ${item.cidade}
                                </h6>
                            </div>
                            <div style="padding: 5px;">
                                <p style="margin: 5px 0; font-size: 13px;">
                                    <strong>📊 Ocorrências:</strong> ${item.valor.toLocaleString('pt-BR')}
                                </p>
                                <hr style="margin: 8px 0; border-color: #ddd;">
                                <p style="margin: 5px 0; font-size: 12px; color: #666;">
                                    <strong>�️ Região:</strong> ${item.macroRegiao}
                                </p>
                            </div>
                        </div>
                    `);
                    
                    geoJsonLayer.addTo(markersLayer);
                } else {
                    console.warn(`⚠️ Polígono não encontrado para: ${item.cidade}`);
                }
            });
            
        } else {
            // MODO MICRO: Mapa de calor normal
            const heatData = dados.map(item => [
                item.lat,
                item.lng,
                item.valor
            ]);

            heatLayer = L.heatLayer(heatData, {
                radius: 25,
                blur: 15,
                maxZoom: 13,
                max: 100,
                gradient: {
                    0.0: '#00ff00',
                    0.25: '#ffff00',
                    0.50: '#ff7700',
                    0.75: '#ff0000',
                    1.0: '#ff0000'
                }
            }).addTo(map);

            // Marcadores normais
            dados.forEach(item => {
                const marker = L.circleMarker([item.lat, item.lng], {
                    radius: 8,
                    fillColor: getColor(item.valor, Math.max(...dados.map(d => d.valor))),
                    color: '#fff',
                    weight: 2,
                    opacity: 1,
                    fillOpacity: 0.8
                });

                marker.bindPopup(`
                    <div style="text-align: center;">
                        <h6 style="margin: 0 0 10px 0; color: #2a5298;">
                            <i class="fas fa-map-marker-alt"></i> ${item.cidade || item.nome}
                        </h6>
                        <p style="margin: 0; font-size: 14px;">
                            <strong>Ocorrências:</strong> ${item.valor.toLocaleString('pt-BR')}
                        </p>
                    </div>
                `);

                marker.addTo(markersLayer);
            });
        }

        // Ajustar zoom para mostrar todos os pontos
        const bounds = L.latLngBounds(dados.map(d => [d.lat, d.lng]));
        map.fitBounds(bounds, { padding: [50, 50] });

        const tipoMapa = isMacro ? 'cidades com círculos por região' : 'cidades com mapa de calor';
        console.log(`✅ Mapa atualizado: ${dados.length} ${tipoMapa}`);
    }

    function getColor(valor, maxValor) {
        // ESCALA FIXA: 0-100 dividida em 4 partes (25 cada)
        // Acima de 100 = vermelho sempre
        if (valor > 100) return '#ff0000';      // VERMELHO: > 100
        if (valor > 75) return '#ff0000';       // VERMELHO: 76-100
        if (valor > 50) return '#ff7700';       // LARANJA: 51-75
        if (valor > 25) return '#ffff00';       // AMARELO: 26-50
        return '#00ff00';                       // VERDE: 1-25
    }

    function atualizarEstatisticas(dados) {
        const statsRow = document.getElementById('statsRow');
        statsRow.style.display = 'flex';

        const totalLocais = dados.length;
        const valores = dados.map(d => d.valor);
        const totalValor = valores.reduce((a, b) => a + b, 0);
        const mediaValor = totalValor / totalLocais;
        const maiorValor = Math.max(...valores);

        // Formatar números - usar separador de milhar apenas para valores grandes
        function formatarNumero(num) {
            if (num >= 1000) {
                return num.toLocaleString('pt-BR', {
                    minimumFractionDigits: 0,
                    maximumFractionDigits: 0
                });
            }
            return num.toFixed(0);
        }

        // Formatar com decimais para média se necessário
        function formatarMedia(num) {
            if (num >= 1000) {
                return num.toLocaleString('pt-BR', {
                    minimumFractionDigits: 0,
                    maximumFractionDigits: 0
                });
            } else if (num >= 100) {
                return num.toFixed(0);
            } else if (num >= 10) {
                return num.toFixed(1);
            } else {
                return num.toFixed(2);
            }
        }

        document.getElementById('totalLocais').textContent = formatarNumero(totalLocais);
        document.getElementById('totalValor').textContent = formatarNumero(totalValor);
        document.getElementById('mediaValor').textContent = formatarMedia(mediaValor);
        document.getElementById('maiorValor').textContent = formatarNumero(maiorValor);
    }

    async function carregarUltimoUpload() {
        const processStatus = document.getElementById('processStatus');
        const statusMessage = document.getElementById('statusMessage');
        
        processStatus.style.display = 'none';
        
        try {
            statusMessage.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Carregando dados salvos...';
            processStatus.className = 'alert alert-info mt-3';
            processStatus.style.display = 'block';
            
            const response = await fetch('/logistica/api/mapa_calor/carregar_ultimo');
            const result = await response.json();
            
            if (response.ok && result.status === 'success') {
                dadosAtuais = result.dados;
                
                // Resetar filtro para "Todos" quando carregar dados salvos
                filtroAtivo = 'all';
                document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
                document.querySelector('[data-range="all"]').classList.add('active');
                document.getElementById('filterInfo').innerHTML = 
                    `<i class="fas fa-map-marked-alt me-1"></i>Mostrando <strong>${result.dados.length}</strong> cidades`;
                
                atualizarMapa(result.dados, false); // false = modo micro
                atualizarEstatisticas(result.dados);
                
                const dataUpload = new Date(result.info.data_upload).toLocaleString('pt-BR');
                
                statusMessage.innerHTML = `
                    <strong>✅ Dados Carregados!</strong><br>
                    📁 Arquivo: ${result.info.nome_arquivo}<br>
                    📅 Upload: ${dataUpload}<br>
                    📍 ${result.info.total_locais} locais mapeados
                `;
                processStatus.className = 'alert alert-success mt-3';
                
            } else {
                statusMessage.innerHTML = `<strong>⚠️ Aviso:</strong> ${result.message || 'Nenhum dado salvo encontrado'}`;
                processStatus.className = 'alert alert-warning mt-3';
            }
            
        } catch (error) {
            console.error('❌ Erro:', error);
            statusMessage.innerHTML = `<strong>❌ Erro:</strong> ${error.message}`;
            processStatus.className = 'alert alert-danger mt-3';
        }
        
        processStatus.style.display = 'block';
    }

    function limparMapa() {
        if (confirm('Deseja realmente limpar o mapa?')) {
            if (heatLayer) {
                map.removeLayer(heatLayer);
            }
            markersLayer.clearLayers();
            dadosAtuais = [];
            
            document.getElementById('statsRow').style.display = 'none';
            document.getElementById('fileInfo').classList.remove('show');
            document.getElementById('fileInput').value = '';
            window.selectedFile = null;

            map.setView([-23.5505, -46.6333], 10);
            
            console.log('🗑️ Mapa limpo');
        }
    }

    // Função de Fullscreen
    function toggleFullscreen() {
        const mapCard = document.getElementById('mapCard');
        const fullscreenIcon = document.getElementById('fullscreenIcon');
        
        if (mapCard.classList.contains('fullscreen')) {
            // Sair do fullscreen
            mapCard.classList.remove('fullscreen');
            fullscreenIcon.classList.remove('fa-compress');
            fullscreenIcon.classList.add('fa-expand');
        } else {
            // Entrar em fullscreen
            mapCard.classList.add('fullscreen');
            fullscreenIcon.classList.remove('fa-expand');
            fullscreenIcon.classList.add('fa-compress');
        }
        
        // Atualizar tamanho do mapa
        setTimeout(() => {
            map.invalidateSize();
        }, 100);
    }

    // Tecla ESC para sair do fullscreen
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            const mapCard = document.getElementById('mapCard');
            const fullscreenIcon = document.getElementById('fullscreenIcon');
            if (mapCard.classList.contains('fullscreen')) {
                mapCard.classList.remove('fullscreen');
                fullscreenIcon.classList.remove('fa-compress');
                fullscreenIcon.classList.add('fa-expand');
                map.invalidateSize();
            }
        }
    });

    // Inicializar quando a página carregar
    document.addEventListener('DOMContentLoaded', function() {
        console.log('🚀 Inicializando Mapa de Calor...');
        initMap();
        
        // CARREGAR AUTOMATICAMENTE dados do banco ao abrir a página
        console.log('📥 Carregando dados salvos automaticamente...');
        setTimeout(() => {
            carregarUltimoUpload();
        }, 500); // Aguarda 500ms para garantir que mapa foi inicializado
    });
</script>

{% endblock %}
