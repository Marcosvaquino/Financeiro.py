{% extends "base.html" %}

{% block title %}Monitoramento Log√≠stico{% endblock %}

{% block extra_css %}
<style>
    .monitoring-container {
        padding: 20px;
        max-width: 1400px;
        margin: 0 auto;
    }

    .monitoring-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 30px;
        border-radius: 12px;
        margin-bottom: 30px;
        box-shadow: 0 8px 32px rgba(102, 126, 234, 0.3);
    }

    .monitoring-header h1 {
        font-size: 2.5rem;
        font-weight: 700;
        margin: 0;
        text-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }

    .status-cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }

    .status-card {
        background: white;
        padding: 25px;
        border-radius: 12px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        transition: transform 0.3s ease;
    }

    .status-card:hover {
        transform: translateY(-5px);
    }

    .card-value {
        font-size: 2.5rem;
        font-weight: 700;
        margin: 10px 0;
    }

    .data-section {
        background: white;
        border-radius: 12px;
        padding: 25px;
        margin-bottom: 20px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }

    .table-responsive {
        max-height: 500px;
        overflow-y: auto;
    }

    .badge {
        font-size: 0.8rem;
    }

    .loading {
        text-align: center;
        padding: 40px;
        color: #666;
    }

    .error {
        background: #f8d7da;
        color: #721c24;
        padding: 15px;
        border-radius: 8px;
        margin: 10px 0;
    }

    .success {
        background: #d4edda;
        color: #155724;
        padding: 15px;
        border-radius: 8px;
        margin: 10px 0;
    }
</style>
{% endblock %}
        margin: 10px 0 0 0;
        opacity: 0.9;
    }

    .status-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }

    .status-card {
        background: white;
        padding: 25px;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        border: 1px solid #e9ecef;
        transition: all 0.3s ease;
    }

    .status-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 30px rgba(0,0,0,0.12);
    }

    .status-card h3 {
        font-size: 0.9rem;
        font-weight: 600;
        text-transform: uppercase;
        color: #6c757d;
        margin: 0 0 10px 0;
        letter-spacing: 0.5px;
    }

    .status-value {
        font-size: 2rem;
        font-weight: 700;
        margin: 0;
        color: #495057;
    }

    .status-online {
        color: #28a745;
    }

    .status-offline {
        color: #dc3545;
    }

    .status-warning {
        color: #ffc107;
    }

    .data-table-container {
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        overflow: hidden;
        margin-bottom: 30px;
    }

    .table-header {
        background: #f8f9fa;
        padding: 20px;
        border-bottom: 1px solid #dee2e6;
    }

    .table-header h2 {
        margin: 0;
        font-size: 1.3rem;
        font-weight: 600;
        color: #495057;
    }

    .data-table {
        width: 100%;
        border-collapse: collapse;
    }

    .data-table th,
    .data-table td {
        padding: 12px 15px;
        text-align: left;
        border-bottom: 1px solid #e9ecef;
    }

    .data-table th {
        background: #f8f9fa;
        font-weight: 600;
        color: #495057;
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .data-table tbody tr:hover {
        background: #f8f9fa;
    }

    .loading {
        text-align: center;
        padding: 40px;
        color: #6c757d;
    }

    .loading-spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #667eea;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        animation: spin 1s linear infinite;
        margin: 0 auto 20px auto;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .auto-refresh {
        display: flex;
        align-items: center;
        gap: 10px;
        margin: 20px 0;
        padding: 15px;
        background: #e8f4fd;
        border: 1px solid #bee5eb;
        border-radius: 8px;
        color: #0c5460;
    }

    .refresh-indicator {
        width: 12px;
        height: 12px;
        background: #28a745;
        border-radius: 50%;
        animation: pulse 2s infinite;
    }

    @keyframes pulse {
        0% { opacity: 1; }
        50% { opacity: 0.5; }
        100% { opacity: 1; }
    }

    .error-message {
        background: #f8d7da;
        color: #721c24;
        padding: 15px;
        border-radius: 8px;
        border: 1px solid #f5c6cb;
        margin: 20px 0;
    }

    .chart-container {
        background: white;
        border-radius: 12px;
        padding: 25px;
        margin-bottom: 30px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.08);
    }

    .btn-control {
        background: #667eea;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 500;
        transition: all 0.3s ease;
    }

    .btn-control:hover {
        background: #5a6fd8;
        transform: translateY(-1px);
    }
</style>
{% endblock %}

{% block content %}
<div class="monitoring-container">
    <div class="monitoring-header">
        <h1><i class="fas fa-radar-chart me-3"></i>Monitoramento Log√≠stico</h1>
        <p>Acompanhamento em tempo real dos dados log√≠sticos via Google Sheets</p>
    </div>

    <div class="auto-refresh">
        <div class="refresh-indicator"></div>
        <span><strong>Auto-atualiza√ß√£o ativa:</strong> Dados s√£o atualizados automaticamente a cada 2 minutos</span>
        <button class="btn-control ms-auto" onclick="forceRefresh()">
            <i class="fas fa-sync-alt me-2"></i>Atualizar Agora
        </button>
    </div>

    <!-- Status Cards -->
    <div class="status-grid">
        <div class="status-card">
            <h3>Status da Conex√£o</h3>
            <p class="status-value" id="connection-status">
                <i class="fas fa-spinner fa-spin"></i> Verificando...
            </p>
        </div>
        
        <div class="status-card">
            <h3>√öltima Atualiza√ß√£o</h3>
            <p class="status-value" id="last-update">--:--</p>
        </div>
        
        <div class="status-card">
            <h3>Total de Registros</h3>
            <p class="status-value" id="record-count">0</p>
        </div>
        
        <div class="status-card">
            <h3>Frequ√™ncia</h3>
            <p class="status-value">2 min</p>
        </div>
    </div>

    <!-- Dados em Tempo Real -->
    <div class="data-table-container">
        <div class="table-header">
            <h2><i class="fas fa-table me-2"></i>Dados em Tempo Real</h2>
        </div>
        <div id="data-content">
            <div class="loading">
                <div class="loading-spinner"></div>
                <p>Carregando dados...</p>
            </div>
        </div>
    </div>

    <!-- Gr√°fico de Monitoramento -->
    <div class="chart-container">
        <h2><i class="fas fa-chart-line me-2"></i>Hist√≥rico de Atualiza√ß√µes</h2>
        <canvas id="monitoring-chart" width="400" height="200"></canvas>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Aguardar carregamento do Chart.js
function loadChartJS() {
    return new Promise((resolve, reject) => {
        if (typeof Chart !== 'undefined') {
            resolve();
            return;
        }
        
        const script = document.createElement('script');
        script.src = 'https://cdn.jsdelivr.net/npm/chart.js';
        script.onload = resolve;
        script.onerror = reject;
        document.head.appendChild(script);
    });
}

let monitoringChart;
let updateInterval;

document.addEventListener('DOMContentLoaded', async function() {
    console.log('üöÄ DOM carregado, inicializando monitoramento...');
    
    try {
        // Aguardar Chart.js carregar
        await loadChartJS();
        console.log('‚úÖ Chart.js carregado');
        
        // Testar API diretamente primeiro
        console.log('üß™ Testando conex√£o com API...');
        try {
            const testResponse = await fetch('/logistica/api/monitoramento/dados');
            console.log('üì¶ Status da API:', testResponse.status, testResponse.statusText);
            
            if (testResponse.ok) {
                const testData = await testResponse.json();
                console.log('‚úÖ Dados da API:', {
                    status: testData.status,
                    count: testData.count || testData.dados?.length || 0,
                    hasData: !!testData.dados || !!testData.data
                });
                
                // For√ßar atualiza√ß√£o imediata
                forceUpdateInterface(testData);
            } else {
                console.error('‚ùå API retornou erro HTTP:', testResponse.status);
            }
        } catch (apiError) {
            console.error('‚ùå Erro ao conectar com API:', apiError);
        }
        
        initializeChart();
        await loadMonitoringData();
        
        // Auto-refresh a cada 30 segundos
        updateInterval = setInterval(loadMonitoringData, 30000);
        console.log('‚úÖ Intervalo de atualiza√ß√£o configurado.');
    } catch (error) {
        console.error('‚ùå Erro na inicializa√ß√£o:', error);
    }
});

function forceUpdateInterface(data) {
    console.log('üîß For√ßando atualiza√ß√£o da interface...');
    
    try {
        // Remover todos os loadings
        const loadingElements = document.querySelectorAll('.loading-placeholder');
        loadingElements.forEach(el => {
            el.style.display = 'none';
            console.log('ü´• Loading removido');
        });
        
        // Atualizar cards b√°sicos
        const totalElement = document.getElementById('record-count');
        if (totalElement) {
            const count = data.count || data.dados?.length || data.data?.length || 0;
            totalElement.textContent = count;
            console.log('üî¢ Total atualizado para:', count);
        }
        
        const statusElement = document.getElementById('connection-status');
        if (statusElement) {
            statusElement.textContent = 'Conectado ‚úÖ';
            statusElement.className = 'badge bg-success';
            console.log('üü¢ Status atualizado para conectado');
        }
        
        const updateElement = document.getElementById('last-update');
        if (updateElement) {
            updateElement.textContent = new Date().toLocaleString('pt-BR');
            console.log('‚è∞ Timestamp atualizado');
        }
        
        // Mostrar dados b√°sicos na tabela
        const tableBody = document.querySelector('#monitoring-table tbody');
        if (tableBody && (data.dados || data.data)) {
            const dados = data.dados || data.data || [];
            let html = '';
            
            dados.slice(0, 10).forEach((item, index) => {
                html += `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${item.Cidade || 'N/A'}</td>
                        <td>${item.Cliente || 'N/A'}</td>
                        <td>${item.Documento || 'N/A'}</td>
                        <td><span class="badge bg-primary">${item['Status viagem'] || 'N/A'}</span></td>
                        <td>${item.Transportadora || 'N/A'}</td>
                    </tr>
                `;
            });
            
            tableBody.innerHTML = html;
            console.log('üìã Tabela atualizada com', dados.slice(0, 10).length, 'registros');
        }
        
    } catch (error) {
        console.error('‚ùå Erro ao for√ßar atualiza√ß√£o:', error);
    }
}

function initializeChart() {
    console.log('üìä Inicializando gr√°fico...');
    
    try {
        if (typeof Chart === 'undefined') {
            throw new Error('Chart.js n√£o est√° dispon√≠vel');
        }
        
        const canvas = document.getElementById('monitoring-chart');
        if (!canvas) {
            throw new Error('Canvas n√£o encontrado');
        }
        
        const ctx = canvas.getContext('2d');
        console.log('‚úÖ Canvas encontrado e contexto criado');
        
        monitoringChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'Registros Coletados',
                    data: [],
                    borderColor: '#667eea',
                    backgroundColor: 'rgba(102, 126, 234, 0.1)',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'N√∫mero de Registros'
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'Hor√°rio'
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: true,
                        position: 'top'
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false
                    }
                }
            }
        });
        
        console.log('‚úÖ Gr√°fico inicializado com sucesso');
    } catch (error) {
        console.error('‚ùå Erro ao inicializar gr√°fico:', error);
    }
}

async function loadMonitoringData() {
    console.log('üöÄ [DEBUG] Iniciando carregamento dos dados...');
    try {
        console.log('üì° [DEBUG] Fazendo requisi√ß√£o para /logistica/api/monitoramento/dados');
        // Carrega dados atuais
        const currentResponse = await fetch('/logistica/api/monitoramento/dados');
        console.log('üì¶ [DEBUG] Resposta recebida - Status:', currentResponse.status, 'OK:', currentResponse.ok);
        
        if (!currentResponse.ok) {
            console.error('‚ùå [DEBUG] Resposta n√£o OK:', currentResponse.statusText);
            throw new Error(`HTTP ${currentResponse.status}: ${currentResponse.statusText}`);
        }
        
        console.log('üìÑ [DEBUG] Parseando JSON dos dados atuais...');
        const currentData = await currentResponse.json();
        console.log('‚úÖ [DEBUG] Dados atuais recebidos:', {
            status: currentData.status,
            count: currentData.count,
            hasData: !!currentData.dados,
            dataLength: currentData.dados ? currentData.dados.length : 0
        });
        
        console.log('üîÑ [DEBUG] Atualizando status cards...');
        updateStatusCards(currentData);
        console.log('‚úÖ [DEBUG] Status cards atualizados');
        
        console.log('üìã [DEBUG] Atualizando tabela...');
        updateDataTable(currentData);
        console.log('‚úÖ [DEBUG] Tabela atualizada');
        
        console.log('üìà [DEBUG] Fazendo requisi√ß√£o para hist√≥rico...');
        // Carrega hist√≥rico para o gr√°fico
        const historyResponse = await fetch('/logistica/api/monitoramento/historico');
        console.log('üì¶ [DEBUG] Resposta hist√≥rico - Status:', historyResponse.status);
        
        const historyData = await historyResponse.json();
        console.log('üìä [DEBUG] Dados hist√≥ricos recebidos:', historyData);
        
        console.log('üìà [DEBUG] Atualizando gr√°fico...');
        updateChart(historyData);
        console.log('‚úÖ [DEBUG] Gr√°fico atualizado');
        
    } catch (error) {
        console.error('‚ùå [DEBUG] Erro completo ao carregar dados:', error);
        console.error('‚ùå [DEBUG] Stack trace:', error.stack);
        showError('Erro ao carregar dados de monitoramento: ' + error.message);
    }
}

function updateStatusCards(data) {
    console.log('üîÑ Atualizando cards de status...', data);
    
    try {
        const connectionStatus = document.getElementById('connection-status');
        const lastUpdate = document.getElementById('last-update');
        const recordCount = document.getElementById('record-count');
        
        if (!connectionStatus || !lastUpdate || !recordCount) {
            console.error('‚ùå Elementos de status n√£o encontrados');
            return;
        }
        
        if (data.status === 'success') {
            connectionStatus.innerHTML = '<i class="fas fa-check-circle"></i> Online';
            connectionStatus.className = 'status-value status-online';
        } else {
            connectionStatus.innerHTML = '<i class="fas fa-exclamation-triangle"></i> ' + (data.status || 'Erro');
            connectionStatus.className = 'status-value status-offline';
        }
        
        if (data.timestamp) {
            const timestamp = new Date(data.timestamp);
            lastUpdate.textContent = timestamp.toLocaleTimeString('pt-BR');
        } else {
            lastUpdate.textContent = '--:--';
        }
        
        recordCount.textContent = data.count || 0;
        console.log('‚úÖ Cards atualizados - Status:', data.status, 'Registros:', data.count);
        
    } catch (error) {
        console.error('‚ùå Erro ao atualizar cards:', error);
    }
}

function updateDataTable(data) {
    const container = document.getElementById('data-content');
    
    if (!data.data || data.data.length === 0) {
        container.innerHTML = `
            <div class="loading">
                <i class="fas fa-inbox" style="font-size: 3rem; color: #6c757d; margin-bottom: 15px;"></i>
                <p>Nenhum dado dispon√≠vel</p>
            </div>
        `;
        return;
    }
    
    // Cria tabela dinamicamente baseada nos dados
    const headers = Object.keys(data.data[0]);
    
    let tableHtml = `
        <table class="data-table">
            <thead>
                <tr>
                    ${headers.map(header => `<th>${header}</th>`).join('')}
                </tr>
            </thead>
            <tbody>
                ${data.data.slice(0, 10).map(row => `
                    <tr>
                        ${headers.map(header => `<td>${row[header] || '-'}</td>`).join('')}
                    </tr>
                `).join('')}
            </tbody>
        </table>
    `;
    
    if (data.data.length > 10) {
        tableHtml += `<div style="padding: 15px; text-align: center; color: #6c757d;">
            Mostrando 10 de ${data.data.length} registros
        </div>`;
    }
    
    container.innerHTML = tableHtml;
}

function updateChart(historyData) {
    if (!historyData || historyData.length === 0) return;
    
    const labels = historyData.slice(-20).reverse().map(item => {
        const date = new Date(item.timestamp);
        return date.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
    });
    
    const data = historyData.slice(-20).reverse().map(item => item.count || 0);
    
    monitoringChart.data.labels = labels;
    monitoringChart.data.datasets[0].data = data;
    monitoringChart.update();
}

function showError(message) {
    const container = document.getElementById('data-content');
    container.innerHTML = `
        <div class="error-message">
            <i class="fas fa-exclamation-triangle me-2"></i>
            ${message}
        </div>
    `;
}

function forceRefresh() {
    console.log('üîÑ For√ßando atualiza√ß√£o...');
    const button = event.target;
    const originalText = button.innerHTML;
    
    button.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Atualizando...';
    button.disabled = true;
    
    loadMonitoringData().then(() => {
        setTimeout(() => {
            button.innerHTML = originalText;
            button.disabled = false;
            console.log('‚úÖ Atualiza√ß√£o for√ßada conclu√≠da');
        }, 1000);
    }).catch(error => {
        console.error('‚ùå Erro na atualiza√ß√£o for√ßada:', error);
        button.innerHTML = originalText;
        button.disabled = false;
    });
}

// Cleanup quando sair da p√°gina
window.addEventListener('beforeunload', function() {
    if (updateInterval) {
        clearInterval(updateInterval);
        console.log('üßπ Intervalo de atualiza√ß√£o limpo');
    }
});
</script>
{% endblock %}