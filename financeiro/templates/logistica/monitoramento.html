{% extends "base.html" %}

{% block title %}Dashboard Logístico{% endblock %}

{% block content %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
        body {
            background: #e3e3e3 !important;
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .content {
            background: #e3e3e3 !important;
        }

        .main-container {
            padding: 20px;
            min-height: 100vh;
        }

        .dashboard-header {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }

        .card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            border: none;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 50px rgba(0, 0, 0, 0.15);
        }

        .metric-card {
            text-align: center;
            cursor: pointer;
            height: 80px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            padding: 10px;
        }

        .metric-icon {
            font-size: 1.3rem;
            margin-bottom: 4px;
        }

        .metric-value {
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 2px;
        }

        .metric-label {
            color: #6c757d;
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .chart-container {
            position: relative;
            height: 400px;
            padding: 20px;
        }

        .map-container {
            height: 400px;
            border-radius: 15px;
            overflow: hidden;
        }

        .custom-marker {
            background: transparent !important;
            border: none !important;
        }

        .custom-pin-simple {
            background: transparent !important;
            border: none !important;
        }

        .pin-simple {
            animation: pinBounce 1.5s ease-in-out infinite;
        }

        .pin-simple:hover {
            animation-play-state: paused;
            transform: scale(1.1);
        }

        @keyframes pinBounce {
            0%, 100% {
                transform: translateY(0);
            }
            50% {
                transform: translateY(-3px);
            }
        }

        .custom-pin-marker {
            background: transparent !important;
            border: none !important;
        }

        .pin-marker {
            animation: gentleBounce 3s ease-in-out infinite;
        }

        .pin-head {
            transition: all 0.3s ease;
        }

        .pin-marker:hover .pin-head {
            transform: rotate(-45deg) scale(1.15);
            filter: brightness(1.2);
        }

        @keyframes gentleBounce {
            0%, 100% {
                transform: translateY(0);
            }
            50% {
                transform: translateY(-3px);
            }
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% {
                transform: translateY(0);
            }
            40% {
                transform: translateY(-5px);
            }
            60% {
                transform: translateY(-3px);
            }
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .filter-section {
            background: #434343;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 25px;
            backdrop-filter: blur(10px);
        }

        .ranking-item {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: between;
            align-items: center;
        }

        .ranking-position {
            font-size: 1.5rem;
            font-weight: bold;
            width: 40px;
        }

        .text-gold { color: #ffd700; }
        .text-silver { color: #c0c0c0; }
        .text-bronze { color: #cd7f32; }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }

        .status-entregue { background-color: #28a745; }
        .status-entrega { background-color: #ffc107; }
        .status-agendada { background-color: #17a2b8; }
        .status-anomalia { background-color: #dc3545; }

        .last-update {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.9);
            padding: 10px 15px;
            border-radius: 25px;
            font-size: 0.9rem;
            color: #666;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            z-index: 1000;
        }

        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
        }

        .spinner-border {
            color: #2a5298;
        }

        .progress-custom {
            height: 8px;
            border-radius: 10px;
            background-color: #e9ecef;
        }

        .progress-bar-custom {
            border-radius: 10px;
        }

        .text-primary { color: #2a5298 !important; }
        .text-success { color: #28a745 !important; }
        .text-warning { color: #ffc107 !important; }
        .text-info { color: #17a2b8 !important; }
        .text-danger { color: #dc3545 !important; }

        .form-select, .form-control {
            border-radius: 10px;
            border: 2px solid rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.9);
        }

        .btn {
            border-radius: 10px;
            padding: 10px 20px;
            font-weight: 600;
        }

        .table-responsive {
            border-radius: 15px;
            overflow: hidden;
        }

        .table th {
            background-color: #2a5298;
            color: white;
            border: none;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.85rem;
        }

        .table td {
            border: none;
            vertical-align: middle;
            padding: 12px;
        }

        .table tbody tr:nth-child(even) {
            background-color: rgba(0, 0, 0, 0.02);
        }

        .card-header {
            background: #434343 !important;
            color: white !important;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1) !important;
        }

        .card-header h5 {
            color: white !important;
        }

        /* Aplicar apenas nos cards de ranking */
        #rankingMelhores, #rankingPiores {
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            min-height: 300px;
        }

        #rankingMelhores .ranking-item, 
        #rankingPiores .ranking-item {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex: 1;
        }

        #rankingMelhores .ranking-item:last-child,
        #rankingPiores .ranking-item:last-child {
            margin-bottom: 0;
        }
    </style>

    <div class="main-container">
        <!-- Header -->
        <div class="dashboard-header">
            <div class="row align-items-center">
                <div class="col">
                    <h1 class="mb-0">
                        <i class="fas fa-map-marked-alt text-primary"></i>
                        Dashboard Logístico
                    </h1>
                    <p class="mb-0 text-muted">Monitoramento completo de operações - Atualização automática</p>
                </div>
                <div class="col-auto">
                    <button class="btn btn-primary" onclick="atualizarDados()">
                        <i class="fas fa-sync-alt"></i> Atualizar
                    </button>
                </div>
            </div>
        </div>

        <!-- Indicador de última atualização -->
        <div class="last-update" id="lastUpdate">
            <i class="fas fa-clock"></i> Carregando...
        </div>

        <!-- Filtros -->
        <div class="filter-section">
            <div class="row">
                <div class="col-md-4">
                    <label class="form-label text-white">
                        <i class="fas fa-layer-group"></i> Tipologia
                    </label>
                    <select class="form-select" id="filtroTipologia">
                        <option value="">Todas</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label class="form-label text-white">
                        <i class="fas fa-user-tag"></i> Perfil
                    </label>
                    <select class="form-select" id="filtroPerfil">
                        <option value="">Todos</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label class="form-label text-white">
                        <i class="fas fa-building"></i> Embarcador
                    </label>
                    <select class="form-select" id="filtroEmbarcador">
                        <option value="">Todos</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Cards de Resumo -->
        <div class="row mb-4">
            <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
                <div class="card metric-card">
                    <div class="card-body">
                        <div class="metric-icon text-primary">
                            <i class="fas fa-truck"></i>
                        </div>
                        <div class="metric-value text-primary" id="totalEntregas">0</div>
                        <div class="metric-label">Total Entregas</div>
                    </div>
                </div>
            </div>
            <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
                <div class="card metric-card">
                    <div class="card-body">
                        <div class="metric-icon text-success">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <div class="metric-value text-success" id="totalEntregues">0</div>
                        <div class="metric-label">Entregues</div>
                    </div>
                </div>
            </div>
            <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
                <div class="card metric-card">
                    <div class="card-body">
                        <div class="metric-icon text-warning">
                            <i class="fas fa-clock"></i>
                        </div>
                        <div class="metric-value text-warning" id="totalTransito">0</div>
                        <div class="metric-label">Em Trânsito</div>
                    </div>
                </div>
            </div>
            <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
                <div class="card metric-card">
                    <div class="card-body">
                        <div class="metric-icon text-info">
                            <i class="fas fa-city"></i>
                        </div>
                        <div class="metric-value text-info" id="totalCidades">0</div>
                        <div class="metric-label">Cidades</div>
                    </div>
                </div>
            </div>
            <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
                <div class="card metric-card">
                    <div class="card-body">
                        <div class="metric-icon text-secondary">
                            <i class="fas fa-truck-loading"></i>
                        </div>
                        <div class="metric-value text-secondary" id="totalVeiculos">0</div>
                        <div class="metric-label">Veículos</div>
                    </div>
                </div>
            </div>
            <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
                <div class="card metric-card">
                    <div class="card-body">
                        <div class="metric-icon text-danger">
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                        <div class="metric-value text-danger" id="totalAnomalias">0</div>
                        <div class="metric-label">Anomalias</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Mapa e Rankings -->
        <div class="row mb-4">
            <div class="col-lg-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-map-marked-alt text-primary"></i> 
                            Mapa de Operações
                        </h5>
                    </div>
                    <div class="card-body p-0">
                        <div id="mapa" class="map-container"></div>
                    </div>
                </div>
            </div>
            <div class="col-lg-3">
                <div class="card h-100">
                    <div class="card-header">
                        <h5 class="mb-0" style="font-size: 0.9rem;">
                            <i class="fas fa-trophy text-warning"></i> 
                            Top 5 Placas - Melhores
                        </h5>
                      
                    </div>
                    <div class="card-body" id="rankingMelhores">
                        <div class="loading">
                            <div class="spinner-border" role="status"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-3">
                <div class="card h-100">
                    <div class="card-header">
                        <h5 class="mb-0" style="font-size: 0.9rem;">
                            <i class="fas fa-exclamation-circle text-danger"></i> 
                            Top 5 Placas - Atenção
                        </h5>
                    </div>
                    <div class="card-body" id="rankingPiores">
                        <div class="loading">
                            <div class="spinner-border" role="status"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Gráficos -->
        <div class="row mb-4">
            <div class="col-lg-8">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-weight text-primary"></i> 
                            Peso por Embarcador - Realizado vs Entregue
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="pesoEmbarcadorChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-chart-pie text-primary"></i> 
                            Status das Entregas
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="statusChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tabela Detalhada -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-table text-primary"></i> 
                    Detalhamento de Entregas
                </h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Status</th>
                                <th>Cidade</th>
                                <th>Cliente</th>
                                <th>Placa</th>
                                <th>Embarcador</th>
                                <th>Peso (kg)</th>
                                <th>Última Atualização</th>
                            </tr>
                        </thead>
                        <tbody id="tabelaDados">
                            <tr>
                                <td colspan="7" class="text-center">
                                    <div class="loading">
                                        <div class="spinner-border" role="status">
                                            <span class="visually-hidden">Carregando...</span>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        let mapa, statusChart, pesoEmbarcadorChart;
        let dados = [];
        let dadosFiltrados = [];

        // Função para buscar dados
        async function buscarDados() {
            try {
                console.log('Buscando dados...');
                const response = await fetch('/logistica/api/monitoramento/dados');
                const result = await response.json();
                
                console.log('Resposta da API:', result);
                
                if (result.status === 'success') {
                    dados = result.data;
                    dadosFiltrados = [...dados];
                    inicializarFiltros();
                    atualizarDashboard();
                    atualizarTimestamp();
                } else {
                    console.error('Erro na resposta:', result);
                }
            } catch (error) {
                console.error('Erro ao buscar dados:', error);
            }
        }

        // Função para inicializar filtros
        function inicializarFiltros() {
            // Tipologia (agora vem do banco de veículos)
            const tipologias = [...new Set(dados.map(item => item['Tipologia'] || 'Não informado').filter(t => t))];
            const selectTipologia = document.getElementById('filtroTipologia');
            selectTipologia.innerHTML = '<option value="">Todas</option>' + 
                tipologias.map(t => `<option value="${t}">${t}</option>`).join('');

            // Perfil (agora vem do banco de veículos)
            const perfis = [...new Set(dados.map(item => item['Perfil'] || 'Não informado').filter(p => p))];
            const selectPerfil = document.getElementById('filtroPerfil');
            selectPerfil.innerHTML = '<option value="">Todos</option>' + 
                perfis.map(p => `<option value="${p}">${p}</option>`).join('');

            // Embarcador
            const embarcadores = [...new Set(dados.map(item => item['Embarcador'] || 'Não informado').filter(e => e))];
            const selectEmbarcador = document.getElementById('filtroEmbarcador');
            selectEmbarcador.innerHTML = '<option value="">Todos</option>' + 
                embarcadores.map(e => `<option value="${e}">${e}</option>`).join('');

            // Eventos de filtro
            ['filtroTipologia', 'filtroPerfil', 'filtroEmbarcador'].forEach(id => {
                document.getElementById(id).addEventListener('change', aplicarFiltros);
            });
        }

        // Função para aplicar filtros
        function aplicarFiltros() {
            const tipologia = document.getElementById('filtroTipologia').value;
            const perfil = document.getElementById('filtroPerfil').value;
            const embarcador = document.getElementById('filtroEmbarcador').value;

            dadosFiltrados = dados.filter(item => {
                if (tipologia && item['Tipologia'] !== tipologia) return false;
                if (perfil && item['Perfil'] !== perfil) return false;
                if (embarcador && item['Embarcador'] !== embarcador) return false;
                
                return true;
            });

            atualizarDashboard();
        }

        // Função para atualizar dashboard
        function atualizarDashboard() {
            console.log('Atualizando dashboard com', dadosFiltrados.length, 'registros filtrados');
            
            atualizarCards();
            atualizarMapa();
            atualizarRankings();
            atualizarGraficos();
            atualizarTabela();
        }

        // Função para normalizar nomes de cidades
        function normalizarNomeCidade(cidade) {
            if (!cidade || cidade.trim() === '') return '';
            
            // Correções específicas de encoding mais abrangentes
            const correcoes = {
                // Padrões comuns de encoding UTF-8 problemático
                'SÃ£o': 'São',
                'SÃ¡o': 'São',
                'JosÃ©': 'José',
                'TaubatÃ©': 'Taubaté',
                'CaÃ§apava': 'Caçapava',
                'BraganÃ§a': 'Bragança',
                'SebastÃ£o': 'Sebastião',
                'Ã¡': 'á',
                'Ã ': 'à',
                'Ã¢': 'â',
                'Ã£': 'ã',
                'Ã©': 'é',
                'Ãª': 'ê',
                'Ã­': 'í',
                'Ã³': 'ó',
                'Ã´': 'ô',
                'Ãµ': 'õ',
                'Ãº': 'ú',
                'Ã§': 'ç',
                'Ã±': 'ñ',
                // Casos específicos identificados
                'São Josã©': 'São José',
                'Braganã§a': 'Bragança',
                'São JosÃ© dos Campos': 'São José dos Campos',
                'São Paulo': 'São Paulo',
                'São Sebastiao': 'São Sebastião',
                'São Joao da Boa Vista': 'São João da Boa Vista',
                'São Joaquim da Barra': 'São Joaquim da Barra',
                // Correções de acentos faltantes
                'Jacarei': 'Jacareí',
                'Guaratingueta': 'Guaratinguetá',
                'Aruja': 'Arujá',
                'Jundiai': 'Jundiaí',
                'Ribeirao Preto': 'Ribeirão Preto',
                'Guaruja': 'Guarujá',
                'Peruibe': 'Peruíbe',
                'Campos do Jordao': 'Campos do Jordão',
                'Hortolandia': 'Hortolândia',
                'Mongagua': 'Mongaguá',
                'Varzea Paulista': 'Várzea Paulista',
                'Cubatao': 'Cubatão',
                'São Bento do Sapucai': 'São Bento do Sapucaí',
                'Sumare': 'Sumaré'
            };
            
            let cidadeNormalizada = cidade.trim();
            
            // Aplicar correções de encoding
            Object.entries(correcoes).forEach(([errado, correto]) => {
                cidadeNormalizada = cidadeNormalizada.replace(new RegExp(errado, 'gi'), correto);
            });
            
            // Capitalização padronizada (primeira letra maiúscula, resto minúscula, exceto preposições)
            const preposicoes = ['de', 'da', 'das', 'do', 'dos', 'e'];
            cidadeNormalizada = cidadeNormalizada.toLowerCase()
                .split(' ')
                .map(palavra => {
                    if (preposicoes.includes(palavra)) {
                        return palavra;
                    }
                    return palavra.charAt(0).toUpperCase() + palavra.slice(1);
                })
                .join(' ');
            
            return cidadeNormalizada;
        }

        // Função para atualizar cards
        function atualizarCards() {
            const total = dadosFiltrados.length;
            
            const entregues = dadosFiltrados.filter(item => 
                item['Status NF'] === 'Entregue' || 
                item['Status viagem'] === 'Entregue'
            ).length;
            
            const emTransito = dadosFiltrados.filter(item => 
                item['Status viagem']?.includes('Entrega') || 
                item['Status viagem'] === 'A entregar' ||
                item['Status viagem']?.includes('Viagem')
            ).length;
            
            // Normalizar nomes de cidades antes de contar
            const cidadesNormalizadas = dadosFiltrados
                .map(item => normalizarNomeCidade(item['Cidade']))
                .filter(c => c && c.trim() !== '');
            
            const cidadesUnicas = [...new Set(cidadesNormalizadas)];
            console.log('🏙️ DEBUG Cidades normalizadas únicas:', cidadesUnicas);
            console.log('🏙️ Total de cidades únicas (normalizado):', cidadesUnicas.length);
            
            const cidades = cidadesUnicas.length;
            
            const veiculos = new Set(dadosFiltrados.map(item => item['Placa']).filter(p => p && p.trim() !== '')).size;
            
            const anomalias = dadosFiltrados.filter(item => 
                item['Anomalia'] && item['Anomalia'].trim() !== ''
            ).length;

            document.getElementById('totalEntregas').textContent = total;
            document.getElementById('totalEntregues').textContent = entregues;
            document.getElementById('totalTransito').textContent = emTransito;
            document.getElementById('totalCidades').textContent = cidades;
            document.getElementById('totalVeiculos').textContent = veiculos;
            document.getElementById('totalAnomalias').textContent = anomalias;
        }

        // Função para inicializar mapa
        function inicializarMapa() {
            if (mapa) {
                mapa.remove();
            }
            
            mapa = L.map('mapa').setView([-23.5505, -46.6333], 8); // São Paulo como centro
            
            // Usar mapa limpo e minimalista
            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
                subdomains: 'abcd',
                maxZoom: 20
            }).addTo(mapa);
        }

        // Função para atualizar mapa
        function atualizarMapa() {
            if (!mapa) {
                inicializarMapa();
            }

            // Limpar marcadores existentes
            mapa.eachLayer(layer => {
                if (layer instanceof L.Marker || layer instanceof L.CircleMarker) {
                    mapa.removeLayer(layer);
                }
            });

            // Agrupar por cidade usando normalização
            const cidadesOperacao = {};
            console.log('🏙️ Processando cidades dos dados:', dadosFiltrados.length, 'registros');
            
            dadosFiltrados.forEach(item => {
                const cidadeOriginal = item['Cidade'];
                
                if (cidadeOriginal && cidadeOriginal.trim() !== '' && cidadeOriginal !== 'N/A') {
                    const cidadeNormalizada = normalizarNomeCidade(cidadeOriginal);
                    const cidadeKey = cidadeNormalizada; // Usar nome normalizado como chave
                    
                    if (!cidadesOperacao[cidadeKey]) {
                        cidadesOperacao[cidadeKey] = {
                            nome: cidadeNormalizada,
                            count: 0,
                            entregas: [],
                            tipologias: {},
                            status: {},
                            placas: new Set()
                        };
                    }
                    
                    cidadesOperacao[cidadeKey].count++;
                    cidadesOperacao[cidadeKey].entregas.push({
                        cliente: item['Cliente'] || item['Empresa'] || 'N/A',
                        status: item['Status viagem'] || item['Status NF'] || 'N/A',
                        placa: item['Placa'] || 'N/A',
                        tipologia: item['Tipologia'] || 'N/A'
                    });
                    
                    // Contar tipologias
                    const tipologia = item['Tipologia'] || 'Outros';
                    cidadesOperacao[cidadeKey].tipologias[tipologia] = (cidadesOperacao[cidadeKey].tipologias[tipologia] || 0) + 1;
                    
                    // Contar status
                    const status = item['Status viagem'] || item['Status NF'] || 'N/A';
                    cidadesOperacao[cidadeKey].status[status] = (cidadesOperacao[cidadeKey].status[status] || 0) + 1;
                    
                    // Coletar placas únicas
                    if (item['Placa'] && item['Placa'] !== 'N/A') {
                        cidadesOperacao[cidadeKey].placas.add(item['Placa']);
                    }
                }
            });

            console.log('🎯 Cidades encontradas:', Object.keys(cidadesOperacao).length);
            console.log('📋 Lista de cidades:', Object.keys(cidadesOperacao));

            // Geocoding das cidades brasileiras (coordenadas expandidas)
            const coordenadasCidades = {
                'SÃO PAULO': [-23.5505, -46.6333],
                'TAUBATÉ': [-23.0205, -45.5555],
                'RIO DE JANEIRO': [-22.9068, -43.1729],
                'BELO HORIZONTE': [-19.9167, -43.9345],
                'BRASÍLIA': [-15.7942, -47.8822],
                'SALVADOR': [-12.9714, -38.5014],
                'FORTALEZA': [-3.7319, -38.5267],
                'RECIFE': [-8.0476, -34.8770],
                'PORTO ALEGRE': [-30.0346, -51.2177],
                'CURITIBA': [-25.4244, -49.2654],
                'CAMPINAS': [-22.9056, -47.0608],
                'SANTOS': [-23.9618, -46.3322],
                'SÃO JOSÉ DOS CAMPOS': [-23.2237, -45.9009],
                'SOROCABA': [-23.5015, -47.4526],
                'RIBEIRÃO PRETO': [-21.1775, -47.8208],
                'SÃO BERNARDO DO CAMPO': [-23.6914, -46.5646],
                'GUARULHOS': [-23.4538, -46.5333],
                'OSASCO': [-23.5329, -46.7918],
                'SÃO CAETANO DO SUL': [-23.6186, -46.5553],
                'DIADEMA': [-23.6861, -46.6208],
                'MAUÁ': [-23.6700, -46.4611],
                'SUZANO': [-23.5426, -46.3116],
                'JACAREÍ': [-23.3056, -45.9658],
                'CAÇAPAVA': [-23.1058, -45.7058],
                'SÃO SEBASTIÃO': [-23.8129, -45.4044],
                'CARAGUATATUBA': [-23.6204, -45.4130],
                'UBATUBA': [-23.4336, -45.0838],
                'GUARATINGUETÁ': [-22.8161, -45.1931],
                'APARECIDA': [-22.8458, -45.2306],
                'LORENA': [-22.7309, -45.1173],
                'CACHOEIRA PAULISTA': [-22.6658, -45.0058],
                'CRUZEIRO': [-22.5761, -44.9633],
                'QUELUZ': [-22.5286, -44.7758],
                'LAVRINHAS': [-22.5658, -44.9058],
                'SÃO LUIZ DO PARAITINGA': [-23.2206, -45.3081],
                // Adicionando cidades que encontramos nos dados
                'AGUAI': [-22.0548, -46.9821],
                'CANAS': [-22.7058, -45.0458],
                'FRANCA': [-20.5386, -47.4006],
                'GUARÁ': [-15.8131, -47.9725],
                'ITAQUAQUECETUBA': [-23.4864, -46.3489],
                'ITUVERAVA': [-20.3386, -47.7761],
                'LAGOINHA': [-23.1158, -45.1758],
                'PINDAMONHANGABA': [-22.9244, -45.4618],
                'PERUÍBE': [-24.3200, -46.9978],
                'PIQUETE': [-22.6158, -45.1758],
                'ROSEIRA': [-22.9044, -45.3008],
                'SANTA ISABEL': [-23.3158, -46.2208],
                'SANTO ANTÔNIO DE POSSE': [-22.6058, -46.9358],
                'SOCORRO': [-22.5919, -46.5297],
                'SÃO JOÃO DA BOA VISTA': [-21.9697, -46.7972],
                'SÃO JOAQUIM DA BARRA': [-20.5825, -47.8586],
                'VARGEM': [-22.8858, -46.4058],
                // Coordenadas em formato normalizado (Title Case)
                'São Paulo': [-23.5505, -46.6333],
                'Taubaté': [-23.0205, -45.5555],
                'São José dos Campos': [-23.2237, -45.9009],
                'Jacareí': [-23.3056, -45.9658],
                'Caçapava': [-23.1058, -45.7058],
                'São Sebastião': [-23.8129, -45.4044],
                'Caraguatatuba': [-23.6204, -45.4130],
                'Ubatuba': [-23.4336, -45.0838],
                'Guaratinguetá': [-22.8161, -45.1931],
                'Aparecida': [-22.8458, -45.2306],
                'Lorena': [-22.7309, -45.1173],
                'Guarulhos': [-23.4538, -46.5333],
                'Santos': [-23.9618, -46.3322],
                'Campinas': [-22.9056, -47.0608],
                'Ribeirão Preto': [-21.1775, -47.8208],
                'Suzano': [-23.5426, -46.3116],
                'Pindamonhangaba': [-22.9244, -45.4618],
                'Mogi das Cruzes': [-23.5228, -46.1883],
                'Paraty': [-23.2176, -44.7146],
                'Bragança Paulista': [-22.9519, -46.5425],
                'Bertioga': [-23.8543, -46.1376],
                'Santa Isabel': [-23.3158, -46.2208],
                'Itaquaquecetuba': [-23.4864, -46.3489],
                'Arujá': [-23.3964, -46.3200],
                'Atibaia': [-23.1169, -46.5533],
                'Jundiaí': [-23.1864, -46.8842],
                'Cachoeira Paulista': [-22.6658, -45.0058],
                'Cruzeiro': [-22.5761, -44.9633],
                'São Vicente': [-23.9632, -46.3919],
                'Roseira': [-22.9044, -45.3008],
                'Guarujá': [-24.0139, -46.2564],
                'Peruíbe': [-24.3200, -46.9978],
                'Canas': [-22.7058, -45.0458],
                'Cunha': [-23.0766, -44.9598],
                'Campos do Jordão': [-22.7399, -45.5917],
                'Franca': [-20.5386, -47.4006],
                'Itanhaém': [-24.1828, -46.7889],
                'Itatiba': [-23.0058, -46.8383],
                'Piracaia': [-23.0533, -46.3594],
                'Franco da Rocha': [-23.3289, -46.7272],
                'Hortolândia': [-22.8583, -47.2200],
                'Mongaguá': [-24.0889, -46.6119],
                'Vargem': [-22.8858, -46.4058],
                'Louveira': [-23.0847, -46.9486],
                'Várzea Paulista': [-23.2114, -46.8294],
                'Vinhedo': [-23.0297, -46.9753],
                'Americana': [-22.7394, -47.3311],
                'Cubatão': [-23.8950, -46.4253],
                'Indaiatuba': [-23.0920, -47.2181],
                'São Bento do Sapucaí': [-22.6859, -45.7253],
                'Socorro': [-22.5919, -46.5297],
                'Sumaré': [-22.8219, -47.2669],
                'Lagoinha': [-23.1158, -45.1758],
                'Monteiro Lobato': [-22.9579, -45.8376],
                'Santa Branca': [-23.3977, -45.8863],
                'Silveiras': [-22.7997, -44.8705]
            };

            // Marcar cidades no mapa
            let cidadesMarcadas = 0;
            Object.entries(cidadesOperacao).forEach(([cidadeKey, data]) => {
                const coordenadas = coordenadasCidades[cidadeKey];
                
                if (coordenadas) {
                    const [lat, lng] = coordenadas;
                    
                    // Definir cor baseada na quantidade de entregas  
                    let color = '#007BFF';  // Azul padrão
                    
                    if (data.count >= 50) color = '#DC3545';         // Vermelho
                    else if (data.count >= 20) color = '#FD7E14';    // Laranja  
                    else if (data.count >= 10) color = '#28A745';    // Verde
                    else color = '#007BFF';                           // Azul

                    // Criar ícone de pin simples sem números
                    const customIcon = L.divIcon({
                        className: 'custom-pin-simple',
                        html: `
                            <div class="pin-simple" style="
                                position: relative;
                                width: 24px;
                                height: 30px;
                            ">
                                <div class="pin-head" style="
                                    background: ${color};
                                    border: 2px solid white;
                                    border-radius: 50% 50% 50% 0;
                                    width: 20px;
                                    height: 20px;
                                    transform: rotate(-45deg);
                                    box-shadow: 0 2px 6px rgba(0,0,0,0.3);
                                    position: absolute;
                                    top: 2px;
                                    left: 2px;
                                ">
                                </div>
                            </div>
                        `,
                        iconSize: [24, 30],
                        iconAnchor: [12, 30]
                    });

                    const marker = L.marker([lat, lng], { icon: customIcon }).addTo(mapa);
                    
                    // Adicionar contorno pontilhado da área da cidade
                    const raioArea = Math.max(500, data.count * 50); // Raio baseado no volume
                    const circle = L.circle([lat, lng], {
                        radius: raioArea,
                        color: color,
                        weight: 2,
                        opacity: 0.8,
                        fillColor: color,
                        fillOpacity: 0.1,
                        dashArray: '5, 10' // Linha pontilhada
                    }).addTo(mapa);
                    
                    // Criar popup com informações detalhadas
                    const topTipologias = Object.entries(data.tipologias)
                        .sort(([,a], [,b]) => b - a)
                        .slice(0, 3);
                        
                    const topStatus = Object.entries(data.status)
                        .sort(([,a], [,b]) => b - a)
                        .slice(0, 3);

                    const popupContent = `
                        <div style="max-width: 300px; font-family: Arial, sans-serif;">
                            <h6 style="margin: 0 0 10px 0; color: ${color}; font-size: 16px;">
                                <strong>📍 ${data.nome}</strong>
                            </h6>
                            
                            <div style="background: #f8f9fa; padding: 8px; border-radius: 6px; margin-bottom: 10px;">
                                <p style="margin: 0; font-size: 14px;"><strong>📦 Total:</strong> ${data.count} entregas</p>
                                <p style="margin: 0; font-size: 14px;"><strong>🚛 Placas ativas:</strong> ${data.placas.size}</p>
                            </div>
                            
                            ${topTipologias.length > 0 ? `
                            <p style="margin: 5px 0 3px 0; font-size: 13px; font-weight: bold;">🏷️ Principais tipologias:</p>
                            <ul style="font-size: 12px; margin: 0 0 10px 0; padding-left: 18px;">
                                ${topTipologias.map(([tip, count]) => 
                                    `<li><strong>${tip}:</strong> ${count} ${count === 1 ? 'entrega' : 'entregas'}</li>`
                                ).join('')}
                            </ul>
                            ` : ''}
                            
                            <p style="margin: 5px 0 3px 0; font-size: 13px; font-weight: bold;">� Status das entregas:</p>
                            <ul style="font-size: 12px; margin: 0 0 10px 0; padding-left: 18px;">
                                ${topStatus.map(([status, count]) => 
                                    `<li><strong>${status}:</strong> ${count}</li>`
                                ).join('')}
                            </ul>
                            
                            <p style="margin: 5px 0 3px 0; font-size: 13px; font-weight: bold;">🚛 Últimas placas:</p>
                            <ul style="font-size: 11px; margin: 0; padding-left: 18px;">
                                ${data.entregas.slice(-4).map(e => 
                                    `<li><strong>${e.placa}</strong> - ${e.cliente.substring(0, 25)}${e.cliente.length > 25 ? '...' : ''}</li>`
                                ).join('')}
                                ${data.entregas.length > 4 ? `<li style="font-style: italic;">... e mais ${data.entregas.length - 4} entregas</li>` : ''}
                            </ul>
                        </div>
                    `;
                    
                    marker.bindPopup(popupContent);
                    cidadesMarcadas++;
                } else {
                    console.log('❌ Coordenadas não encontradas para:', data.nome);
                }
            });

            // Ajustar view para mostrar todas as cidades
            if (cidadesMarcadas > 0) {
                console.log('✅ Marcadas', cidadesMarcadas, 'cidades no mapa');
                // Foco na região de São Paulo/Vale do Paraíba onde você opera mais
                mapa.setView([-23.2, -45.5], 8);
            } else {
                console.log('⚠️ Nenhuma cidade foi marcada no mapa');
                mapa.setView([-15.7942, -47.8822], 5);
            }
        }

        // Função para atualizar rankings
        function atualizarRankings() {
            // Contar entregas por placa
            const placaStats = {};
            
            dadosFiltrados.forEach(item => {
                const placa = item['Placa'];
                const statusNF = item['Status NF'];
                const statusViagem = item['Status viagem'];
                
                if (placa && placa.trim() !== '' && placa !== '-' && placa !== 'N/A') {
                    if (!placaStats[placa]) {
                        placaStats[placa] = { 
                            total: 0, 
                            entregues: 0,
                            emAndamento: 0,
                            problemas: 0
                        };
                    }
                    
                    placaStats[placa].total++;
                    
                    // Contar entregues
                    if (statusNF === 'Entregue' || statusViagem === 'Entregue') {
                        placaStats[placa].entregues++;
                    } 
                    // Contar em andamento
                    else if (statusViagem?.includes('Entrega') || statusViagem?.includes('Viagem') || statusViagem === 'A entregar') {
                        placaStats[placa].emAndamento++;
                    } 
                    // Contar problemas
                    else if (item['Anomalia'] && item['Anomalia'].trim() !== '') {
                        placaStats[placa].problemas++;
                    }
                }
            });

            console.log('Estatísticas de placas:', placaStats);

            // Calcular percentual de eficiência
            const placasComPercentual = Object.entries(placaStats)
                .filter(([placa, stats]) => stats.total >= 3) // Mínimo 3 entregas
                .map(([placa, stats]) => ({
                    placa,
                    total: stats.total,
                    entregues: stats.entregues,
                    emAndamento: stats.emAndamento,
                    problemas: stats.problemas,
                    percentual: stats.total > 0 ? (stats.entregues / stats.total * 100) : 0
                }));

            // Melhores (maior percentual de sucesso) - EXCLUIR placas com 0% e 100%
            const melhores = placasComPercentual
                .filter(placa => placa.percentual > 0 && placa.percentual < 100) // Excluir placas com 0% e 100%
                .sort((a, b) => b.percentual - a.percentual || b.total - a.total)
                .slice(0, 5);

            // Piores (menor percentual de sucesso, mais problemas) - INCLUIR placas com 0%
            const piores = placasComPercentual
                .sort((a, b) => a.percentual - b.percentual || b.problemas - a.problemas)
                .slice(0, 5);

            console.log('Melhores placas:', melhores);
            console.log('Piores placas:', piores);

            // Renderizar rankings
            renderizarRanking('rankingMelhores', melhores, true);
            renderizarRanking('rankingPiores', piores, false);
        }

        // Função para renderizar ranking
        function renderizarRanking(containerId, dados, isMelhor) {
            const container = document.getElementById(containerId);
            
            if (dados.length === 0) {
                container.innerHTML = '<p class="text-center text-muted">Dados insuficientes</p>';
                return;
            }

            container.innerHTML = dados.map((item, index) => {
                // Para o ranking de atenção, se percentual for 0, sempre vermelho
                let corTexto = '';
                if (isMelhor) {
                    const coresMelhores = ['text-success', 'text-success', 'text-success', 'text-primary', 'text-info'];
                    corTexto = coresMelhores[index] || 'text-success';
                } else {
                    // Top 5 Atenção: todos vermelhos se percentual for 0,0%
                    corTexto = item.percentual === 0 ? 'text-danger' : 'text-warning';
                }

                return `
                <div class="ranking-item d-flex align-items-center py-2 border-bottom">
                    <div class="ranking-position me-3">
                        <span class="badge ${isMelhor ? 'bg-success' : 'bg-danger'} rounded-circle" style="width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; font-size: 0.75rem;">
                            ${index + 1}
                        </span>
                    </div>
                    <div class="flex-grow-1">
                        <div class="fw-bold" style="font-size: 0.9rem;">${item.placa}</div>
                        <div class="text-muted" style="font-size: 0.75rem;">
                            ${item.entregues}/${item.total} entregas${item.problemas > 0 ? ` • ${item.problemas} problema${item.problemas > 1 ? 's' : ''}` : ''}
                        </div>
                    </div>
                    <div class="text-end">
                        <div class="fw-bold ${corTexto}" style="font-size: 0.9rem;">${item.percentual.toFixed(1)}%</div>
                        <div class="text-muted" style="font-size: 0.7rem;">eficiência</div>
                    </div>
                </div>
                `;
            }).join('');
        }

        // Função para atualizar gráficos
        function atualizarGraficos() {
            atualizarGraficoStatus();
            atualizarGraficoPesoEmbarcador();
        }

        // Gráfico de status
        function atualizarGraficoStatus() {
            const ctx = document.getElementById('statusChart').getContext('2d');
            
            const statusCount = {};
            dadosFiltrados.forEach(item => {
                const status = item['Status viagem'] || 'Não informado';
                statusCount[status] = (statusCount[status] || 0) + 1;
            });

            if (statusChart) {
                statusChart.destroy();
            }

            statusChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(statusCount),
                    datasets: [{
                        data: Object.values(statusCount),
                        backgroundColor: [
                            '#28a745', '#ffc107', '#17a2b8', '#dc3545', 
                            '#6c757d', '#007bff', '#20c997', '#fd7e14'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        // Gráfico de peso por embarcador
        function atualizarGraficoPesoEmbarcador() {
            const ctx = document.getElementById('pesoEmbarcadorChart').getContext('2d');
            
            const embarcadorStats = {};
            
            dadosFiltrados.forEach(item => {
                const embarcador = item['Embarcador'] || 'Não informado';
                const pesoStr = item['Peso bruto (NF)'] || '0';
                const peso = parseFloat(pesoStr.replace(/"/g, '').replace(/[^\d.,]/g, '').replace(',', '.')) || 0;
                const isEntregue = item['Status NF'] === 'Entregue';
                
                if (!embarcadorStats[embarcador]) {
                    embarcadorStats[embarcador] = { total: 0, entregue: 0 };
                }
                
                embarcadorStats[embarcador].total += peso;
                if (isEntregue) {
                    embarcadorStats[embarcador].entregue += peso;
                }
            });

            const embarcadores = Object.keys(embarcadorStats).slice(0, 10); // Top 10
            const pesoTotal = embarcadores.map(e => embarcadorStats[e].total);
            const pesoEntregue = embarcadores.map(e => embarcadorStats[e].entregue);

            if (pesoEmbarcadorChart) {
                pesoEmbarcadorChart.destroy();
            }

            pesoEmbarcadorChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: embarcadores,
                    datasets: [
                        {
                            label: 'Peso Total (kg)',
                            data: pesoTotal,
                            backgroundColor: '#2a5298',
                            borderColor: '#1e3c72',
                            borderWidth: 1
                        },
                        {
                            label: 'Peso Entregue (kg)',
                            data: pesoEntregue,
                            backgroundColor: '#28a745',
                            borderColor: '#1e7e34',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Peso (kg)'
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                afterLabel: function(context) {
                                    const embarcador = context.label;
                                    const stats = embarcadorStats[embarcador];
                                    const percentual = stats.total > 0 ? (stats.entregue / stats.total * 100) : 0;
                                    return `Eficiência: ${percentual.toFixed(1)}%`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // Função para atualizar tabela
        function atualizarTabela() {
            const tbody = document.getElementById('tabelaDados');
            
            const ultimosRegistros = dadosFiltrados.slice(0, 20);
            
            tbody.innerHTML = ultimosRegistros.map(item => {
                const status = item['Status viagem'] || 'Não informado';
                const statusClass = getStatusClass(status);
                const peso = item['Peso bruto (NF)'] || '-';
                
                return `
                    <tr>
                        <td>
                            <span class="status-indicator ${statusClass}"></span>
                            ${status}
                        </td>
                        <td>${item['Cidade'] || '-'}</td>
                        <td>${(item['Cliente'] || '-').substring(0, 30)}${(item['Cliente'] || '').length > 30 ? '...' : ''}</td>
                        <td><strong>${item['Placa'] || '-'}</strong></td>
                        <td>${(item['Embarcador'] || '-').substring(0, 20)}${(item['Embarcador'] || '').length > 20 ? '...' : ''}</td>
                        <td>${peso}</td>
                        <td>${formatarData(item['Atualizado em: 2025-10-09 08:56:36\\r'] || '')}</td>
                    </tr>
                `;
            }).join('');
        }

        // Função para obter classe do status
        function getStatusClass(status) {
            if (status.includes('Entregue')) return 'status-entregue';
            if (status.includes('Entrega') || status.includes('entregar')) return 'status-entrega';
            if (status.includes('Agendada')) return 'status-agendada';
            if (status.includes('Anomalia')) return 'status-anomalia';
            return 'status-entrega';
        }

        // Função para formatar data
        function formatarData(dataStr) {
            if (!dataStr) return '-';
            try {
                const data = new Date(dataStr.replace('\\r', ''));
                return data.toLocaleString('pt-BR');
            } catch {
                return dataStr.substring(0, 16);
            }
        }

        // Função para atualizar timestamp
        function atualizarTimestamp() {
            const agora = new Date();
            document.getElementById('lastUpdate').innerHTML = 
                `<i class="fas fa-clock"></i> Última atualização: ${agora.toLocaleTimeString('pt-BR')}`;
        }

        // Função para atualização manual
        function atualizarDados() {
            buscarDados();
        }

        // Inicializar
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM carregado, iniciando dashboard...');
            inicializarMapa();
            buscarDados();
            
            // Atualizar a cada 2 minutos
            setInterval(buscarDados, 120000);
        });
    </script>
{% endblock %}