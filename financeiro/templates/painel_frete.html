{% extends "base.html" %}

{% block title %}Painel Frete - Dashboard{% endblock %}

{% block content %}
<style>
/* Reset e configura√ß√£o para viewport sem scroll */
* {
    box-sizing: border-box;
}

.dashboard-container {
    height: 100vh;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    background: #2d3436;
    color: white;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}

/* Barra de filtros modernizada */
.filtros-container {
    min-height: 85px;
    background: linear-gradient(135deg, #2d3436 0%, #636e72 100%);
    display: flex;
    align-items: center;
    padding: 20px 25px;
    gap: 30px;
    border-bottom: 3px solid #74b9ff;
    flex-shrink: 0;
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    flex-wrap: wrap;
}

.filtro-grupo {
    display: flex;
    flex-direction: column;
    gap: 8px;
    min-width: 140px;
}

.filtro-label {
    font-size: 12px;
    font-weight: 700;
    color: #ffffff;
    text-transform: uppercase;
    letter-spacing: 1px;
    text-shadow: 0 1px 2px rgba(0,0,0,0.3);
    margin-bottom: 2px;
}

.filtro-select {
    background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
    color: #2d3436;
    border: 2px solid #74b9ff;
    padding: 12px 16px;
    border-radius: 10px;
    font-size: 13px;
    font-weight: 600;
    min-width: 140px;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    cursor: pointer;
    box-shadow: 0 2px 10px rgba(116, 185, 255, 0.15);
    position: relative;
}

.filtro-select:hover {
    border-color: #0984e3;
    box-shadow: 0 4px 20px rgba(116, 185, 255, 0.3);
    transform: translateY(-2px);
    background: linear-gradient(135deg, #ffffff 0%, #e3f2fd 100%);
}

.filtro-select:focus {
    outline: none;
    border-color: #0984e3;
    box-shadow: 0 0 0 4px rgba(116, 185, 255, 0.25);
}

.filtro-select option {
    background: #ffffff;
    color: #2d3436;
    padding: 12px 16px;
    font-weight: 500;
    border-radius: 4px;
    margin: 2px 0;
}

.filtro-select option:hover {
    background: #e3f2fd;
}



/* Bot√£o limpar filtros */
.btn-limpar-filtros {
    background: linear-gradient(135deg, #e17055 0%, #d63031 100%);
    color: white;
    border: none;
    padding: 12px 20px;
    border-radius: 10px;
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: 0 2px 10px rgba(225, 112, 85, 0.3);
    min-width: 140px;
}

.btn-limpar-filtros:hover {
    background: linear-gradient(135deg, #d63031 0%, #a71e34 100%);
    transform: translateY(-2px);
    box-shadow: 0 4px 20px rgba(225, 112, 85, 0.5);
}

.btn-limpar-filtros:active {
    transform: translateY(0);
}

/* Status dos filtros */
.filtros-status {
    display: flex;
    flex-direction: column;
    gap: 4px;
    min-width: 160px;
}

.status-badge {
    background: linear-gradient(135deg, #00b894 0%, #00a085 100%);
    color: white;
    padding: 10px 15px;
    border-radius: 25px;
    font-size: 11px;
    font-weight: 700;
    text-align: center;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    box-shadow: 0 3px 15px rgba(0, 184, 148, 0.4);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    border: 2px solid rgba(255,255,255,0.2);
}

.status-badge.filtrado {
    background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
    box-shadow: 0 3px 15px rgba(255, 107, 107, 0.4);
    animation: pulse-filtrado 1.5s infinite;
}

.status-badge.carregando {
    background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%);
    box-shadow: 0 3px 15px rgba(116, 185, 255, 0.4);
    animation: loading-pulse 0.8s infinite;
}

@keyframes pulse-filtrado {
    0%, 100% { 
        transform: scale(1);
        box-shadow: 0 3px 15px rgba(255, 107, 107, 0.4);
    }
    50% { 
        transform: scale(1.05);
        box-shadow: 0 5px 20px rgba(255, 107, 107, 0.6);
    }
}

@keyframes loading-pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.7; }
}

/* Container principal dos gr√°ficos */
.dashboard-main {
    flex: 1;
    display: grid;
    grid-template-columns: 2fr 1fr;
    grid-template-rows: 1fr 1fr;
    gap: 10px;
    padding: 10px;
    min-height: 0;
}

/* Gr√°fico de frete di√°rio (superior esquerda) */
.grafico-diario {
    background: #636e72;
    border-radius: 8px;
    padding: 15px 15px 25px 15px;
    position: relative;
    overflow: hidden;
}

.grafico-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
    flex-wrap: wrap;
    gap: 10px;
}

.totais-mensais {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
}

.total-card {
    background: rgba(45, 52, 54, 0.8);
    border-radius: 6px;
    padding: 8px 12px;
    text-align: center;
    border: 1px solid;
    min-width: 120px;
}

.total-card.frete-correto {
    border-color: #00b894;
    background: linear-gradient(135deg, rgba(0, 184, 148, 0.2), rgba(0, 160, 133, 0.2));
}

.total-card.despesas-gerais {
    border-color: #e17055;
    background: linear-gradient(135deg, rgba(225, 112, 85, 0.2), rgba(230, 126, 34, 0.2));
}

.total-card.diferenca-total {
    border-color: #74b9ff;
    background: linear-gradient(135deg, rgba(116, 185, 255, 0.2), rgba(9, 132, 227, 0.2));
}

.total-label {
    font-size: 10px;
    font-weight: bold;
    text-transform: uppercase;
    margin-bottom: 4px;
    opacity: 0.9;
    color: white;
}

.total-valor {
    font-size: 12px;
    font-weight: bold;
    color: white;
}

.grafico-title {
    font-size: 14px;
    font-weight: bold;
    color: white;
    margin-bottom: 10px;
    text-transform: uppercase;
}

.chart-container {
    height: calc(100% - 40px);
    position: relative;
}

/* M√©tricas e gr√°fico de clientes (superior direita) */
.metricas-clientes {
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.metricas-cards {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 8px;
    height: 120px;
}

.metrica-card {
    background: #2d3436;
    border-radius: 6px;
    padding: 10px;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    border: 1px solid #74b9ff;
}

.metrica-card.receber {
    border-color: #ff7675;
    background: linear-gradient(135deg, #ff7675 0%, #fd79a8 100%);
}

.metrica-card.pagar {
    border-color: #74b9ff;
    background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%);
}

.metrica-card.diferenca {
    border-color: #00b894;
    background: linear-gradient(135deg, #00b894 0%, #00a085 100%);
}

.metrica-card.produtividade {
    border-color: #fdcb6e;
    background: linear-gradient(135deg, #fdcb6e 0%, #e17055 100%);
}

.metrica-label {
    font-size: 10px;
    font-weight: bold;
    text-transform: uppercase;
    margin-bottom: 5px;
    opacity: 0.9;
}

.metrica-valor {
    font-size: 16px;
    font-weight: bold;
}

.clientes-chart {
    background: #636e72;
    border-radius: 8px;
    padding: 15px;
    flex: 1;
    min-height: 0;
}

/* Gr√°fico mensal (inferior, span de 2 colunas) */
.grafico-mensal {
    background: #636e72;
    border-radius: 8px;
    padding: 15px;
    grid-column: 1 / -1;
    position: relative;
    overflow: hidden;
}

/* Responsividade para telas menores */
@media (max-width: 1200px) {
    .dashboard-main {
        grid-template-columns: 1fr;
        grid-template-rows: auto auto auto;
    }
    
    .grafico-mensal {
        grid-column: 1;
    }
    
    .metricas-cards {
        grid-template-columns: repeat(4, 1fr);
        height: 80px;
    }
    
    .metrica-valor {
        font-size: 14px;
    }
    
    .grafico-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
    }
    
    .totais-mensais {
        justify-content: flex-start;
        width: 100%;
    }
    
    .total-card {
        min-width: 100px;
        font-size: 11px;
    }
}

@media (max-width: 768px) {
    .filtros-container {
        height: auto;
        padding: 10px;
        flex-wrap: wrap;
        gap: 10px;
    }
    
    .metricas-cards {
        grid-template-columns: 1fr 1fr;
        height: 120px;
    }
    
    .filtro-select {
        min-width: 60px;
        font-size: 10px;
    }
}

/* Loader placeholder para gr√°ficos */
.chart-placeholder {
    display: flex;
    align-items: center;
    justify-content: center;
    height: 100%;
    color: #ddd;
    font-size: 14px;
}

.loading {
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0% { opacity: 0.6; }
    50% { opacity: 1; }
    100% { opacity: 0.6; }
}
</style>

<div class="dashboard-container">
    <!-- Barra de Filtros -->
    <div class="filtros-container">
        <div class="filtro-grupo">
            <div class="filtro-label">üè∑Ô∏è Perfil</div>
            <select class="filtro-select" id="filtro-perfil">
                {% for perfil in dados.filtros.opcoes_perfis %}
                <option value="{{ perfil }}" {% if perfil == dados.filtros.perfil_selecionado %}selected{% endif %}>{{ perfil }}</option>
                {% endfor %}
            </select>
        </div>
        
        <div class="filtro-grupo">
            <div class="filtro-label">üè¢ Clientes</div>
            <select class="filtro-select" id="filtro-clientes">
                <option value="">TODOS OS CLIENTES</option>
                {% for cliente in dados.filtros.opcoes_clientes %}
                <option value="{{ cliente }}">{{ cliente }}</option>
                {% endfor %}
            </select>
        </div>
        
        <div class="filtro-grupo">
            <div class="filtro-label">üöö Ve√≠culos</div>
            <select class="filtro-select" id="filtro-veiculo">
                <option value="">TODOS OS VE√çCULOS</option>
                {% for veiculo in dados.filtros.opcoes_veiculos %}
                <option value="{{ veiculo }}">{{ veiculo }}</option>
                {% endfor %}
            </select>
        </div>
        
        <div class="filtro-grupo">
            <div class="filtro-label">üìÖ M√™s</div>
            <select class="filtro-select" id="filtro-mes">
                <option value="JAN" {% if dados.filtros.mes_atual == 'JAN' %}selected{% endif %}>Janeiro</option>
                <option value="FEV" {% if dados.filtros.mes_atual == 'FEV' %}selected{% endif %}>Fevereiro</option>
                <option value="MAR" {% if dados.filtros.mes_atual == 'MAR' %}selected{% endif %}>Mar√ßo</option>
                <option value="ABR" {% if dados.filtros.mes_atual == 'ABR' %}selected{% endif %}>Abril</option>
                <option value="MAI" {% if dados.filtros.mes_atual == 'MAI' %}selected{% endif %}>Maio</option>
                <option value="JUN" {% if dados.filtros.mes_atual == 'JUN' %}selected{% endif %}>Junho</option>
                <option value="JUL" {% if dados.filtros.mes_atual == 'JUL' %}selected{% endif %}>Julho</option>
                <option value="AGO" {% if dados.filtros.mes_atual == 'AGO' %}selected{% endif %}>Agosto</option>
                <option value="SET" {% if dados.filtros.mes_atual == 'SET' %}selected{% endif %}>Setembro</option>
                <option value="OUT" {% if dados.filtros.mes_atual == 'OUT' %}selected{% endif %}>Outubro</option>
                <option value="NOV" {% if dados.filtros.mes_atual == 'NOV' %}selected{% endif %}>Novembro</option>
                <option value="DEZ" {% if dados.filtros.mes_atual == 'DEZ' %}selected{% endif %}>Dezembro</option>
            </select>
        </div>
        
        <div class="filtro-grupo">
            <div class="filtro-label">üóìÔ∏è Ano</div>
            <select class="filtro-select" id="filtro-ano">
                {% for ano in dados.filtros.opcoes_anos %}
                <option value="{{ ano }}" {% if ano == dados.filtros.ano_atual %}selected{% endif %}>{{ ano }}</option>
                {% endfor %}
            </select>
        </div>
        
        <div class="filtro-grupo">
            <div class="filtro-label">‚öôÔ∏è A√ß√µes</div>
            <button class="btn-limpar-filtros" id="btnLimparFiltros" onclick="limparFiltros()">
                üóëÔ∏è Limpar Filtros
            </button>
        </div>
        
        <div class="filtro-grupo">
            <div class="filtro-label">üìä Status</div>
            <div class="filtros-status" id="filtrosStatus">
                <span class="status-badge">Todos os dados</span>
            </div>
        </div>
    </div>

    <!-- Dashboard Principal -->
    <div class="dashboard-main">
        <!-- Gr√°fico Frete Di√°rio -->
        <div class="grafico-diario">
            <div class="grafico-header">
                <div class="grafico-title">Frete Correto vs Despesas Gerais</div>
                <!-- Totais Mensais -->
                <div class="totais-mensais">
                    <div class="total-card frete-correto">
                        <div class="total-label">Frete Correto</div>
                        <div class="total-valor" id="totalFreteCorreto">R$ 0,00</div>
                    </div>
                    <div class="total-card despesas-gerais">
                        <div class="total-label">Despesas Gerais</div>
                        <div class="total-valor" id="totalDespesasGerais">R$ 0,00</div>
                    </div>
                    <div class="total-card diferenca-total">
                        <div class="total-label">Diferen√ßa</div>
                        <div class="total-valor" id="totalDiferenca">R$ 0,00</div>
                    </div>
                </div>
            </div>
            <div class="chart-container">
                <div class="chart-placeholder loading">
                    üìä Carregando gr√°fico di√°rio...
                </div>
                <canvas id="chartFreteDialio" style="display: none;"></canvas>
            </div>
        </div>

        <!-- M√©tricas + Clientes -->
        <div class="metricas-clientes">
            <!-- Cards de M√©tricas -->
            <div class="metricas-cards">
                <div class="metrica-card receber">
                    <div class="metrica-label">Frete Receber</div>
                    <div class="metrica-valor">R$ {{ dados.metricas.frete_receber|currency }}</div>
                </div>
                <div class="metrica-card pagar">
                    <div class="metrica-label">Frete Pagar</div>
                    <div class="metrica-valor">R$ {{ dados.metricas.frete_pagar|currency }}</div>
                </div>
                <div class="metrica-card diferenca">
                    <div class="metrica-label">Diferen√ßa</div>
                    <div class="metrica-valor">R$ {{ dados.metricas.diferenca|currency }}</div>
                </div>
                <div class="metrica-card produtividade">
                    <div class="metrica-label">Produtividade</div>
                    <div class="metrica-valor">{{ "%.2f"|format(dados.metricas.produtividade) }}%</div>
                </div>
            </div>
            
            <!-- Gr√°fico de Clientes -->
            <div class="clientes-chart">
                <div class="grafico-title">Participa√ß√£o por Cliente</div>
                <div class="chart-container">
                    <div class="chart-placeholder loading">
                        üìä Carregando participa√ß√£o...
                    </div>
                    <canvas id="chartClientes" style="display: none;"></canvas>
                </div>
            </div>
        </div>

        <!-- Gr√°fico Frete Mensal -->
        <div class="grafico-mensal">
            <div class="grafico-title">Frete Mensal</div>
            <div class="chart-container">
                <div class="chart-placeholder loading">
                    üìä Carregando gr√°fico mensal...
                </div>
                <canvas id="chartFreteMensal" style="display: none;"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- Chart.js DataLabels Plugin -->
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>

<script>
// Dados do dashboard passados do backend
const dashboardData = JSON.parse('{{ dados|tojson|safe }}');
console.log('Dashboard Data:', dashboardData);

// Configura√ß√£o global do Chart.js
Chart.defaults.color = '#ffffff';
Chart.defaults.backgroundColor = 'rgba(255, 255, 255, 0.1)';
Chart.defaults.borderColor = 'rgba(116, 185, 255, 0.5)';

// Registrar plugin datalabels
Chart.register(ChartDataLabels);

// Fun√ß√£o para calcular proje√ß√£o futura baseada nos dados reais
function calcularProjecaoFutura(dados, labels) {
    // Encontrar onde os dados param de mudar (valores repetidos)
    let ultimoIndiceComDadosReais = -1;
    
    // Procurar o √∫ltimo dia onde houve mudan√ßa significativa
    for (let i = 1; i < dados.length; i++) {
        if (dados[i] && dados[i] > 0 && dados[i-1] && dados[i-1] > 0) {
            // Se a diferen√ßa entre dias consecutivos for maior que 1% ou 1000 reais
            const diferenca = Math.abs(dados[i] - dados[i-1]);
            const percentualMudanca = diferenca / dados[i-1];
            
            if (diferenca > 1000 || percentualMudanca > 0.01) {
                ultimoIndiceComDadosReais = i;
            }
        }
    }
    
    // Se n√£o encontrou mudan√ßas, usar apenas os primeiros dias com dados
    if (ultimoIndiceComDadosReais < 1) {
        for (let i = 0; i < dados.length; i++) {
            if (dados[i] && dados[i] > 0) {
                ultimoIndiceComDadosReais = Math.min(i + 5, dados.length - 1); // Usar pelo menos 5 dias
                break;
            }
        }
    }
    
    if (ultimoIndiceComDadosReais < 1) {
        return dados.map(() => null);
    }
    
    console.log(`üìä √öltimo dia com dados reais detectado: ${ultimoIndiceComDadosReais + 1}`);
    
    // Pegar apenas os dados v√°lidos at√© o ponto onde param de mudar
    const dadosValidos = [];
    const indicesValidos = [];
    
    for (let i = 0; i <= ultimoIndiceComDadosReais; i++) {
        if (dados[i] && dados[i] > 0) {
            dadosValidos.push(dados[i]);
            indicesValidos.push(i);
        }
    }
    
    if (dadosValidos.length < 2) {
        return dados.map(() => null);
    }
    
    // Calcular regress√£o linear dos dados v√°lidos
    const n = dadosValidos.length;
    const somaX = indicesValidos.reduce((a, b) => a + b, 0);
    const somaY = dadosValidos.reduce((a, b) => a + b, 0);
    const somaXY = indicesValidos.reduce((acc, x, i) => acc + x * dadosValidos[i], 0);
    const somaX2 = indicesValidos.reduce((acc, x) => acc + x * x, 0);
    
    const inclinacao = (n * somaXY - somaX * somaY) / (n * somaX2 - somaX * somaX);
    const intercepto = (somaY - inclinacao * somaX) / n;
    
    console.log(`üìà Regress√£o: y = ${inclinacao.toFixed(2)}x + ${intercepto.toFixed(2)}`);
    
    // Criar array de proje√ß√£o
    const projecao = dados.map((_, index) => {
        // At√© o √∫ltimo dia com dados reais: usar os dados reais
        if (index <= ultimoIndiceComDadosReais) {
            return dados[index] && dados[index] > 0 ? dados[index] : null;
        }
        // Ap√≥s o √∫ltimo dia com dados reais: projetar usando a tend√™ncia
        else {
            const valorProjetado = inclinacao * index + intercepto;
            return valorProjetado > 0 ? valorProjetado : null;
        }
    });
    
    return projecao;
}

// Fun√ß√£o para criar gr√°fico de linha (Frete Correto vs Despesas Gerais)
function criarGraficoDialio() {
    const ctx = document.getElementById('chartFreteDialio').getContext('2d');
    
    // Verificar se dados_diarios existe no objeto
    const dadosDiarios = dashboardData.frete_diario.dados_diarios || dashboardData.frete_diario;
    const totaisMensais = dashboardData.frete_diario.totais_mensais || {};
    
    const labels = dadosDiarios.map(d => d.dia.toString());
    const freteCorreto = dadosDiarios.map(d => d.frete_correto || 0);
    const despesasGerais = dadosDiarios.map(d => d.despesas_gerais || 0);
    
    // Calcular proje√ß√£o futura para Frete Correto
    const projecaoFrete = calcularProjecaoFutura(freteCorreto, labels);
    
    // Atualizar totais mensais na interface
    atualizarTotaisMensais(totaisMensais);
    
    chartDialio = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'Frete Correto',
                data: freteCorreto,
                borderColor: '#00b894',
                backgroundColor: 'rgba(0, 184, 148, 0.1)',
                borderWidth: 2,
                fill: false,
                tension: 0.4
            }, {
                label: 'Despesas Gerais',
                data: despesasGerais,
                borderColor: '#e17055',
                backgroundColor: 'rgba(225, 112, 85, 0.1)',
                borderWidth: 2,
                fill: false,
                tension: 0.4
            }, {
                label: 'Proje√ß√£o Frete',
                data: projecaoFrete,
                borderColor: '#fdcb6e',
                backgroundColor: 'rgba(253, 203, 110, 0.1)',
                borderWidth: 2,
                borderDash: [5, 5],
                fill: false,
                tension: 0.1,
                pointRadius: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: true,
                    position: 'top',
                    labels: {
                        color: '#ffffff',
                        font: {
                            size: 12
                        },
                        usePointStyle: true,
                        padding: 20
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return context.dataset.label + ': R$ ' + context.parsed.y.toLocaleString('pt-BR', {
                                minimumFractionDigits: 2,
                                maximumFractionDigits: 2
                            });
                        }
                    }
                },
                datalabels: {
                    display: function(context) {
                        // Mostrar r√≥tulos APENAS no Frete Correto (primeiro dataset)
                        if (context.datasetIndex !== 0) {
                            return false; // Ocultar para Despesas Gerais
                        }
                        // Mostrar r√≥tulos apenas a cada 5 dias para n√£o poluir
                        const index = context.dataIndex;
                        return index % 5 === 0 || index === context.dataset.data.length - 1;
                    },
                    color: '#ffffff',
                    backgroundColor: '#00b894', // Cor fixa verde para Frete Correto
                    borderColor: 'rgba(255, 255, 255, 0.3)',
                    borderRadius: 4,
                    borderWidth: 1,
                    padding: {
                        top: 4,
                        bottom: 4,
                        left: 6,
                        right: 6
                    },
                    font: {
                        size: 10,
                        weight: 'bold'
                    },
                    formatter: function(value, context) {
                        if (value > 0) {
                            return 'R$ ' + (value / 1000).toFixed(0) + 'k';
                        }
                        return '';
                    },
                    anchor: 'end',
                    align: 'top',
                    offset: 10
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return 'R$ ' + (value / 1000).toFixed(0) + 'k';
                        },
                        color: '#ffffff',
                        font: {
                            size: 11
                        }
                    },
                    grid: {
                        color: 'rgba(255, 255, 255, 0.1)'
                    }
                },
                x: {
                    ticks: {
                        color: '#ffffff',
                        font: {
                            size: 10
                        },
                        maxTicksLimit: 31,
                        maxRotation: 0,
                        minRotation: 0,
                        padding: 5,
                        autoSkip: false
                    },
                    grid: {
                        color: 'rgba(255, 255, 255, 0.1)'
                    }
                }
            }
        }
    });
}

// Fun√ß√£o para atualizar totais mensais
function atualizarTotaisMensais(totais) {
    console.log('üí∞ Atualizando totais mensais:', totais);
    
    const totalFreteCorreto = totais.frete_correto || 0;
    const totalDespesasGerais = totais.despesas_gerais || 0;
    const diferenca = totalFreteCorreto - totalDespesasGerais;
    
    console.log(`üìä FC: R$ ${totalFreteCorreto.toFixed(2)} | DG: R$ ${totalDespesasGerais.toFixed(2)} | Diff: R$ ${diferenca.toFixed(2)}`);
    
    const elementoFC = document.getElementById('totalFreteCorreto');
    const elementoDG = document.getElementById('totalDespesasGerais');
    const elementoDiff = document.getElementById('totalDiferenca');
    
    if (elementoFC) {
        elementoFC.textContent = 'R$ ' + totalFreteCorreto.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2});
        console.log('‚úÖ Total FC atualizado');
    } else {
        console.log('‚ùå Elemento totalFreteCorreto n√£o encontrado');
    }
    
    if (elementoDG) {
        elementoDG.textContent = 'R$ ' + totalDespesasGerais.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2});
        console.log('‚úÖ Total DG atualizado');
    } else {
        console.log('‚ùå Elemento totalDespesasGerais n√£o encontrado');
    }
    
    if (elementoDiff) {
        elementoDiff.textContent = 'R$ ' + diferenca.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2});
        console.log('‚úÖ Total Diferen√ßa atualizado');
    } else {
        console.log('‚ùå Elemento totalDiferenca n√£o encontrado');
    }
}

// Fun√ß√£o para criar gr√°fico de barras horizontais (Clientes) 
function criarGraficoClientes() {
    const ctx = document.getElementById('chartClientes').getContext('2d');
    
    const labels = dashboardData.clientes_participacao.map(d => d.nome);
    const valores = dashboardData.clientes_participacao.map(d => d.percentual);
    const cores = dashboardData.clientes_participacao.map(d => d.cor);
    
    chartClientes = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Participa√ß√£o %',
                data: valores,
                backgroundColor: cores,
                borderColor: 'rgba(255, 255, 255, 0.2)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            indexAxis: 'y',
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return context.dataset.label + ': ' + context.parsed.x.toFixed(2) + '%';
                        }
                    }
                }
            },
            scales: {
                x: {
                    beginAtZero: true,
                    max: 40,
                    ticks: {
                        callback: function(value) {
                            return value + '%';
                        }
                    },
                    grid: {
                        color: 'rgba(255, 255, 255, 0.1)'
                    }
                },
                y: {
                    grid: {
                        color: 'rgba(255, 255, 255, 0.1)'
                    }
                }
            }
        }
    });
}

// Fun√ß√£o para criar gr√°fico de barras (Frete Mensal)
function criarGraficoMensal() {
    const ctx = document.getElementById('chartFreteMensal').getContext('2d');
    
    const labels = dashboardData.frete_mensal.map(d => d.mes);
    const valores = dashboardData.frete_mensal.map(d => d.frete_receber);
    
    chartMensal = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Frete Mensal',
                data: valores,
                backgroundColor: 'rgba(116, 185, 255, 0.8)',
                borderColor: '#74b9ff',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return 'Frete: R$ ' + context.parsed.y.toLocaleString('pt-BR', {
                                minimumFractionDigits: 2,
                                maximumFractionDigits: 2
                            });
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return 'R$ ' + (value / 1000000).toFixed(1) + 'M';
                        }
                    },
                    grid: {
                        color: 'rgba(255, 255, 255, 0.1)'
                    }
                },
                x: {
                    grid: {
                        color: 'rgba(255, 255, 255, 0.1)'
                    }
                }
            }
        }
    });
}

// Inicializar gr√°ficos quando a p√°gina carregar
document.addEventListener('DOMContentLoaded', function() {
    // Ocultar placeholders e mostrar canvas
    setTimeout(() => {
        document.querySelectorAll('.chart-placeholder').forEach(placeholder => {
            placeholder.style.display = 'none';
        });
        
        document.querySelectorAll('canvas').forEach(canvas => {
            canvas.style.display = 'block';
        });
        
        // Criar gr√°ficos
        criarGraficoDialio();
        criarGraficoClientes();
        criarGraficoMensal();
    }, 500);
});

// Fun√ß√£o para limpar todos os filtros
function limparFiltros() {
    document.getElementById('filtro-perfil').value = 'TODOS';
    document.getElementById('filtro-clientes').value = '';
    document.getElementById('filtro-veiculo').value = '';
    document.getElementById('filtro-mes').value = 'AGO';
    document.getElementById('filtro-ano').value = '2025';
    
    atualizarStatusFiltros();
    atualizarDashboard();
}

// Fun√ß√£o para atualizar status dos filtros
function atualizarStatusFiltros() {
    console.log('üè∑Ô∏è Iniciando atualizarStatusFiltros...');
    
    const perfil = document.getElementById('filtro-perfil').value;
    const cliente = document.getElementById('filtro-clientes').value;
    const veiculo = document.getElementById('filtro-veiculo').value;
    const mes = document.getElementById('filtro-mes').value;
    const ano = document.getElementById('filtro-ano').value;
    
    console.log(`üìã Valores dos filtros:`, {perfil, cliente, veiculo, mes, ano});
    
    const statusElement = document.getElementById('filtrosStatus');
    const statusBadge = statusElement?.querySelector('.status-badge');
    
    if (!statusBadge) {
        console.log('‚ùå Status badge n√£o encontrado!');
        return;
    }
    
    let statusText = '';
    let isFiltrado = false;
    
    if (perfil !== 'TODOS' || cliente !== '' || veiculo !== '') {
        isFiltrado = true;
        let partes = [];
        if (perfil !== 'TODOS') partes.push(perfil);
        if (cliente !== '') partes.push(cliente);
        if (veiculo !== '') partes.push(veiculo);
        statusText = partes.join(' + ') + ` | ${mes}/${ano}`;
        console.log(`üîç Status filtrado: "${statusText}"`);
    } else {
        statusText = `Todos os dados | ${mes}/${ano}`;
        console.log(`üìä Status sem filtros: "${statusText}"`);
    }
    
    statusBadge.textContent = statusText;
    statusBadge.className = isFiltrado ? 'status-badge filtrado' : 'status-badge';
    
    console.log('‚úÖ Status badge atualizado:', statusBadge.textContent, statusBadge.className);
}

// Event listeners para os filtros
document.getElementById('filtro-perfil').addEventListener('change', function() {
    console.log('Perfil alterado:', this.value);
    atualizarStatusFiltros();
    atualizarDashboard();
});

document.getElementById('filtro-clientes').addEventListener('change', function() {
    atualizarStatusFiltros();
    atualizarDashboard();
});

document.getElementById('filtro-veiculo').addEventListener('change', function() {
    atualizarStatusFiltros();
    atualizarDashboard();
});

document.getElementById('filtro-mes').addEventListener('change', function() {
    console.log('M√™s alterado:', this.value);
    atualizarStatusFiltros();
    atualizarDashboard();
});

document.getElementById('filtro-ano').addEventListener('change', function() {
    console.log('Ano alterado:', this.value);
    atualizarStatusFiltros();
    atualizarDashboard();
});

// Vari√°veis globais para os gr√°ficos
let chartDialio, chartClientes, chartMensal;

// Fun√ß√£o para atualizar dashboard via AJAX
function atualizarDashboard() {
    const filtros = {
        perfil: document.getElementById('filtro-perfil').value,
        mes: document.getElementById('filtro-mes').value,
        ano: document.getElementById('filtro-ano').value,
        clientes: document.getElementById('filtro-clientes').value ? [document.getElementById('filtro-clientes').value] : [],
        veiculos: document.getElementById('filtro-veiculo').value ? [document.getElementById('filtro-veiculo').value] : []
    };
    
    console.log('üîÑ Atualizando dashboard com filtros:', filtros);
    
    // Mostrar indicador de carregamento
    document.querySelectorAll('.chart-container').forEach(container => {
        container.style.opacity = '0.5';
    });
    
    // Atualizar status para carregando
    const statusBadge = document.querySelector('.status-badge');
    const textoOriginal = statusBadge.textContent;
    statusBadge.textContent = 'üîÑ Filtrando dados...';
    statusBadge.className = 'status-badge carregando';
    
    // Debug dos totais antes da atualiza√ß√£o
    const totalAtual = document.getElementById('totalFreteCorreto').textContent;
    console.log('üí∞ Total atual antes da atualiza√ß√£o:', totalAtual);
    
    fetch('/frete/painel/api/dados', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(filtros)
    })
    .then(response => {
        console.log('üì° Status da resposta:', response.status, response.statusText);
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
    })
    .then(data => {
        console.log('‚úÖ Dados atualizados recebidos:', data);
        console.log('üìä Frete di√°rio recebido:', data.frete_diario);
        
        // Verificar se temos dados de frete di√°rio
        if (data.frete_diario && (data.frete_diario.dados_diarios || data.frete_diario.length > 0)) {
            console.log('üìà Atualizando gr√°fico com novos dados...');
            // Atualizar gr√°ficos
            atualizarGraficos(data);
        } else {
            console.log('‚ö†Ô∏è Nenhum dado de frete di√°rio encontrado');
        }
        
        // Atualizar m√©tricas
        atualizarMetricas(data.metricas);
        
        // Remover indicador de carregamento
        document.querySelectorAll('.chart-container').forEach(container => {
            container.style.opacity = '1';
        });
        
        // Restaurar status dos filtros
        console.log('üîÑ Iniciando restore do status dos filtros...');
        setTimeout(() => {
            console.log('‚è∞ Executando atualizarStatusFiltros ap√≥s 500ms...');
            atualizarStatusFiltros();
            console.log('‚úÖ Status dos filtros restaurado com sucesso!');
        }, 500);
    })
    .catch(error => {
        console.error('‚ùå Erro ao atualizar dashboard:', error);
        
        // Restaurar interface em caso de erro
        document.querySelectorAll('.chart-container').forEach(container => {
            container.style.opacity = '1';
        });
        
        // Restaurar status
        const statusBadge = document.querySelector('.status-badge');
        statusBadge.textContent = '‚ö†Ô∏è Erro ao filtrar';
        statusBadge.className = 'status-badge filtrado';
        
        // Tentar restaurar status ap√≥s 3 segundos
        setTimeout(() => {
            atualizarStatusFiltros();
        }, 3000);
    });
}

// Fun√ß√£o para atualizar m√©tricas
function atualizarMetricas(metricas) {
    document.querySelector('.metrica-card.receber .metrica-valor').textContent = 
        'R$ ' + metricas.frete_receber.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2});
    
    document.querySelector('.metrica-card.pagar .metrica-valor').textContent = 
        'R$ ' + metricas.frete_pagar.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2});
    
    document.querySelector('.metrica-card.diferenca .metrica-valor').textContent = 
        'R$ ' + metricas.diferenca.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2});
    
    document.querySelector('.metrica-card.produtividade .metrica-valor').textContent = 
        metricas.produtividade.toFixed(2) + '%';
}

// Fun√ß√£o para atualizar gr√°ficos
function atualizarGraficos(data) {
    console.log('üéØ Iniciando atualiza√ß√£o dos gr√°ficos...');
    console.log('üìä Dados recebidos para gr√°fico:', data.frete_diario);
    
    // Atualizar gr√°fico di√°rio (Frete Correto vs Despesas Gerais)
    if (chartDialio) {
        const dadosDiarios = data.frete_diario.dados_diarios || data.frete_diario;
        const totaisMensais = data.frete_diario.totais_mensais || {};
        
        console.log('üìà Dados di√°rios:', dadosDiarios ? dadosDiarios.length : 'undefined');
        console.log('üí∞ Totais mensais:', totaisMensais);
        
        if (dadosDiarios && Array.isArray(dadosDiarios)) {
            const labels = dadosDiarios.map(d => d.dia.toString());
            const freteCorreto = dadosDiarios.map(d => d.frete_correto || 0);
            const despesasGerais = dadosDiarios.map(d => d.despesas_gerais || 0);
            
            // Recalcular proje√ß√£o futura
            const projecaoFrete = calcularProjecaoFutura(freteCorreto, labels);
            
            console.log('üìä Atualizando gr√°fico com novos dados:');
            console.log('   Labels:', labels.length);
            console.log('   FC max:', Math.max(...freteCorreto));
            console.log('   DG max:', Math.max(...despesasGerais));
            
            chartDialio.data.labels = labels;
            chartDialio.data.datasets[0].data = freteCorreto;
            chartDialio.data.datasets[1].data = despesasGerais;
            if (chartDialio.data.datasets[2]) {
                chartDialio.data.datasets[2].data = projecaoFrete;
            }
            chartDialio.update('active');
            
            console.log('‚úÖ Gr√°fico atualizado!');
        } else {
            console.log('‚ö†Ô∏è Dados di√°rios inv√°lidos:', dadosDiarios);
        }
        
        // Atualizar totais mensais
        atualizarTotaisMensais(totaisMensais);
        console.log('üèÅ Gr√°fico principal atualizado com sucesso!');
    } else {
        console.log('‚ùå Gr√°fico n√£o encontrado!');
    }
    
    // Atualizar gr√°fico de clientes
    if (chartClientes) {
        const labels = data.clientes_participacao.map(d => d.nome);
        const valores = data.clientes_participacao.map(d => d.percentual);
        const cores = data.clientes_participacao.map(d => d.cor);
        
        chartClientes.data.labels = labels;
        chartClientes.data.datasets[0].data = valores;
        chartClientes.data.datasets[0].backgroundColor = cores;
        chartClientes.update();
    }
    
    // Atualizar gr√°fico mensal
    if (chartMensal) {
        const labels = data.frete_mensal.map(d => d.mes);
        const valores = data.frete_mensal.map(d => d.frete_receber);
        
        chartMensal.data.labels = labels;
        chartMensal.data.datasets[0].data = valores;
        chartMensal.update();
    }
}
</script>
{% endblock %}