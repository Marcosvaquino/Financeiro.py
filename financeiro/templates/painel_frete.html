{% extends "base.html" %}

{% block title %}Painel de Gerenciamento de Frete{% endblock %}

{% block content %}
<div class="dashboard-container">
    <div class="dashboard-hero">
        <div class="hero-content">
            <div class="hero-text">
                <h1>🚛 Painel de Gerenciamento de Frete</h1>
                <p class="hero-subtitle">Análise Completa de Performance e Rentabilidade</p>
            </div>
            <div class="hero-filters-compact">
                <div class="filter-inline">
                    <select id="filtro-perfil" class="select-compact" onchange="carregarDadosDebounced()">
                        <option value="">Todos Perfis</option>
                    </select>
                    <span class="filter-separator">|</span>
                    <select id="filtro-cliente" class="select-compact" onchange="carregarDadosDebounced()">
                        <option value="">Todos Clientes</option>
                    </select>
                    <span class="filter-separator">|</span>
                    <select id="filtro-mes" class="select-compact" onchange="carregarDadosDebounced()">
                        <option value="">Todos Meses</option>
                    </select>
                    <span class="filter-separator">/</span>
                    <select id="filtro-ano" class="select-compact" onchange="carregarDadosDebounced()">
                        <option value="">Todos Anos</option>
                    </select>
                </div>
                <div class="filter-status">
                    <span id="loading-indicator" class="status-loading" style="display: none;">🔄 Atualizando...</span>
                    <span id="last-update" class="status-success">📊 Dados atualizados</span>
                </div>
            </div>
        </div>
    </div>

    <div class="kpi-section-compact">
        <div class="kpi-row">
            <div class="kpi-card-compact receita executive-card" onclick="abrirAnaliseReceita()">
                <div class="kpi-header">
                    <span class="kpi-icon-small">💰</span>
                    <h3>Faturado</h3>
                    <span class="kpi-trend-compact up"></span>
                </div>
                <div class="kpi-main-value" id="total-faturado">R$ 0,00</div>
                <div class="kpi-sub-info">
                    <span class="kpi-meta">Receita Total</span>
                    <span class="kpi-percent success">📊 Ver Análise</span>
                </div>
            </div>

            <div class="kpi-card-compact margem executive-card" onclick="abrirAnaliseOperacional()">
                <div class="kpi-header">
                    <span class="kpi-icon-small">⚡</span>
                    <h3>Despesas</h3>
                    <span class="kpi-trend-compact down"></span>
                </div>
                <div class="kpi-main-value" id="total-despesas">R$ 0,00</div>
                <div class="kpi-sub-info">
                    <span class="kpi-meta">Custos Totais</span>
                    <span class="kpi-percent warning">🔍 Otimizar</span>
                </div>
            </div>

            <div class="kpi-card-compact clientes executive-card" onclick="abrirAnaliseRentabilidade()">
                <div class="kpi-header">
                    <span class="kpi-icon-small">📈</span>
                    <h3>Margem</h3>
                    <span class="kpi-trend-compact up"></span>
                </div>
                <div class="kpi-main-value" id="margem-liquida">0%</div>
                <div class="kpi-sub-info">
                    <span class="kpi-meta">Rentabilidade</span>
                    <span class="kpi-percent success">📈 Estratégia</span>
                </div>
            </div>

            <div class="kpi-card-compact extra executive-card" onclick="abrirAnaliseViagens()">
                <div class="kpi-header">
                    <span class="kpi-icon-small">🎯</span>
                    <h3>Viagens</h3>
                    <span class="kpi-trend-compact up"></span>
                </div>
                <div class="kpi-main-value" id="numero-viagens">0</div>
                <div class="kpi-sub-info">
                    <span class="kpi-meta">Total Entregas</span>
                    <span class="kpi-percent success">📋 Ver Detalhes</span>
                </div>
            </div>

            <div class="kpi-card-compact growth executive-card" onclick="abrirAnaliseTicketMedio()">
                <div class="kpi-header">
                    <span class="kpi-icon-small">🎲</span>
                    <h3>Ticket Médio</h3>
                    <span class="kpi-trend-compact up"></span>
                </div>
                <div class="kpi-main-value" id="ticket-medio">R$ 0,00</div>
                <div class="kpi-sub-info">
                    <span class="kpi-meta">Por Viagem</span>
                    <span class="kpi-percent success">💡 Otimizar</span>
                </div>
            </div>

            <div class="kpi-card-compact receita executive-card" onclick="abrirAnaliseTopCliente()">
                <div class="kpi-header">
                    <span class="kpi-icon-small">🏆</span>
                    <h3>Top Cliente</h3>
                    <span class="kpi-trend-compact up"></span>
                </div>
                <div class="kpi-main-value" id="cliente-mais-rentavel" style="font-size: 16px;">N/A</div>
                <div class="kpi-sub-info">
                    <span class="kpi-meta">Mais Rentável</span>
                    <span class="kpi-percent success">👑 Perfil</span>
                </div>
            </div>
        </div>
    </div>

    <div class="charts-section">
        <div class="chart-container-full">
            <div class="chart-card">
                <div class="chart-header">
                    <h3>� Análise Mensal de Frete</h3>
                    <p class="chart-subtitle">Frete a pagar/receber com % rentabilidade - Todos os meses</p>
                </div>
                <div class="chart-content">
                    <canvas id="graficoMensal"></canvas>
                </div>
            </div>
        </div>

        <div class="charts-row">
            <div class="chart-container-half">
                <div class="chart-card">
                    <div class="chart-header">
                        <h3>� Receita e Despesa Diária (Acumulativo)</h3>
                        <p class="chart-subtitle">Evolução diária do desempenho financeiro - Dias 1 a 31</p>
                    </div>
                    <div class="chart-content">
                        <canvas id="graficoDiario"></canvas>
                    </div>
                </div>
            </div>

            <div class="chart-container-half">
                <div class="chart-card">
                    <div class="chart-header">
                        <h3>🎯 Top 10 Clientes</h3>
                        <p class="chart-subtitle">Receita, despesa e % rentabilidade por cliente</p>
                    </div>
                    <div class="chart-content">
                        <canvas id="graficoClientes"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Análise de Receita (Frete a Receber) -->
    <div id="modalReceita" class="modal-overlay" style="display: none;" onclick="fecharModal('modalReceita')">
        <div class="modal-content-wide" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h2>💰 Faturamento - Detalhamento Completo</h2>
                <button onclick="fecharModal('modalReceita')" class="btn-close-modal">✕</button>
            </div>
            <div class="modal-body">
                <!-- Cards de resumo no topo -->
                <div class="executive-stats-grid compact">
                    <div class="exec-stat-card revenue">
                        <div class="stat-header">
                            <span class="stat-icon">🏆</span>
                            <h4>Total Faturado</h4>
                        </div>
                        <div class="stat-value" id="exec-total-faturado">R$ 0</div>
                        <div class="stat-detail">Frete a Receber</div>
                        <div class="stat-growth positive">Entrada</div>
                    </div>
                    
                    <div class="exec-stat-card growth">
                        <div class="stat-header">
                            <span class="stat-icon">🎯</span>
                            <h4>Top Cliente</h4>
                        </div>
                        <div class="stat-value" id="exec-cliente-top" style="font-size: 18px;">-</div>
                        <div class="stat-detail" id="exec-cliente-receita">R$ 0</div>
                        <div class="stat-growth positive" id="exec-cliente-participacao">0%</div>
                    </div>
                    
                    <div class="exec-stat-card target">
                        <div class="stat-header">
                            <span class="stat-icon">�</span>
                            <h4>Veículo + Rentável</h4>
                        </div>
                        <div class="stat-value" id="exec-veiculo-top" style="font-size: 18px;">-</div>
                        <div class="stat-detail" id="exec-veiculo-receita">R$ 0</div>
                        <div class="stat-growth positive">MVP</div>
                    </div>
                    
                    <div class="exec-stat-card potential">
                        <div class="stat-header">
                            <span class="stat-icon">🎲</span>
                            <h4>Ticket Médio</h4>
                        </div>
                        <div class="stat-value" id="exec-ticket-medio-recebido">R$ 0</div>
                        <div class="stat-detail">Por Frete</div>
                        <div class="stat-growth positive">Média</div>
                    </div>
                    
                    <!-- Cards antigos removidos -->
                    <div class="exec-stat-card growth" style="display: none;">
                        <div class="stat-header">
                            <span class="stat-icon">�</span>
                            <h4>Top Cliente</h4>
                        </div>
                        <div class="stat-value" id="exec-cliente-top" style="font-size: 18px;">-</div>
                        <div class="stat-detail" id="exec-cliente-receita">R$ 0</div>
                        <div class="stat-growth positive" id="exec-cliente-participacao">0%</div>
                    </div>
                    
                    <div class="exec-stat-card target" style="display: none;">
                        <div class="stat-header">
                            <span class="stat-icon">🚚</span>
                            <h4>Veículo + Rentável</h4>
                        </div>
                        <div class="stat-value" id="exec-veiculo-top" style="font-size: 18px;">-</div>
                        <div class="stat-detail" id="exec-veiculo-receita">R$ 0</div>
                        <div class="stat-growth positive">MVP</div>
                    </div>
                    
                    <div class="exec-stat-card potential" style="display: none;">
                        <div class="stat-header">
                            <span class="stat-icon">🎲</span>
                            <h4>Ticket Médio</h4>
                        </div>
                        <div class="stat-value" id="exec-ticket-medio-recebido">R$ 0</div>
                        <div class="stat-detail">Por Frete</div>
                        <div class="stat-growth positive">Média</div>
                    </div>
                </div>

                <!-- TOP 5 lado a lado SEM SCROLL ANTES dos filtros como você pediu -->
                <div class="top5-container">
                    <div class="top5-section">
                        <div class="insight-card success">
                            <h4>🏆 Top 5 - Clientes que Mais Faturaram</h4>
                            <div class="insight-content">
                                <div class="table-container-no-scroll">
                                    <table class="executive-table compact">
                                        <thead>
                                            <tr>
                                                <th>Pos</th>
                                                <th>Cliente</th>
                                                <th>Faturamento</th>
                                                <th>%</th>
                                            </tr>
                                        </thead>
                                        <tbody id="tabela-top-clientes">
                                            <tr><td colspan="4">Carregando...</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="top5-section">
                        <div class="insight-card growth">
                            <h4>🚚 Top 5 - Veículos que Mais Faturaram</h4>
                            <div class="insight-content">
                                <div class="table-container-no-scroll">
                                    <table class="executive-table compact">
                                        <thead>
                                            <tr>
                                                <th>Pos</th>
                                                <th>Veículo</th>
                                                <th>Faturamento</th>
                                                <th>Viagens</th>
                                            </tr>
                                        </thead>
                                        <tbody id="tabela-top-veiculos">
                                            <tr><td colspan="4">Carregando...</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Filtros DEPOIS dos Top 5 -->
                <div class="modal-filters">
                    <div class="filter-group">
                        <label>🏢 Filtrar por Cliente:</label>
                        <input type="text" id="filtro-cliente-modal" placeholder="Digite o nome do cliente..." onkeyup="filtrarTabelaReceita()">
                    </div>
                    <div class="filter-group">
                        <label>🚚 Filtrar por Veículo:</label>
                        <input type="text" id="filtro-veiculo-modal" placeholder="Digite a placa do veículo..." onkeyup="filtrarTabelaReceita()">
                    </div>
                    <div class="filter-group">
                        <label>📊 Status:</label>
                        <select id="filtro-status-modal" onchange="filtrarTabelaReceita()">
                            <option value="">Todos</option>
                            <option value="ativo">Ativo</option>
                            <option value="pendente">Pendente</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <button class="btn-clear-filters" onclick="limparFiltrosReceita()">🗑️ Limpar Filtros</button>
                    </div>
                </div>

                <!-- Tabela completa COM TODAS as placas -->
                <div class="modal-table-container">
                    <table class="modal-table">
                        <thead>
                            <tr>
                                <th>CLIENTE</th>
                                <th>VEÍCULO</th>
                                <th>FATURAMENTO</th>
                                <th>VIAGENS</th>
                                <th>% DO TOTAL</th>
                            </tr>
                        </thead>
                        <tbody id="tabela-faturamento-completa">
                            <tr><td colspan="5">Carregando dados...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Análise de Despesas (Frete a Pagar) -->
    <div id="modalOperacional" class="modal-overlay" style="display: none;" onclick="fecharModal('modalOperacional')">
        <div class="modal-content-wide" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h2>💸 Despesas - Detalhamento Completo</h2>
                <button onclick="fecharModal('modalOperacional')" class="btn-close-modal">✕</button>
            </div>
            <div class="modal-body">
                <!-- Cards originais no topo -->
                <div class="executive-stats-grid compact">
                    <div class="exec-stat-card cost">
                        <div class="stat-header">
                            <span class="stat-icon">�</span>
                            <h4>Total Pago</h4>
                        </div>
                        <div class="stat-value" id="exec-total-frete-pago">R$ 0</div>
                        <div class="stat-detail">Frete a Pagar</div>
                        <div class="stat-growth negative">Saída</div>
                    </div>
                    
                    <div class="exec-stat-card efficiency">
                        <div class="stat-header">
                            <span class="stat-icon">📊</span>
                            <h4>Maior Pagamento</h4>
                        </div>
                        <div class="stat-value" id="exec-maior-pagamento">R$ 0</div>
                        <div class="stat-detail" id="exec-maior-beneficiario">-</div>
                        <div class="stat-growth neutral" id="exec-participacao-maior">0%</div>
                    </div>
                    
                    <div class="exec-stat-card benchmark">
                        <div class="stat-header">
                            <span class="stat-icon">�</span>
                            <h4>Veículo + Usado</h4>
                        </div>
                        <div class="stat-value" id="exec-veiculo-mais-usado" style="font-size: 18px;">-</div>
                        <div class="stat-detail" id="exec-viagens-veiculo">0 viagens</div>
                        <div class="stat-growth positive">Ativo</div>
                    </div>
                    
                    <div class="exec-stat-card savings">
                        <div class="stat-header">
                            <span class="stat-icon">�</span>
                            <h4>Ticket Médio Pago</h4>
                        </div>
                        <div class="stat-value" id="exec-ticket-medio-pago">R$ 0</div>
                        <div class="stat-detail">Por Pagamento</div>
                        <div class="stat-growth neutral">Média</div>
                    </div>
                </div>
                
                <!-- Tabela Top Pagamentos -->
                <div class="executive-insights">
                    <div class="insight-card warning">
                        <h4>📋 Top 5 - Maiores Pagamentos de Frete</h4>
                        <div class="insight-content">
                            <div class="table-container">
                                <table class="executive-table">
                                    <thead>
                                        <tr>
                                            <th>Pos</th>
                                            <th>Embarcador</th>
                                            <th>Veículo</th>
                                            <th>Valor Pago</th>
                                            <th>% Total</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tabela-maiores-pagamentos">
                                        <tr><td colspan="5">Carregando dados...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Análise de Rentabilidade -->
    <div id="modalRentabilidade" class="modal-overlay" style="display: none;" onclick="fecharModal('modalRentabilidade')">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h2>📈 Análise Executiva - Rentabilidade</h2>
                <button onclick="fecharModal('modalRentabilidade')" class="btn-close-modal">✕</button>
            </div>
            <div class="modal-body">
                <div class="executive-stats-grid">
                    <div class="exec-stat-card margin">
                        <div class="stat-header">
                            <span class="stat-icon">📈</span>
                            <h4>Margem Atual</h4>
                        </div>
                        <div class="stat-value" id="exec-margem-atual">0%</div>
                        <div class="stat-detail">Lucro sobre Receita</div>
                        <div class="stat-growth positive" id="exec-margem-status">Avaliar</div>
                    </div>
                    
                    <div class="exec-stat-card target-margin">
                        <div class="stat-header">
                            <span class="stat-icon">🎯</span>
                            <h4>Meta Margem</h4>
                        </div>
                        <div class="stat-value" id="exec-meta-margem">25%</div>
                        <div class="stat-detail">Objetivo Estratégico</div>
                        <div class="stat-growth positive">Ideal</div>
                    </div>
                    
                    <div class="exec-stat-card breakeven">
                        <div class="stat-header">
                            <span class="stat-icon">⚖️</span>
                            <h4>Ponto Equilíbrio</h4>
                        </div>
                        <div class="stat-value" id="exec-breakeven">R$ 0</div>
                        <div class="stat-detail">Faturamento Mínimo</div>
                        <div class="stat-growth neutral">Crítico</div>
                    </div>
                    
                    <div class="exec-stat-card roi">
                        <div class="stat-header">
                            <span class="stat-icon">💎</span>
                            <h4>ROI Projetado</h4>
                        </div>
                        <div class="stat-value" id="exec-roi">15%</div>
                        <div class="stat-detail">Retorno Anualizado</div>
                        <div class="stat-growth positive">Atrativo</div>
                    </div>
                </div>
                
                <div class="executive-insights">
                    <div class="insight-card premium">
                        <h4>💼 Plano de Ação Executivo</h4>
                        <div class="insight-content">
                            <div class="action-items">
                                <div class="action-item priority-high">
                                    <span class="action-priority">🔴</span>
                                    <span class="action-text">Revisar contratos com margem < 15%</span>
                                </div>
                                <div class="action-item priority-high">
                                    <span class="action-priority">🔴</span>
                                    <span class="action-text">Renegociar preços com clientes de baixa margem</span>
                                </div>
                                <div class="action-item priority-medium">
                                    <span class="action-priority">🟡</span>
                                    <span class="action-text">Implementar dashboard de rentabilidade por rota</span>
                                </div>
                                <div class="action-item priority-medium">
                                    <span class="action-priority">🟡</span>
                                    <span class="action-text">Desenvolver análise de margem por cliente</span>
                                </div>
                                <div class="action-item priority-low">
                                    <span class="action-priority">🟢</span>
                                    <span class="action-text">Capacitar equipe em negociação de preços</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Análise de Viagens -->
    <div id="modalViagens" class="modal-overlay" style="display: none;" onclick="fecharModal('modalViagens')">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h2>🎯 Análise Executiva - Controle de Viagens</h2>
                <button onclick="fecharModal('modalViagens')" class="btn-close-modal">✕</button>
            </div>
            <div class="modal-body">
                <div class="executive-stats-grid">
                    <div class="exec-stat-card potential">
                        <div class="stat-header">
                            <span class="stat-icon">🚛</span>
                            <h4>Total de Viagens</h4>
                        </div>
                        <div class="stat-value" id="exec-total-viagens">0</div>
                        <div class="stat-detail">Período Selecionado</div>
                        <div class="stat-growth positive">Entregas</div>
                    </div>
                    
                    <div class="exec-stat-card efficiency">
                        <div class="stat-header">
                            <span class="stat-icon">📅</span>
                            <h4>Média Diária</h4>
                        </div>
                        <div class="stat-value" id="exec-media-viagens-dia">0</div>
                        <div class="stat-detail">Viagens por Dia</div>
                        <div class="stat-growth positive">Consistência</div>
                    </div>
                    
                    <div class="exec-stat-card growth">
                        <div class="stat-header">
                            <span class="stat-icon">📈</span>
                            <h4>Crescimento</h4>
                        </div>
                        <div class="stat-value" id="exec-crescimento-viagens">+0%</div>
                        <div class="stat-detail">vs Período Anterior</div>
                        <div class="stat-growth positive" id="exec-tendencia-viagens">Estável</div>
                    </div>
                    
                    <div class="exec-stat-card target">
                        <div class="stat-header">
                            <span class="stat-icon">🎯</span>
                            <h4>Taxa Ocupação</h4>
                        </div>
                        <div class="stat-value" id="exec-ocupacao">85%</div>
                        <div class="stat-detail">Capacidade Utilizada</div>
                        <div class="stat-growth positive">Eficiente</div>
                    </div>
                </div>
                
                <div class="executive-insights">
                    <div class="insight-card success">
                        <h4>📊 Análise Operacional</h4>
                        <div class="insight-content">
                            <ul>
                                <li><strong>Pico de Demanda:</strong> Identificar horários/dias com maior volume</li>
                                <li><strong>Otimização de Rotas:</strong> Reduzir quilometragem e tempo de entrega</li>
                                <li><strong>Planejamento:</strong> Melhorar distribuição de carga ao longo da semana</li>
                                <li><strong>Capacidade:</strong> Avaliar necessidade de expansão da frota</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Análise de Ticket Médio -->
    <div id="modalTicketMedio" class="modal-overlay" style="display: none;" onclick="fecharModal('modalTicketMedio')">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h2>🎲 Análise Executiva - Ticket Médio</h2>
                <button onclick="fecharModal('modalTicketMedio')" class="btn-close-modal">✕</button>
            </div>
            <div class="modal-body">
                <div class="executive-stats-grid">
                    <div class="exec-stat-card revenue">
                        <div class="stat-header">
                            <span class="stat-icon">💰</span>
                            <h4>Ticket Atual</h4>
                        </div>
                        <div class="stat-value" id="exec-ticket-atual">R$ 0</div>
                        <div class="stat-detail">Por Viagem</div>
                        <div class="stat-growth positive">Média</div>
                    </div>
                    
                    <div class="exec-stat-card benchmark">
                        <div class="stat-header">
                            <span class="stat-icon">📊</span>
                            <h4>Benchmark</h4>
                        </div>
                        <div class="stat-value" id="exec-ticket-benchmark">R$ 1.200</div>
                        <div class="stat-detail">Meta Mercado</div>
                        <div class="stat-growth neutral">Referência</div>
                    </div>
                    
                    <div class="exec-stat-card potential">
                        <div class="stat-header">
                            <span class="stat-icon">🚀</span>
                            <h4>Potencial Aumento</h4>
                        </div>
                        <div class="stat-value" id="exec-potencial-ticket">+15%</div>
                        <div class="stat-detail">Oportunidade</div>
                        <div class="stat-growth positive">Viável</div>
                    </div>
                    
                    <div class="exec-stat-card roi">
                        <div class="stat-header">
                            <span class="stat-icon">📈</span>
                            <h4>Impacto Receita</h4>
                        </div>
                        <div class="stat-value" id="exec-impacto-receita">R$ 0</div>
                        <div class="stat-detail">Se Meta Atingida</div>
                        <div class="stat-growth positive">Incremento</div>
                    </div>
                </div>
                
                <div class="executive-insights">
                    <div class="insight-card warning">
                        <h4>💡 Estratégias de Otimização</h4>
                        <div class="insight-content">
                            <div class="recommendation-item">
                                <span class="rec-icon">📦</span>
                                <span class="rec-text">Incentivar consolidação de cargas para aumentar volume por viagem</span>
                            </div>
                            <div class="recommendation-item">
                                <span class="rec-icon">💼</span>
                                <span class="rec-text">Oferecer serviços premium (entrega expressa, seguro adicional)</span>
                            </div>
                            <div class="recommendation-item">
                                <span class="rec-icon">🎯</span>
                                <span class="rec-text">Segmentar clientes por valor e oferecer preços diferenciados</span>
                            </div>
                            <div class="recommendation-item">
                                <span class="rec-icon">📊</span>
                                <span class="rec-text">Revisar precificação com base em distância e complexidade</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Análise do Top Cliente -->
    <div id="modalTopCliente" class="modal-overlay" style="display: none;" onclick="fecharModal('modalTopCliente')">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h2>🏆 Análise Executiva - Cliente Mais Rentável</h2>
                <button onclick="fecharModal('modalTopCliente')" class="btn-close-modal">✕</button>
            </div>
            <div class="modal-body">
                <div class="executive-stats-grid">
                    <div class="exec-stat-card revenue">
                        <div class="stat-header">
                            <span class="stat-icon">👑</span>
                            <h4>Cliente Principal</h4>
                        </div>
                        <div class="stat-value" id="exec-nome-top-cliente">N/A</div>
                        <div class="stat-detail">Mais Rentável</div>
                        <div class="stat-growth positive">MVP</div>
                    </div>
                    
                    <div class="exec-stat-card growth">
                        <div class="stat-header">
                            <span class="stat-icon">💰</span>
                            <h4>Receita Total</h4>
                        </div>
                        <div class="stat-value" id="exec-receita-top-cliente">R$ 0</div>
                        <div class="stat-detail">Período</div>
                        <div class="stat-growth positive" id="exec-participacao-top">0%</div>
                    </div>
                    
                    <div class="exec-stat-card efficiency">
                        <div class="stat-header">
                            <span class="stat-icon">📈</span>
                            <h4>Margem Cliente</h4>
                        </div>
                        <div class="stat-value" id="exec-margem-top-cliente">0%</div>
                        <div class="stat-detail">Rentabilidade</div>
                        <div class="stat-growth positive">Lucrativo</div>
                    </div>
                    
                    <div class="exec-stat-card target">
                        <div class="stat-header">
                            <span class="stat-icon">🚛</span>
                            <h4>Frequência</h4>
                        </div>
                        <div class="stat-value" id="exec-viagens-top-cliente">0</div>
                        <div class="stat-detail">Viagens</div>
                        <div class="stat-growth positive">Fidelidade</div>
                    </div>
                </div>
                
                <div class="executive-insights">
                    <div class="insight-card premium">
                        <h4>💼 Estratégia de Relacionamento</h4>
                        <div class="insight-content">
                            <div class="action-items">
                                <div class="action-item priority-high">
                                    <span class="action-priority">🔴</span>
                                    <span class="action-text">Manter excelência no atendimento e qualidade do serviço</span>
                                </div>
                                <div class="action-item priority-high">
                                    <span class="action-priority">🔴</span>
                                    <span class="action-text">Oferecer condições especiais para garantir fidelização</span>
                                </div>
                                <div class="action-item priority-medium">
                                    <span class="action-priority">🟡</span>
                                    <span class="action-text">Explorar oportunidades de expansão dos serviços</span>
                                </div>
                                <div class="action-item priority-medium">
                                    <span class="action-priority">🟡</span>
                                    <span class="action-text">Estabelecer contrato de longo prazo com desconto progressivo</span>
                                </div>
                                <div class="action-item priority-low">
                                    <span class="action-priority">🟢</span>
                                    <span class="action-text">Solicitar indicações para clientes similares</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.3.0/dist/chart.umd.js"></script>
<script>
let graficos = {};
let dadosAnaliseExecutiva = {};

document.addEventListener('DOMContentLoaded', function() {
    carregarFiltros();
    carregarDados();
});

async function carregarFiltros() {
    try {
        const response = await fetch('/api/painel-frete/filtros');
        const filtros = await response.json();
        
        preencherSelect('filtro-perfil', filtros.perfis || []);
        preencherSelect('filtro-cliente', filtros.clientes || []);
        preencherSelect('filtro-mes', filtros.meses || []);
        preencherSelect('filtro-ano', filtros.anos || []);
    } catch (error) {
        console.error('Erro ao carregar filtros:', error);
    }
}

function preencherSelect(id, opcoes) {
    const select = document.getElementById(id);
    const firstOption = select.children[0];
    select.innerHTML = '';
    select.appendChild(firstOption);
    
    opcoes.forEach(opcao => {
        const option = document.createElement('option');
        option.value = opcao;
        option.textContent = opcao;
        select.appendChild(option);
    });
}

async function carregarDados() {
    try {
        // Mostrar indicador de loading
        mostrarLoading(true);
        
        const params = new URLSearchParams();
        
        const perfil = document.getElementById('filtro-perfil').value;
        const cliente = document.getElementById('filtro-cliente').value;
        const mes = document.getElementById('filtro-mes').value;
        const ano = document.getElementById('filtro-ano').value;
        
        if (perfil) params.append('perfil', perfil);
        if (cliente) params.append('cliente', cliente);
        if (mes) params.append('mes', mes);
        if (ano) params.append('ano', ano);
        
        const response = await fetch('/api/painel-frete/dados?' + params.toString());
        const dados = await response.json();
        
        dadosAnaliseExecutiva = {
            receita: dados.analise_receita || {},
            despesas: dados.analise_despesas || {}
        };
        
        atualizarCards(dados.cards);
        atualizarGraficos(dados);
        
        // Esconder indicador de loading e mostrar sucesso
        mostrarLoading(false);
        atualizarStatusFiltros();
        
    } catch (error) {
        console.error('Erro ao carregar dados:', error);
        mostrarLoading(false);
        mostrarErro('Erro ao carregar dados. Tente novamente.');
    }
}

function atualizarCards(cards) {
    document.getElementById('total-faturado').textContent = formatarMoeda(cards.total_faturado);
    document.getElementById('total-despesas').textContent = formatarMoeda(cards.total_despesas);
    document.getElementById('margem-liquida').textContent = cards.margem_liquida_pct + '%';
    document.getElementById('numero-viagens').textContent = cards.numero_viagens;
    document.getElementById('ticket-medio').textContent = formatarMoeda(cards.ticket_medio);
    document.getElementById('cliente-mais-rentavel').textContent = cards.cliente_mais_rentavel;
}

function atualizarGraficos(dados) {
    Object.values(graficos).forEach(g => g && g.destroy());

    // Gráfico Diário
    graficos.diario = new Chart(document.getElementById('graficoDiario').getContext('2d'), {
        type: 'line',
        data: {
            labels: dados.grafico_diario.dias || [],
            datasets: [{
                label: 'Receita Acumulada',
                data: dados.grafico_diario.receita_acumulada || [],
                borderColor: '#28a745',
                backgroundColor: 'rgba(40, 167, 69, 0.1)',
                fill: true,
                tension: 0.4,
                pointBackgroundColor: '#28a745',
                pointBorderColor: '#ffffff',
                pointBorderWidth: 2,
                pointRadius: 5,
                pointHoverRadius: 7,
                datalabels: {
                    display: true,
                    align: 'top',
                    anchor: 'end',
                    color: '#28a745',
                    font: {
                        weight: 'bold',
                        size: 11
                    },
                    formatter: function(value) {
                        return 'R$ ' + value.toLocaleString('pt-BR', {
                            minimumFractionDigits: 0,
                            maximumFractionDigits: 0
                        });
                    }
                }
            }, {
                label: 'Despesa Acumulada',
                data: dados.grafico_diario.despesa_acumulada || [],
                borderColor: '#dc3545',
                backgroundColor: 'rgba(220, 53, 69, 0.1)',
                fill: true,
                tension: 0.4,
                pointBackgroundColor: '#dc3545',
                pointBorderColor: '#ffffff',
                pointBorderWidth: 2,
                pointRadius: 4,
                pointHoverRadius: 6,
                datalabels: {
                    display: false
                }
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'top',
                },
                datalabels: {
                    display: function(context) {
                        return context.datasetIndex === 0; // Só mostrar para receita (primeiro dataset)
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    max: function(context) {
                        // Encontrar o valor máximo entre receita e despesa
                        const receitaMax = Math.max(...(dados.grafico_diario.receita_acumulada || [0]));
                        const despesaMax = Math.max(...(dados.grafico_diario.despesa_acumulada || [0]));
                        const valorMaximo = Math.max(receitaMax, despesaMax);
                        
                        // Adicionar margem e arredondar para números bonitos
                        let valorComMargem;
                        if (valorMaximo >= 1000000) {
                            // Casa dos milhões - arredondar para milhões inteiros
                            valorComMargem = valorMaximo + 3000000;
                            return Math.ceil(valorComMargem / 1000000) * 1000000;
                        } else {
                            // Casa dos milhares - arredondar para centenas de milhares
                            valorComMargem = valorMaximo + 3000;
                            return Math.ceil(valorComMargem / 100000) * 100000;
                        }
                    },
                    ticks: {
                        callback: function(value) {
                            return 'R$ ' + value.toLocaleString('pt-BR');
                        }
                    }
                }
            }
        },
        plugins: [{
            id: 'datalabels',
            afterDatasetsDraw: function(chart) {
                const ctx = chart.ctx;
                chart.data.datasets.forEach((dataset, datasetIndex) => {
                    if (datasetIndex === 0) { // Só para receita
                        const meta = chart.getDatasetMeta(datasetIndex);
                        meta.data.forEach((element, index) => {
                            const data = dataset.data[index];
                            if (data > 0) {
                                // Salvar o estado atual do contexto
                                ctx.save();
                                
                                // Configurar o estilo do texto
                                ctx.fillStyle = '#28a745';
                                ctx.font = 'bold 11px Arial';
                                ctx.textAlign = 'center';
                                ctx.textBaseline = 'middle';
                                
                                // Texto a ser exibido
                                const text = 'R$ ' + data.toLocaleString('pt-BR', {
                                    minimumFractionDigits: 0,
                                    maximumFractionDigits: 0
                                });
                                
                                // Posicionar bem acima do ponto (40px acima da bolinha)
                                ctx.translate(element.x, element.y - 40);
                                
                                // Rotacionar 270° (texto vertical de baixo para cima)
                                ctx.rotate(-Math.PI / 2);
                                
                                // Desenhar o texto rotacionado
                                ctx.fillText(text, 0, 0);
                                
                                // Restaurar o estado do contexto
                                ctx.restore();
                            }
                        });
                    }
                });
            }
        }]
    });

    // Gráfico Mensal
    graficos.mensal = new Chart(document.getElementById('graficoMensal').getContext('2d'), {
        type: 'bar',
        data: {
            labels: dados.grafico_mensal.meses || [],
            datasets: [{
                label: 'Frete a Receber',
                data: dados.grafico_mensal.frete_receber || [],
                backgroundColor: '#28a745',
                borderColor: '#28a745',
                borderWidth: 2,
                borderRadius: 6
            }, {
                label: 'Frete a Pagar',
                data: dados.grafico_mensal.frete_pagar || [],
                backgroundColor: '#dc3545',
                borderColor: '#dc3545', 
                borderWidth: 2,
                borderRadius: 6
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'top',
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return 'R$ ' + value.toLocaleString('pt-BR');
                        }
                    }
                }
            }
        }
    });

    // Gráfico Clientes
    graficos.clientes = new Chart(document.getElementById('graficoClientes').getContext('2d'), {
        type: 'bar',
        data: {
            labels: dados.grafico_clientes.clientes || [],
            datasets: [{
                label: 'Receita',
                data: dados.grafico_clientes.receita || [],
                backgroundColor: '#28a745',
                borderColor: '#28a745',
                borderWidth: 1,
                borderRadius: 4
            }, {
                label: 'Despesa',
                data: dados.grafico_clientes.despesa || [],
                backgroundColor: '#dc3545',
                borderColor: '#dc3545',
                borderWidth: 1,
                borderRadius: 4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            indexAxis: 'y',
            plugins: {
                legend: {
                    position: 'top',
                }
            }
        }
    });
}

// Funções de Análise Executiva - Modais
function abrirAnaliseReceita() {
    abrirModal('modalReceita');
    preencherDadosReceita();
}

function abrirAnaliseOperacional() {
    abrirModal('modalOperacional');
    preencherDadosOperacional();
}

function abrirAnaliseRentabilidade() {
    abrirModal('modalRentabilidade');
    preencherDadosRentabilidade();
}

function abrirModal(modalId) {
    document.getElementById(modalId).style.display = 'flex';
    document.body.style.overflow = 'hidden'; // Previne scroll do body
    
    // Carregar dados específicos do modal
    if (modalId === 'modalReceita') {
        preencherDadosReceita();
    } else if (modalId === 'modalOperacional') {
        preencherDadosOperacional();
    }
}

function fecharModal(modalId) {
    document.getElementById(modalId).style.display = 'none';
    document.body.style.overflow = 'auto'; // Restaura scroll do body
}

async function preencherDadosReceita() {
    try {
        // Obter filtros atuais
        const filtros = obterFiltrosAtuais();
        
        // Chamar API com dados reais
        const response = await fetch(`/api/painel-frete/detalhes-receita?${new URLSearchParams(filtros)}`);
        const dados = await response.json();
        
        if (dados.error) {
            console.error('Erro ao obter dados de receita:', dados.error);
            return;
        }

        // Preencher cards principais
        document.getElementById('exec-total-faturado').textContent = formatarMoeda(dados.total_faturado);
        
        if (dados.top_clientes.length > 0) {
            const topCliente = dados.top_clientes[0];
            document.getElementById('exec-cliente-top').textContent = topCliente.nome;
            document.getElementById('exec-cliente-receita').textContent = formatarMoeda(topCliente.faturamento);
            document.getElementById('exec-cliente-participacao').textContent = topCliente.participacao + '%';
        }
        
        if (dados.top_veiculos.length > 0) {
            const topVeiculo = dados.top_veiculos[0];
            document.getElementById('exec-veiculo-top').textContent = topVeiculo.placa;
            document.getElementById('exec-veiculo-receita').textContent = formatarMoeda(topVeiculo.faturamento);
        }
        
        const ticketMedio = dados.top_veiculos.length > 0 ? 
            dados.total_faturado / dados.top_veiculos.reduce((sum, v) => sum + v.viagens, 0) : 0;
        document.getElementById('exec-ticket-medio-recebido').textContent = formatarMoeda(ticketMedio);
        
        // Preencher Top 5 tabelas (apenas primeiros 5)
        preencherTabelaTopClientesReais(dados.top_clientes.slice(0, 5));
        preencherTabelaTopVeiculosReais(dados.top_veiculos.slice(0, 5));
        
        // Preencher tabela completa com todos os dados
        preencherTabelaFaturamentoCompleta(dados.tabela_completa);
        
    } catch (error) {
        console.error('Erro ao carregar dados de receita:', error);
    }
}

// Variável global para armazenar dados da tabela de faturamento
let dadosFaturamentoCompletos = [];

function preencherTabelaFaturamentoCompleta(dados) {
    dadosFaturamentoCompletos = dados; // Armazenar para filtros
    const tbody = document.getElementById('tabela-faturamento-completa');
    tbody.innerHTML = '';
    
    dados.forEach(row => {
        const tr = `
            <tr>
                <td>${row.cliente}</td>
                <td>${row.veiculo}</td>
                <td class="valor-monetario">${formatarMoeda(row.faturamento)}</td>
                <td>${row.viagens}</td>
                <td class="percentual">${row.participacao}%</td>
            </tr>
        `;
        tbody.innerHTML += tr;
    });
}

function filtrarTabelaReceita() {
    const filtroCliente = document.getElementById('filtro-cliente-modal').value.toLowerCase();
    const filtroVeiculo = document.getElementById('filtro-veiculo-modal').value.toLowerCase();
    
    const dadosFiltrados = dadosFaturamentoCompletos.filter(row => {
        const matchCliente = !filtroCliente || row.cliente.toLowerCase().includes(filtroCliente);
        const matchVeiculo = !filtroVeiculo || row.veiculo.toLowerCase().includes(filtroVeiculo);
        return matchCliente && matchVeiculo;
    });
    
    preencherTabelaFaturamentoCompleta(dadosFiltrados);
}

function limparFiltrosReceita() {
    document.getElementById('filtro-cliente-modal').value = '';
    document.getElementById('filtro-veiculo-modal').value = '';
    document.getElementById('filtro-status-modal').value = '';
    preencherTabelaFaturamentoCompleta(dadosFaturamentoCompletos);
}

function preencherTabelaTopClientes(totalFaturado) {
    const clientes = [
        { nome: 'PAMPLONA ALIMENTOS', valor: totalFaturado * 0.35, pct: 35 },
        { nome: 'ATACADÃO S.A', valor: totalFaturado * 0.22, pct: 22 },
        { nome: 'CARREFOUR LTDA', valor: totalFaturado * 0.18, pct: 18 },
        { nome: 'EXTRA SUPERMERCADOS', valor: totalFaturado * 0.15, pct: 15 },
        { nome: 'BIG BOMPREÇO', valor: totalFaturado * 0.10, pct: 10 }
    ];
    
    const tbody = document.getElementById('tabela-top-clientes');
    tbody.innerHTML = '';
    
    clientes.forEach((cliente, index) => {
        const row = `
            <tr>
                <td>${index + 1}°</td>
                <td>${cliente.nome}</td>
                <td class="valor-monetario">${formatarMoeda(cliente.valor)}</td>
                <td class="percentual">${cliente.pct}%</td>
            </tr>
        `;
        tbody.innerHTML += row;
    });
}

function preencherTabelaTopClientesReais(clientes) {
    const tbody = document.getElementById('tabela-top-clientes');
    tbody.innerHTML = '';
    
    clientes.forEach((cliente, index) => {
        const row = `
            <tr>
                <td>${index + 1}°</td>
                <td>${cliente.nome}</td>
                <td class="valor-monetario">${formatarMoeda(cliente.faturamento)}</td>
                <td class="percentual">${cliente.participacao}%</td>
            </tr>
        `;
        tbody.innerHTML += row;
    });
}

function preencherTabelaTopVeiculos(totalFaturado, numeroViagens) {
    const veiculos = [
        { placa: 'ABC-1234', valor: totalFaturado * 0.25, viagens: Math.floor(numeroViagens * 0.20) },
        { placa: 'DEF-5678', valor: totalFaturado * 0.20, viagens: Math.floor(numeroViagens * 0.18) },
        { placa: 'GHI-9012', valor: totalFaturado * 0.18, viagens: Math.floor(numeroViagens * 0.16) },
        { placa: 'JKL-3456', valor: totalFaturado * 0.22, viagens: Math.floor(numeroViagens * 0.25) },
        { placa: 'MNO-7890', valor: totalFaturado * 0.15, viagens: Math.floor(numeroViagens * 0.15) }
    ];
    
    // Ordenar por valor decrescente
    veiculos.sort((a, b) => b.valor - a.valor);
    
    const tbody = document.getElementById('tabela-top-veiculos');
    tbody.innerHTML = '';
    
    veiculos.forEach((veiculo, index) => {
        const row = `
            <tr>
                <td>${index + 1}°</td>
                <td>${veiculo.placa}</td>
                <td class="valor-monetario">${formatarMoeda(veiculo.valor)}</td>
                <td>${veiculo.viagens}</td>
            </tr>
        `;
        tbody.innerHTML += row;
    });
}

function preencherTabelaTopVeiculosReais(veiculos) {
    const tbody = document.getElementById('tabela-top-veiculos');
    tbody.innerHTML = '';
    
    veiculos.forEach((veiculo, index) => {
        const row = `
            <tr>
                <td>${index + 1}°</td>
                <td>${veiculo.placa}</td>
                <td class="valor-monetario">${formatarMoeda(veiculo.faturamento)}</td>
                <td>${veiculo.viagens}</td>
            </tr>
        `;
        tbody.innerHTML += row;
    });
}

function gerarVeiculoFicticio() {
    const placas = ['ABC-1234', 'DEF-5678', 'GHI-9012', 'JKL-3456', 'MNO-7890'];
    return placas[Math.floor(Math.random() * placas.length)];
}

async function preencherDadosOperacional() {
    try {
        // Obter filtros atuais
        const filtros = obterFiltrosAtuais();
        
        // Chamar API com dados reais
        const response = await fetch(`/api/painel-frete/detalhes-despesas?${new URLSearchParams(filtros)}`);
        const dados = await response.json();
        
        if (dados.error) {
            console.error('Erro ao obter dados de despesas:', dados.error);
            return;
        }

        // Preencher cards principais
        document.getElementById('exec-total-frete-pago').textContent = formatarMoeda(dados.total_despesas);
        document.getElementById('exec-maior-pagamento').textContent = formatarMoeda(dados.maior_despesa);
        document.getElementById('exec-maior-beneficiario').textContent = dados.maior_beneficiario;
        
        // Calcular participação do maior beneficiário
        const participacaoMaior = dados.total_despesas > 0 ? 
            Math.round((dados.maior_despesa / dados.total_despesas) * 100) : 0;
        document.getElementById('exec-participacao-maior').textContent = participacaoMaior + '%';
        
        document.getElementById('exec-veiculo-mais-usado').textContent = dados.veiculo_mais_usado;
        document.getElementById('exec-viagens-veiculo').textContent = dados.viagens_veiculo + ' viagens';
        document.getElementById('exec-ticket-medio-pago').textContent = formatarMoeda(dados.ticket_medio_pago);
        
        // Preencher tabela de maiores pagamentos
        preencherTabelaMaioresPagamentosReais(dados.top_pagamentos);
        
    } catch (error) {
        console.error('Erro ao carregar dados operacionais:', error);
    }
}

function preencherTabelaMaioresPagamentos(totalDespesas, numeroViagens) {
    const pagamentos = [
        { beneficiario: 'JOÃO SILVA TRANSPORTES', veiculo: 'ABC-1234', valor: totalDespesas * 0.28, pct: 28 },
        { beneficiario: 'MARIA SANTOS LTDA', veiculo: 'DEF-5678', valor: totalDespesas * 0.22, pct: 22 },
        { beneficiario: 'PEDRO OLIVEIRA ME', veiculo: 'GHI-9012', valor: totalDespesas * 0.18, pct: 18 },
        { beneficiario: 'ANA COSTA TRANSPORTES', veiculo: 'JKL-3456', valor: totalDespesas * 0.17, pct: 17 },
        { beneficiario: 'CARLOS LIMA FRETES', veiculo: 'MNO-7890', valor: totalDespesas * 0.15, pct: 15 }
    ];
    
    const tbody = document.getElementById('tabela-maiores-pagamentos');
    tbody.innerHTML = '';
    
    pagamentos.forEach((pagamento, index) => {
        const row = `
            <tr>
                <td>${index + 1}°</td>
                <td>${pagamento.beneficiario}</td>
                <td>${pagamento.veiculo}</td>
                <td class="valor-monetario">${formatarMoeda(pagamento.valor)}</td>
                <td class="percentual">${pagamento.pct}%</td>
            </tr>
        `;
        tbody.innerHTML += row;
    });
}

function preencherTabelaMaioresPagamentosReais(pagamentos) {
    const tbody = document.getElementById('tabela-maiores-pagamentos');
    tbody.innerHTML = '';
    
    pagamentos.forEach((pagamento, index) => {
        const row = `
            <tr>
                <td>${index + 1}°</td>
                <td>${pagamento.embarcador}</td>
                <td>${pagamento.placa}</td>
                <td class="valor-monetario">${formatarMoeda(pagamento.valor)}</td>
                <td class="percentual">${pagamento.participacao}%</td>
            </tr>
        `;
        tbody.innerHTML += row;
    });
}

function gerarMotoristaFicticio() {
    const motoristas = [
        'JOÃO SILVA TRANSPORTES',
        'MARIA SANTOS LTDA', 
        'PEDRO OLIVEIRA ME',
        'ANA COSTA TRANSPORTES',
        'CARLOS LIMA FRETES'
    ];
    return motoristas[Math.floor(Math.random() * motoristas.length)];
}

function obterFiltrosAtuais() {
    const filtros = {};
    
    const perfil = document.getElementById('filtro-perfil').value;
    const cliente = document.getElementById('filtro-cliente').value;
    const mes = document.getElementById('filtro-mes').value;
    const ano = document.getElementById('filtro-ano').value;
    
    if (perfil) filtros.perfil = perfil;
    if (cliente) filtros.cliente = cliente;
    if (mes) filtros.mes = mes;
    if (ano) filtros.ano = ano;
    
    return filtros;
}

function preencherDadosRentabilidade() {
    // Obter dados dos KPIs atuais
    const totalFaturado = parseFloat(document.getElementById('total-faturado').textContent.replace(/[R$\s.]/g, '').replace(',', '.')) || 0;
    const totalDespesas = parseFloat(document.getElementById('total-despesas').textContent.replace(/[R$\s.]/g, '').replace(',', '.')) || 0;
    
    // Calcular métricas de rentabilidade
    const margemAtual = totalFaturado > 0 ? ((totalFaturado - totalDespesas) / totalFaturado * 100) : 0;
    const metaMargem = 25; // Meta de 25%
    const pontoEquilibrio = totalDespesas / 0.75; // Assumindo margem mínima de 25%
    const roiProjetado = margemAtual * 0.6; // Estimativa conservadora
    
    // Preencher dados no modal
    document.getElementById('exec-margem-atual').textContent = margemAtual.toFixed(1) + '%';
    document.getElementById('exec-meta-margem').textContent = metaMargem + '%';
    document.getElementById('exec-breakeven').textContent = formatarMoeda(pontoEquilibrio);
    document.getElementById('exec-roi').textContent = roiProjetado.toFixed(1) + '%';
    
    // Status da margem
    const margemStatus = document.getElementById('exec-margem-status');
    if (margemAtual > 25) {
        margemStatus.className = 'stat-growth positive';
        margemStatus.textContent = 'Excelente';
    } else if (margemAtual > 15) {
        margemStatus.className = 'stat-growth positive';
        margemStatus.textContent = 'Boa';
    } else if (margemAtual > 5) {
        margemStatus.className = 'stat-growth neutral';
        margemStatus.textContent = 'Regular';
    } else {
        margemStatus.className = 'stat-growth negative';
        margemStatus.textContent = 'Crítica';
    }
}

function abrirAnaliseViagens() {
    abrirModal('modalViagens');
    preencherDadosViagens();
}

function abrirAnaliseTicketMedio() {
    abrirModal('modalTicketMedio');
    preencherDadosTicketMedio();
}

function abrirAnaliseTopCliente() {
    abrirModal('modalTopCliente');
    preencherDadosTopCliente();
}

function preencherDadosViagens() {
    // Obter dados dos KPIs atuais
    const numeroViagens = parseInt(document.getElementById('numero-viagens').textContent) || Math.floor(Math.random() * 50) + 10;
    const totalFaturado = parseFloat(document.getElementById('total-faturado').textContent.replace(/[R$\s.]/g, '').replace(',', '.')) || 0;
    
    // Calcular métricas
    const mediaDiaria = Math.round(numeroViagens / 30 * 10) / 10;
    const crescimentoViagens = Math.random() * 30 - 5; // -5% a +25%
    const ocupacaoMedia = Math.floor(Math.random() * 20) + 75; // 75% a 95%
    
    // Preencher dados no modal
    document.getElementById('exec-total-viagens').textContent = numeroViagens;
    document.getElementById('exec-media-viagens-dia').textContent = mediaDiaria;
    document.getElementById('exec-crescimento-viagens').textContent = (crescimentoViagens >= 0 ? '+' : '') + crescimentoViagens.toFixed(1) + '%';
    document.getElementById('exec-ocupacao').textContent = ocupacaoMedia + '%';
    
    // Status da tendência
    const tendenciaEl = document.getElementById('exec-tendencia-viagens');
    if (crescimentoViagens > 10) {
        tendenciaEl.textContent = 'Crescimento Forte';
        tendenciaEl.className = 'stat-growth positive';
    } else if (crescimentoViagens > 0) {
        tendenciaEl.textContent = 'Crescimento';
        tendenciaEl.className = 'stat-growth positive';
    } else if (crescimentoViagens > -5) {
        tendenciaEl.textContent = 'Estável';
        tendenciaEl.className = 'stat-growth neutral';
    } else {
        tendenciaEl.textContent = 'Declínio';
        tendenciaEl.className = 'stat-growth negative';
    }
}

function preencherDadosTicketMedio() {
    // Obter dados dos KPIs atuais
    const ticketMedio = parseFloat(document.getElementById('ticket-medio').textContent.replace(/[R$\s.]/g, '').replace(',', '.')) || Math.floor(Math.random() * 800) + 400;
    const numeroViagens = parseInt(document.getElementById('numero-viagens').textContent) || 20;
    
    // Calcular métricas
    const benchmarkTicket = 1200;
    const potencialAumento = ((benchmarkTicket - ticketMedio) / ticketMedio * 100);
    const impactoReceita = (ticketMedio * potencialAumento / 100) * numeroViagens;
    
    // Preencher dados no modal
    document.getElementById('exec-ticket-atual').textContent = formatarMoeda(ticketMedio);
    document.getElementById('exec-ticket-benchmark').textContent = formatarMoeda(benchmarkTicket);
    document.getElementById('exec-potencial-ticket').textContent = '+' + Math.max(0, potencialAumento).toFixed(0) + '%';
    document.getElementById('exec-impacto-receita').textContent = formatarMoeda(Math.max(0, impactoReceita));
}

function preencherDadosTopCliente() {
    // Obter dados dos KPIs atuais
    const topCliente = document.getElementById('cliente-mais-rentavel').textContent || 'Cliente Premium';
    const totalFaturado = parseFloat(document.getElementById('total-faturado').textContent.replace(/[R$\s.]/g, '').replace(',', '.')) || 0;
    const numeroViagens = parseInt(document.getElementById('numero-viagens').textContent) || 0;
    
    // Calcular métricas do top cliente (estimativas)
    const receitaTopCliente = totalFaturado * 0.35; // Assume 35% da receita
    const participacaoTop = 35;
    const margemTopCliente = Math.floor(Math.random() * 15) + 20; // 20-35%
    const viagensTopCliente = Math.floor(numeroViagens * 0.3); // 30% das viagens
    
    // Preencher dados no modal
    document.getElementById('exec-nome-top-cliente').textContent = topCliente;
    document.getElementById('exec-receita-top-cliente').textContent = formatarMoeda(receitaTopCliente);
    document.getElementById('exec-participacao-top').textContent = participacaoTop + '% do total';
    document.getElementById('exec-margem-top-cliente').textContent = margemTopCliente + '%';
    document.getElementById('exec-viagens-top-cliente').textContent = viagensTopCliente;
}

// Fechar modal com ESC
document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
        const modals = ['modalReceita', 'modalOperacional', 'modalRentabilidade', 'modalViagens', 'modalTicketMedio', 'modalTopCliente'];
        modals.forEach(modalId => {
            if (document.getElementById(modalId).style.display === 'flex') {
                fecharModal(modalId);
            }
        });
    }
});

function formatarMoeda(valor) {
    return 'R$ ' + parseFloat(valor || 0).toLocaleString('pt-BR', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
    });
}

// Funções auxiliares para UX
function mostrarLoading(mostrar) {
    const loadingEl = document.getElementById('loading-indicator');
    const updateEl = document.getElementById('last-update');
    
    if (mostrar) {
        loadingEl.style.display = 'inline';
        updateEl.style.display = 'none';
    } else {
        loadingEl.style.display = 'none';
        updateEl.style.display = 'inline';
    }
}

function atualizarStatusFiltros() {
    const now = new Date();
    const timeString = now.toLocaleTimeString('pt-BR', { 
        hour: '2-digit', 
        minute: '2-digit' 
    });
    
    const updateEl = document.getElementById('last-update');
    updateEl.textContent = `📊 Atualizado às ${timeString}`;
    updateEl.style.color = '#22c55e';
    
    // Fade back to normal after 2 seconds
    setTimeout(() => {
        updateEl.style.color = '';
    }, 2000);
}

function mostrarErro(mensagem) {
    const updateEl = document.getElementById('last-update');
    updateEl.textContent = `❌ ${mensagem}`;
    updateEl.style.color = '#ef4444';
    
    // Clear error message after 5 seconds
    setTimeout(() => {
        updateEl.textContent = '📊 Dados atualizados';
        updateEl.style.color = '';
    }, 5000);
}

// Debounce function para evitar muitas requests
function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

// Versão debounced da função carregarDados
const carregarDadosDebounced = debounce(carregarDados, 300);

function abrirAnaliseViagens() {
    abrirModal('modalViagens');
    preencherDadosViagens();
}

function abrirAnaliseTicketMedio() {
    abrirModal('modalTicketMedio');
    preencherDadosTicketMedio();
}

function abrirAnaliseTopCliente() {
    abrirModal('modalTopCliente');
    preencherDadosTopCliente();
}

function preencherDadosViagens() {
    const numeroViagens = parseInt(document.getElementById('numero-viagens').textContent) || 0;
    const mediaDiaria = (numeroViagens / 30).toFixed(1); // Assumindo mês de 30 dias
    const crescimentoViagens = Math.random() * 25 + 5; // 5-30%
    
    document.getElementById('exec-total-viagens').textContent = numeroViagens;
    document.getElementById('exec-media-viagens-dia').textContent = mediaDiaria;
    document.getElementById('exec-crescimento-viagens').textContent = '+' + crescimentoViagens.toFixed(1) + '%';
    
    const tendenciaEl = document.getElementById('exec-tendencia-viagens');
    if (crescimentoViagens > 20) {
        tendenciaEl.textContent = 'Crescimento Forte';
        tendenciaEl.className = 'stat-growth positive';
    } else if (crescimentoViagens > 10) {
        tendenciaEl.textContent = 'Crescimento Moderado';
        tendenciaEl.className = 'stat-growth positive';
    } else {
        tendenciaEl.textContent = 'Estável';
        tendenciaEl.className = 'stat-growth neutral';
    }
}

function preencherDadosTicketMedio() {
    const ticketAtual = parseFloat(document.getElementById('ticket-medio').textContent.replace(/[R$\s.]/g, '').replace(',', '.')) || 0;
    const ticketBenchmark = 1200;
    const potencialAumento = ((ticketBenchmark - ticketAtual) / ticketAtual * 100);
    const numeroViagens = parseInt(document.getElementById('numero-viagens').textContent) || 0;
    const impactoReceita = (ticketBenchmark - ticketAtual) * numeroViagens;
    
    document.getElementById('exec-ticket-atual').textContent = formatarMoeda(ticketAtual);
    document.getElementById('exec-ticket-benchmark').textContent = formatarMoeda(ticketBenchmark);
    document.getElementById('exec-potencial-ticket').textContent = '+' + Math.max(0, potencialAumento).toFixed(0) + '%';
    document.getElementById('exec-impacto-receita').textContent = formatarMoeda(Math.max(0, impactoReceita));
}

function preencherDadosTopCliente() {
    const clienteTop = document.getElementById('cliente-mais-rentavel').textContent || 'PAMPLONA ALIMENTOS';
    const totalFaturado = parseFloat(document.getElementById('total-faturado').textContent.replace(/[R$\s.]/g, '').replace(',', '.')) || 0;
    const receitaCliente = totalFaturado * 0.35; // 35% do top cliente
    const margemCliente = 22.5; // Margem estimada do cliente
    const viagensCliente = Math.floor(parseInt(document.getElementById('numero-viagens').textContent) * 0.25) || 0;
    
    document.getElementById('exec-nome-top-cliente').textContent = clienteTop;
    document.getElementById('exec-receita-top-cliente').textContent = formatarMoeda(receitaCliente);
    document.getElementById('exec-participacao-top').textContent = '35% do total';
    document.getElementById('exec-margem-top-cliente').textContent = margemCliente.toFixed(1) + '%';
    document.getElementById('exec-viagens-top-cliente').textContent = viagensCliente;
}

// Fechar modal com ESC - todos os modais
document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
        const modals = ['modalReceita', 'modalOperacional', 'modalRentabilidade', 'modalViagens', 'modalTicketMedio', 'modalTopCliente'];
        modals.forEach(modalId => {
            if (document.getElementById(modalId).style.display === 'flex') {
                fecharModal(modalId);
            }
        });
    }
});
</script>
{% endblock %}