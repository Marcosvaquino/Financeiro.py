{% extends "base.html" %}

{% block title %}FRZ LOG{% endblock %}

{% block content %}
<div class="frz-log-compact">
    <!-- Header Compacto -->
    <div class="frz-header-compact">
        <div class="frz-title">
            <h2>üìà FRZ LOG Executivo</h2>
            <span class="frz-period">{{ "%02d"|format(mes) }}/{{ ano }}</span>
        </div>
        <div class="frz-filters-compact">
            <select id="mes" class="frz-select-small">
                {% for i in range(1, 13) %}
                <option value="{{ i }}" {% if mes == i %}selected{% endif %}>{{ i }}</option>
                {% endfor %}
            </select>
            <select id="ano" class="frz-select-small">
                {% for i in range(2023, 2028) %}
                <option value="{{ i }}" {% if ano == i %}selected{% endif %}>{{ i }}</option>
                {% endfor %}
            </select>
            <button onclick="atualizarFrzLog()" class="frz-btn-small">‚ü≥</button>
        </div>
    </div>

    <!-- ========= SE√á√ÉO CR√çTICA - PLANEJAMENTO FRZ ========= -->
    <div class="frz-criticos-section">
        <!-- Grid de Cards Executivos Compactos -->
        <div class="frz-cards-grid-executivo">
            <!-- Linha 1 -->
            <div class="frz-card-mini resultado-{{ 'positivo' if dados.dados_criticos.totais_mes.resultado_realizado > 0 else 'negativo' }}">
                <div class="frz-mini-icon">üí∞</div>
                <div class="frz-mini-info">
                    <div class="frz-mini-titulo">Resultado</div>
                    <div class="frz-mini-valor">
                        {% if dados.dados_criticos.totais_mes.resultado_realizado < 0 %}-{% endif %}
                        R$ {{ dados.dados_criticos.totais_mes.resultado_realizado|abs|currency_no_decimal }}
                    </div>
                </div>
            </div>
            
            <div class="frz-card-mini">
                <div class="frz-mini-icon">üìà</div>
                <div class="frz-mini-info">
                    <div class="frz-mini-titulo">Receitas</div>
                    <div class="frz-mini-valor">R$ {{ dados.dados_criticos.totais_mes.receita_realizada|currency_no_decimal }}</div>
                </div>
            </div>
            
            <div class="frz-card-mini">
                <div class="frz-mini-icon">ÔøΩ</div>
                <div class="frz-mini-info">
                    <div class="frz-mini-titulo">Despesas</div>
                    <div class="frz-mini-valor">R$ {{ dados.dados_criticos.totais_mes.despesa_realizada|currency_no_decimal }}</div>
                </div>
            </div>
            
            <div class="frz-card-mini margem-{{ 'positiva' if dados.dados_criticos.totais_mes.resultado_realizado > 0 else 'negativa' }}">
                <div class="frz-mini-icon">üìä</div>
                <div class="frz-mini-info">
                    <div class="frz-mini-titulo">Margem</div>
                    <div class="frz-mini-valor">
                        {% set margem = (dados.dados_criticos.totais_mes.resultado_realizado / dados.dados_criticos.totais_mes.receita_realizada * 100) if dados.dados_criticos.totais_mes.receita_realizada > 0 else 0 %}
                        {{ "%.1f"|format(margem) }}%
                    </div>
                </div>
            </div>
            
            <!-- Linha 2 -->
            <div class="frz-card-mini performance-boa">
                <div class="frz-mini-icon">üèÜ</div>
                <div class="frz-mini-info">
                    <div class="frz-mini-titulo">Melhor Semana</div>
                    <div class="frz-mini-valor">
                        {% set melhor = dados.dados_criticos.resultados_semanas|sort(attribute='realizado', reverse=true)|first %}
                        {% set semana_num = loop.index0 + 1 if loop else ((dados.dados_criticos.resultados_semanas.index(melhor) + 1) if melhor in dados.dados_criticos.resultados_semanas else 1) %}
                        Semana {{ "%02d"|format(dados.dados_criticos.resultados_semanas.index(melhor) + 1) }}
                    </div>
                </div>
            </div>
            
            <div class="frz-card-mini performance-ruim">
                <div class="frz-mini-icon">‚ö†Ô∏è</div>
                <div class="frz-mini-info">
                    <div class="frz-mini-titulo">Pior Semana</div>
                    <div class="frz-mini-valor">
                        {% set pior = dados.dados_criticos.resultados_semanas|sort(attribute='realizado')|first %}
                        Semana {{ "%02d"|format(dados.dados_criticos.resultados_semanas.index(pior) + 1) }}
                    </div>
                </div>
            </div>
            
            <div class="frz-card-mini">
                <div class="frz-mini-icon">üéØ</div>
                <div class="frz-mini-info">
                    <div class="frz-mini-titulo">Efici√™ncia</div>
                    <div class="frz-mini-valor">
                        {% set eficiencia = (dados.dados_criticos.totais_mes.receita_realizada / dados.dados_criticos.totais_mes.receita_projetada * 100) if dados.dados_criticos.totais_mes.receita_projetada > 0 else 0 %}
                        {{ "%.0f"|format(eficiencia) }}%
                    </div>
                </div>
            </div>
            
            <div class="frz-card-mini status-{{ 'bom' if dados.dados_criticos.totais_mes.performance_resultado >= 80 else 'medio' if dados.dados_criticos.totais_mes.performance_resultado >= 50 else 'ruim' }}">
                <div class="frz-mini-icon">üö¶</div>
                <div class="frz-mini-info">
                    <div class="frz-mini-titulo">Status Geral</div>
                    <div class="frz-mini-valor">
                        {% if dados.dados_criticos.totais_mes.performance_resultado >= 80 %}
                            √ìtimo
                        {% elif dados.dados_criticos.totais_mes.performance_resultado >= 50 %}
                            Regular
                        {% else %}
                            Cr√≠tico
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Tabela Semanal Compacta - RECEITAS vs DESPESAS vs RESULTADO -->
        <div class="frz-tabela-semanal">
            <h4>üí∞ Fluxo Semanal - Receitas | Despesas | Resultado</h4>
            <div class="frz-semanas-grid">
                {% for i in range(5) %}
                {% set receita = dados.dados_criticos.receitas_semanas[i] %}
                {% set despesa = dados.dados_criticos.despesas_semanas[i] %}
                {% set resultado = dados.dados_criticos.resultados_semanas[i] %}
                
                <div class="frz-semana-card status-{{ resultado.status }}">
                    <div class="frz-semana-titulo">Semana {{ "%02d"|format(i + 1) }}</div>
                    
                    <!-- Receitas -->
                    <div class="frz-linha-dados">
                        <span class="frz-tipo">üí∞ Receitas</span>
                        <div class="frz-valores">
                            <span class="frz-realizado">{{ receita.realizado|currency_no_decimal }}</span>
                            <span class="frz-previsto">/ {{ receita.projetado|currency_no_decimal }}</span>
                            <span class="frz-perf perf-{{ (receita.performance / 20)|round|int }}">{{ "%.0f"|format(receita.performance) }}%</span>
                        </div>
                    </div>
                    
                    <!-- Despesas -->
                    <div class="frz-linha-dados">
                        <span class="frz-tipo">üí∏ Despesas</span>
                        <div class="frz-valores">
                            <span class="frz-realizado">{{ despesa.realizado|currency_no_decimal }}</span>
                            <span class="frz-previsto">/ {{ despesa.projetado|currency_no_decimal }}</span>
                            <span class="frz-perf perf-{{ (despesa.performance / 20)|round|int }}">{{ "%.0f"|format(despesa.performance) }}%</span>
                        </div>
                    </div>
                    
                    <!-- Resultado -->
                    <div class="frz-linha-resultado">
                        <span class="frz-tipo">üìä Resultado</span>
                        <div class="frz-valores">
                            <span class="frz-resultado-valor resultado-{{ resultado.status }}">
                                {{ resultado.realizado|currency_no_decimal }}
                            </span>
                            <span class="frz-resultado-meta">/ {{ resultado.projetado|currency_no_decimal }}</span>
                        </div>
                    </div>
                    
                    <!-- Gr√°fico Previsto vs Realizado -->
                    <div class="frz-grafico-container">
                        <div class="frz-grafico-bar">
                            <div class="frz-bar-background">
                                {% set percentual = ((receita.realizado / receita.projetado * 100) if receita.projetado > 0 and receita.realizado > 0 else 0)|round|int %}
                                <div class="frz-bar-fill" 
                                     style="height: {{ percentual }}%">
                                </div>
                            </div>
                            <div class="frz-bar-percent-base">{{ percentual }}%</div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Alertas de Fluxo (Movido para baixo) -->
        {% if dados.dados_criticos.alertas_fluxo %}
        <div class="frz-alertas-fluxo-baixo">
            <h4>‚ö†Ô∏è Alertas de Fluxo</h4>
            <div class="frz-alertas-list">
                {% for alerta in dados.dados_criticos.alertas_fluxo %}
                <div class="frz-alerta-fluxo alert-{{ alerta.tipo }}">{{ alerta.msg }}</div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
    </div>

    <!-- ========= SE√á√ÉO COMPLEMENTAR (ANTIGO) ========= -->
    <div class="frz-secao-complementar">
        <h3>üìà An√°lise Complementar</h3>
        
        <!-- Cards Principais Compactos -->
        <div class="frz-cards-compact">
        <div class="frz-card-mini performance-{{ dados.metricas_principais.performance_geral|round|int // 20 }}">
            <span class="frz-label">Performance</span>
            <span class="frz-value">{{ "%.1f"|format(dados.metricas_principais.performance_geral) }}%</span>
        </div>
        <div class="frz-card-mini">
            <span class="frz-label">Realizado</span>
            <span class="frz-value">{{ dados.metricas_principais.total_realizado|currency_no_decimal }}</span>
        </div>
        <div class="frz-card-mini">
            <span class="frz-label">Gap</span>
            <span class="frz-value {% if dados.metricas_principais.gap_realizacao <= 0 %}positive{% else %}negative{% endif %}">
                {{ dados.metricas_principais.gap_realizacao|abs|currency_no_decimal }}
            </span>
        </div>
        <div class="frz-card-mini">
            <span class="frz-label">Risk Score</span>
            <span class="frz-value risk-{{ dados.metricas_principais.risk_score|round|int // 20 }}">{{ dados.metricas_principais.risk_score|round|int }}</span>
        </div>
        <div class="frz-card-mini">
            <span class="frz-label">Top3 Concentr.</span>
            <span class="frz-value">{{ "%.0f"|format(dados.metricas_principais.concentracao_top3) }}%</span>
        </div>
    </div>

    <!-- Grid Principal -->
    <div class="frz-main-grid">
        <!-- Alertas -->
        {% if dados.alertas %}
        <div class="frz-section frz-alertas">
            <h4>üö® Alertas</h4>
            {% for alerta in dados.alertas %}
            <div class="frz-alert alert-{{ alerta.tipo }}">{{ alerta.msg }}</div>
            {% endfor %}
        </div>
        {% endif %}

        <!-- Performance Semanal Compacta -->
        <div class="frz-section frz-semanas">
            <h4>üìÖ Performance Semanal</h4>
            <div class="frz-semanas-compact">
                {% for semana in dados.semanas %}
                <div class="frz-semana-item status-{{ semana.status }}">
                    <div class="frz-semana-header">
                        <span class="frz-semana-label">Semana {{ "%02d"|format(loop.index) }}</span>
                        <span class="frz-semana-perf">{{ "%.0f"|format(semana.percentual) }}%</span>
                    </div>
                    <div class="frz-semana-bar">
                        <div class="frz-semana-progress" style="width: {{ semana.percentual|round|int }}%"></div>
                    </div>
                    <div class="frz-semana-values">
                        <span>{{ semana.realizado|currency_no_decimal }} / {{ semana.projetado|currency_no_decimal }}</span>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Top Clientes -->
        <div class="frz-section frz-clientes">
            <h4>üèÜ Top Clientes</h4>
            <div class="frz-clientes-compact">
                {% for cliente in dados.clientes[:8] %}
                <div class="frz-cliente-item status-{{ cliente.status }}">
                    <div class="frz-cliente-info">
                        <span class="frz-cliente-nome">{{ cliente.nome[:20] }}{{ "..." if cliente.nome|length > 20 else "" }}</span>
                        <span class="frz-cliente-perf">{{ "%.0f"|format(cliente.performance) }}%</span>
                    </div>
                    <div class="frz-cliente-values">
                        <span class="frz-cliente-real">{{ cliente.realizado|currency_no_decimal }}</span>
                        <span class="frz-cliente-part">({{ "%.1f"|format(cliente.participacao) }}%)</span>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Clientes Cr√≠ticos -->
        {% if dados.clientes_criticos %}
        <div class="frz-section frz-criticos">
            <h4>‚ö†Ô∏è Clientes Cr√≠ticos</h4>
            <div class="frz-criticos-list">
                {% for cliente in dados.clientes_criticos %}
                <div class="frz-critico-item">
                    <span class="frz-critico-nome">{{ cliente.nome[:15] }}{{ "..." if cliente.nome|length > 15 else "" }}</span>
                    <span class="frz-critico-perf">{{ "%.0f"|format(cliente.performance) }}%</span>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- Clientes Estrelas -->
        {% if dados.clientes_estrelas %}
        <div class="frz-section frz-estrelas">
            <h4>‚≠ê Clientes Estrelas</h4>
            <div class="frz-estrelas-list">
                {% for cliente in dados.clientes_estrelas %}
                <div class="frz-estrela-item">
                    <span class="frz-estrela-nome">{{ cliente.nome[:15] }}{{ "..." if cliente.nome|length > 15 else "" }}</span>
                    <span class="frz-estrela-perf">{{ "%.0f"|format(cliente.performance) }}%</span>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- Indicadores R√°pidos -->
        <div class="frz-section frz-indicadores">
            <h4>üìä Indicadores</h4>
            <div class="frz-indicadores-grid">
                <div class="frz-indicador">
                    <span class="frz-ind-value">{{ dados.indicadores.clientes_ativos }}</span>
                    <span class="frz-ind-label">Ativos</span>
                </div>
                <div class="frz-indicador">
                    <span class="frz-ind-value">{{ dados.indicadores.clientes_inativos }}</span>
                    <span class="frz-ind-label">Inativos</span>
                </div>
                <div class="frz-indicador">
                    <span class="frz-ind-value">{{ dados.indicadores.semanas_boas }}</span>
                    <span class="frz-ind-label">Sem. Boas</span>
                </div>
                <div class="frz-indicador">
                    <span class="frz-ind-value">{{ dados.indicadores.semanas_ruins }}</span>
                    <span class="frz-ind-label">Sem. Ruins</span>
                </div>
            </div>
        </div>

        <!-- Tend√™ncia -->
        <div class="frz-section frz-tendencia">
            <h4>üìà Tend√™ncia</h4>
            <div class="frz-tendencia-chart">
                {% for valor in dados.tendencia_semanal %}
                <div class="frz-tend-bar {% if valor > 0 %}positive{% elif valor < 0 %}negative{% else %}neutral{% endif %}" 
                     style="height: {{ (valor|abs / 50)|round|int * 5 + 20 }}px;">
                    <span class="frz-tend-value">{{ "%.0f"|format(valor) }}</span>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    
    </div> <!-- Fim da se√ß√£o complementar -->
</div>

<script>
function atualizarFrzLog() {
    const mes = document.getElementById('mes').value;
    const ano = document.getElementById('ano').value;
    window.location.href = `/frz_log?mes=${mes}&ano=${ano}`;
}
</script>
{% endblock %}