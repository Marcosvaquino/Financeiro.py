{% extends "base.html" %}

{% block title %}FRZ LOG{% endblock %}

{% block content %}
<div class="frz-log-compact">
    <!-- Header Compacto -->
    <div class="frz-header-compact">
        <div class="frz-title">
            <h2>üìà FRZ LOG Executivo</h2>
            <span class="frz-period">{{ "%02d"|format(mes) }}/{{ ano }}</span>
        </div>
        <div class="frz-filters-compact">
            <select id="mes" class="frz-select-small">
                {% for i in range(1, 13) %}
                <option value="{{ i }}" {% if mes == i %}selected{% endif %}>{{ i }}</option>
                {% endfor %}
            </select>
            <select id="ano" class="frz-select-small">
                {% for i in range(2023, 2028) %}
                <option value="{{ i }}" {% if ano == i %}selected{% endif %}>{{ i }}</option>
                {% endfor %}
            </select>
            <button onclick="atualizarFrzLog()" class="frz-btn-small">‚ü≥</button>
        </div>
    </div>

    <!-- ========= SE√á√ÉO CR√çTICA - PLANEJAMENTO FRZ ========= -->
    <div class="frz-criticos-section">
        <!-- Grid de Cards Executivos Compactos -->
        <div class="frz-cards-grid-executivo">
            <!-- Linha 1 -->
            <div class="frz-card-mini resultado-{{ 'positivo' if dados.dados_criticos.totais_mes.resultado_realizado > 0 else 'negativo' }}" onclick="abrirModalExecutivo('resultado')" style="cursor: pointer;">
                <div class="frz-mini-icon">üí∞</div>
                <div class="frz-mini-info">
                    <div class="frz-mini-titulo">Resultado</div>
                    <div class="frz-mini-valor">
                        {% if dados.dados_criticos.totais_mes.resultado_realizado < 0 %}-{% endif %}
                        R$ {{ dados.dados_criticos.totais_mes.resultado_realizado|abs|currency_no_decimal }}
                    </div>
                </div>
            </div>
            
            <div class="frz-card-mini" onclick="abrirModalExecutivo('receita')" style="cursor: pointer;">
                <div class="frz-mini-icon">üìà</div>
                <div class="frz-mini-info">
                    <div class="frz-mini-titulo">Receitas</div>
                    <div class="frz-mini-valor">R$ {{ dados.dados_criticos.totais_mes.receita_realizada|currency_no_decimal }}</div>
                    <div class="frz-mini-previsto-linha">
                        <span class="frz-previsto-texto">Previsto: R$ {{ dados.dados_criticos.totais_mes.receita_projetada|currency_no_decimal }}</span>
                        <span class="frz-mini-percentual">
                            {% set pct_receita = (dados.dados_criticos.totais_mes.receita_realizada / dados.dados_criticos.totais_mes.receita_projetada * 100) if dados.dados_criticos.totais_mes.receita_projetada > 0 else 0 %}
                            {{ "%.0f"|format(pct_receita) }}%
                        </span>
                    </div>
                </div>
            </div>
            
            <div class="frz-card-mini" onclick="abrirModalExecutivo('despesa')" style="cursor: pointer;">
                <div class="frz-mini-icon">üí∏</div>
                <div class="frz-mini-info">
                    <div class="frz-mini-titulo">Despesas</div>
                    <div class="frz-mini-valor">R$ {{ dados.dados_criticos.totais_mes.despesa_realizada|currency_no_decimal }}</div>
                    <div class="frz-mini-previsto-linha">
                        <span class="frz-previsto-texto">Previsto: R$ {{ dados.dados_criticos.totais_mes.despesa_projetada|currency_no_decimal }}</span>
                        <span class="frz-mini-percentual">
                            {% set pct_despesa = (dados.dados_criticos.totais_mes.despesa_realizada / dados.dados_criticos.totais_mes.despesa_projetada * 100) if dados.dados_criticos.totais_mes.despesa_projetada > 0 else 0 %}
                            {{ "%.0f"|format(pct_despesa) }}%
                        </span>
                    </div>
                </div>
            </div>
            
            <div class="frz-card-mini margem-{{ 'positiva' if dados.dados_criticos.totais_mes.resultado_realizado > 0 else 'negativa' }}">
                <div class="frz-mini-icon">üìä</div>
                <div class="frz-mini-info">
                    <div class="frz-mini-titulo">Margem</div>
                    <div class="frz-mini-valor">
                        {% set margem = (dados.dados_criticos.totais_mes.resultado_realizado / dados.dados_criticos.totais_mes.receita_realizada * 100) if dados.dados_criticos.totais_mes.receita_realizada > 0 else 0 %}
                        {{ "%.1f"|format(margem) }}%
                    </div>
                </div>
            </div>
            
            <!-- Linha 2 -->
            <div class="frz-card-mini performance-boa">
                <div class="frz-mini-icon">üèÜ</div>
                <div class="frz-mini-info">
                    <div class="frz-mini-titulo">Melhor Semana</div>
                    <div class="frz-mini-valor">
                        {% set melhor = dados.dados_criticos.resultados_semanas|sort(attribute='realizado', reverse=true)|first %}
                        {% set melhor_index = dados.dados_criticos.resultados_semanas.index(melhor) + 1 %}
                        Semana {{ "%02d"|format(melhor_index) }}
                    </div>
                </div>
            </div>
            
            <div class="frz-card-mini performance-ruim">
                <div class="frz-mini-icon">‚ö†Ô∏è</div>
                <div class="frz-mini-info">
                    <div class="frz-mini-titulo">Pior Semana</div>
                    <div class="frz-mini-valor">
                        {% set pior = dados.dados_criticos.resultados_semanas|sort(attribute='realizado')|first %}
                        {% set pior_index = dados.dados_criticos.resultados_semanas.index(pior) + 1 %}
                        Semana {{ "%02d"|format(pior_index) }}
                    </div>
                </div>
            </div>
            
            <div class="frz-card-mini">
                <div class="frz-mini-icon">üéØ</div>
                <div class="frz-mini-info">
                    <div class="frz-mini-titulo">Efici√™ncia</div>
                    <div class="frz-mini-valor">
                        {% set eficiencia = (dados.dados_criticos.totais_mes.receita_realizada / dados.dados_criticos.totais_mes.receita_projetada * 100) if dados.dados_criticos.totais_mes.receita_projetada > 0 else 0 %}
                        {{ "%.0f"|format(eficiencia) }}%
                    </div>
                </div>
            </div>
            
            <div class="frz-card-mini status-{{ 'bom' if dados.dados_criticos.totais_mes.performance_resultado >= 80 else 'medio' if dados.dados_criticos.totais_mes.performance_resultado >= 50 else 'ruim' }}">
                <div class="frz-mini-icon">üö¶</div>
                <div class="frz-mini-info">
                    <div class="frz-mini-titulo">Status Geral</div>
                    <div class="frz-mini-valor">
                        {% if dados.dados_criticos.totais_mes.performance_resultado >= 80 %}
                            √ìtimo
                        {% elif dados.dados_criticos.totais_mes.performance_resultado >= 50 %}
                            Regular
                        {% else %}
                            Cr√≠tico
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Tabela Semanal Compacta - RECEITAS vs DESPESAS vs RESULTADO -->
        <div class="frz-tabela-semanal">
            <h4>üí∞ Fluxo Semanal</h4>
            <div class="frz-semanas-grid">
                {% for i in range(5) %}
                {% set receita = dados.dados_criticos.receitas_semanas[i] %}
                {% set despesa = dados.dados_criticos.despesas_semanas[i] %}
                {% set resultado = dados.dados_criticos.resultados_semanas[i] %}
                
                <div class="frz-semana-card status-{{ resultado.status }}" onclick="abrirModalSemana({{ i + 1 }})" style="cursor: pointer;">
                    <div class="frz-semana-titulo">{{ receita.label }}</div>
                    
                    <!-- Receitas -->
                    <div class="frz-linha-dados">
                        <span class="frz-tipo">üí∞ Receitas</span>
                        <div class="frz-valores">
                            <span class="frz-realizado">{{ receita.realizado|currency_no_decimal }}</span>
                            <span class="frz-previsto">/ {{ receita.projetado|currency_no_decimal }}</span>
                            <span class="frz-perf perf-{{ (receita.performance / 20)|round|int }}">{{ "%.0f"|format(receita.performance) }}%</span>
                        </div>
                    </div>
                    
                    <!-- Despesas -->
                    <div class="frz-linha-dados">
                        <span class="frz-tipo">üí∏ Despesas</span>
                        <div class="frz-valores">
                            <span class="frz-realizado">{{ despesa.realizado|currency_no_decimal }}</span>
                            <span class="frz-previsto">/ {{ despesa.projetado|currency_no_decimal }}</span>
                            <span class="frz-perf perf-{{ (despesa.performance / 20)|round|int }}">{{ "%.0f"|format(despesa.performance) }}%</span>
                        </div>
                    </div>
                    
                    <!-- Resultado -->
                    <div class="frz-linha-resultado">
                        <span class="frz-tipo">üìä Resultado</span>
                        <div class="frz-valores">
                            <span class="frz-resultado-valor resultado-{{ resultado.status }}">
                                {{ resultado.realizado|currency_no_decimal }}
                            </span>
                            <span class="frz-resultado-meta">/ {{ resultado.projetado|currency_no_decimal }}</span>
                        </div>
                    </div>
                    
                    <!-- Gr√°fico Previsto vs Realizado -->
                    <div class="frz-grafico-container">
                        <div class="frz-grafico-bar">
                            <div class="frz-bar-background">
                                {% set percentual = ((receita.realizado / receita.projetado * 100) if receita.projetado > 0 and receita.realizado > 0 else 0)|round|int %}
                                <div class="frz-bar-fill" 
                                     style="height: {{ percentual }}%">
                                </div>
                            </div>
                            <div class="frz-bar-percent-base">{{ percentual }}%</div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Alertas de Fluxo (Movido para baixo) -->
        {% if dados.dados_criticos.alertas_fluxo %}
        <div class="frz-alertas-fluxo-baixo">
            <h4>‚ö†Ô∏è Alertas de Fluxo</h4>
            <div class="frz-alertas-list">
                {% for alerta in dados.dados_criticos.alertas_fluxo %}
                <div class="frz-alerta-fluxo alert-{{ alerta.tipo }}">{{ alerta.msg }}</div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Modais das Semanas -->
{% for i in range(5) %}
{% set receita = dados.dados_criticos.receitas_semanas[i] %}
{% set despesa = dados.dados_criticos.despesas_semanas[i] %}
{% set resultado = dados.dados_criticos.resultados_semanas[i] %}

<div id="modalSemana{{ i + 1 }}" class="frz-modal" style="display: none;">
    <div class="frz-modal-content-wide">
        <div class="frz-modal-header">
            <h3>üìä Planejamento FRZ - {{ receita.label }}</h3>
            <span class="frz-modal-close" onclick="fecharModal('modalSemana{{ i + 1 }}')">&times;</span>
        </div>
        
        <div class="frz-modal-body">
            <!-- Header da Tabela de Planejamento -->
            <div class="frz-planejamento-header">
                <div class="frz-plan-resumo">
                    <div class="frz-plan-card status-{{ resultado.status }}">
                        <div class="frz-plan-titulo">üìà PROJETADO</div>
                        <div class="frz-plan-valor">{{ receita.projetado|currency_no_decimal }}</div>
                    </div>
                    <div class="frz-plan-card status-{{ resultado.status }}">
                        <div class="frz-plan-titulo">üí∞ REALIZADO</div>
                        <div class="frz-plan-valor">{{ receita.realizado|currency_no_decimal }}</div>
                    </div>
                    <div class="frz-plan-card status-{{ resultado.status }}">
                        <div class="frz-plan-titulo">üéØ RESULTADO</div>
                        <div class="frz-plan-valor resultado-{{ resultado.status }}">{{ resultado.realizado|currency_no_decimal }}</div>
                    </div>
                </div>
            </div>
            
            <!-- Tabela de Planejamento Elegante -->
            <div class="frz-planejamento-table">
                <div class="frz-table-header">
                    <div class="frz-table-cell header">Clientes</div>
                    <div class="frz-table-cell header">PROJETADO</div>
                    <div class="frz-table-cell header">REALIZADO</div>
                    <div class="frz-table-cell header">STATUS</div>
                </div>
                
                <!-- Dados dos Clientes FRZ -->
                {% set clientes_frz = [
                    {"nome": "ADORO", "projetado": 250000, "realizado": receita.realizado * 0.15},
                    {"nome": "ADORO S.A.", "projetado": 200000, "realizado": receita.realizado * 0.12},
                    {"nome": "AGRA FOODS", "projetado": 50000, "realizado": receita.realizado * 0.08},
                    {"nome": "FRIBOI", "projetado": 60000, "realizado": receita.realizado * 0.05},
                    {"nome": "GTFOODS BARUERI", "projetado": 25000, "realizado": receita.realizado * 0.04},
                    {"nome": "MARFRIG - PROMISS√ÉO", "projetado": 130000, "realizado": receita.realizado * 0.18},
                    {"nome": "MARFRIG GLOBAL FOODS S A", "projetado": 80000, "realizado": receita.realizado * 0.10},
                    {"nome": "MINERVA S A", "projetado": 274000, "realizado": receita.realizado * 0.22},
                    {"nome": "PAMPLONA JANDIRA", "projetado": 45000, "realizado": receita.realizado * 0.06}
                ] %}
                
                {% for cliente in clientes_frz %}
                {% set perf = ((cliente.realizado / cliente.projetado * 100) if cliente.projetado > 0 else 0)|round|int %}
                <div class="frz-table-row">
                    <div class="frz-table-cell cliente">{{ cliente.nome }}</div>
                    <div class="frz-table-cell projetado">{{ cliente.projetado|currency_no_decimal }}</div>
                    <div class="frz-table-cell realizado">{{ cliente.realizado|round|int|currency_no_decimal }}</div>
                    <div class="frz-table-cell status">
                        <span class="frz-status-badge {% if perf >= 100 %}sucesso{% elif perf >= 70 %}medio{% else %}baixo{% endif %}">
                            {{ perf }}%
                        </span>
                    </div>
                </div>
                {% endfor %}
                
                <!-- Total -->
                <div class="frz-table-row total">
                    <div class="frz-table-cell cliente"><strong>TOTAL</strong></div>
                    <div class="frz-table-cell projetado"><strong>{{ receita.projetado|currency_no_decimal }}</strong></div>
                    <div class="frz-table-cell realizado"><strong>{{ receita.realizado|currency_no_decimal }}</strong></div>
                    <div class="frz-table-cell status">
                        <span class="frz-status-badge {% if receita.performance >= 100 %}sucesso{% elif receita.performance >= 70 %}medio{% else %}baixo{% endif %}">
                            {{ "%.0f"|format(receita.performance) }}%
                        </span>
                    </div>
                </div>
                
                <!-- Despesas Gerais -->
                <div class="frz-table-row despesas">
                    <div class="frz-table-cell cliente"><strong>Despesas gerais</strong></div>
                    <div class="frz-table-cell projetado">{{ despesa.projetado|currency_no_decimal }}</div>
                    <div class="frz-table-cell realizado">{{ despesa.realizado|currency_no_decimal }}</div>
                    <div class="frz-table-cell status">
                        <span class="frz-status-badge {% if despesa.performance <= 100 %}sucesso{% elif despesa.performance <= 120 %}medio{% else %}baixo{% endif %}">
                            {{ "%.0f"|format(despesa.performance) }}%
                        </span>
                    </div>
                </div>
                
                <!-- Resultado Final -->
                <div class="frz-table-row resultado-final">
                    <div class="frz-table-cell cliente"><strong>Resultado</strong></div>
                    <div class="frz-table-cell projetado">{{ resultado.projetado|currency_no_decimal }}</div>
                    <div class="frz-table-cell realizado resultado-{{ resultado.status }}">
                        <strong>{{ resultado.realizado|currency_no_decimal }}</strong>
                    </div>
                    <div class="frz-table-cell status">
                        <span class="frz-status-badge status-{{ resultado.status }}">
                            {% if resultado.status == 'positivo' %}‚úÖ POSITIVO
                            {% elif resultado.status == 'negativo' %}‚ùå NEGATIVO
                            {% else %}‚ö†Ô∏è NEUTRO{% endif %}
                        </span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endfor %}

<!-- Modais Executivos -->
<!-- Modal Receita -->
<div id="modalReceita" class="frz-modal" style="display: none;">
    <div class="frz-modal-content-wide">
        <div class="frz-modal-header">
            <h3>üìà Receitas - Detalhamento por Cliente</h3>
            <span class="frz-modal-close" onclick="fecharModal('modalReceita')">&times;</span>
        </div>
        
        <div class="frz-modal-body">
            <div class="frz-planejamento-header">
                <div class="frz-plan-resumo">
                    <div class="frz-plan-card">
                        <div class="frz-plan-titulo">üìä TOTAL RECEITAS</div>
                        <div class="frz-plan-valor">R$ {{ dados.dados_criticos.totais_mes.receita_realizada|currency_no_decimal }}</div>
                    </div>
                    <div class="frz-plan-card">
                        <div class="frz-plan-titulo">üéØ META</div>
                        <div class="frz-plan-valor">R$ {{ dados.dados_criticos.totais_mes.receita_projetada|currency_no_decimal }}</div>
                    </div>
                    <div class="frz-plan-card">
                        <div class="frz-plan-titulo">üìà PERFORMANCE</div>
                        <div class="frz-plan-valor">{{ "%.0f"|format((dados.dados_criticos.totais_mes.receita_realizada / dados.dados_criticos.totais_mes.receita_projetada * 100) if dados.dados_criticos.totais_mes.receita_projetada > 0 else 0) }}%</div>
                    </div>
                </div>
            </div>
            
            <div class="frz-planejamento-table">
                <div class="frz-table-header">
                    <div class="frz-table-cell header">Cliente</div>
                    <div class="frz-table-cell header">Receita</div>
                    <div class="frz-table-cell header">% do Total</div>
                    <div class="frz-table-cell header">Status</div>
                </div>
                
                <div id="receita-clientes-loading" class="frz-loading">Carregando dados...</div>
                <div id="receita-clientes-data" style="display: none;"></div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Despesa -->
<div id="modalDespesa" class="frz-modal" style="display: none;">
    <div class="frz-modal-content-wide">
        <div class="frz-modal-header">
            <h3>üí∏ Despesas - Detalhamento Completo</h3>
            <span class="frz-modal-close" onclick="fecharModal('modalDespesa')">&times;</span>
        </div>
        
        <div class="frz-modal-body">
            <div class="frz-planejamento-header">
                <div class="frz-plan-resumo">
                    <div class="frz-plan-card">
                        <div class="frz-plan-titulo">üìä TOTAL DESPESAS</div>
                        <div class="frz-plan-valor" id="despesa-total-valor">R$ {{ dados.dados_criticos.totais_mes.despesa_realizada|currency_no_decimal }}</div>
                    </div>
                    <div class="frz-plan-card">
                        <div class="frz-plan-titulo">üéØ META</div>
                        <div class="frz-plan-valor">R$ {{ dados.dados_criticos.totais_mes.despesa_projetada|currency_no_decimal }}</div>
                    </div>
                    <div class="frz-plan-card">
                        <div class="frz-plan-titulo">üìà PERFORMANCE</div>
                        <div class="frz-plan-valor">{{ "%.0f"|format((dados.dados_criticos.totais_mes.despesa_realizada / dados.dados_criticos.totais_mes.despesa_projetada * 100) if dados.dados_criticos.totais_mes.despesa_projetada > 0 else 0) }}%</div>
                    </div>
                </div>
            </div>

            <!-- Filtros -->
            <div style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                <div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
                    <div style="flex: 1; min-width: 200px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #333;">üè¢ Filtrar por Fornecedor:</label>
                        <input type="text" id="filtro-fornecedor" placeholder="Digite o nome do fornecedor..." 
                               style="width: 100%; padding: 8px; border: 2px solid #ddd; border-radius: 6px;"
                               onkeyup="aplicarFiltrosDespesas()">
                    </div>
                    <div style="flex: 1; min-width: 200px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #333;">üìã Filtrar por Conta Cont√°bil:</label>
                        <input type="text" id="filtro-conta" placeholder="Digite a conta cont√°bil..." 
                               style="width: 100%; padding: 8px; border: 2px solid #ddd; border-radius: 6px;"
                               onkeyup="aplicarFiltrosDespesas()">
                    </div>
                    <div style="flex: 1; min-width: 150px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #333;">üö¶ Status:</label>
                        <select id="filtro-status" 
                                style="width: 100%; padding: 8px; border: 2px solid #ddd; border-radius: 6px; background: white;"
                                onchange="aplicarFiltrosDespesas()">
                            <option value="">Todos</option>
                            <option value="pago">‚úÖ Pago</option>
                            <option value="pendente">‚è≥ Pendente</option>
                        </select>
                    </div>
                    <div style="flex: 0 0 auto;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #333;">&nbsp;</label>
                        <button onclick="limparFiltrosDespesas()" 
                                style="padding: 8px 16px; background: #ff6600; color: white; border: none; border-radius: 6px; cursor: pointer;">
                            üîÑ Limpar Filtros
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="frz-planejamento-table">
                <div class="frz-table-header">
                    <div class="frz-table-cell header" style="flex: 3;">Fornecedor</div>
                    <div class="frz-table-cell header" style="flex: 3;">Conta Cont√°bil</div>
                    <div class="frz-table-cell header" style="flex: 1.5;">Despesa</div>
                    <div class="frz-table-cell header" style="flex: 1.2;">Status</div>
                    <div class="frz-table-cell header" style="flex: 1;">% do Total</div>
                </div>
                
                <div id="despesa-clientes-loading" class="frz-loading">Carregando dados...</div>
                <div id="despesa-clientes-data" style="display: none; max-height: 400px; overflow-y: auto; overflow-x: auto; border: 1px solid #ddd; border-radius: 6px;"></div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Resultado -->
<div id="modalResultado" class="frz-modal" style="display: none;">
    <div class="frz-modal-content-wide">
        <div class="frz-modal-header">
            <h3>üí∞ An√°lise de Performance Financeira</h3>
            <span class="frz-modal-close" onclick="fecharModal('modalResultado')">&times;</span>
        </div>
        
        <div class="frz-modal-body">
            <!-- Resumo Visual Compacto -->
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                <div style="background: linear-gradient(135deg, #ff6600, #e55a00); color: white; padding: 12px; border-radius: 8px; text-align: center;">
                    <div style="font-size: 1.2rem; margin-bottom: 3px;">üí∞</div>
                    <div style="font-size: 0.75rem; opacity: 0.9; margin-bottom: 3px;">RESULTADO ATUAL</div>
                    <div id="resultado-valor-principal" style="font-size: 1.1rem; font-weight: bold;">Carregando...</div>
                </div>
                <div style="background: linear-gradient(135deg, #28a745, #20c997); color: white; padding: 12px; border-radius: 8px; text-align: center;">
                    <div style="font-size: 1.2rem; margin-bottom: 3px;">üìà</div>
                    <div style="font-size: 0.75rem; opacity: 0.9; margin-bottom: 3px;">MARGEM</div>
                    <div id="resultado-margem-principal" style="font-size: 1.1rem; font-weight: bold;">Carregando...</div>
                </div>
                <div style="background: linear-gradient(135deg, #6f42c1, #6610f2); color: white; padding: 12px; border-radius: 8px; text-align: center;">
                    <div style="font-size: 1.2rem; margin-bottom: 3px;">üéØ</div>
                    <div style="font-size: 0.75rem; opacity: 0.9; margin-bottom: 3px;">TEND√äNCIA</div>
                    <div id="resultado-tendencia-principal" style="font-size: 1.1rem; font-weight: bold;">Carregando...</div>
                </div>
            </div>

            <!-- Detalhamento por M√™s -->
            <div style="background: white; border: 1px solid #dee2e6; border-radius: 12px; overflow: hidden;">
                <div style="background: #6c757d; color: white; padding: 15px;">
                    <h4 style="margin: 0; display: flex; align-items: center; gap: 10px;">
                        <span>üìÖ</span> Detalhamento Mensal
                    </h4>
                </>
                <div id="resultado-comparativo-loading" class="frz-loading" style="margin: 20px;">Carregando dados detalhados...</div>
                <div id="resultado-comparativo-data" style="display: none;"></div>
            </div>

            <!-- Insights Autom√°ticos -->
            <div id="resultado-insights" style="margin-top: 20px; padding: 20px; background: linear-gradient(135deg, #fff3cd, #ffeaa7); border-radius: 12px; border-left: 5px solid #ffc107;">
                <h5 style="color: #856404; margin-bottom: 10px;">üí° Insights Autom√°ticos</h5>
                <div id="resultado-insights-content" style="color: #856404;">Carregando an√°lise...</div>
            </div>
        </div>
    </div>
</div>

<script>
function atualizarFrzLog() {
    const mes = document.getElementById('mes').value;
    const ano = document.getElementById('ano').value;
    window.location.href = `/frz_log?mes=${mes}&ano=${ano}`;
}

function abrirModalSemana(semana) {
    document.getElementById(`modalSemana${semana}`).style.display = 'flex';
}

function abrirModalExecutivo(tipo) {
    const modalId = `modal${tipo.charAt(0).toUpperCase() + tipo.slice(1)}`;
    document.getElementById(modalId).style.display = 'flex';
    
    // Carregar dados via AJAX
    carregarDadosExecutivo(tipo);
}

function carregarDadosExecutivo(tipo) {
    const mes = {{ mes }};
    const ano = {{ ano }};
    
    fetch(`/api/dados_executivo?tipo=${tipo}&mes=${mes}&ano=${ano}`, {
        method: 'GET',
        credentials: 'same-origin',
        headers: {
            'Content-Type': 'application/json',
        }
    })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            if (tipo === 'receita') {
                preencherModalReceita(data);
            } else if (tipo === 'despesa') {
                preencherModalDespesa(data);
            } else if (tipo === 'resultado') {
                preencherModalResultado(data);
            }
        })
        .catch(error => {
            console.error('Erro ao carregar dados:', error);
            const loadingId = tipo === 'resultado' ? 'resultado-comparativo-loading' : `${tipo}-clientes-loading`;
            document.getElementById(loadingId).innerHTML = `
                <div style="text-align: center; color: #ff6600; padding: 20px;">
                    <strong>‚ö†Ô∏è Erro de conex√£o</strong><br>
                    <small>Detalhes: ${error.message}</small><br>
                    <small>Verifique sua sess√£o e tente novamente</small>
                </div>
            `;
        });
}

function preencherModalReceita(data) {
    const loading = document.getElementById('receita-clientes-loading');
    const dataDiv = document.getElementById('receita-clientes-data');
    
    let html = '';
    data.clientes.forEach(cliente => {
        const percentual = ((cliente.valor / data.total) * 100).toFixed(1);
        html += `
            <div class="frz-table-row">
                <div class="frz-table-cell cliente">${cliente.nome}</div>
                <div class="frz-table-cell realizado">R$ ${cliente.valor.toLocaleString('pt-BR')}</div>
                <div class="frz-table-cell status">${percentual}%</div>
                <div class="frz-table-cell status">
                    <span class="frz-status-badge sucesso">‚úÖ</span>
                </div>
            </div>
        `;
    });
    
    dataDiv.innerHTML = html;
    loading.style.display = 'none';
    dataDiv.style.display = 'block';
}

// Vari√°vel global para armazenar os dados completos das despesas
let despesasCompletas = [];

function preencherModalDespesa(data) {
    const loading = document.getElementById('despesa-clientes-loading');
    const dataDiv = document.getElementById('despesa-clientes-data');
    const totalValor = document.getElementById('despesa-total-valor');
    
    // Armazena os dados completos para os filtros
    despesasCompletas = data.despesas;
    
    // Atualiza o total
    totalValor.textContent = `R$ ${data.total.toLocaleString('pt-BR', {minimumFractionDigits: 0, maximumFractionDigits: 0})}`;
    
    // Renderiza todos os dados
    renderizarDespesas(despesasCompletas, data.total);
    
    loading.style.display = 'none';
    dataDiv.style.display = 'block';
}

function renderizarDespesas(despesas, totalOriginal) {
    const dataDiv = document.getElementById('despesa-clientes-data');
    
    let html = '';
    despesas.forEach(despesa => {
        const percentual = ((despesa.valor / totalOriginal) * 100).toFixed(1);
        
        // Status mais limpo e compacto na mesma linha
        let statusHtml = '';
        if (despesa.status === 'Recebido') {
            statusHtml = '<span style="background: #28a745; color: white; padding: 2px 6px; border-radius: 8px; font-size: 0.75rem; font-weight: 600;">‚úÖ Pago</span>';
        } else {
            statusHtml = '<span style="background: #ffc107; color: #333; padding: 2px 6px; border-radius: 8px; font-size: 0.75rem; font-weight: 600;">‚è≥ Pendente</span>';
        }
        
        html += `
            <div class="frz-table-row">
                <div class="frz-table-cell cliente" style="flex: 3;">${despesa.fornecedor}</div>
                <div class="frz-table-cell cliente" style="flex: 3;">${despesa.conta_contabil}</div>
                <div class="frz-table-cell realizado" style="flex: 1.5;">R$ ${despesa.valor.toLocaleString('pt-BR', {minimumFractionDigits: 0, maximumFractionDigits: 0})}</div>
                <div class="frz-table-cell status" style="flex: 1.2; text-align: center;">
                    ${statusHtml}
                </div>
                <div class="frz-table-cell status" style="flex: 1; text-align: center;">${percentual}%</div>
            </div>
        `;
    });
    
    dataDiv.innerHTML = html;
}

function aplicarFiltrosDespesas() {
    const filtroFornecedor = document.getElementById('filtro-fornecedor').value.toLowerCase();
    const filtroConta = document.getElementById('filtro-conta').value.toLowerCase();
    const filtroStatus = document.getElementById('filtro-status').value.toLowerCase();
    
    let despesasFiltradas = despesasCompletas.filter(despesa => {
        const matchFornecedor = despesa.fornecedor.toLowerCase().includes(filtroFornecedor);
        const matchConta = despesa.conta_contabil.toLowerCase().includes(filtroConta);
        
        // Filtro de status com dropdown - "todos", "pago", "pendente"
        let matchStatus = true;
        if (filtroStatus === 'pago') {
            matchStatus = despesa.status === 'Recebido';
        } else if (filtroStatus === 'pendente') {
            matchStatus = despesa.status === 'Pendente';
        }
        // Se filtroStatus est√° vazio ("todos"), matchStatus permanece true
        
        return matchFornecedor && matchConta && matchStatus;
    });
    
    // Calcula o total filtrado
    const totalFiltrado = despesasFiltradas.reduce((sum, despesa) => sum + despesa.valor, 0);
    
    // Atualiza o total exibido
    const totalValor = document.getElementById('despesa-total-valor');
    totalValor.textContent = `R$ ${totalFiltrado.toLocaleString('pt-BR', {minimumFractionDigits: 0, maximumFractionDigits: 0})} (${despesasFiltradas.length} registros)`;
    
    // Renderiza os dados filtrados
    renderizarDespesas(despesasFiltradas, totalFiltrado);
}

function limparFiltrosDespesas() {
    document.getElementById('filtro-fornecedor').value = '';
    document.getElementById('filtro-conta').value = '';
    document.getElementById('filtro-status').selectedIndex = 0; // Volta para "Todos"
    
    // Calcula o total original
    const totalOriginal = despesasCompletas.reduce((sum, despesa) => sum + despesa.valor, 0);
    
    // Restaura o total original
    const totalValor = document.getElementById('despesa-total-valor');
    totalValor.textContent = `R$ ${totalOriginal.toLocaleString('pt-BR', {minimumFractionDigits: 0, maximumFractionDigits: 0})}`;
    
    // Renderiza todos os dados
    renderizarDespesas(despesasCompletas, totalOriginal);
}

function preencherModalResultado(data) {
    const loading = document.getElementById('resultado-comparativo-loading');
    const dataDiv = document.getElementById('resultado-comparativo-data');
    
    // Dados do m√™s atual (primeiro per√≠odo)
    const mesAtual = data.periodos[0];
    const margem = mesAtual.receitas > 0 ? (mesAtual.resultado / mesAtual.receitas * 100) : 0;
    
    // Atualizar cards principais
    const valorPrincipal = document.getElementById('resultado-valor-principal');
    const margemPrincipal = document.getElementById('resultado-margem-principal');
    const tendenciaPrincipal = document.getElementById('resultado-tendencia-principal');
    
    // Valor com formata√ß√£o bonita
    const valorFormatado = mesAtual.resultado >= 0 ? 
        `+R$ ${mesAtual.resultado.toLocaleString('pt-BR')}` : 
        `-R$ ${Math.abs(mesAtual.resultado).toLocaleString('pt-BR')}`;
    
    valorPrincipal.textContent = valorFormatado;
    valorPrincipal.parentElement.style.background = mesAtual.resultado >= 0 ?
        'linear-gradient(135deg, #28a745, #20c997)' :
        'linear-gradient(135deg, #dc3545, #c82333)';
    
    margemPrincipal.textContent = `${margem.toFixed(1)}%`;
    
    // Tend√™ncia baseada na varia√ß√£o
    const variacao = mesAtual.variacao_percentual;
    if (variacao > 10) {
        tendenciaPrincipal.textContent = 'üöÄ EXCELENTE';
        tendenciaPrincipal.parentElement.style.background = 'linear-gradient(135deg, #28a745, #20c997)';
    } else if (variacao > 0) {
        tendenciaPrincipal.textContent = 'üìà MELHORA';
        tendenciaPrincipal.parentElement.style.background = 'linear-gradient(135deg, #17a2b8, #138496)';
    } else if (variacao > -10) {
        tendenciaPrincipal.textContent = '‚ö†Ô∏è EST√ÅVEL';
        tendenciaPrincipal.parentElement.style.background = 'linear-gradient(135deg, #ffc107, #e0a800)';
    } else {
        tendenciaPrincipal.textContent = 'üìâ ATEN√á√ÉO';
        tendenciaPrincipal.parentElement.style.background = 'linear-gradient(135deg, #dc3545, #c82333)';
    }
    
    // Removido gr√°fico para layout mais limpo
    
    // Reverter ordem para mostrar do mais recente para o mais antigo
    data.periodos.reverse();
    
    // Tabela detalhada
    let tabelaHtml = `
        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr 1fr; gap: 0; font-size: 0.9rem;">
            <div style="background: #495057; color: white; padding: 12px; font-weight: bold;">Per√≠odo</div>
            <div style="background: #495057; color: white; padding: 12px; font-weight: bold;">Receitas</div>
            <div style="background: #495057; color: white; padding: 12px; font-weight: bold;">Despesas</div>
            <div style="background: #495057; color: white; padding: 12px; font-weight: bold;">Resultado</div>
            <div style="background: #495057; color: white; padding: 12px; font-weight: bold;">Varia√ß√£o</div>
    `;
    
    data.periodos.forEach((periodo, index) => {
        const variacao = periodo.variacao_percentual;
        const variacaoIcon = variacao > 0 ? 'üìà' : variacao < 0 ? 'üìâ' : '‚ûñ';
        const resultadoCor = periodo.resultado >= 0 ? '#28a745' : '#dc3545';
        const bgColor = index % 2 === 0 ? '#f8f9fa' : '#ffffff';
        
        tabelaHtml += `
            <div style="background: ${bgColor}; padding: 12px; border-bottom: 1px solid #dee2e6; color: #333; font-weight: 500;">${periodo.periodo}</div>
            <div style="background: ${bgColor}; padding: 12px; border-bottom: 1px solid #dee2e6; color: #333;">R$ ${periodo.receitas.toLocaleString('pt-BR')}</div>
            <div style="background: ${bgColor}; padding: 12px; border-bottom: 1px solid #dee2e6; color: #333;">R$ ${periodo.despesas.toLocaleString('pt-BR')}</div>
            <div style="background: ${bgColor}; padding: 12px; border-bottom: 1px solid #dee2e6; color: ${resultadoCor}; font-weight: bold;">
                ${periodo.resultado >= 0 ? '+' : ''}R$ ${periodo.resultado.toLocaleString('pt-BR')}
            </div>
            <div style="background: ${bgColor}; padding: 12px; border-bottom: 1px solid #dee2e6; color: #333; font-weight: 500;">
                ${variacaoIcon} ${Math.abs(variacao).toFixed(1)}%
            </div>
        `;
    });
    tabelaHtml += '</div>';
    
    // Insights autom√°ticos
    const insightsContent = document.getElementById('resultado-insights-content');
    let insights = [];
    
    if (mesAtual.resultado < 0) {
        insights.push(`‚Ä¢ Resultado negativo de R$ ${Math.abs(mesAtual.resultado).toLocaleString('pt-BR')} requer aten√ß√£o`);
    }
    if (margem < -50) {
        insights.push(`‚Ä¢ Margem operacional de ${margem.toFixed(1)}% indica despesas muito superiores √†s receitas`);
    }
    if (variacao < -20) {
        insights.push(`‚Ä¢ Queda de ${Math.abs(variacao).toFixed(1)}% em rela√ß√£o ao m√™s anterior`);
    }
    if (mesAtual.receitas < 100000) {
        insights.push(`‚Ä¢ Receitas baixas (R$ ${mesAtual.receitas.toLocaleString('pt-BR')}) podem indicar sazonalidade`);
    }
    
    if (insights.length === 0) {
        insights.push('‚Ä¢ Performance dentro dos par√¢metros esperados');
    }
    
    insightsContent.innerHTML = insights.join('<br>');
    
    dataDiv.innerHTML = tabelaHtml;
    loading.style.display = 'none';
    dataDiv.style.display = 'block';
}

function fecharModal(modalId) {
    document.getElementById(modalId).style.display = 'none';
}

// Fechar modal clicando fora dele
window.onclick = function(event) {
    if (event.target.classList.contains('frz-modal')) {
        event.target.style.display = 'none';
    }
}
</script>
{% endblock %}