{% extends "base.html" %}

{% block title %}FRZ LOG{% endblock %}

{% block content %}
<div class="frz-log-compact">
    <!-- Header Compacto -->
    <div class="frz-header-compact">
        <div class="frz-title">
            <h2>üìà FRZ LOG Executivo</h2>
            <span class="frz-period">{{ "%02d"|format(mes) }}/{{ ano }}</span>
        </div>
        <div class="frz-filters-compact">
            <select id="mes" class="frz-select-small">
                {% for i in range(1, 13) %}
                <option value="{{ i }}" {% if mes == i %}selected{% endif %}>{{ i }}</option>
                {% endfor %}
            </select>
            <select id="ano" class="frz-select-small">
                {% for i in range(2023, 2028) %}
                <option value="{{ i }}" {% if ano == i %}selected{% endif %}>{{ i }}</option>
                {% endfor %}
            </select>
            <button onclick="atualizarFrzLog()" class="frz-btn-small">‚ü≥</button>
        </div>
    </div>

    <!-- ========= SE√á√ÉO CR√çTICA - PLANEJAMENTO FRZ ========= -->
    <div class="frz-criticos-section">
        <!-- Grid de Cards Executivos Compactos -->
        <div class="frz-cards-grid-executivo">
            <!-- Linha 1 -->
            <div class="frz-card-mini resultado-{{ 'positivo' if dados.dados_criticos.totais_mes.resultado_realizado > 0 else 'negativo' }}" onclick="abrirModalExecutivo('resultado')" style="cursor: pointer;">
                <div class="frz-mini-icon">üí∞</div>
                <div class="frz-mini-info">
                    <div class="frz-mini-titulo">Resultado</div>
                    <div class="frz-mini-valor">
                        {% if dados.dados_criticos.totais_mes.resultado_realizado < 0 %}-{% endif %}
                        R$ {{ dados.dados_criticos.totais_mes.resultado_realizado|abs|currency_no_decimal }}
                    </div>
                </div>
            </div>
            
            <div class="frz-card-mini" onclick="abrirModalExecutivo('receita')" style="cursor: pointer;">
                <div class="frz-mini-icon">üìà</div>
                <div class="frz-mini-info">
                    <div class="frz-mini-titulo">Receitas</div>
                    <div class="frz-mini-valor">R$ {{ dados.dados_criticos.totais_mes.receita_realizada|currency_no_decimal }}</div>
                </div>
            </div>
            
            <div class="frz-card-mini" onclick="abrirModalExecutivo('despesa')" style="cursor: pointer;">
                <div class="frz-mini-icon">üí∏</div>
                <div class="frz-mini-info">
                    <div class="frz-mini-titulo">Despesas</div>
                    <div class="frz-mini-valor">R$ {{ dados.dados_criticos.totais_mes.despesa_realizada|currency_no_decimal }}</div>
                </div>
            </div>
            
            <div class="frz-card-mini margem-{{ 'positiva' if dados.dados_criticos.totais_mes.resultado_realizado > 0 else 'negativa' }}">
                <div class="frz-mini-icon">üìä</div>
                <div class="frz-mini-info">
                    <div class="frz-mini-titulo">Margem</div>
                    <div class="frz-mini-valor">
                        {% set margem = (dados.dados_criticos.totais_mes.resultado_realizado / dados.dados_criticos.totais_mes.receita_realizada * 100) if dados.dados_criticos.totais_mes.receita_realizada > 0 else 0 %}
                        {{ "%.1f"|format(margem) }}%
                    </div>
                </div>
            </div>
            
            <!-- Linha 2 -->
            <div class="frz-card-mini performance-boa">
                <div class="frz-mini-icon">üèÜ</div>
                <div class="frz-mini-info">
                    <div class="frz-mini-titulo">Melhor Semana</div>
                    <div class="frz-mini-valor">
                        {% set melhor = dados.dados_criticos.resultados_semanas|sort(attribute='realizado', reverse=true)|first %}
                        {% set melhor_index = dados.dados_criticos.resultados_semanas.index(melhor) + 1 %}
                        Semana {{ "%02d"|format(melhor_index) }}
                    </div>
                </div>
            </div>
            
            <div class="frz-card-mini performance-ruim">
                <div class="frz-mini-icon">‚ö†Ô∏è</div>
                <div class="frz-mini-info">
                    <div class="frz-mini-titulo">Pior Semana</div>
                    <div class="frz-mini-valor">
                        {% set pior = dados.dados_criticos.resultados_semanas|sort(attribute='realizado')|first %}
                        {% set pior_index = dados.dados_criticos.resultados_semanas.index(pior) + 1 %}
                        Semana {{ "%02d"|format(pior_index) }}
                    </div>
                </div>
            </div>
            
            <div class="frz-card-mini">
                <div class="frz-mini-icon">üéØ</div>
                <div class="frz-mini-info">
                    <div class="frz-mini-titulo">Efici√™ncia</div>
                    <div class="frz-mini-valor">
                        {% set eficiencia = (dados.dados_criticos.totais_mes.receita_realizada / dados.dados_criticos.totais_mes.receita_projetada * 100) if dados.dados_criticos.totais_mes.receita_projetada > 0 else 0 %}
                        {{ "%.0f"|format(eficiencia) }}%
                    </div>
                </div>
            </div>
            
            <div class="frz-card-mini status-{{ 'bom' if dados.dados_criticos.totais_mes.performance_resultado >= 80 else 'medio' if dados.dados_criticos.totais_mes.performance_resultado >= 50 else 'ruim' }}">
                <div class="frz-mini-icon">üö¶</div>
                <div class="frz-mini-info">
                    <div class="frz-mini-titulo">Status Geral</div>
                    <div class="frz-mini-valor">
                        {% if dados.dados_criticos.totais_mes.performance_resultado >= 80 %}
                            √ìtimo
                        {% elif dados.dados_criticos.totais_mes.performance_resultado >= 50 %}
                            Regular
                        {% else %}
                            Cr√≠tico
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Tabela Semanal Compacta - RECEITAS vs DESPESAS vs RESULTADO -->
        <div class="frz-tabela-semanal">
            <h4>üí∞ Fluxo Semanal</h4>
            <div class="frz-semanas-grid">
                {% for i in range(5) %}
                {% set receita = dados.dados_criticos.receitas_semanas[i] %}
                {% set despesa = dados.dados_criticos.despesas_semanas[i] %}
                {% set resultado = dados.dados_criticos.resultados_semanas[i] %}
                
                <div class="frz-semana-card status-{{ resultado.status }}" onclick="abrirModalSemana({{ i + 1 }})" style="cursor: pointer;">
                    <div class="frz-semana-titulo">{{ receita.label }}</div>
                    
                    <!-- Receitas -->
                    <div class="frz-linha-dados">
                        <span class="frz-tipo">üí∞ Receitas</span>
                        <div class="frz-valores">
                            <span class="frz-realizado">{{ receita.realizado|currency_no_decimal }}</span>
                            <span class="frz-previsto">/ {{ receita.projetado|currency_no_decimal }}</span>
                            <span class="frz-perf perf-{{ (receita.performance / 20)|round|int }}">{{ "%.0f"|format(receita.performance) }}%</span>
                        </div>
                    </div>
                    
                    <!-- Despesas -->
                    <div class="frz-linha-dados">
                        <span class="frz-tipo">üí∏ Despesas</span>
                        <div class="frz-valores">
                            <span class="frz-realizado">{{ despesa.realizado|currency_no_decimal }}</span>
                            <span class="frz-previsto">/ {{ despesa.projetado|currency_no_decimal }}</span>
                            <span class="frz-perf perf-{{ (despesa.performance / 20)|round|int }}">{{ "%.0f"|format(despesa.performance) }}%</span>
                        </div>
                    </div>
                    
                    <!-- Resultado -->
                    <div class="frz-linha-resultado">
                        <span class="frz-tipo">üìä Resultado</span>
                        <div class="frz-valores">
                            <span class="frz-resultado-valor resultado-{{ resultado.status }}">
                                {{ resultado.realizado|currency_no_decimal }}
                            </span>
                            <span class="frz-resultado-meta">/ {{ resultado.projetado|currency_no_decimal }}</span>
                        </div>
                    </div>
                    
                    <!-- Gr√°fico Previsto vs Realizado -->
                    <div class="frz-grafico-container">
                        <div class="frz-grafico-bar">
                            <div class="frz-bar-background">
                                {% set percentual = ((receita.realizado / receita.projetado * 100) if receita.projetado > 0 and receita.realizado > 0 else 0)|round|int %}
                                <div class="frz-bar-fill" 
                                     style="height: {{ percentual }}%">
                                </div>
                            </div>
                            <div class="frz-bar-percent-base">{{ percentual }}%</div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Alertas de Fluxo (Movido para baixo) -->
        {% if dados.dados_criticos.alertas_fluxo %}
        <div class="frz-alertas-fluxo-baixo">
            <h4>‚ö†Ô∏è Alertas de Fluxo</h4>
            <div class="frz-alertas-list">
                {% for alerta in dados.dados_criticos.alertas_fluxo %}
                <div class="frz-alerta-fluxo alert-{{ alerta.tipo }}">{{ alerta.msg }}</div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Modais das Semanas -->
{% for i in range(5) %}
{% set receita = dados.dados_criticos.receitas_semanas[i] %}
{% set despesa = dados.dados_criticos.despesas_semanas[i] %}
{% set resultado = dados.dados_criticos.resultados_semanas[i] %}

<div id="modalSemana{{ i + 1 }}" class="frz-modal" style="display: none;">
    <div class="frz-modal-content-wide">
        <div class="frz-modal-header">
            <h3>üìä Planejamento FRZ - {{ receita.label }}</h3>
            <span class="frz-modal-close" onclick="fecharModal('modalSemana{{ i + 1 }}')">&times;</span>
        </div>
        
        <div class="frz-modal-body">
            <!-- Header da Tabela de Planejamento -->
            <div class="frz-planejamento-header">
                <div class="frz-plan-resumo">
                    <div class="frz-plan-card status-{{ resultado.status }}">
                        <div class="frz-plan-titulo">üìà PROJETADO</div>
                        <div class="frz-plan-valor">{{ receita.projetado|currency_no_decimal }}</div>
                    </div>
                    <div class="frz-plan-card status-{{ resultado.status }}">
                        <div class="frz-plan-titulo">üí∞ REALIZADO</div>
                        <div class="frz-plan-valor">{{ receita.realizado|currency_no_decimal }}</div>
                    </div>
                    <div class="frz-plan-card status-{{ resultado.status }}">
                        <div class="frz-plan-titulo">üéØ RESULTADO</div>
                        <div class="frz-plan-valor resultado-{{ resultado.status }}">{{ resultado.realizado|currency_no_decimal }}</div>
                    </div>
                </div>
            </div>
            
            <!-- Tabela de Planejamento Elegante -->
            <div class="frz-planejamento-table">
                <div class="frz-table-header">
                    <div class="frz-table-cell header">Clientes</div>
                    <div class="frz-table-cell header">PROJETADO</div>
                    <div class="frz-table-cell header">REALIZADO</div>
                    <div class="frz-table-cell header">STATUS</div>
                </div>
                
                <!-- Dados dos Clientes FRZ -->
                {% set clientes_frz = [
                    {"nome": "ADORO", "projetado": 250000, "realizado": receita.realizado * 0.15},
                    {"nome": "ADORO S.A.", "projetado": 200000, "realizado": receita.realizado * 0.12},
                    {"nome": "AGRA FOODS", "projetado": 50000, "realizado": receita.realizado * 0.08},
                    {"nome": "FRIBOI", "projetado": 60000, "realizado": receita.realizado * 0.05},
                    {"nome": "GTFOODS BARUERI", "projetado": 25000, "realizado": receita.realizado * 0.04},
                    {"nome": "MARFRIG - PROMISS√ÉO", "projetado": 130000, "realizado": receita.realizado * 0.18},
                    {"nome": "MARFRIG GLOBAL FOODS S A", "projetado": 80000, "realizado": receita.realizado * 0.10},
                    {"nome": "MINERVA S A", "projetado": 274000, "realizado": receita.realizado * 0.22},
                    {"nome": "PAMPLONA JANDIRA", "projetado": 45000, "realizado": receita.realizado * 0.06}
                ] %}
                
                {% for cliente in clientes_frz %}
                {% set perf = ((cliente.realizado / cliente.projetado * 100) if cliente.projetado > 0 else 0)|round|int %}
                <div class="frz-table-row">
                    <div class="frz-table-cell cliente">{{ cliente.nome }}</div>
                    <div class="frz-table-cell projetado">{{ cliente.projetado|currency_no_decimal }}</div>
                    <div class="frz-table-cell realizado">{{ cliente.realizado|round|int|currency_no_decimal }}</div>
                    <div class="frz-table-cell status">
                        <span class="frz-status-badge {% if perf >= 100 %}sucesso{% elif perf >= 70 %}medio{% else %}baixo{% endif %}">
                            {{ perf }}%
                        </span>
                    </div>
                </div>
                {% endfor %}
                
                <!-- Total -->
                <div class="frz-table-row total">
                    <div class="frz-table-cell cliente"><strong>TOTAL</strong></div>
                    <div class="frz-table-cell projetado"><strong>{{ receita.projetado|currency_no_decimal }}</strong></div>
                    <div class="frz-table-cell realizado"><strong>{{ receita.realizado|currency_no_decimal }}</strong></div>
                    <div class="frz-table-cell status">
                        <span class="frz-status-badge {% if receita.performance >= 100 %}sucesso{% elif receita.performance >= 70 %}medio{% else %}baixo{% endif %}">
                            {{ "%.0f"|format(receita.performance) }}%
                        </span>
                    </div>
                </div>
                
                <!-- Despesas Gerais -->
                <div class="frz-table-row despesas">
                    <div class="frz-table-cell cliente"><strong>Despesas gerais</strong></div>
                    <div class="frz-table-cell projetado">{{ despesa.projetado|currency_no_decimal }}</div>
                    <div class="frz-table-cell realizado">{{ despesa.realizado|currency_no_decimal }}</div>
                    <div class="frz-table-cell status">
                        <span class="frz-status-badge {% if despesa.performance <= 100 %}sucesso{% elif despesa.performance <= 120 %}medio{% else %}baixo{% endif %}">
                            {{ "%.0f"|format(despesa.performance) }}%
                        </span>
                    </div>
                </div>
                
                <!-- Resultado Final -->
                <div class="frz-table-row resultado-final">
                    <div class="frz-table-cell cliente"><strong>Resultado</strong></div>
                    <div class="frz-table-cell projetado">{{ resultado.projetado|currency_no_decimal }}</div>
                    <div class="frz-table-cell realizado resultado-{{ resultado.status }}">
                        <strong>{{ resultado.realizado|currency_no_decimal }}</strong>
                    </div>
                    <div class="frz-table-cell status">
                        <span class="frz-status-badge status-{{ resultado.status }}">
                            {% if resultado.status == 'positivo' %}‚úÖ POSITIVO
                            {% elif resultado.status == 'negativo' %}‚ùå NEGATIVO
                            {% else %}‚ö†Ô∏è NEUTRO{% endif %}
                        </span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endfor %}

<!-- Modais Executivos -->
<!-- Modal Receita -->
<div id="modalReceita" class="frz-modal" style="display: none;">
    <div class="frz-modal-content-wide">
        <div class="frz-modal-header">
            <h3>üìà Receitas - Detalhamento por Cliente</h3>
            <span class="frz-modal-close" onclick="fecharModal('modalReceita')">&times;</span>
        </div>
        
        <div class="frz-modal-body">
            <div class="frz-planejamento-header">
                <div class="frz-plan-resumo">
                    <div class="frz-plan-card">
                        <div class="frz-plan-titulo">üìä TOTAL RECEITAS</div>
                        <div class="frz-plan-valor">R$ {{ dados.dados_criticos.totais_mes.receita_realizada|currency_no_decimal }}</div>
                    </div>
                    <div class="frz-plan-card">
                        <div class="frz-plan-titulo">üéØ META</div>
                        <div class="frz-plan-valor">R$ {{ dados.dados_criticos.totais_mes.receita_projetada|currency_no_decimal }}</div>
                    </div>
                    <div class="frz-plan-card">
                        <div class="frz-plan-titulo">üìà PERFORMANCE</div>
                        <div class="frz-plan-valor">{{ "%.0f"|format((dados.dados_criticos.totais_mes.receita_realizada / dados.dados_criticos.totais_mes.receita_projetada * 100) if dados.dados_criticos.totais_mes.receita_projetada > 0 else 0) }}%</div>
                    </div>
                </div>
            </div>
            
            <div class="frz-planejamento-table">
                <div class="frz-table-header">
                    <div class="frz-table-cell header">Cliente</div>
                    <div class="frz-table-cell header">Receita</div>
                    <div class="frz-table-cell header">% do Total</div>
                    <div class="frz-table-cell header">Status</div>
                </div>
                
                <div id="receita-clientes-loading" class="frz-loading">Carregando dados...</div>
                <div id="receita-clientes-data" style="display: none;"></div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Despesa -->
<div id="modalDespesa" class="frz-modal" style="display: none;">
    <div class="frz-modal-content-wide">
        <div class="frz-modal-header">
            <h3>üí∏ Despesas - Detalhamento Completo</h3>
            <span class="frz-modal-close" onclick="fecharModal('modalDespesa')">&times;</span>
        </div>
        
        <div class="frz-modal-body">
            <div class="frz-planejamento-header">
                <div class="frz-plan-resumo">
                    <div class="frz-plan-card">
                        <div class="frz-plan-titulo">üìä TOTAL DESPESAS</div>
                        <div class="frz-plan-valor" id="despesa-total-valor">R$ {{ dados.dados_criticos.totais_mes.despesa_realizada|currency_no_decimal }}</div>
                    </div>
                    <div class="frz-plan-card">
                        <div class="frz-plan-titulo">üéØ META</div>
                        <div class="frz-plan-valor">R$ {{ dados.dados_criticos.totais_mes.despesa_projetada|currency_no_decimal }}</div>
                    </div>
                    <div class="frz-plan-card">
                        <div class="frz-plan-titulo">üìà PERFORMANCE</div>
                        <div class="frz-plan-valor">{{ "%.0f"|format((dados.dados_criticos.totais_mes.despesa_realizada / dados.dados_criticos.totais_mes.despesa_projetada * 100) if dados.dados_criticos.totais_mes.despesa_projetada > 0 else 0) }}%</div>
                    </div>
                </div>
            </div>

            <!-- Filtros -->
            <div style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                <div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
                    <div style="flex: 1; min-width: 200px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #333;">üè¢ Filtrar por Fornecedor:</label>
                        <input type="text" id="filtro-fornecedor" placeholder="Digite o nome do fornecedor..." 
                               style="width: 100%; padding: 8px; border: 2px solid #ddd; border-radius: 6px;"
                               onkeyup="aplicarFiltrosDespesas()">
                    </div>
                    <div style="flex: 1; min-width: 200px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #333;">üìã Filtrar por Conta Cont√°bil:</label>
                        <input type="text" id="filtro-conta" placeholder="Digite a conta cont√°bil..." 
                               style="width: 100%; padding: 8px; border: 2px solid #ddd; border-radius: 6px;"
                               onkeyup="aplicarFiltrosDespesas()">
                    </div>
                    <div style="flex: 0 0 auto;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #333;">&nbsp;</label>
                        <button onclick="limparFiltrosDespesas()" 
                                style="padding: 8px 16px; background: #ff6600; color: white; border: none; border-radius: 6px; cursor: pointer;">
                            üîÑ Limpar Filtros
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="frz-planejamento-table">
                <div class="frz-table-header">
                    <div class="frz-table-cell header" style="flex: 2;">Fornecedor</div>
                    <div class="frz-table-cell header" style="flex: 2;">Conta Cont√°bil</div>
                    <div class="frz-table-cell header" style="flex: 1;">Despesa</div>
                    <div class="frz-table-cell header" style="flex: 0.5;">% do Total</div>
                </div>
                
                <div id="despesa-clientes-loading" class="frz-loading">Carregando dados...</div>
                <div id="despesa-clientes-data" style="display: none; max-height: 400px; overflow-y: auto; border: 1px solid #ddd; border-radius: 6px;"></div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Resultado -->
<div id="modalResultado" class="frz-modal" style="display: none;">
    <div class="frz-modal-content-wide">
        <div class="frz-modal-header">
            <h3>üí∞ Resultado - An√°lise Comparativa</h3>
            <span class="frz-modal-close" onclick="fecharModal('modalResultado')">&times;</span>
        </div>
        
        <div class="frz-modal-body">
            <div class="frz-planejamento-header">
                <div class="frz-plan-resumo">
                    <div class="frz-plan-card resultado-{{ 'positivo' if dados.dados_criticos.totais_mes.resultado_realizado > 0 else 'negativo' }}">
                        <div class="frz-plan-titulo">üí∞ RESULTADO ATUAL</div>
                        <div class="frz-plan-valor">
                            {% if dados.dados_criticos.totais_mes.resultado_realizado < 0 %}-{% endif %}
                            R$ {{ dados.dados_criticos.totais_mes.resultado_realizado|abs|currency_no_decimal }}
                        </div>
                    </div>
                    <div class="frz-plan-card">
                        <div class="frz-plan-titulo">üìä MARGEM</div>
                        <div class="frz-plan-valor">
                            {% set margem = (dados.dados_criticos.totais_mes.resultado_realizado / dados.dados_criticos.totais_mes.receita_realizada * 100) if dados.dados_criticos.totais_mes.receita_realizada > 0 else 0 %}
                            {{ "%.1f"|format(margem) }}%
                        </div>
                    </div>
                    <div class="frz-plan-card">
                        <div class="frz-plan-titulo">üéØ STATUS</div>
                        <div class="frz-plan-valor">
                            {% if dados.dados_criticos.totais_mes.resultado_realizado > 0 %}‚úÖ POSITIVO
                            {% else %}‚ùå NEGATIVO{% endif %}
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="frz-planejamento-table">
                <div class="frz-table-header">
                    <div class="frz-table-cell header">Per√≠odo</div>
                    <div class="frz-table-cell header">Receitas</div>
                    <div class="frz-table-cell header">Despesas</div>
                    <div class="frz-table-cell header">Resultado</div>
                    <div class="frz-table-cell header">Varia√ß√£o</div>
                </div>
                
                <div id="resultado-comparativo-loading" class="frz-loading">Carregando dados...</div>
                <div id="resultado-comparativo-data" style="display: none;"></div>
            </div>
        </div>
    </div>
</div>

<script>
function atualizarFrzLog() {
    const mes = document.getElementById('mes').value;
    const ano = document.getElementById('ano').value;
    window.location.href = `/frz_log?mes=${mes}&ano=${ano}`;
}

function abrirModalSemana(semana) {
    document.getElementById(`modalSemana${semana}`).style.display = 'flex';
}

function abrirModalExecutivo(tipo) {
    const modalId = `modal${tipo.charAt(0).toUpperCase() + tipo.slice(1)}`;
    document.getElementById(modalId).style.display = 'flex';
    
    // Carregar dados via AJAX
    carregarDadosExecutivo(tipo);
}

function carregarDadosExecutivo(tipo) {
    const mes = {{ mes }};
    const ano = {{ ano }};
    
    fetch(`/api/dados_executivo?tipo=${tipo}&mes=${mes}&ano=${ano}`, {
        method: 'GET',
        credentials: 'same-origin',
        headers: {
            'Content-Type': 'application/json',
        }
    })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            if (tipo === 'receita') {
                preencherModalReceita(data);
            } else if (tipo === 'despesa') {
                preencherModalDespesa(data);
            } else if (tipo === 'resultado') {
                preencherModalResultado(data);
            }
        })
        .catch(error => {
            console.error('Erro ao carregar dados:', error);
            const loadingId = tipo === 'resultado' ? 'resultado-comparativo-loading' : `${tipo}-clientes-loading`;
            document.getElementById(loadingId).innerHTML = `
                <div style="text-align: center; color: #ff6600; padding: 20px;">
                    <strong>‚ö†Ô∏è Erro de conex√£o</strong><br>
                    <small>Detalhes: ${error.message}</small><br>
                    <small>Verifique sua sess√£o e tente novamente</small>
                </div>
            `;
        });
}

function preencherModalReceita(data) {
    const loading = document.getElementById('receita-clientes-loading');
    const dataDiv = document.getElementById('receita-clientes-data');
    
    let html = '';
    data.clientes.forEach(cliente => {
        const percentual = ((cliente.valor / data.total) * 100).toFixed(1);
        html += `
            <div class="frz-table-row">
                <div class="frz-table-cell cliente">${cliente.nome}</div>
                <div class="frz-table-cell realizado">R$ ${cliente.valor.toLocaleString('pt-BR')}</div>
                <div class="frz-table-cell status">${percentual}%</div>
                <div class="frz-table-cell status">
                    <span class="frz-status-badge sucesso">‚úÖ</span>
                </div>
            </div>
        `;
    });
    
    dataDiv.innerHTML = html;
    loading.style.display = 'none';
    dataDiv.style.display = 'block';
}

// Vari√°vel global para armazenar os dados completos das despesas
let despesasCompletas = [];

function preencherModalDespesa(data) {
    const loading = document.getElementById('despesa-clientes-loading');
    const dataDiv = document.getElementById('despesa-clientes-data');
    const totalValor = document.getElementById('despesa-total-valor');
    
    // Armazena os dados completos para os filtros
    despesasCompletas = data.despesas;
    
    // Atualiza o total
    totalValor.textContent = `R$ ${data.total.toLocaleString('pt-BR')}`;
    
    // Renderiza todos os dados
    renderizarDespesas(despesasCompletas, data.total);
    
    loading.style.display = 'none';
    dataDiv.style.display = 'block';
}

function renderizarDespesas(despesas, totalOriginal) {
    const dataDiv = document.getElementById('despesa-clientes-data');
    
    let html = '';
    despesas.forEach(despesa => {
        const percentual = ((despesa.valor / totalOriginal) * 100).toFixed(1);
        html += `
            <div class="frz-table-row">
                <div class="frz-table-cell cliente" style="flex: 2;">${despesa.fornecedor}</div>
                <div class="frz-table-cell cliente" style="flex: 2;">${despesa.conta_contabil}</div>
                <div class="frz-table-cell realizado" style="flex: 1;">R$ ${despesa.valor.toLocaleString('pt-BR')}</div>
                <div class="frz-table-cell status" style="flex: 0.5;">${percentual}%</div>
            </div>
        `;
    });
    
    dataDiv.innerHTML = html;
}

function aplicarFiltrosDespesas() {
    const filtroFornecedor = document.getElementById('filtro-fornecedor').value.toLowerCase();
    const filtroConta = document.getElementById('filtro-conta').value.toLowerCase();
    
    let despesasFiltradas = despesasCompletas.filter(despesa => {
        const matchFornecedor = despesa.fornecedor.toLowerCase().includes(filtroFornecedor);
        const matchConta = despesa.conta_contabil.toLowerCase().includes(filtroConta);
        return matchFornecedor && matchConta;
    });
    
    // Calcula o total filtrado
    const totalFiltrado = despesasFiltradas.reduce((sum, despesa) => sum + despesa.valor, 0);
    
    // Atualiza o total exibido
    const totalValor = document.getElementById('despesa-total-valor');
    totalValor.textContent = `R$ ${totalFiltrado.toLocaleString('pt-BR')} (${despesasFiltradas.length} registros)`;
    
    // Renderiza os dados filtrados
    renderizarDespesas(despesasFiltradas, totalFiltrado);
}

function limparFiltrosDespesas() {
    document.getElementById('filtro-fornecedor').value = '';
    document.getElementById('filtro-conta').value = '';
    
    // Calcula o total original
    const totalOriginal = despesasCompletas.reduce((sum, despesa) => sum + despesa.valor, 0);
    
    // Restaura o total original
    const totalValor = document.getElementById('despesa-total-valor');
    totalValor.textContent = `R$ ${totalOriginal.toLocaleString('pt-BR')}`;
    
    // Renderiza todos os dados
    renderizarDespesas(despesasCompletas, totalOriginal);
}

function preencherModalResultado(data) {
    const loading = document.getElementById('resultado-comparativo-loading');
    const dataDiv = document.getElementById('resultado-comparativo-data');
    
    let html = '';
    data.periodos.forEach(periodo => {
        const variacao = periodo.variacao_percentual;
        const variacaoClass = variacao > 0 ? 'positivo' : variacao < 0 ? 'negativo' : 'neutro';
        const variacaoIcon = variacao > 0 ? 'üìà' : variacao < 0 ? 'üìâ' : '‚ûñ';
        
        html += `
            <div class="frz-table-row">
                <div class="frz-table-cell cliente">${periodo.periodo}</div>
                <div class="frz-table-cell projetado">R$ ${periodo.receitas.toLocaleString('pt-BR')}</div>
                <div class="frz-table-cell realizado">R$ ${periodo.despesas.toLocaleString('pt-BR')}</div>
                <div class="frz-table-cell realizado resultado-${variacaoClass}">R$ ${periodo.resultado.toLocaleString('pt-BR')}</div>
                <div class="frz-table-cell status">
                    <span class="frz-status-badge ${variacaoClass}">${variacaoIcon} ${variacao.toFixed(1)}%</span>
                </div>
            </div>
        `;
    });
    
    dataDiv.innerHTML = html;
    loading.style.display = 'none';
    dataDiv.style.display = 'block';
}

function fecharModal(modalId) {
    document.getElementById(modalId).style.display = 'none';
}

// Fechar modal clicando fora dele
window.onclick = function(event) {
    if (event.target.classList.contains('frz-modal')) {
        event.target.style.display = 'none';
    }
}
</script>
{% endblock %}