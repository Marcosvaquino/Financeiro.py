<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Armazém</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}?v=4">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .dashboard-armazem {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .header-dashboard {
            background: white;
            border-radius: 15px;
            padding: 25px 30px;
            margin-bottom: 20px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        
        .header-title {
            font-size: 2rem;
            font-weight: 700;
            color: #667eea;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
    .filtros-section {
        background: white;
        border-radius: 15px;
        padding: 15px 20px;
        margin-bottom: 20px;
        box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    }
    
    .filtros-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 12px;
    }
    
    .filtro-item {
        display: flex;
        flex-direction: column;
    }
    
    .filtro-item label {
        font-size: 0.75rem;
        font-weight: 600;
        color: #555;
        margin-bottom: 4px;
    }
    
    .filtro-item select {
        padding: 6px 12px;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        font-size: 0.875rem;
        background: white;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .filtro-item select:hover {
        border-color: #667eea;
    }
    
    .filtro-item select:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }        .cards-resumo {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
    .card-stat {
        background: linear-gradient(135deg, #ffffff 0%, #f8f9ff 100%);
        border-radius: 12px;
        padding: 15px 20px;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.1);
        transition: all 0.3s ease;
        border-left: 4px solid #667eea;
        position: relative;
        overflow: hidden;
    }
    
    .card-stat::before {
        content: '';
        position: absolute;
        top: 0;
        right: 0;
        width: 100px;
        height: 100px;
        background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.05) 100%);
        border-radius: 50%;
        transform: translate(30%, -30%);
    }
    
    .card-stat:hover {
        transform: translateY(-3px);
        box-shadow: 0 6px 20px rgba(102, 126, 234, 0.2);
        border-left-color: #764ba2;
    }
    
    .card-header {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 8px;
    }
    
    .card-icon {
        font-size: 1.5rem;
        filter: drop-shadow(2px 2px 4px rgba(102, 126, 234, 0.3));
    }
    
    .card-label {
        font-size: 0.75rem;
        color: #667eea;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .card-value {
        font-size: 1.5rem;
        font-weight: 700;
        color: #333;
        position: relative;
        z-index: 1;
    }        .charts-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 20px;
        }
        
        @media (max-width: 1200px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }
        }
        
        .chart-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        
        .chart-card.full-width {
            grid-column: 1 / -1;
        }
        
        .chart-card.two-cols {
            grid-column: span 2;
        }
        
        .chart-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: #333;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .chart-container {
            position: relative;
            height: 350px;
        }
        
        .chart-container-tall {
            position: relative;
            height: 450px;
        }
        
        .tabela-section {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            overflow-x: auto;
        }
        
        .tabela-dados {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.875rem;
        }
        
        .tabela-dados thead {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
    .tabela-dados th {
        padding: 15px 10px;
        text-align: center;
        font-weight: 600;
        white-space: nowrap;
    }
    
    .tabela-dados td {
        padding: 12px 10px;
        border-bottom: 1px solid #e0e0e0;
        text-align: center;
    }
    
    .tabela-dados td:first-child,
    .tabela-dados th:first-child {
        text-align: left;
    }
    
    .tabela-dados td:nth-child(2),
    .tabela-dados th:nth-child(2) {
        text-align: center;
        font-weight: 600;
    }        .tabela-dados tbody tr:hover {
            background: #f5f5f5;
        }
        
        .loading {
            text-align: center;
            padding: 50px;
            font-size: 1.25rem;
            color: #667eea;
        }
        
        .chart-pizza {
            height: 400px !important;
        }
        
        .full-width {
            grid-column: 1 / -1;
        }
    </style>
</head>
<body>
    <!-- Menu Lateral -->
    <div class="sidebar" id="sidebar">
        <button id="sidebarClose" class="sidebar-close" aria-label="Fechar menu">‹</button>
        <h2 class="sidebar-title">Menu</h2>
        
        <!-- Seção do usuário -->
        <div class="user-info">
            <div class="user-name">👤 Administrador</div>
        </div>
        
        <nav class="menu">
            <ul class="menu-root">
                <li class="menu-item has-children">
                    <span class="menu-parent">Financeiro</span>
                    <ul class="menu-children">
                        <li class="child-item"><a href="{{ url_for('planejamento') }}">Painel</a></li>
                        <li class="child-item"><a class="menu-orange" href="{{ url_for('planejamento_frz') }}">Planejamento FRZ</a></li>
                        <li class="child-item"><a href="{{ url_for('projecao') }}">Projeção</a></li>
                        <li class="child-item"><a href="{{ url_for('dashboard') }}">Dashboard</a></li>
                        <li class="child-item"><a href="{{ url_for('resumo') }}">Resumo</a></li>
                        <li class="child-item"><a href="{{ url_for('consolidacao') }}">Consolidação</a></li>
                        <li class="child-item"><a href="{{ url_for('importacao') }}">📂 Importação</a></li>
                        <li class="child-item"><a class="menu-highlight" href="{{ url_for('frz_log') }}">📈 FRZ LOG</a></li>
                    </ul>
                </li>
                <li class="menu-item has-children">
                    <span class="menu-parent">Frete</span>
                    <ul class="menu-children">
                        <li class="child-item"><a class="menu-highlight" href="{{ url_for('painel_frete.painel_frete') }}">📊 Painel Frete</a></li>
                        <li class="child-item"><a class="menu-orange" href="{{ url_for('margem_analise.dashboard_margem') }}">💰 Análise de Margem</a></li>
                        <li class="child-item"><a href="{{ url_for('upload_sistema.index') }}">📂 Importação</a></li>
                        <li class="child-item"><a href="{{ url_for('suporte.index') }}">🔧 Suporte</a></li>
                        <li class="child-item"><a href="{{ url_for('custo_frota.index') }}">🚛 Custo Frota</a></li>
                    </ul>
                </li>
                <li class="menu-item has-children expanded">
                    <span class="menu-parent">Armazem</span>
                    <ul class="menu-children">
                        <li class="child-item"><a href="{{ url_for('armazem.index') }}">📦 Painel</a></li>
                        <li class="child-item"><a href="{{ url_for('armazem.consolidado') }}">📊 Consolidado</a></li>
                        <li class="child-item"><a href="{{ url_for('armazem.frz_log') }}">🚚 FRZ LOG</a></li>
                        <li class="child-item"><a href="{{ url_for('armazem.importacao') }}">📂 Importação</a></li>
                    </ul>
                </li>
                <li class="menu-item has-children">
                    <span class="menu-parent">Logistica</span>
                    <ul class="menu-children">
                        <li class="child-item"><a href="{{ url_for('logistica.index') }}">Logistica</a></li>
                        <li class="child-item"><a href="{{ url_for('logistica.monitoramento') }}">📡 Monitoramento</a></li>
                        <li class="child-item"><a href="{{ url_for('logistica.mapa_calor') }}">🔥 Mapa de Calor</a></li>
                    </ul>
                </li>
            </ul>
        </nav>
    </div>

    <!-- Botão para abrir menu quando fechado -->
    <button id="sidebarOpen" class="sidebar-open" aria-label="Abrir menu">›</button>

    <!-- Wrapper para conteúdo principal -->
    <div class="content">
        <div class="dashboard-armazem">
            <!-- Header -->
            <div class="header-dashboard">
                <div class="header-title">
                    📦 Dashboard de Armazém
                </div>
            </div>
        
        <!-- Filtros -->
        <div class="filtros-section">
            <div class="filtros-grid">
                <div class="filtro-item">
                    <label for="filtro-dia">📅 Dia</label>
                    <select id="filtro-dia" onchange="carregarDados()">
                        <option value="TODOS">Todos os dias</option>
                    </select>
                </div>
                <div class="filtro-item">
                    <label for="filtro-mes">📆 Mês</label>
                    <select id="filtro-mes" onchange="carregarDados()">
                        <option value="TODOS">Todos os meses</option>
                    </select>
                </div>
                <div class="filtro-item">
                    <label for="filtro-ano">🗓️ Ano</label>
                    <select id="filtro-ano" onchange="carregarDados()">
                        <option value="TODOS">Todos os anos</option>
                    </select>
                </div>
                <div class="filtro-item">
                    <label for="filtro-filial">🏢 Filial</label>
                    <select id="filtro-filial" onchange="carregarDados()">
                        <option value="TODAS">Todas as filiais</option>
                    </select>
                </div>
            </div>
        </div>
        
        <!-- Cards de Resumo -->
        <div class="cards-resumo">
            <div class="card-stat">
                <div class="card-header">
                    <div class="card-icon">🚚</div>
                    <div class="card-label">Total de Carros</div>
                </div>
                <div class="card-value" id="total-carros">-</div>
            </div>
            <div class="card-stat">
                <div class="card-header">
                    <div class="card-icon">⚖️</div>
                    <div class="card-label">Peso Total (toneladas)</div>
                </div>
                <div class="card-value" id="total-peso">-</div>
            </div>
            <div class="card-stat">
                <div class="card-header">
                    <div class="card-icon">📊</div>
                    <div class="card-label">Média Diária (carros)</div>
                </div>
                <div class="card-value" id="media-carros">-</div>
            </div>
            <div class="card-stat">
                <div class="card-header">
                    <div class="card-icon">📈</div>
                    <div class="card-label">Peso Médio (por carro)</div>
                </div>
                <div class="card-value" id="media-peso">-</div>
            </div>
        </div>
        
        <!-- Gráficos Principais -->
        <div class="charts-grid">
            <!-- Gráfico de Embarcadores -->
            <div class="chart-card full-width">
                <div class="chart-title">📊 Embarcadores - JAC e SJC</div>
                <div class="chart-container">
                    <canvas id="grafico-embarcadores"></canvas>
                </div>
            </div>
            
            <!-- Gráfico Mensal (Barras + Linha) -->
            <div class="chart-card full-width">
                <div class="chart-title">📈 Análise Mensal - Peso e Carros</div>
                <div class="chart-container">
                    <canvas id="grafico-mensal"></canvas>
                </div>
            </div>
            
            <!-- Gráfico Pizza (Peso por Filial) -->
            <div class="chart-card">
                <div class="chart-title">🥧 Peso x Bases - Anual</div>
                <div class="chart-container">
                    <canvas id="grafico-pizza-filiais"></canvas>
                </div>
            </div>
            
            <!-- Gráfico Evolução Diária -->
            <div class="chart-card two-cols">
                <div class="chart-title">📈 Evolução Diária de Carros</div>
                <div class="chart-container">
                    <canvas id="grafico-evolucao-diaria"></canvas>
                </div>
            </div>
        </div>
        
        <!-- Tabela Detalhada -->
        <div class="tabela-section">
            <div class="chart-title">📋 Detalhamento Diário</div>
            <table class="tabela-dados">
                <thead>
                    <tr>
                        <th>Data</th>
                        <th>Filial</th>
                        <th>Total Carros</th>
                        <th>Peso (t)</th>
                        <th>MIEGGS (SJC)</th>
                        <th>FRIBOI</th>
                        <th>MINERVA (SJC)</th>
                        <th>GOLD PÃO</th>
                        <th>MAFRIG</th>
                        <th>FRZ LOG</th>
                        <th>ADORO</th>
                        <th>VISTA FOODS</th>
                        <th>MIEGGS (JAC)</th>
                        <th>MINERVA (JAC)</th>
                    </tr>
                </thead>
                <tbody id="tabela-corpo">
                    <tr>
                        <td colspan="14" class="loading">Carregando dados...</td>
                    </tr>
                </tbody>
            </table>
        </div>
        </div> <!-- Fecha dashboard-armazem -->
    </div> <!-- Fecha content -->

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        let chartEmbarcadores = null;
        let chartMensal = null;
        let chartPizzaFiliais = null;
        let chartEvolucaoDiaria = null;

        const mesesNomes = {
            1: 'Janeiro', 2: 'Fevereiro', 3: 'Março', 4: 'Abril',
            5: 'Maio', 6: 'Junho', 7: 'Julho', 8: 'Agosto',
            9: 'Setembro', 10: 'Outubro', 11: 'Novembro', 12: 'Dezembro'
        };

        async function carregarDados() {
            try {
                const dia = document.getElementById('filtro-dia').value;
                const mes = document.getElementById('filtro-mes').value;
                const ano = document.getElementById('filtro-ano').value;
                const filial = document.getElementById('filtro-filial').value;
                
                const params = new URLSearchParams({
                    dia: dia,
                    mes: mes,
                    ano: ano,
                    filial: filial
                });
                
                const response = await fetch(`/armazem/api/dados?${params}`);
                const data = await response.json();
                
                if (data.error) {
                    alert('Erro ao carregar dados: ' + data.error);
                    return;
                }
                
                atualizarResumo(data.resumo);
                atualizarGraficoEmbarcadores(data.embarcadores);
                atualizarGraficoMensal(data.mensal);
                atualizarGraficoPizzaFiliais(data.peso_filiais);
                atualizarGraficoEvolucaoDiaria(data.evolucao_diaria);
                atualizarTabela(data.tabela);
                
                // Atualiza filtros na primeira carga
                if (!document.getElementById('filtro-dia').hasAttribute('data-loaded')) {
                    popularFiltros(data.filtros);
                    document.getElementById('filtro-dia').setAttribute('data-loaded', 'true');
                }
            } catch (error) {
                console.error('Erro:', error);
                alert('Erro ao carregar dados: ' + error.message);
            }
        }

        function popularFiltros(filtros) {
            // Dias
            const selectDia = document.getElementById('filtro-dia');
            filtros.dias.forEach(dia => {
                const option = document.createElement('option');
                option.value = dia;
                option.textContent = dia;
                selectDia.appendChild(option);
            });
            
            // Meses
            const selectMes = document.getElementById('filtro-mes');
            filtros.meses.forEach(mes => {
                const option = document.createElement('option');
                option.value = mes;
                option.textContent = mesesNomes[mes];
                selectMes.appendChild(option);
            });
            
            // Anos
            const selectAno = document.getElementById('filtro-ano');
            filtros.anos.forEach(ano => {
                const option = document.createElement('option');
                option.value = ano;
                option.textContent = ano;
                selectAno.appendChild(option);
            });
            
            // Filiais
            const selectFilial = document.getElementById('filtro-filial');
            filtros.filiais.forEach(filial => {
                const option = document.createElement('option');
                option.value = filial;
                option.textContent = filial;
                selectFilial.appendChild(option);
            });
        }

        function atualizarResumo(resumo) {
            // Formatar números no padrão brasileiro
            document.getElementById('total-carros').textContent = resumo.total_carros.toLocaleString('pt-BR');
            document.getElementById('total-peso').textContent = (resumo.total_peso / 1000).toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2});
            document.getElementById('media-carros').textContent = Math.round(resumo.media_diaria_carros).toLocaleString('pt-BR');
            
            // Calcular peso médio por carro em QUILOS (kg)
            const pesoMedioPorCarroKg = resumo.total_carros > 0 ? resumo.total_peso / resumo.total_carros : 0;
            document.getElementById('media-peso').textContent = Math.round(pesoMedioPorCarroKg).toLocaleString('pt-BR');
        }

        function atualizarGraficoEmbarcadores(embarcadores) {
            const ctx = document.getElementById('grafico-embarcadores').getContext('2d');
            
            // Ordena os embarcadores do maior para o menor peso
            const embarcadoresArray = Object.entries(embarcadores).map(([nome, dados]) => ({
                nome: nome,
                carros: dados.carros,
                peso: dados.peso
            }));
            
            // Ordena por peso (decrescente)
            embarcadoresArray.sort((a, b) => b.peso - a.peso);
            
            const labels = embarcadoresArray.map(item => item.nome);
            const carros = embarcadoresArray.map(item => item.carros);
            const pesos = embarcadoresArray.map(item => item.peso);
            
            if (chartEmbarcadores) {
                chartEmbarcadores.destroy();
            }
            
            chartEmbarcadores = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Peso (t)',
                            data: pesos,
                            backgroundColor: '#ff6600',
                            borderColor: '#ff6600',
                            borderWidth: 2,
                            order: 1
                        },
                        {
                            label: 'Carros',
                            data: carros,
                            backgroundColor: '#004E89',
                            borderColor: '#004E89',
                            borderWidth: 2,
                            order: 2
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                font: {
                                    size: 12,
                                    weight: 'bold'
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    label += context.parsed.y.toLocaleString('pt-BR');
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value.toLocaleString('pt-BR');
                                }
                            }
                        }
                    }
                },
                plugins: [{
                    afterDatasetsDraw: function(chart) {
                        const ctx = chart.ctx;
                        chart.data.datasets.forEach(function(dataset, i) {
                            const meta = chart.getDatasetMeta(i);
                            if (!meta.hidden) {
                                meta.data.forEach(function(element, index) {
                                    ctx.fillStyle = '#000';
                                    ctx.font = 'bold 11px Arial';
                                    ctx.textAlign = 'center';
                                    ctx.textBaseline = 'bottom';
                                    
                                    const dataValue = dataset.data[index];
                                    if (dataValue > 0) {
                                        const x = element.x;
                                        const y = element.y - 5;
                                        ctx.fillText(dataValue.toLocaleString('pt-BR'), x, y);
                                    }
                                });
                            }
                        });
                    }
                }]
            });
        }

        function atualizarGraficoMensal(mensal) {
            const ctx = document.getElementById('grafico-mensal').getContext('2d');
            
            const labels = mensal.map(item => item.mes);
            const carros = mensal.map(item => item.carros);
            const pesos = mensal.map(item => item.peso / 1000);
            
            // Calcula os valores máximos para ajustar as escalas
            const maxPeso = Math.max(...pesos);
            const maxCarros = Math.max(...carros);
            
            if (chartMensal) {
                chartMensal.destroy();
            }
            
            chartMensal = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Carros',
                            data: carros,
                            type: 'line',
                            borderColor: '#004E89',
                            backgroundColor: 'rgba(0, 78, 137, 0.1)',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.4,
                            pointRadius: 5,
                            pointHoverRadius: 7,
                            yAxisID: 'y1',
                            order: 1
                        },
                        {
                            label: 'Peso (t)',
                            data: pesos,
                            backgroundColor: '#ff6600',
                            borderColor: '#ff6600',
                            borderWidth: 2,
                            yAxisID: 'y',
                            order: 2
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                font: {
                                    size: 12,
                                    weight: 'bold'
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            type: 'linear',
                            position: 'left',
                            beginAtZero: true,
                            max: maxPeso * 1.5,
                            title: {
                                display: true,
                                text: 'Peso (toneladas)',
                                font: {
                                    weight: 'bold',
                                    size: 13
                                },
                                color: '#ff6600'
                            },
                            ticks: {
                                callback: function(value) {
                                    return value.toLocaleString('pt-BR');
                                }
                            }
                        },
                        y1: {
                            type: 'linear',
                            position: 'right',
                            min: 0,
                            max: maxCarros * 1.15,
                            title: {
                                display: true,
                                text: 'Carros',
                                font: {
                                    weight: 'bold',
                                    size: 13
                                },
                                color: '#004E89'
                            },
                            grid: {
                                drawOnChartArea: false
                            },
                            ticks: {
                                callback: function(value) {
                                    return value.toLocaleString('pt-BR');
                                }
                            }
                        }
                    }
                },
                plugins: [{
                    afterDatasetsDraw: function(chart) {
                        const ctx = chart.ctx;
                        
                        // Desenha valores nos pontos da linha (Carros) - ordem 0
                        const metaLine = chart.getDatasetMeta(0);
                        if (!metaLine.hidden) {
                            metaLine.data.forEach(function(element, index) {
                                ctx.fillStyle = '#004E89';
                                ctx.font = 'bold 10px Arial';
                                ctx.textAlign = 'center';
                                ctx.textBaseline = 'bottom';
                                
                                const dataValue = carros[index];
                                if (dataValue > 0) {
                                    const x = element.x;
                                    const y = element.y - 8;
                                    ctx.fillText(dataValue.toLocaleString('pt-BR'), x, y);
                                }
                            });
                        }
                        
                        // Desenha valores nas barras (Peso) - ordem 1
                        const metaBar = chart.getDatasetMeta(1);
                        if (!metaBar.hidden) {
                            metaBar.data.forEach(function(element, index) {
                                ctx.fillStyle = '#000';
                                ctx.font = 'bold 10px Arial';
                                ctx.textAlign = 'center';
                                ctx.textBaseline = 'bottom';
                                
                                const dataValue = pesos[index];
                                if (dataValue > 0) {
                                    const x = element.x;
                                    const y = element.y - 5;
                                    ctx.fillText(dataValue.toLocaleString('pt-BR'), x, y);
                                }
                            });
                        }
                    }
                }]
            });
        }

        function atualizarGraficoPizzaFiliais(pesoFiliais) {
            const ctx = document.getElementById('grafico-pizza-filiais').getContext('2d');
            
            const labels = Object.keys(pesoFiliais);
            const dados = labels.map(key => pesoFiliais[key] / 1000);
            
            if (chartPizzaFiliais) {
                chartPizzaFiliais.destroy();
            }
            
            chartPizzaFiliais = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: dados,
                        backgroundColor: ['#004E89', '#1A936F']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                },
                plugins: [{
                    afterDatasetsDraw: function(chart) {
                        const ctx = chart.ctx;
                        chart.data.datasets.forEach((dataset, i) => {
                            const meta = chart.getDatasetMeta(i);
                            meta.data.forEach((element, index) => {
                                const value = dataset.data[index];
                                const total = dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = ((value / total) * 100).toFixed(1);
                                
                                // Formatar valor em padrão BR: 20.033,9t
                                const valorFormatado = value.toLocaleString('pt-BR', {
                                    minimumFractionDigits: 1,
                                    maximumFractionDigits: 1
                                });
                                
                                const position = element.tooltipPosition();
                                ctx.fillStyle = '#fff';
                                ctx.font = 'bold 16px Arial';
                                ctx.textAlign = 'center';
                                ctx.textBaseline = 'middle';
                                ctx.shadowColor = 'rgba(0,0,0,0.3)';
                                ctx.shadowBlur = 4;
                                ctx.fillText(valorFormatado + 't', position.x, position.y - 12);
                                ctx.font = 'bold 14px Arial';
                                ctx.fillText(percentage.replace('.', ',') + '%', position.x, position.y + 12);
                                ctx.shadowBlur = 0;
                            });
                        });
                    }
                }]
            });
        }

        function atualizarGraficoEvolucaoDiaria(evolucao) {
            const ctx = document.getElementById('grafico-evolucao-diaria').getContext('2d');
            
            const labels = evolucao.map(item => item.dia);
            const carros = evolucao.map(item => item.carros);
            
            if (chartEvolucaoDiaria) {
                chartEvolucaoDiaria.destroy();
            }
            
            chartEvolucaoDiaria = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Carros',
                        data: carros,
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        borderWidth: 3,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                },
                plugins: [{
                    afterDatasetsDraw: function(chart) {
                        const ctx = chart.ctx;
                        chart.data.datasets.forEach((dataset, i) => {
                            const meta = chart.getDatasetMeta(i);
                            meta.data.forEach((element, index) => {
                                const value = dataset.data[index];
                                if (value && value > 0) {
                                    // Alternar posição: ímpar em cima, par embaixo
                                    const offset = index % 2 === 0 ? -10 : 15;
                                    
                                    ctx.fillStyle = '#667eea';
                                    ctx.font = 'bold 12px Arial';
                                    ctx.textAlign = 'center';
                                    ctx.strokeStyle = '#fff';
                                    ctx.lineWidth = 3;
                                    ctx.strokeText(value, element.x, element.y + offset);
                                    ctx.fillText(value, element.x, element.y + offset);
                                }
                            });
                        });
                    }
                }]
            });
        }

        function atualizarTabela(dados) {
            const tbody = document.getElementById('tabela-corpo');
            tbody.innerHTML = '';
            
            if (dados.length === 0) {
                tbody.innerHTML = '<tr><td colspan="14" style="text-align: center; padding: 30px;">Nenhum dado encontrado</td></tr>';
                return;
            }
            
            dados.slice(0, 30).forEach(row => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${row.data}</td>
                    <td><strong>${row.filial}</strong></td>
                    <td><strong>${row.carros}</strong></td>
                    <td>${(row.peso / 1000).toFixed(2)}</td>
                    <td>${row.mafrig_foods}</td>
                    <td>${row.friboi}</td>
                    <td>${row.mafrig_atacado}</td>
                    <td>${row.gold_pao}</td>
                    <td>${row.mafrig_compart}</td>
                    <td>${row.frz_log_compart}</td>
                    <td>${row.adoro}</td>
                    <td>${row.vista_foods}</td>
                    <td>${row.mieggs}</td>
                    <td>${row.minerva_jac}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        // Carregar dados ao iniciar
        document.addEventListener('DOMContentLoaded', function() {
            carregarDados();
        });
    </script>

    <!-- Script do Menu Lateral -->
    <script>
        // Sidebar toggle
        (function(){
            const btnClose = document.getElementById('sidebarClose');
            const btnOpen = document.getElementById('sidebarOpen');
            const sidebar = document.getElementById('sidebar');
            const STORAGE_KEY = 'frz_sidebar_collapsed';
            if(!sidebar) return;

            function setClosed(){
                sidebar.classList.add('collapsed');
                if(btnClose) btnClose.style.display = 'none';
                if(btnOpen) btnOpen.style.display = 'block';
                try { localStorage.setItem(STORAGE_KEY, '1'); } catch(e){}
            }
            function setOpen(){
                sidebar.classList.remove('collapsed');
                if(btnClose) btnClose.style.display = 'block';
                if(btnOpen) btnOpen.style.display = 'none';
                try { localStorage.setItem(STORAGE_KEY, '0'); } catch(e){}
            }

            if(btnClose){
                btnClose.addEventListener('click', function(e){
                    setClosed();
                    e.stopPropagation();
                });
            }
            if(btnOpen){
                btnOpen.addEventListener('click', function(e){
                    setOpen();
                    e.stopPropagation();
                });
            }

            try {
                const stored = localStorage.getItem(STORAGE_KEY);
                if (stored === '1') {
                    setClosed();
                } else if (stored === '0') {
                    setOpen();
                } else {
                    if(sidebar.classList.contains('collapsed')){
                        if(btnClose) btnClose.style.display = 'none';
                        if(btnOpen) btnOpen.style.display = 'block';
                    } else {
                        if(btnClose) btnClose.style.display = 'block';
                        if(btnOpen) btnOpen.style.display = 'none';
                    }
                }
            } catch(e) {
                if(sidebar.classList.contains('collapsed')){
                    if(btnClose) btnClose.style.display = 'none';
                    if(btnOpen) btnOpen.style.display = 'block';
                } else {
                    if(btnClose) btnClose.style.display = 'block';
                    if(btnOpen) btnOpen.style.display = 'none';
                }
            }
        })();

        // Menu pai/filho
        (function(){
            const parents = document.querySelectorAll('.menu-parent');
            parents.forEach(p => {
                p.addEventListener('click', function(){
                    const item = this.parentElement;
                    
                    if (item.classList.contains('expanded')) {
                        item.classList.remove('expanded');
                        return;
                    }
                    
                    const allMenuItems = document.querySelectorAll('.menu-item');
                    allMenuItems.forEach(menuItem => {
                        menuItem.classList.remove('expanded');
                    });
                    
                    item.classList.add('expanded');
                });
            });
        })();
    </script>
</body>
</html>
